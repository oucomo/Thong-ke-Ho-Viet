---
title: "Ho Viet"
author: "Duc Du"
date: '`r format(Sys.time(), "%d %B, %Y")`'
output: html_document
---

```{r setup, include=FALSE}
rm(list = ls(all.names = TRUE))
knitr::opts_chunk$set(echo = FALSE, 
                      cache=TRUE,
                      tidy.opts=list(width.cutoff=60),
                      tidy=TRUE)
#library(rmarkdown)
#library(knitr)
library(markdown)
library(stringr)
library(forcats)
library(RColorBrewer)
library(tidyverse)
library(dplyr)
library(ggplot2)
library(Hmisc)
library(gtsummary)
#library(flextable)
library(huxtable)
library(data.table)
library(lubridate)
library(stringi)
library(forcats)
library(ggpubr)
library(rstatix)
#library(dlookr)
#library(flextable)
library(haven)
library(raster)
library(rgdal)
library(viridis)
library(sf)

select<-dplyr::select
filter<-dplyr::filter
recode<-dplyr::recode
getData<-raster::getData

# rotate function (see here: https://r-spatial.github.io/sf/articles/sf3.html#affine-transformations
rot <- function(a) matrix(c(cos(a), sin(a), -sin(a), cos(a)), 2, 2)

options(scipen=999, digits = 3)
options(max.print=1000000)
```

# Load data

```{r load data}
path_ho = file.path("data", "DanhSach_Ho.sav") 
path_huyen = file.path("data", "Dm_Huyen.sav")
path_tinh = file.path("data", "Dm_Tinh.sav")
path_xa = file.path("data", "Dm_Xa.sav")

data_ho = read_sav(path_ho) %>% filter(Ho!="" & Ho!=" " & !is.na(Ho))
data_huyen = read_sav(path_huyen)
data_tinh = read_sav(path_tinh)
data_xa = read_sav(path_xa)

#gadm36_VNM2 <- readRDS("data/gadm36_VNM_2_sp.rds")
#gadm36_VNM3 <- readRDS("data/"gadm36_VNM_3_sp.rds")

gadm36_VNM3_sf <- readRDS("data/gadm36_VNM_3_sf.rds")
#publicProvinces <- readRDS("data", "publicProvinces.rds")

load("data/geo_vnm.Rdata")
load("data/pop_info.Rdata")
load("data/vnm2_map.Rdata")
load("data/vnm3_map.Rdata")
```

```{r load data2}
#load("data/hoviet.RData")
```

## Inspecting data

```{r, echo=FALSE}
#diagnose(data_ho) %>% flextable()
#diagnose_category(data_ho) %>% flextable()
#diagnose_numeric(data_ho) %>% flextable()
#diagnose_outlier(data_ho) %>% flextable()
```

# Cleaning

```{r}
data_ho$Ho <- trimws(gsub("\\s+", " ", data_ho$Ho))
data_ho$Ho <- ifelse(str_detect(data_ho$Ho, "bui|Buì|Bui|bùi|Bùi|Bùi|BÙI|BUI|Búi|bùi|Bùi|BùI|BÙi|BÙI|Bùo|Bùu|Bủi|Bừi|Bụi") == TRUE, "Bùi", data_ho$Ho)
data_ho$Ho <- ifelse(str_detect(data_ho$Ho, "cao|Cao|CAO|CAo") == TRUE, "Cao", data_ho$Ho)
data_ho$Ho <- ifelse(str_detect(data_ho$Ho, "Chau|châu|Châu|CHÂU|chau") == TRUE, "Châu", data_ho$Ho)
data_ho$Ho <- ifelse(str_detect(data_ho$Ho, "chu|Chu|CHU") == TRUE, "Chu", data_ho$Ho)
data_ho$Ho <- ifelse(str_detect(data_ho$Ho, "đàm|Đàm|ĐÀM|Đàm|Đàm|đàm") == TRUE, "Đàm", data_ho$Ho)
data_ho$Ho <- ifelse(str_detect(data_ho$Ho, "Đăng|đặng|Đặng|Đặng|ĐẶNG|dặng|Dặng|Đặnh|đặng|ĐặNg|ĐẶNG|Đạng|Đậng|Đặng|Ðặng|Đặnh|Đănhj") == TRUE, "Đặng", data_ho$Ho)
data_ho$Ho <- ifelse(str_detect(data_ho$Ho, "danh|Danh|DANH") == TRUE, "Danh", data_ho$Ho)
data_ho$Ho <- ifelse((data_ho$Ho == "đào" | data_ho$Ho == "Đào" | data_ho$Ho == "Đào" | data_ho$Ho == "ĐÀO" | data_ho$Ho == "Dào" | data_ho$Ho == "Đaò" | data_ho$Ho == "đào" | data_ho$Ho =="ĐàO" | data_ho$Ho == "ĐÀo" | data_ho$Ho == "ĐÀO" | data_ho$Ho == "Đoà" | data_ho$Ho == "Đòa"), "Đào", data_ho$Ho)
data_ho$Ho <- ifelse(str_detect(data_ho$Ho, "đinh|Đinh|ĐINH|Đimh|Din|Đin|Đing|dinh|Dinh|DINH|ĐInh|Đjnh|Đlnh") == TRUE, "Đinh", data_ho$Ho)
data_ho$Ho <- ifelse(str_detect(data_ho$Ho, "đỗ|Đỗ|Đỗ|ĐỖ|Đổ|ĐỖ|Dỗ|đổ|Đổ|ĐỔ|ĐỔ|Đõ|ĐÕ|Đỡ") == TRUE, "Đỗ", data_ho$Ho)
data_ho$Ho <- ifelse((data_ho$Ho == "đoàn" | data_ho$Ho ==  "Đoàn" | data_ho$Ho == "Đoàn" | data_ho$Ho == "ĐOÀN" | data_ho$Ho == "đoàn" | data_ho$Ho == "ĐoàN" | data_ho$Ho == "ĐOàn" | data_ho$Ho == "ĐOÀN" | data_ho$Ho == "đòan" | data_ho$Ho == "Đòan" | data_ho$Ho == "Đòan" | data_ho$Ho == "ĐÒAN" | data_ho$Ho == "Ðoàn"), "Đoàn", data_ho$Ho)
data_ho$Ho <- ifelse((data_ho$Ho == "dư" | data_ho$Ho == "Dư" | data_ho$Ho == "DƯ"), "Dư", data_ho$Ho)
data_ho$Ho <- ifelse((data_ho$Ho == "Duong" | data_ho$Ho == "dương" | data_ho$Ho == "Dương" | data_ho$Ho == "DƯƠNG" | data_ho$Ho == "Dươ" | data_ho$Ho == "Dươg" | data_ho$Ho == "Dươg" | data_ho$Ho == "Dươmg" | data_ho$Ho == "Dươn" | data_ho$Ho == "Duỏng" | data_ho$Ho == "Duơng" | data_ho$Ho == "Dươngthanh" | data_ho$Ho == "Dươnh" | data_ho$Ho == "Dươnng"), "Dương", data_ho$Ho)
data_ho$Ho <- ifelse(str_detect(data_ho$Ho, "đường|Đường|ĐƯỜNG|Dướng|dường|Dường|Dường|Dưỡng|Dượng|Đương|Đường|Đường") == TRUE, "Đường", data_ho$Ho)
data_ho$Ho <- ifelse(str_detect(data_ho$Ho, "giàng|Giàng|Giàng|Giàng|GIÀNG|giàng") == TRUE, "Giàng", data_ho$Ho)
data_ho$Ho <- ifelse(str_detect(data_ho$Ho, "hà|Hà|Hà|HÀ|hà|Hà|HÀ") == TRUE, "Hà", data_ho$Ho)
data_ho$Ho <- ifelse(str_detect(data_ho$Ho, "hồ|Hồ̀|HỒ|hồ|Hồ|Hồ|HỒ") == TRUE, "Hồ", data_ho$Ho)
data_ho$Ho <- ifelse(str_detect(data_ho$Ho, "Hoang|hoàng|hoàng|Hoàng|Hoàng|HOÀNG|Hoàng|HOÀNG|Hòang|Hoáng|HOàng|hòang|HÒANG|HÒANG|Hoành|HOÀNH") == TRUE, "Hoàng", data_ho$Ho)
data_ho$Ho <- ifelse(str_detect(data_ho$Ho, "Huynh|huỳnh|Huỳnh|Huỳnh|HuỲNH|HUỲNH|Hùynh|huỳnh|Huỳnh|HUỲNH|Huuỳnh|Huuỳnh|Huỳn|Huỳng|huynh|HUYNH|Huýnh|Huỳnh|Huỹnh|Huỷnh|hùynh|Hùynh|HÙYNH|Huyỳnh") == TRUE, "Huỳnh", data_ho$Ho)
data_ho$Ho <- ifelse(str_detect(data_ho$Ho, "Khuc|khúc|Khúc|Khúc|KHÚC") == TRUE, "Khúc", data_ho$Ho)
data_ho$Ho <- ifelse(str_detect(data_ho$Ho, "kiều|Kiều|Kiều|Kiều|KIỀU|Kieu|Kièu|Kiêu|Kiếu|KiỀU|KIỀU|Kiểu") == TRUE, "Kiều", data_ho$Ho)
data_ho$Ho <- ifelse(str_detect(data_ho$Ho, "lại|Lại|LẠI|Lại|Lại|Laị|LẠI") == TRUE, "Lại", data_ho$Ho)
data_ho$Ho <- ifelse(str_detect(data_ho$Ho, "Lam|lâm|Lâm|LÂM|LÂm") == TRUE, "Lâm", data_ho$Ho)
data_ho$Ho <- ifelse(str_detect(data_ho$Ho, "Lâ|lã|Lã|Lã|LÃ|Lả") == TRUE, "Lã", data_ho$Ho)
data_ho$Ho <- ifelse(str_detect(data_ho$Ho, "Le|lê|Lê|LÊ|le|LE|Lê|Lế") == TRUE, "Lê", data_ho$Ho)
data_ho$Ho <- ifelse(str_detect(data_ho$Ho, "Lo|lò|lò|Lò|Lò|LÒ|LÒ") == TRUE, "Lò", data_ho$Ho)
data_ho$Ho <- ifelse(str_detect(data_ho$Ho, "Luong|lương|Lương|LƯƠNG|Lươmg|Lươn|luong|Lưong|Lươnh") == TRUE, "Lương", data_ho$Ho)
data_ho$Ho <- ifelse(str_detect(data_ho$Ho, "lường|Lường|lường|Lường|Lường|LƯỜNG|Luòng|Luờng|Lường|LƯỜNG|Lừơng|Lươờng") == TRUE, "Lường", data_ho$Ho)
data_ho$Ho <- ifelse(str_detect(data_ho$Ho, "Luu|lưu|Lưu|LƯU|luu|LUU|Luư|Lưư") == TRUE, "Lưu", data_ho$Ho)
data_ho$Ho <- ifelse(str_detect(data_ho$Ho, "Ly|lý|Lý|Lý|LÝ|ly|LY|lý|Lý") == TRUE, "Lý", data_ho$Ho)
data_ho$Ho <- ifelse(str_detect(data_ho$Ho, "Mă|Mẵ|mã|Mã|Mã|MÃ|MÃ|mả|Mả") == TRUE, "Mã", data_ho$Ho)
data_ho$Ho <- ifelse(str_detect(data_ho$Ho, "Mạc|Mạc|MẠC|mạc|Mặc") == TRUE, "Mạc", data_ho$Ho)
data_ho$Ho <- ifelse(str_detect(data_ho$Ho, "mai|Mai|MAI|MAi") == TRUE, "Mai", data_ho$Ho)
data_ho$Ho <- ifelse(str_detect(data_ho$Ho, "Ngo|ngô|Ngô|NGÔ|NGô") == TRUE, "Ngô", data_ho$Ho)
data_ho$Ho <- ifelse(str_detect(data_ho$Ho, "Nguễn|Nguyễ|Nhuyễn|nguyen|Nguyen|NGUYEN|Nguyên|Nguyến|Nguyền|nguyễn|nguyễn|Nguyễn|Nguyễn|NguyễN|NguyỄn|NGUYỄN|NGUYỄN|Nguyển|Nguỹen|Ngyễn|Nguyê|Nguyêễn|nguyên|NGUYÊN|Nguyêñ|Nguyễn|nguyển|NGUYỂN|Nguyện|Nguỹên|Nguyênc|Nguyễnthanh|NguyễnThị|Ncuyên|Nghuyen|Nghuyễn|Nghyễn|Ngiyeenx|Ngiyen|ngiyên|Ngiyên|Ngiyễn|Ngiyênx|Nguen|Nguên|nguễn|Nguễn|NGUỄN|Nguển|Nguễyn|Nguhên|Nguien|Ngutên|Nguueenx|Nguuen|Nguuên|Nguuễn|Nguuễn|Nguye|nguyễ|NGUYỄ|Nguyể|Nguyeễn|NGUYÊỄN|Nguyem|NguyEn|Nguyĕn|nguyến|NGUYẾN|NGUYẾN|nguyền|NGUYỀN|Nguyễn|NGUYỄn|Nguyën|Nguyẽn|Nguyẽn|Nguyēn|nguyện|NGUYỆN|nguỹen|NGUỸEN|Nguỷen|Ngũyên|Ngưyễn|Nguyi|Nguyn|Nguỹn|Nguyôn|Nguyyễn|Ngyen|Ngyên|ngyễn|NGYỄN|Ngyuen|Ngyuên|Ngyuễn") == TRUE, "Nguyễn", data_ho$Ho)
data_ho$Ho <- ifelse(str_detect(data_ho$Ho, "Pham|phạm|Phạm|Phạm|PHẠM|PHẠM|Phaạm|pham|PHAM|phạm|Phạm|Phạm|PhạM|PhẠm|PHạm|PHạm|PHạm|Phặm|Phậm") == TRUE, "Phạm", data_ho$Ho)
data_ho$Ho <- ifelse(str_detect(data_ho$Ho, "phan|Phan|PHAN|pHAN|Phan") == TRUE, "Phan", data_ho$Ho)
data_ho$Ho <- ifelse(str_detect(data_ho$Ho, "phùng|Phùng|Phùng|PHÙNG|Phùn|Phung|Phùng|Phủng|Phúng|phùng|Phùng|PHÙNG|Phừng") == TRUE, "Phùng", data_ho$Ho)
data_ho$Ho <- ifelse(str_detect(data_ho$Ho, "quách|Quách|Quách|QUÁCH|Quach|Quách|Qách|Qoách|Quác|quach|QUÁCH|Quách|Qúach") == TRUE, "Quách", data_ho$Ho)
data_ho$Ho <- ifelse(str_detect(data_ho$Ho, "quàng|quàng|Quàng|Quàng|QUÀNG") == TRUE, "Quàng", data_ho$Ho)
data_ho$Ho <- ifelse(str_detect(data_ho$Ho, "Ta|tạ|Tạ|Tạ|TẠ|tạ|Tạ|TẠ") == TRUE, "Tạ", data_ho$Ho)
data_ho$Ho <- ifelse(str_detect(data_ho$Ho, "Thach|thạch|Thạch|Thạch|THẠCH|thạch|Thạch|THẠCH") == TRUE, "Thạch", data_ho$Ho)
data_ho$Ho <- ifelse(str_detect(data_ho$Ho, "thái|Thái|Thái|THÁI|Thái|THÁI") == TRUE, "Thái", data_ho$Ho)
data_ho$Ho <- ifelse(str_detect(data_ho$Ho, "thị|Thị|Thị|THỊ") == TRUE, "Thị", data_ho$Ho)
data_ho$Ho <- ifelse(str_detect(data_ho$Ho, "tôn|Tôn|TÔN|Ton") == TRUE, "Tôn", data_ho$Ho)
data_ho$Ho <- ifelse(str_detect(data_ho$Ho, "tòng|Tòng|tòng|Tòng|TÒNG") == TRUE, "Tòng", data_ho$Ho)
data_ho$Ho <- ifelse(str_detect(data_ho$Ho, "tống|Tống|TỐNG") == TRUE, "Tống", data_ho$Ho)
data_ho$Ho <- ifelse(str_detect(data_ho$Ho, "Tran|Tràn|trần|trần|Trần|Trần|TRẦN|Trầ|Trằn|trân|Trân|TRÂN|Trần|TrầN|TrẦn|TRần|TRầN|TRẦN|tran|TRan|TRAN|Trán|Trán|tràn|Tràn|TRÀN|Trăn|trấn|Trấn|TRẤN|Trần|trẫn|Trẫn|trẩn|Trẩn|Trận") == TRUE, "Trần", data_ho$Ho)
data_ho$Ho <- ifelse(str_detect(data_ho$Ho, "triệu|Triệu|Triệu|TRIỆU|Trieu|Triêu|Triệu|Triêụ|triệu|TRIỆU|Triẹu|Triệu|TRiệu") == TRUE, "Triệu", data_ho$Ho)
data_ho$Ho <- ifelse(str_detect(data_ho$Ho, "trịnh|Trịnh|Trịnh|TRỊNH|Trịnh|TRỊNH|Triịnh|TRIỊNH|Trịn|Tring|Trịng|Trĩnh|trịnh|Trịnh|TrịNh|TRịnh|Trinhj") == TRUE, "Trịnh", data_ho$Ho)
data_ho$Ho <- ifelse(str_detect(data_ho$Ho, "Truong|trương|Trương|TRƯƠNG|truong|Trươ|Trươg|Trươmg|Trươn|TRUONG|truơng|Truơng|Trưong|Trưông|Trương|Trươnh|Truương") == TRUE, "Trương", data_ho$Ho)
data_ho$Ho <- ifelse(str_detect(data_ho$Ho, "Văn|VĂN|văn|Văn|Vắn") == TRUE, "Văn", data_ho$Ho)
data_ho$Ho <- ifelse(str_detect(data_ho$Ho, "Vàng|VÀNG|vàng|Vàng|Vàng|VÀNG") == TRUE, "Vàng", data_ho$Ho)
data_ho$Ho <- ifelse(str_detect(data_ho$Ho, "vi|Vi|VI|ViThị|ViVăn|vy|Vy|VY|VyThị|VyVăn") == TRUE, "Vi", data_ho$Ho)
data_ho$Ho <- ifelse(str_detect(data_ho$Ho, "vì|Vì") == TRUE, "Vì", data_ho$Ho)
data_ho$Ho <- ifelse(str_detect(data_ho$Ho, "võ|Võ|Võ|VÕ|Vỏ|Vỗ|võ|Võ|VÕ|vỏ|Vỏ|VỎ|Vỡ") == TRUE, "Võ", data_ho$Ho)
data_ho$Ho <- ifelse(str_detect(data_ho$Ho, "vũ|Vũ|Vũ|VŨ|vũ|Vũ|Vủ|VŨ|Vū|vủ|VỦ|Vữ") == TRUE, "Vũ", data_ho$Ho)
data_ho$Ho <- ifelse(str_detect(data_ho$Ho, "vừ|Vừ|Vừ|Vừ|VỪ") == TRUE, "Vừ", data_ho$Ho)
data_ho$Ho <- ifelse(str_detect(data_ho$Ho, "Vuong|Vương|VƯƠNG|vương|Vương|Vươn|vuong|Vuông|Vuơng|Vưong|Vương") == TRUE, "Vương", data_ho$Ho)
```

# Tổng họ

```{r}
data_ho_overall <- data_ho %>%
  group_by(Ho) %>%
  summarise(songuoi=sum(songuoi))

data_ho_tinh <- data_ho %>%
  group_by(MATINH, Ho) %>%
  summarise(songuoi=sum(songuoi)) %>% filter(MATINH!="") %>%
  group_by(MATINH) %>%
  mutate(danso=sum(songuoi)) %>% ungroup() %>%
  mutate(pro.pop=(songuoi/danso)*100)

data_ho_xa <- data_ho %>%
  group_by(MATINH, MAHUYEN, MAXA, Ho) %>%
  summarise(songuoi=sum(songuoi)) %>% filter(MATINH!="") %>%
  group_by(MAXA) %>%
  mutate(danso=sum(songuoi)) %>% ungroup() %>%
  mutate(pro.pop=(songuoi/danso)*100)
```
## Top Họ cả nước

```{r}
data_ho_top10000 <- data_ho_overall %>%
  arrange(desc(songuoi)) %>%
  mutate(pro.pop=(songuoi/sum(songuoi)*100))
data_ho_top10000 <- head(data_ho_top10000, n=10000)
library(writexl)
#write_xlsx(data_ho_top10000, "output/Top 10000 ho.xlsx")

data_ho_top3000 <- data_ho_overall %>%
  arrange(desc(songuoi)) %>%
  mutate(pro.pop=(songuoi/sum(songuoi)*100))
data_ho_top3000 <- head(data_ho_top3000, n=3000)
#write_xlsx(data_ho_top3000, "output/Top 3000 ho.xlsx")

data_ho_top1000 <- data_ho_overall %>%
  arrange(desc(songuoi))
data_ho_top1000 <- head(data_ho_top1000, n=1000)

data_ho_top500 <- data_ho_overall %>%
  arrange(desc(songuoi))
data_ho_top500 <- head(data_ho_top500, n=500)

data_ho_top200 <- data_ho_overall %>%
  arrange(desc(songuoi))
data_ho_top200 <- head(data_ho_top200, n=200) %>%
  mutate(rank = dense_rank(desc(songuoi)),
         group=NA,
         group=ifelse(rank %in% c(1:50), 1, ifelse(rank %in% c(51:100), 2, ifelse(rank %in% c(101:150), 3, ifelse(rank %in% c(151:200), 4, group)))),
         group=factor(group, levels = c(1,2,3,4), labels = c("1-50","51-100","101-150","151-200")))

data_ho_top150 <- data_ho_overall %>%
  arrange(desc(songuoi))
data_ho_top150 <- data_ho_top150 %>% slice(101:150)

data_ho_top100 <- data_ho_overall %>%
  arrange(desc(songuoi))
data_ho_top100 <- data_ho_top100 %>% slice(51:100)

data_ho_top50 <- data_ho_overall %>%
  arrange(desc(songuoi))
data_ho_top50 <- head(data_ho_top50, n=50)

data_ho_top20 <- data_ho_overall %>%
  arrange(desc(songuoi))
data_ho_top20 <- head(data_ho_top20, n=20)

data_ho_top10 <- data_ho_overall %>%
  arrange(desc(songuoi))
data_ho_top10 <- head(data_ho_top10, n=10)
```

```{r}
ggplot(data = data_ho_top50, aes(x = reorder(Ho, songuoi, decreasing=F), y =songuoi)) +
  geom_bar(stat = "identity", fill="red", width = 0.75) +
  #geom_text(aes(label = songuoi, y = songuoi + 50), size = 3) +
  scale_x_discrete(name = NULL) +
  scale_y_continuous(name = NULL, breaks = seq(from = 0, to = 30000000, by = 5000000)) +
  theme_bw() +
  theme(axis.text.y = element_text(size = 7),
        panel.grid.major = element_blank()) + coord_flip() +
  ggtitle("Top 50 họ có số người cao nhất")
#ggsave(filename = file.path("figures", "General", "top50_ho.png"), width = 7, height = 5)
```

```{r}
ggplot(data = data_ho_top100, aes(x = reorder(Ho, songuoi, decreasing=F), y =songuoi)) +
  geom_bar(stat = "identity", fill="red", width = 0.75) +
  #geom_text(aes(label = songuoi, y = songuoi + 50), size = 3) +
  scale_x_discrete(name = NULL) +
  #scale_y_continuous(name = NULL, breaks = seq(from = 0, to = 12000, by = 2000)) +
  theme_bw() +
  theme(axis.text.y = element_text(size = 7),
        panel.grid.major = element_blank()) + coord_flip() +
  ggtitle("Top 50-100 họ có số người cao nhất")
#ggsave(filename = file.path("figures", "General", "top100_ho.png"), width = 7, height = 5)
```

```{r}
ggplot(data = data_ho_top150, aes(x = reorder(Ho, songuoi, decreasing=F), y =songuoi)) +
  geom_bar(stat = "identity", fill="red", width = 0.75) +
  #geom_text(aes(label = songuoi, y = songuoi + 50), size = 3) +
  scale_x_discrete(name = NULL) +
  #scale_y_continuous(name = NULL, breaks = seq(from = 0, to = 12000, by = 2000)) +
  theme_bw() +
  theme(axis.text.y = element_text(size = 7),
        panel.grid.major = element_blank()) + coord_flip() +
  ggtitle("Top 100-150 họ có số người cao nhất")
#ggsave(filename = file.path("figures", "General", "top150_ho.png"), width = 7, height = 5)
```

```{r}
top1_100 <- data_ho_top200 %>% filter(rank %in% c(1:100)) %>%
  ggplot(aes(x = reorder(Ho, songuoi, decreasing=F), y =songuoi)) +
  geom_bar(stat = "identity", fill="red", width = 0.75) +
  #geom_text(aes(label = songuoi, y = songuoi + 50), size = 3) +
  scale_x_discrete(name = NULL) +
  scale_y_continuous(name = NULL, breaks = seq(from = 0, to = 30000000, by = 5000000)) +
  theme_bw() +
  theme(axis.text.y = element_text(size = 15),
        panel.grid.major = element_blank()) + coord_flip() +
  ggtitle("Top 100 họ có số người cao nhất") +
  facet_wrap(~group, scales = "free_y")
#ggsave(filename = file.path("figures", "General", "top100_ho.png"), width = 7, height = 5)
top1_100
```

```{r}
top101_200 <- data_ho_top200 %>% filter(rank %in% c(101:200)) %>%
  ggplot(aes(x = reorder(Ho, songuoi, decreasing=F), y =songuoi)) +
  geom_bar(stat = "identity", fill="red", width = 0.75) +
  #geom_text(aes(label = songuoi, y = songuoi + 50), size = 3) +
  scale_x_discrete(name = NULL) +
  scale_y_continuous(name = NULL, breaks = seq(from = 0, to = 30000000, by = 5000000)) +
  ylim(0, 30000000) +
  theme_bw() +
  theme(axis.text.y = element_text(size = 15),
        panel.grid.major = element_blank()) + coord_flip() +
  ggtitle("Top 101-200 họ có số người cao nhất") +
  facet_wrap(~group, scales = "free_y")
#ggsave(filename = file.path("figures", "General", "top101-200_ho.png"), width = 7, height = 5)
top101_200
```

## Tổng họ theo tỉnh

## Top Họ theo tỉnh

```{r}
phutho <- data_ho_tinh %>% filter(MATINH=="25") %>%
  arrange(desc(songuoi))
#write_xlsx(phutho, "output/Phu Tho.xlsx")

vinhphuc <- data_ho_tinh %>% filter(MATINH=="26") %>%
  arrange(desc(songuoi))
#write_xlsx(vinhphuc, "output/Vinh Phuc.xlsx")

sonla <- data_ho_tinh %>% filter(MATINH=="14") %>%
  arrange(desc(songuoi))
#write_xlsx(sonla, "output/Son La.xlsx")

hoabinh <- data_ho_tinh %>% filter(MATINH=="17") %>%
  arrange(desc(songuoi))
#write_xlsx(hoabinh, "output/Hoa Binh.xlsx")

thainguyen <- data_ho_tinh %>% filter(MATINH=="19") %>%
  arrange(desc(songuoi))
#write_xlsx(thainguyen, "output/Thai Nguyen.xlsx")

tuyenquang <- data_ho_tinh %>% filter(MATINH=="08") %>%
  arrange(desc(songuoi))
#write_xlsx(tuyenquang, "output/Tuyen Quang.xlsx")

hanam <- data_ho_tinh %>% filter(MATINH=="35") %>%
  arrange(desc(songuoi))
#write_xlsx(hanam, "output/Ha Nam.xlsx")

hungyen <- data_ho_tinh %>% filter(MATINH=="33") %>%
  arrange(desc(songuoi))
#write_xlsx(hungyen, "output/Hung Yen.xlsx")

haiduong <- data_ho_tinh %>% filter(MATINH=="30") %>%
  arrange(desc(songuoi))
#write_xlsx(haiduong, "Hai Duong.xlsx")

ninhbinh <- data_ho_tinh %>% filter(MATINH=="37") %>%
  arrange(desc(songuoi))
#write_xlsx(ninhbinh, "output/Ninh Binh.xlsx")

namdinh <- data_ho_tinh %>% filter(MATINH=="36") %>%
  arrange(desc(songuoi))
#write_xlsx(namdinh, "output/Nam Dinh.xlsx")

thanhhoa <- data_ho_tinh %>% filter(MATINH=="38") %>%
  arrange(desc(songuoi))
#write_xlsx(thanhhoa, "output/Thanh Hoa.xlsx")

nghean <- data_ho_tinh %>% filter(MATINH=="40") %>%
  arrange(desc(songuoi))
#write_xlsx(nghean, "output/Nghe An.xlsx")

hcm <- data_ho_tinh %>% filter(MATINH=="79") %>%
  arrange(desc(songuoi))
#write_xlsx(hcm, "output/HCM.xlsx")

hanoi <- data_ho_tinh %>% filter(MATINH=="01") %>%
  arrange(desc(songuoi))
#write_xlsx(hanoi, "output/Ha Noi.xlsx")

dongnai <- data_ho_tinh %>% filter(MATINH=="75") %>%
  arrange(desc(songuoi))
#write_xlsx(dongnai, "output/Dong Nai.xlsx")

binhduong <- data_ho_tinh %>% filter(MATINH=="74") %>%
  arrange(desc(songuoi))
#write_xlsx(binhduong, "output/Binh Duong.xlsx")
```

## Bản đồ Việt Nam

```{r, warning=FALSE, message=FALSE}
# libs <- c("maptools", "sp")
# lapply(libs, require, character.only = TRUE)
# 
# geo63 <- readRDS("geo63.rds")
# spplot(geo63, "ID_1", main="63 tỉnh")
```

```{r, message=FALSE, warning=FALSE}
## Get the Vietnam data - provincial level
vnm = raster::getData("GADM", country="Vietnam", level=1)
vnm2 = getData("GADM", country="Vietnam", level=2)
vnm3 = getData("GADM", country="Vietnam", level=3)

## Clean up data
vn = fortify(vnm, regions="VARNAME_1")
head(vn)
vn2 = fortify(vnm2, regions="VARNAME_2")
head(vn2)
vn3 = fortify(vnm3, regions="VARNAME_3")
head(vn3)
```

```{r}
ggplot(data=vn, aes(x=long, y=lat, group=group)) +
  geom_polygon(aes(fill=id), col="grey30", show.legend = F)
```

```{r}
vn_ho <- data_ho %>%
  mutate(id=case_when(MATINH=="01" ~ 24,
                      MATINH=="02" ~ 22,
                      MATINH=="04" ~ 14,
                      MATINH=="06" ~ 4,
                      MATINH=="08" ~ 60,
                      MATINH=="10" ~ 38,
                      MATINH=="11" ~ 18,
                      MATINH=="12" ~ 35,
                      MATINH=="14" ~ 52,
                      MATINH=="15" ~ 63,
                      MATINH=="17" ~ 30,
                      MATINH=="19" ~ 55,
                      MATINH=="20" ~ 37,
                      MATINH=="22" ~ 49,
                      MATINH=="24" ~ 3,
                      MATINH=="25" ~ 44,
                      MATINH=="26" ~ 62,
                      MATINH=="27" ~ 6,
                      MATINH=="30" ~ 26,
                      MATINH=="31" ~ 27,
                      MATINH=="33" ~ 31,
                      MATINH=="34" ~ 54,
                      MATINH=="35" ~ 23,
                      MATINH=="36" ~ 40,
                      MATINH=="37" ~ 42,
                      MATINH=="38" ~ 56,
                      MATINH=="40" ~ 41,
                      MATINH=="42" ~ 25,
                      MATINH=="44" ~ 46,
                      MATINH=="45" ~ 50,
                      MATINH=="46" ~ 57,
                      MATINH=="48" ~ 15,
                      MATINH=="49" ~ 47,
                      MATINH=="51" ~ 48,
                      MATINH=="52" ~ 8,
                      MATINH=="54" ~ 45,
                      MATINH=="56" ~ 32,
                      MATINH=="58" ~ 43,
                      MATINH=="60" ~ 11,
                      MATINH=="62" ~ 34,
                      MATINH=="64" ~ 21,
                      MATINH=="66" ~ 16,
                      MATINH=="67" ~ 17,
                      MATINH=="68" ~ 36,
                      MATINH=="70" ~ 10,
                      MATINH=="72" ~ 53,
                      MATINH=="77" ~ 2,
                      MATINH=="79" ~ 29,
                      MATINH=="80" ~ 39,
                      MATINH=="82" ~ 58,
                      MATINH=="83" ~ 7,
                      MATINH=="84" ~ 59,
                      MATINH=="86" ~ 61,
                      MATINH=="87" ~ 20,
                      MATINH=="89" ~ 1,
                      MATINH=="91" ~ 33,
                      MATINH=="92" ~ 13,
                      MATINH=="93" ~ 28,
                      MATINH=="94" ~ 51,
                      MATINH=="95" ~ 5,
                      MATINH=="96" ~ 12))

vn_ho_tinh <- data_ho_tinh %>%
  mutate(id=case_when(MATINH=="01" ~ 24,
                      MATINH=="02" ~ 22,
                      MATINH=="04" ~ 14,
                      MATINH=="06" ~ 4,
                      MATINH=="08" ~ 60,
                      MATINH=="10" ~ 38,
                      MATINH=="11" ~ 18,
                      MATINH=="12" ~ 35,
                      MATINH=="14" ~ 52,
                      MATINH=="15" ~ 63,
                      MATINH=="17" ~ 30,
                      MATINH=="19" ~ 55,
                      MATINH=="20" ~ 37,
                      MATINH=="22" ~ 49,
                      MATINH=="24" ~ 3,
                      MATINH=="25" ~ 44,
                      MATINH=="26" ~ 62,
                      MATINH=="27" ~ 6,
                      MATINH=="30" ~ 26,
                      MATINH=="31" ~ 27,
                      MATINH=="33" ~ 31,
                      MATINH=="34" ~ 54,
                      MATINH=="35" ~ 23,
                      MATINH=="36" ~ 40,
                      MATINH=="37" ~ 42,
                      MATINH=="38" ~ 56,
                      MATINH=="40" ~ 41,
                      MATINH=="42" ~ 25,
                      MATINH=="44" ~ 46,
                      MATINH=="45" ~ 50,
                      MATINH=="46" ~ 57,
                      MATINH=="48" ~ 15,
                      MATINH=="49" ~ 47,
                      MATINH=="51" ~ 48,
                      MATINH=="52" ~ 8,
                      MATINH=="54" ~ 45,
                      MATINH=="56" ~ 32,
                      MATINH=="58" ~ 43,
                      MATINH=="60" ~ 11,
                      MATINH=="62" ~ 34,
                      MATINH=="64" ~ 21,
                      MATINH=="66" ~ 16,
                      MATINH=="67" ~ 17,
                      MATINH=="68" ~ 36,
                      MATINH=="70" ~ 10,
                      MATINH=="72" ~ 53,
                      MATINH=="77" ~ 2,
                      MATINH=="79" ~ 29,
                      MATINH=="80" ~ 39,
                      MATINH=="82" ~ 58,
                      MATINH=="83" ~ 7,
                      MATINH=="84" ~ 59,
                      MATINH=="86" ~ 61,
                      MATINH=="87" ~ 20,
                      MATINH=="89" ~ 1,
                      MATINH=="91" ~ 33,
                      MATINH=="92" ~ 13,
                      MATINH=="93" ~ 28,
                      MATINH=="94" ~ 51,
                      MATINH=="95" ~ 5,
                      MATINH=="96" ~ 12)) %>% filter(MATINH!="" & Ho %in% data_ho_top10000$Ho)
```

```{r, message=FALSE, warning=FALSE}
#memory.limit(size=1000000)
ho_tinh = merge(vn, vn_ho_tinh, by="id")
nguyen <- ho_tinh %>% filter(Ho=="Nguyễn")
tran <- ho_tinh %>% filter(Ho=="Trần")
le <- ho_tinh %>% filter(Ho=="Lê")
du <- ho_tinh %>% filter(Ho=="Dư")
ly <- ho_tinh %>% filter(Ho=="Lý")
mac <- ho_tinh %>% filter(Ho=="Mạc")
phung <- ho_tinh %>% filter(Ho=="Phùng")
khuc <- ho_tinh %>% filter(Ho=="Khúc")
ngo <- ho_tinh %>% filter(Ho=="Ngô")
doan <- ho_tinh %>% filter(Ho=="Đoàn")
trieu <- ho_tinh %>% filter(Ho=="Triệu")
```

## Họ Nguyễn

```{r}
ggplot(data = nguyen, aes(x=long, y=lat, group=group)) +
  geom_polygon(aes(fill=songuoi), show.legend = T) +
  scale_fill_viridis(direction=-1, option = "viridis") +
  ggtitle("Họ Nguyễn")
#ggsave(filename = file.path("figures", "General", "Ho Nguyen.png"), width = 7, height = 5)
```
## Họ Trần

```{r}
ggplot(data = tran, aes(x=long, y=lat, group=group)) +
  geom_polygon(aes(fill=songuoi), show.legend = T) +
  scale_fill_viridis(direction=-1, option = "viridis") +
  ggtitle("Họ Trần")
#ggsave(filename = file.path("figures", "General", "Ho Tran.png"), width = 7, height = 5) 
```

## Họ Lê

```{r}
ggplot(data = le, aes(x=long, y=lat, group=group)) +
  geom_polygon(aes(fill=songuoi), show.legend = T) +
  scale_fill_viridis(direction=-1, option = "viridis") +
  ggtitle("Họ Lê")
#ggsave(filename = file.path("figures", "General", "Ho Le.png"), width = 7, height = 5)
```
## Họ Dư

```{r}
ggplot(data = du, aes(x=long, y=lat, group=group)) +
  geom_polygon(aes(fill=songuoi), show.legend = T) +
  scale_fill_viridis(direction=-1, option = "viridis") +
  ggtitle("Họ Dư")
#ggsave(filename = file.path("figures", "General", "Ho Du.png"), width = 7, height = 5)
```

## Họ Lý

```{r}
ggplot(data = ly, aes(x=long, y=lat, group=group)) +
  geom_polygon(aes(fill=songuoi), show.legend = T) +
  scale_fill_viridis(direction=-1, option = "viridis") +
  ggtitle("Họ Lý")
#ggsave(filename = file.path("figures", "General", "Ho Ly.png"), width = 7, height = 5)
```

## Họ Mạc

```{r}
ggplot(data = mac, aes(x=long, y=lat, group=group)) +
  geom_polygon(aes(fill=songuoi), show.legend = T) +
  scale_fill_viridis(direction=-1, option = "viridis") +
  ggtitle("Họ Mạc")
#ggsave(filename = file.path("figures", "General", "Ho Mac.png"), width = 7, height = 5)
```

## Họ Phùng

```{r}
ggplot(data = phung, aes(x=long, y=lat, group=group)) +
  geom_polygon(aes(fill=songuoi), show.legend = T) +
  scale_fill_viridis(direction=-1, option = "viridis") +
  ggtitle("Họ Phùng")
#ggsave(filename = file.path("figures", "General", "Ho Phung.png"), width = 7, height = 5)
```
## Họ Khúc

```{r}
ggplot(data = khuc, aes(x=long, y=lat, group=group)) +
  geom_polygon(aes(fill=songuoi), show.legend = T) +
  scale_fill_viridis(direction=-1, option = "viridis") +
  ggtitle("Họ Khúc")
#ggsave(filename = file.path("figures", "General", "Ho Khuc.png"), width = 7, height = 5)
```
## Họ Ngô

```{r}
ggplot(data = ngo, aes(x=long, y=lat, group=group)) +
  geom_polygon(aes(fill=songuoi), show.legend = T) +
  scale_fill_viridis(direction=-1, option = "viridis") +
  ggtitle("Họ Ngô")
#ggsave(filename = file.path("figures", "General", "Ho Ngo.png"), width = 7, height = 5)
```
## Họ Đoàn

```{r}
ggplot(data = doan, aes(x=long, y=lat, group=group)) +
  geom_polygon(aes(fill=songuoi), show.legend = T) +
  scale_fill_viridis(direction=-1, option = "viridis") +
  ggtitle("Họ Đoàn")
#ggsave(filename = file.path("figures", "General", "Ho Doan.png"), width = 7, height = 5)
```
## Họ Triệu

```{r}
ggplot(data = trieu, aes(x=long, y=lat, group=group)) +
  geom_polygon(aes(fill=songuoi), show.legend = T) +
  scale_fill_viridis(direction=-1, option = "viridis") +
  ggtitle("Họ Triệu")
#ggsave(filename = file.path("figures", "General", "Ho Trieu.png"), width = 7, height = 5)
```
## Tổng dân số

```{r}
data_pop <- pop_all %>%
  group_by(province) %>%
  summarise(danso=sum(n_all_total))

data_pop2 <- pop_all %>%
  group_by(province2) %>%
  summarise(danso=sum(n_all_total)) %>% select(-danso)

nametinh <- vnm$VARNAME_1
data_pop <- cbind(data_pop, data_pop2) %>%
  mutate(id=order(nametinh))

ho_tinh_pop = merge(ho_tinh, data_pop, by="id")
# ho_tinh_pop <- ho_tinh_pop %>%
#   mutate(nguoi_pop=songuoi/danso)

namexa <- vnm3$VARNAME_3
```

## Tỉ lệ họ trên dân số

```{r, message=FALSE, warning=FALSE}
nguyen_pop <- ho_tinh_pop %>% filter(Ho=="Nguyễn") %>% unique()
tran_pop <- ho_tinh_pop %>% filter(Ho=="Trần")
le_pop <- ho_tinh_pop %>% filter(Ho=="Lê")
du_pop <- ho_tinh_pop %>% filter(Ho=="Dư")
ly_pop <- ho_tinh_pop %>% filter(Ho=="Lý")
mac_pop <- ho_tinh_pop %>% filter(Ho=="Mạc")
phung_pop <- ho_tinh_pop %>% filter(Ho=="Phùng")
khuc_pop <- ho_tinh_pop %>% filter(Ho=="Khúc")
ngo_pop <- ho_tinh_pop %>% filter(Ho=="Ngô")
doan_pop <- ho_tinh_pop %>% filter(Ho=="Đoàn")
trieu_pop <- ho_tinh_pop %>% filter(Ho=="Triệu")
```

# Bản đồ tỉ lệ % họ tính đến xã

```{r}
## merge TENTINH, TENHUYEN, TENXA
tinh = merge(data_ho_xa, data_tinh %>% select(MATINH, TENTINH), by="MATINH")
huyen = merge(tinh, data_huyen %>% select(MAHUYEN, TENHUYEN), by="MAHUYEN")
xa = merge(huyen, data_xa %>% select(MAXA, TENXA), by="MAXA")

##remove common prefix
xa$TENTINH <- gsub("Thành phố", "", xa$TENTINH)
xa$TENTINH <- gsub("Tỉnh", "", xa$TENTINH)

xa$TENHUYEN <- gsub("Huyện", "", xa$TENHUYEN)
xa$TENHUYEN <- gsub("Quận", "", xa$TENHUYEN)
xa$TENHUYEN <- gsub("Thành phố", "", xa$TENHUYEN)
xa$TENHUYEN <- gsub("Thành Phố", "", xa$TENHUYEN)
xa$TENHUYEN <- gsub("Thị xã", "", xa$TENHUYEN)
xa$TENHUYEN <- gsub("Thị Xã", "", xa$TENHUYEN)

#xa$TENXA <- gsub("Phường", "", xa$TENXA)
#xa$TENXA <- gsub("Xã", "", xa$TENXA)
#xa$TENXA <- gsub("Thị trấn", "", xa$TENXA)
#xa$TENXA <- gsub("Huyện", "", xa$TENXA)

#xa$TENXA <- stri_trans_general(xa$TENXA, "Latin-ASCII")

#nametinh <- vnm3$NAME_1
#nametinh <- stri_trans_general(nametinh, "Latin-ASCII")
#namehuyen <- vnm3$NAME_2
#namehuyen <- stri_trans_general(namehuyen, "Latin-ASCII")
#namexa <- vnm3$NAME_3
#namexa <- stri_trans_general(namexa, "Latin-ASCII")

xa2 <- xa %>% rename(NAME_1=TENTINH, NAME_2=TENHUYEN, NAME_3=TENXA)
gadm36_VNM3_sf <- readRDS("data/gadm36_VNM_3_sf.rds")

## Merge all data

xa2$NAME_1 <- stri_trans_general(xa2$NAME_1, "Latin-ASCII")
xa2$NAME_2 <- stri_trans_general(xa2$NAME_2, "Latin-ASCII")
xa2$NAME_3 <- stri_trans_general(xa2$NAME_3, "Latin-ASCII")
xa2$NAME_1 <- trimws(gsub("\\s+", " ", xa2$NAME_1))
xa2$NAME_2 <- trimws(gsub("\\s+", " ", xa2$NAME_2))
xa2$NAME_3 <- trimws(gsub("\\s+", " ", xa2$NAME_3))

gadm_sf <- gadm36_VNM3_sf[,c("NAME_1", "NAME_2", "NAME_3", "TYPE_3", "geometry")]
gadm_sf <- data.frame(gadm_sf)

gadm_sf$NAME_3 <- paste(gadm_sf$TYPE_3, gadm_sf$NAME_3)
gadm_sf$NAME_1 <- trimws(gsub("\\s+", " ", gadm_sf$NAME_1))
gadm_sf$NAME_2 <- trimws(gsub("\\s+", " ", gadm_sf$NAME_2))
gadm_sf$NAME_3 <- trimws(gsub("\\s+", " ", gadm_sf$NAME_3))
gadm_sf$NAME_1 <- stri_trans_general(gadm_sf$NAME_1, "Latin-ASCII")
gadm_sf$NAME_2 <- stri_trans_general(gadm_sf$NAME_2, "Latin-ASCII")
gadm_sf$NAME_3 <- stri_trans_general(gadm_sf$NAME_3, "Latin-ASCII")

library(sf)
xa2 <- xa2 %>% distinct(., NAME_1, NAME_2, NAME_3, Ho, .keep_all = T)
gadm_sf <- gadm_sf %>% distinct(., NAME_1, NAME_2, NAME_3, .keep_all = T)

dat_sf <- merge(xa2, gadm_sf, by=c("NAME_1", "NAME_2", "NAME_3"))

table(xa2$NAME_1 %in% gadm_sf$NAME_1)
head(xa2$NAME_1)
```
## Họ Nguyễn

```{r}
library(sf)
nguyen_sf <- dat_sf %>% mutate(prop.nguyen=(sum(subset(., Ho=="Nguyễn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Nguyễn")
nguyen_plot <- nguyen_sf %>% select(pro.pop, prop.nguyen, geometry) %>% st_as_sf(crs = 4326)
#colnames(nguyen_plot) <- c("Tỉ lệ % họ trên tổng dân số", "geometry")
#plot(nguyen_plot)
ggplot() + geom_sf() + geom_sf(data=nguyen_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(nguyen_plot$prop.nguyen[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Nguyễn")
#ggsave(filename = file.path("Ho Nguyen-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Nguyen-PerPop.jpeg"), width = 49, height = 33)
```

## Họ Trần

```{r}
tran_sf <- dat_sf %>% mutate(prop.tran=(sum(subset(., Ho=="Trần")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trần")
tran_plot <- tran_sf %>% select(pro.pop, prop.tran, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=tran_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(tran_plot$prop.tran[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Trần")
#ggsave(filename = file.path("Ho Tran-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Tran-PerPop.jpeg"), width = 49, height = 33)
```

## Họ Lã

```{r}
la_sf <- dat_sf %>% mutate(prop.la=(sum(subset(., Ho=="Lã")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lã")
la_plot <- la_sf %>% select(pro.pop, prop.la, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=la_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(la_plot$prop.la[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Lã")
#ggsave(filename = file.path("Ho La-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho La-PerPop.jpeg"), width = 49, height = 33)
```

## Họ Lê

```{r}
le_sf <- dat_sf %>% mutate(prop.le=(sum(subset(., Ho=="Lê")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lê")
le_plot <- le_sf %>% select(pro.pop, prop.le, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=le_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(le_plot$prop.le[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Lê")
#ggsave(filename = file.path("Ho Le-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Le-PerPop.jpeg"), width = 49, height = 33)
```

## Họ Dư

```{r}
du_sf <- dat_sf %>% mutate(prop.du=(sum(subset(., Ho=="Dư")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Dư")
du_plot <- du_sf %>% select(pro.pop, prop.du, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=du_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(du_plot$prop.du[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Dư")
#ggsave(filename = file.path("Ho Du-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Du-PerPop.jpeg"), width = 49, height = 33)
```
## Họ Dương

```{r}
duong_sf <- dat_sf %>% mutate(prop.duong=(sum(subset(., Ho=="Dương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Dương")
duong_plot <- duong_sf %>% select(pro.pop, prop.duong, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=duong_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(duong_plot$prop.duong[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Dương")
#ggsave(filename = file.path("Ho Duong-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Duong-PerPop.jpeg"), width = 49, height = 33)
```

## Họ Lý

```{r}
ly_sf <- dat_sf %>% mutate(prop.ly=(sum(subset(., Ho=="Lý")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lý")
ly_plot <- ly_sf %>% select(pro.pop, prop.ly, geometry) %>% st_as_sf(crs = 4326)
#colnames(ly_plot) <- c("Tỉ lệ % họ trên tổng dân số", "geometry")
ggplot() + geom_sf() + geom_sf(data=ly_plot, aes(fill=pro.pop), lwd=0) +
  #geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(ly_plot$prop.ly[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Lý")
#ggsave(filename = file.path("Ho Ly-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Ly-PerPop.jpeg"), width = 49, height = 33)
```
## Họ Đoàn

```{r}
doan_sf <- dat_sf %>% mutate(prop.doan=(sum(subset(., Ho=="Đoàn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đoàn")
doan_plot <- doan_sf %>% select(pro.pop, prop.doan, geometry) %>% st_as_sf(crs = 4326)
#colnames(doan_plot) <- c("Tỉ lệ % họ trên tổng dân số", "geometry")
ggplot() + geom_sf(data=doan_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(doan_plot$prop.doan[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Đoàn")
#ggsave(filename = file.path("Ho Doan-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Doan-PerPop.jpeg"), width = 49, height = 33)
```

## Họ Ngô

```{r}
ngo_sf <- dat_sf %>% mutate(prop.ngo=(sum(subset(., Ho=="Ngô")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ngô")
ngo_plot <- ngo_sf %>% select(pro.pop, prop.ngo, geometry) %>% st_as_sf(crs = 4326)
#colnames(doan_plot) <- c("Tỉ lệ % họ trên tổng dân số", "geometry")
ggplot() + geom_sf(data=ngo_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(ngo_plot$prop.ngo[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Ngô")
#ggsave(filename = file.path("Ho Ngo-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Ngo-PerPop.jpeg"), width = 49, height = 33)
```
## Họ Triệu

```{r}
trieu_sf <- dat_sf %>% mutate(prop.trieu=(sum(subset(., Ho=="Triệu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Triệu")
trieu_plot <- trieu_sf %>% select(pro.pop, prop.trieu, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=trieu_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(trieu_plot$prop.trieu[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Triệu")
#ggsave(filename = file.path("Ho Trieu-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Trieu-PerPop.jpeg"), width = 49, height = 33)
```

## Họ Mã

```{r}
ma_sf <- dat_sf %>% mutate(prop.ma=(sum(subset(., Ho=="Mã")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mã")
ma_plot <- ma_sf %>% select(pro.pop, prop.ma, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=ma_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(ma_plot$prop.ma[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Mã")
#ggsave(filename = file.path("Ho Ma-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Ma-PerPop.jpeg"), width = 49, height = 33)
```

## Họ Mạc

```{r}
mac_sf <- dat_sf %>% mutate(prop.mac=(sum(subset(., Ho=="Mạc")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mạc")
mac_plot <- mac_sf %>% select(pro.pop, prop.mac, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=mac_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(mac_plot$prop.mac[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Mạc")
#ggsave(filename = file.path("Ho Mac-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Mac-PerPop.jpeg"), width = 49, height = 33)
```
## Họ Mai

```{r}
mai_sf <- dat_sf %>% mutate(prop.mai=(sum(subset(., Ho=="Mai")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mai")
mai_plot <- mai_sf %>% select(pro.pop, prop.mai, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=mai_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(mai_plot$prop.mai[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Mai")
#ggsave(filename = file.path("Ho Mai-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Mai-PerPop.jpeg"), width = 49, height = 33)
```

## Họ Phùng

```{r}
phung_sf <- dat_sf %>% mutate(prop.phung=(sum(subset(., Ho=="Phùng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phùng")
phung_plot <- phung_sf %>% select(pro.pop, prop.phung, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=phung_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(phung_plot$prop.phung[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Phùng")
#ggsave(filename = file.path("Ho Phung-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Phung-PerPop.jpeg"), width = 49, height = 33)
```
## Họ Khúc

```{r}
khuc_sf <- dat_sf %>% mutate(prop.khuc=(sum(subset(., Ho=="Khúc")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Khúc")
khuc_plot <- khuc_sf %>% select(pro.pop, prop.khuc, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=khuc_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(khuc_plot$prop.khuc[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Khúc")
#ggsave(filename = file.path("Ho Khuc-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Khuc-PerPop.jpeg"), width = 49, height = 33)
```
## Họ Phạm

```{r}
pham_sf <- dat_sf %>% mutate(prop.pham=(sum(subset(., Ho=="Phạm")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phạm")
pham_plot <- pham_sf %>% select(pro.pop, prop.pham, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=pham_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(pham_plot$prop.pham[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Phạm")
#ggsave(filename = file.path("Ho Pham-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Pham-PerPop.jpeg"), width = 49, height = 33)
```

## Họ Hồ

```{r}
ho_sf <- dat_sf %>% mutate(prop.ho=(sum(subset(., Ho=="Hồ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hồ")
ho_plot <- ho_sf %>% select(pro.pop, prop.ho, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=ho_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(ho_plot$prop.ho[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Hồ")
#ggsave(filename = file.path("Ho Ho-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Ho-PerPop.jpeg"), width = 49, height = 33)
```

## Họ Tôn

```{r}
ton_sf <- dat_sf %>% mutate(prop.ton=(sum(subset(., Ho=="Tôn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Tôn")
ton_plot <- ton_sf %>% select(pro.pop, prop.ton, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=ton_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(ton_plot$prop.ton[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Tôn")
#ggsave(filename = file.path("Ho Ton-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Ton-PerPop.jpeg"), width = 49, height = 33)
```
## Họ Bùi

```{r}
bui_sf <- dat_sf %>% mutate(prop.bui=(sum(subset(., Ho=="Bùi")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Bùi")
bui_plot <- bui_sf %>% select(pro.pop, prop.bui, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=bui_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(bui_plot$prop.bui[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Bùi")
#ggsave(filename = file.path("Ho Bui-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Bui-PerPop.jpeg"), width = 49, height = 33)
```
## Họ Đào

```{r}
dao_sf <- dat_sf %>% mutate(prop.dao=(sum(subset(., Ho=="Đào")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đào")
dao_plot <- dao_sf %>% select(pro.pop, prop.dao, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=dao_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(dao_plot$prop.dao[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Đào")
#ggsave(filename = file.path("Ho Dao-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Dao-PerPop.jpeg"), width = 49, height = 33)
```

## Họ Đinh

```{r}
dinh_sf <- dat_sf %>% mutate(prop.dinh=(sum(subset(., Ho=="Đinh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đinh")
dinh_plot <- dinh_sf %>% select(pro.pop, prop.dinh, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=dinh_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(dinh_plot$prop.dinh[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Đinh")
#ggsave(filename = file.path("Ho Dinh-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Dinh-PerPop.jpeg"), width = 49, height = 33)
```
## Họ Đỗ

```{r}
do_sf <- dat_sf %>% mutate(prop.do=(sum(subset(., Ho=="Đỗ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đỗ")
do_plot <- do_sf %>% select(pro.pop, prop.do, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=do_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(do_plot$prop.do[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Đỗ")
#ggsave(filename = file.path("Ho Do-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Do-PerPop.jpeg"), width = 49, height = 33)
```
## Họ Hoàng

```{r}
hoang_sf <- dat_sf %>% mutate(prop.hoang=(sum(subset(., Ho=="Hoàng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hoàng")
hoang_plot <- hoang_sf %>% select(pro.pop, prop.hoang, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=hoang_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(hoang_plot$prop.hoang[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Hoàng")
#ggsave(filename = file.path("Ho Hoang-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Hoang-PerPop.jpeg"), width = 49, height = 33)
```
## Họ Huỳnh

```{r}
huynh_sf <- dat_sf %>% mutate(prop.huynh=(sum(subset(., Ho=="Huỳnh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Huỳnh")
huynh_plot <- huynh_sf %>% select(pro.pop, prop.huynh, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=huynh_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(huynh_plot$prop.huynh[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Huỳnh")
#ggsave(filename = file.path("Ho Huynh-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Huynh-PerPop.jpeg"), width = 49, height = 33)
```

## Họ Phan

```{r}
phan_sf <- dat_sf %>% mutate(prop.phan=(sum(subset(., Ho=="Phan")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phan")
phan_plot <- phan_sf %>% select(pro.pop, prop.phan, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=phan_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(phan_plot$prop.phan[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Phan")
#ggsave(filename = file.path("Ho Phan-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Phan-PerPop.jpeg"), width = 49, height = 33)
```

## Họ Quách

```{r}
quach_sf <- dat_sf %>% mutate(prop.quach=(sum(subset(., Ho=="Quách")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Quách")
quach_plot <- quach_sf %>% select(pro.pop, prop.quach, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=quach_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(quach_plot$prop.quach[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Quách")
#ggsave(filename = file.path("Ho Quach-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Quach-PerPop.jpeg"), width = 49, height = 33)
```

## Họ Trịnh

```{r}
trinh_sf <- dat_sf %>% mutate(prop.trinh=(sum(subset(., Ho=="Trịnh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trịnh")
trinh_plot <- trinh_sf %>% select(pro.pop, prop.trinh, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=trinh_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(trinh_plot$prop.trinh[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Trịnh")
#ggsave(filename = file.path("Ho Trinh-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Trinh-PerPop.jpeg"), width = 49, height = 33)
```

## Họ Trương

```{r}
truong_sf <- dat_sf %>% mutate(prop.truong=(sum(subset(., Ho=="Trương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trương")
truong_plot <- truong_sf %>% select(pro.pop, prop.truong, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=truong_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(truong_plot$prop.truong[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Trương")
#ggsave(filename = file.path("Ho Truong-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Truong-PerPop.jpeg"), width = 49, height = 33)
```

## Họ Vũ

```{r}
vu_sf <- dat_sf %>% mutate(prop.vu=(sum(subset(., Ho=="Vũ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Vũ")
vu_plot <- vu_sf %>% select(pro.pop, prop.vu, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=vu_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(vu_plot$prop.vu[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Vũ")
#ggsave(filename = file.path("Ho Vu-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Vu-PerPop.jpeg"), width = 49, height = 33)
```
## Họ Võ

```{r}
vo_sf <- dat_sf %>% mutate(prop.vo=(sum(subset(., Ho=="Võ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Võ")
vo_plot <- vo_sf %>% select(pro.pop, prop.vo, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=vo_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(vo_plot$prop.vo[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Võ")
#ggsave(filename = file.path("Ho Vo-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Vo-PerPop.jpeg"), width = 49, height = 33)
```

# Bản đồ mật độ họ trên diện tích tính đến xã

```{r}
# Add contour
#library(htmlwidgets) 
#library(tmap)
#tm_shape(ly_plot) +
#  tm_grid(col ="lightgray", line = TRUE) +
#  tm_iso(col = "blue", text = "DEPTH",  fontface = "bold") +
#  tm_layout(frame = TRUE, inner.margins = 0) 
## AREA
```

```{r}
library(sf)
f <- st_read("data/gadm36_VNM_3.shp")
f$area <- st_area(f) #Take care of units

dat_f <- f[,c("NAME_1", "NAME_2", "NAME_3", "TYPE_3", "area")]
dat_f <- data.frame(dat_f)

dat_f$NAME_3 <- paste(dat_f$TYPE_3, dat_f$NAME_3)
dat_f$NAME_1 <- trimws(gsub("\\s+", " ", dat_f$NAME_1))
dat_f$NAME_2 <- trimws(gsub("\\s+", " ", dat_f$NAME_2))
dat_f$NAME_3 <- trimws(gsub("\\s+", " ", dat_f$NAME_3))
dat_f$NAME_1 <- stri_trans_general(dat_f$NAME_1, "Latin-ASCII")
dat_f$NAME_2 <- stri_trans_general(dat_f$NAME_2, "Latin-ASCII")
dat_f$NAME_3 <- stri_trans_general(dat_f$NAME_3, "Latin-ASCII")

dat_f <- dat_f %>% distinct(., NAME_1, NAME_2, NAME_3, .keep_all = T)

dat_sff <- merge(xa2, dat_f, by=c("NAME_1", "NAME_2", "NAME_3")) %>%
  mutate(area_km=area/1000000,
         songuoi_km=songuoi/area_km,
         songuoi_km=as.numeric(songuoi_km),
         pro.pop_km=pro.pop/area_km,
         pro.pop_km=as.numeric(pro.pop_km))
head(dat_sff)

table(xa2$NAME_1 %in% dat_f$NAME_1)
head(xa2$NAME_1)
head(dat_f$NAME_1)
```

## Họ Nguyễn

```{r}
library(sf)
nguyen_sff <- dat_sff %>% mutate(prop.nguyen=(sum(subset(., Ho=="Nguyễn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Nguyễn")
nguyen_plotf <- nguyen_sff %>% select(songuoi_km, prop.nguyen, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=nguyen_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(nguyen_plotf$prop.nguyen[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Nguyễn")
#ggsave(filename = file.path("Ho Nguyen-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Nguyen-PerArea.jpeg"), width = 49, height = 33)
```

## Họ Trần

```{r}
tran_sff <- dat_sff %>% mutate(prop.tran=(sum(subset(., Ho=="Trần")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trần")
tran_plotf <- tran_sff %>% select(songuoi_km, prop.tran, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=tran_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(tran_plot$prop.tran[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Trần")
#ggsave(filename = file.path("Ho Tran-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Tran-PerArea.jpeg"), width = 49, height = 33)
```

## Họ Lã

```{r}
la_sff <- dat_sff %>% mutate(prop.la=(sum(subset(., Ho=="Lã")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lã")
la_plotf <- la_sff %>% select(songuoi_km, prop.la, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=la_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(la_plot$prop.la[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Lã")
#ggsave(filename = file.path("Ho La-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho La-PerArea.jpeg"), width = 49, height = 33)
```

## Họ Lê

```{r}
le_sff <- dat_sff %>% mutate(prop.le=(sum(subset(., Ho=="Lê")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lê")
le_plotf <- le_sff %>% select(songuoi_km, prop.le, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=le_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(le_plot$prop.le[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Lê")
#ggsave(filename = file.path("Ho Le-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Le-PerArea.jpeg"), width = 49, height = 33)
```

## Họ Dư

```{r}
du_sff <- dat_sff %>% mutate(prop.du=(sum(subset(., Ho=="Dư")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Dư")
du_plotf <- du_sff %>% select(songuoi_km, prop.du, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=du_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(du_plot$prop.du[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Dư")
#ggsave(filename = file.path("Ho Du-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Du-PerArea.jpeg"), width = 49, height = 33)
```
## Họ Dương

```{r}
duong_sff <- dat_sff %>% mutate(prop.duong=(sum(subset(., Ho=="Dương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Dương")
duong_plotf <- duong_sff %>% select(songuoi_km, prop.duong, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=duong_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(duong_plot$prop.duong[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Dương")
#ggsave(filename = file.path("Ho Duong-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Duong-PerArea.jpeg"), width = 49, height = 33)
```

## Họ Lý

```{r}
ly_sff <- dat_sff %>% mutate(prop.ly=(sum(subset(., Ho=="Lý")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lý")
ly_plotf <- ly_sff %>% select(songuoi_km, prop.ly, geometry) %>% st_as_sf(crs = 4326)
#colnames(ly_plot) <- c("Tỉ lệ % họ trên tổng dân số", "geometry")
ggplot() + geom_sf() + geom_sf(data=ly_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(ly_plot$prop.ly[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Lý")
#ggsave(filename = file.path("Ho Ly-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Ly-PerArea.jpeg"), width = 49, height = 33)
```
## Họ Đoàn

```{r}
doan_sff <- dat_sff %>% mutate(prop.doan=(sum(subset(., Ho=="Đoàn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đoàn")
doan_plotf <- doan_sff %>% select(songuoi_km, prop.doan, geometry) %>% st_as_sf(crs = 4326)
#colnames(doan_plot) <- c("Tỉ lệ % họ trên tổng dân số", "geometry")
ggplot() + geom_sf(data=doan_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(doan_plot$prop.doan[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Đoàn")
#ggsave(filename = file.path("Ho Doan-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Doan-PerArea.jpeg"), width = 49, height = 33)
```

## Họ Ngô

```{r}
ngo_sff <- dat_sff %>% mutate(prop.ngo=(sum(subset(., Ho=="Ngô")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ngô")
ngo_plotf <- ngo_sff %>% select(songuoi_km, prop.ngo, geometry) %>% st_as_sf(crs = 4326)
#colnames(doan_plot) <- c("Tỉ lệ % họ trên tổng dân số", "geometry")
ggplot() + geom_sf(data=ngo_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(ngo_plot$prop.ngo[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Ngô")
#ggsave(filename = file.path("Ho Ngo-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Ngo-PerArea.jpeg"), width = 49, height = 33)
```
## Họ Triệu

```{r}
trieu_sff <- dat_sff %>% mutate(prop.trieu=(sum(subset(., Ho=="Triệu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Triệu")
trieu_plotf <- trieu_sff %>% select(songuoi_km, prop.trieu, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=trieu_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(trieu_plot$prop.trieu[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Triệu")
#ggsave(filename = file.path("Ho Trieu-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Trieu-PerArea.jpeg"), width = 49, height = 33)
```

## Họ Mã

```{r}
ma_sff <- dat_sff %>% mutate(prop.ma=(sum(subset(., Ho=="Mã")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mã")
ma_plotf <- ma_sff %>% select(songuoi_km, prop.ma, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=ma_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(ma_plot$prop.ma[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Mã")
#ggsave(filename = file.path("Ho Ma-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Ma-PerArea.jpeg"), width = 49, height = 33)
```

## Họ Mạc

```{r}
mac_sff <- dat_sff %>% mutate(prop.mac=(sum(subset(., Ho=="Mạc")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mạc")
mac_plotf <- mac_sff %>% select(songuoi_km, prop.mac, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=mac_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(mac_plot$prop.mac[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Mạc")
#ggsave(filename = file.path("Ho Mac-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Mac-PerArea.jpeg"), width = 49, height = 33)
```

## Họ Mai

```{r}
mai_sff <- dat_sff %>% mutate(prop.mai=(sum(subset(., Ho=="Mai")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mai")
mai_plotf <- mai_sff %>% select(songuoi_km, prop.mai, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=mai_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(mai_plot$prop.mai[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Mai")
#ggsave(filename = file.path("Ho Mai-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Mai-PerArea.jpeg"), width = 49, height = 33)
```

## Họ Phùng

```{r}
phung_sff <- dat_sff %>% mutate(prop.phung=(sum(subset(., Ho=="Phùng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phùng")
phung_plotf <- phung_sff %>% select(songuoi_km, prop.phung, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=phung_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(phung_plot$prop.phung[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Phùng")
#ggsave(filename = file.path("Ho Phung-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Phung-PerArea.jpeg"), width = 49, height = 33)
```
## Họ Khúc

```{r}
khuc_sff <- dat_sff %>% mutate(prop.khuc=(sum(subset(., Ho=="Khúc")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Khúc")
khuc_plotf <- khuc_sff %>% select(songuoi_km, prop.khuc, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=khuc_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(khuc_plot$prop.khuc[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Khúc")
#ggsave(filename = file.path("Ho Khuc-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Khuc-PerArea.jpeg"), width = 49, height = 33)
```
## Họ Phạm

```{r}
pham_sff <- dat_sff %>% mutate(prop.pham=(sum(subset(., Ho=="Phạm")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phạm")
pham_plotf <- pham_sff %>% select(songuoi_km, prop.pham, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=pham_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(pham_plot$prop.pham[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Phạm")
#ggsave(filename = file.path("Ho Pham-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Pham-PerArea.jpeg"), width = 49, height = 33)
```

## Họ Hồ

```{r}
ho_sff <- dat_sff %>% mutate(prop.ho=(sum(subset(., Ho=="Hồ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hồ")
ho_plotf <- ho_sff %>% select(songuoi_km, prop.ho, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=ho_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(ho_plotf$prop.ho[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Hồ")
#ggsave(filename = file.path("Ho Ho-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Ho-PerArea.jpeg"), width = 49, height = 33)
```

## Họ Tôn

```{r}
ton_sff <- dat_sff %>% mutate(prop.ton=(sum(subset(., Ho=="Tôn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Tôn")
ton_plotf <- ton_sff %>% select(songuoi_km, prop.ton, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=ton_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(ton_plotf$prop.ton[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Tôn")
#ggsave(filename = file.path("Ho Ton-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Ton-PerArea.jpeg"), width = 49, height = 33)
```

## Họ Bùi

```{r}
bui_sff <- dat_sff %>% mutate(prop.bui=(sum(subset(., Ho=="Bùi")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Bùi")
bui_plotf <- bui_sff %>% select(songuoi_km, prop.bui, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=bui_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(bui_plotf$prop.bui[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Bùi")
#ggsave(filename = file.path("Ho Bui-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Bui-PerArea.jpeg"), width = 49, height = 33)
```
## Họ Đào

```{r}
dao_sff <- dat_sff %>% mutate(prop.dao=(sum(subset(., Ho=="Đào")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đào")
dao_plotf <- dao_sff %>% select(songuoi_km, prop.dao, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=dao_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(dao_plotf$prop.dao[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Đào")
#ggsave(filename = file.path("Ho Dao-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Dao-PerArea.jpeg"), width = 49, height = 33)
```

## Họ Đinh

```{r}
dinh_sff <- dat_sff %>% mutate(prop.dinh=(sum(subset(., Ho=="Đinh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đinh")
dinh_plotf <- dinh_sff %>% select(songuoi_km, prop.dinh, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=dinh_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(dinh_plotf$prop.dinh[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Đinh")
#ggsave(filename = file.path("Ho Dinh-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Dinh-PerArea.jpeg"), width = 49, height = 33)
```
## Họ Đỗ

```{r}
do_sff <- dat_sff %>% mutate(prop.do=(sum(subset(., Ho=="Đỗ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đỗ")
do_plotf <- do_sff %>% select(songuoi_km, prop.do, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=do_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(do_plotf$prop.do[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Đỗ")
#ggsave(filename = file.path("Ho Do-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Do-PerArea.jpeg"), width = 49, height = 33)
```
## Họ Hoàng

```{r}
hoang_sff <- dat_sff %>% mutate(prop.hoang=(sum(subset(., Ho=="Hoàng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hoàng")
hoang_plotf <- hoang_sff %>% select(songuoi_km, prop.hoang, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=hoang_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(hoang_plotf$prop.hoang[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Hoàng")
#ggsave(filename = file.path("Ho Hoang-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Hoang-PerArea.jpeg"), width = 49, height = 33)
```
## Họ Huỳnh

```{r}
huynh_sff <- dat_sff %>% mutate(prop.huynh=(sum(subset(., Ho=="Huỳnh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Huỳnh")
huynh_plotf <- huynh_sff %>% select(songuoi_km, prop.huynh, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=huynh_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(huynh_plotf$prop.huynh[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Huỳnh")
#ggsave(filename = file.path("Ho Huynh-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Huynh-PerArea.jpeg"), width = 49, height = 33)
```
## Họ Phan

```{r}
phan_sff <- dat_sff %>% mutate(prop.phan=(sum(subset(., Ho=="Phan")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phan")
phan_plotf <- phan_sff %>% select(songuoi_km, prop.phan, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=phan_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(phan_plotf$prop.phan[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Phan")
#ggsave(filename = file.path("Ho Phan-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Phan-PerArea.jpeg"), width = 49, height = 33)
```

## Họ Quách

```{r}
quach_sff <- dat_sff %>% mutate(prop.quach=(sum(subset(., Ho=="Quách")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Quách")
quach_plotf <- quach_sff %>% select(songuoi_km, prop.quach, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=quach_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(quach_plotf$prop.quach[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Quách")
#ggsave(filename = file.path("Ho Quach-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Quach-PerArea.jpeg"), width = 49, height = 33)
```

## Họ Trịnh

```{r}
trinh_sff <- dat_sff %>% mutate(prop.trinh=(sum(subset(., Ho=="Trịnh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trịnh")
trinh_plotf <- trinh_sff %>% select(songuoi_km, prop.trinh, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=trinh_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(trinh_plotf$prop.trinh[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Trịnh")
#ggsave(filename = file.path("Ho Trinh-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Trinh-PerArea.jpeg"), width = 49, height = 33)
```
## Họ Trương

```{r}
truong_sff <- dat_sff %>% mutate(prop.truong=(sum(subset(., Ho=="Trương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trương")
truong_plotf <- truong_sff %>% select(songuoi_km, prop.truong, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=truong_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(truong_plotf$prop.truong[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Trương")
#ggsave(filename = file.path("Ho Truong-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Truong-PerArea.jpeg"), width = 49, height = 33)
```

## Họ Vũ

```{r}
vu_sff <- dat_sff %>% mutate(prop.vu=(sum(subset(., Ho=="Vũ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Vũ")
vu_plotf <- vu_sff %>% select(songuoi_km, prop.vu, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=vu_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(vu_plotf$prop.vu[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Vũ")
#ggsave(filename = file.path("Ho Vu-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Vu-PerArea.jpeg"), width = 49, height = 33)
```
## Họ Võ

```{r}
vo_sff <- dat_sff %>% mutate(prop.vo=(sum(subset(., Ho=="Võ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Võ")
vo_plotf <- vo_sff %>% select(songuoi_km, prop.vo, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=vo_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(vo_plotf$prop.vo[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Võ")
#ggsave(filename = file.path("Ho Vo-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Vo-PerArea.jpeg"), width = 49, height = 33)
```

# Bản đồ tỉ lệ % họ tính đến xã có sông ngòi

## Get river data

```{r}
#rivers <- st_read(file.path("GloRiC_v10_shapefile", "GloRiC_v10.shp"))
#river1 <- st_read(file.path("data", "ThuyHeVN2000.shp")) #https://data.opendevelopmentmekong.net/dataset/mng-li-thy-vn
#river2 <- st_read(file.path("data", "river.shp")) #https://www.greatermekong.org/gms-main-rivers
river3 <- st_read(file.path("data", "fk621pf5900.shp")) #https://maps.princeton.edu/catalog/stanford-fk621pf5900
```

## Họ Nguyễn

```{r}
library(sf)
nguyen_sf <- dat_sf %>% mutate(prop.nguyen=(sum(subset(., Ho=="Nguyễn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Nguyễn")
nguyen_plot <- nguyen_sf %>% select(pro.pop, prop.nguyen, geometry) %>% st_as_sf(crs = 4326)
#colnames(nguyen_plot) <- c("Tỉ lệ % họ trên tổng dân số", "geometry")
#plot(nguyen_plot)
ggplot() + geom_sf() + geom_sf(data=nguyen_plot, aes(fill=pro.pop), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(nguyen_plot$prop.nguyen[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Nguyễn")
#ggsave(filename = file.path("figures", "Nguyen-PerPop-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerPop-River", "Nguyen-PerPop-River.jpeg"), width = 49, height = 33)
```

## Họ Trần

```{r}
tran_sf <- dat_sf %>% mutate(prop.tran=(sum(subset(., Ho=="Trần")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trần")
tran_plot <- tran_sf %>% select(pro.pop, prop.tran, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=tran_plot, aes(fill=pro.pop), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(tran_plot$prop.tran[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Trần")
#ggsave(filename = file.path("figures", "Tran-PerPop-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerPop-River", "Tran-PerPop-River.jpeg"), width = 49, height = 33)
```

## Họ Lã

```{r}
la_sf <- dat_sf %>% mutate(prop.la=(sum(subset(., Ho=="Lã")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lã")
la_plot <- la_sf %>% select(pro.pop, prop.la, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=la_plot, aes(fill=pro.pop), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(la_plot$prop.la[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Lã")
#ggsave(filename = file.path("figures", "La-PerPop-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerPop-River", "La-PerPop-River.jpeg"), width = 49, height = 33)
```

## Họ Lê

```{r}
le_sf <- dat_sf %>% mutate(prop.le=(sum(subset(., Ho=="Lê")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lê")
le_plot <- le_sf %>% select(pro.pop, prop.le, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=le_plot, aes(fill=pro.pop), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(le_plot$prop.le[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Lê")
#ggsave(filename = file.path("figures", "Le-PerPop-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerPop-River", "Le-PerPop-River.jpeg"), width = 49, height = 33)
```

## Họ Dư

```{r}
du_sf <- dat_sf %>% mutate(prop.du=(sum(subset(., Ho=="Dư")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Dư")
du_plot <- du_sf %>% select(pro.pop, prop.du, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=du_plot, aes(fill=pro.pop), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(du_plot$prop.du[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Dư")
#ggsave(filename = file.path("figures", "Du-PerPop-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerPop-River", "Du-PerPop-River.jpeg"), width = 49, height = 33)
```
## Họ Dương

```{r}
duong_sf <- dat_sf %>% mutate(prop.duong=(sum(subset(., Ho=="Dương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Dương")
duong_plot <- duong_sf %>% select(pro.pop, prop.duong, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=duong_plot, aes(fill=pro.pop), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(duong_plot$prop.duong[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Dương")
#ggsave(filename = file.path("figures", "Duong-PerPop-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerPop-River", "Duong-PerPop-River.jpeg"), width = 49, height = 33)
```

## Họ Lý

```{r}
ly_sf <- dat_sf %>% mutate(prop.ly=(sum(subset(., Ho=="Lý")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lý")
ly_plot <- ly_sf %>% select(pro.pop, prop.ly, geometry) %>% st_as_sf(crs = 4326)
#colnames(ly_plot) <- c("Tỉ lệ % họ trên tổng dân số", "geometry")
ggplot() + geom_sf() + geom_sf(data=ly_plot, aes(fill=pro.pop), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(ly_plot$prop.ly[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Lý")
#ggsave(filename = file.path("figures", "Ly-PerPop-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerPop-River", "Ly-PerPop-River.jpeg"), width = 49, height = 33)
```

## Họ Đoàn

```{r}
doan_sf <- dat_sf %>% mutate(prop.doan=(sum(subset(., Ho=="Đoàn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đoàn")
doan_plot <- doan_sf %>% select(pro.pop, prop.doan, geometry) %>% st_as_sf(crs = 4326)
#colnames(doan_plot) <- c("Tỉ lệ % họ trên tổng dân số", "geometry")
ggplot() + geom_sf(data=doan_plot, aes(fill=pro.pop), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(doan_plot$prop.doan[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Đoàn")
#ggsave(filename = file.path("figures", "Doan-PerPop-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerPop-River", "Doan-PerPop-River.jpeg"), width = 49, height = 33)
```

## Họ Ngô

```{r}
ngo_sf <- dat_sf %>% mutate(prop.ngo=(sum(subset(., Ho=="Ngô")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ngô")
ngo_plot <- ngo_sf %>% select(pro.pop, prop.ngo, geometry) %>% st_as_sf(crs = 4326)
#colnames(doan_plot) <- c("Tỉ lệ % họ trên tổng dân số", "geometry")
ggplot() + geom_sf(data=ngo_plot, aes(fill=pro.pop), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(ngo_plot$prop.ngo[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Ngô")
#ggsave(filename = file.path("figures", "Ngo-PerPop-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerPop-River", "Ngo-PerPop-River.jpeg"), width = 49, height = 33)
```

## Họ Triệu

```{r}
trieu_sf <- dat_sf %>% mutate(prop.trieu=(sum(subset(., Ho=="Triệu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Triệu")
trieu_plot <- trieu_sf %>% select(pro.pop, prop.trieu, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=trieu_plot, aes(fill=pro.pop), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(trieu_plot$prop.trieu[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Triệu")
#ggsave(filename = file.path("figures", "Trieu-PerPop-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerPop-River", "Trieu-PerPop-River.jpeg"), width = 49, height = 33)
```

## Họ Mã

```{r}
ma_sf <- dat_sf %>% mutate(prop.ma=(sum(subset(., Ho=="Mã")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mã")
ma_plot <- ma_sf %>% select(pro.pop, prop.ma, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=ma_plot, aes(fill=pro.pop), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(ma_plot$prop.ma[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Mã")
#ggsave(filename = file.path("figures", "Ma-PerPop-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerPop-River", "Ma-PerPop-River.jpeg"), width = 49, height = 33)
```

## Họ Mạc

```{r}
mac_sf <- dat_sf %>% mutate(prop.mac=(sum(subset(., Ho=="Mạc")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mạc")
mac_plot <- mac_sf %>% select(pro.pop, prop.mac, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=mac_plot, aes(fill=pro.pop), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(mac_plot$prop.mac[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Mạc")
#ggsave(filename = file.path("figures", "Mac-PerPop-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerPop-River", "Mac-PerPop-River.jpeg"), width = 49, height = 33)
```

## Họ Mai

```{r}
mai_sf <- dat_sf %>% mutate(prop.mai=(sum(subset(., Ho=="Mai")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mai")
mai_plot <- mai_sf %>% select(pro.pop, prop.mai, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=mai_plot, aes(fill=pro.pop), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(mai_plot$prop.mai[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Mai")
#ggsave(filename = file.path("figures", "Mai-PerPop-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerPop-River", "Mai-PerPop-River.jpeg"), width = 49, height = 33)
```

## Họ Phùng

```{r}
phung_sf <- dat_sf %>% mutate(prop.phung=(sum(subset(., Ho=="Phùng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phùng")
phung_plot <- phung_sf %>% select(pro.pop, prop.phung, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=phung_plot, aes(fill=pro.pop), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(phung_plot$prop.phung[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Phùng")
#ggsave(filename = file.path("figures", "Phung-PerPop-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerPop-River", "Phung-PerPop-River.jpeg"), width = 49, height = 33)
```
## Họ Khúc

```{r}
khuc_sf <- dat_sf %>% mutate(prop.khuc=(sum(subset(., Ho=="Khúc")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Khúc")
khuc_plot <- khuc_sf %>% select(pro.pop, prop.khuc, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=khuc_plot, aes(fill=pro.pop), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(khuc_plot$prop.khuc[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Khúc")
#ggsave(filename = file.path("figures", "Khuc-PerPop-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerPop-River", "Khuc-PerPop-River.jpeg"), width = 49, height = 33)
```
## Họ Phạm

```{r}
pham_sf <- dat_sf %>% mutate(prop.pham=(sum(subset(., Ho=="Phạm")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phạm")
pham_plot <- pham_sf %>% select(pro.pop, prop.pham, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=pham_plot, aes(fill=pro.pop), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(pham_plot$prop.pham[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Phạm")
#ggsave(filename = file.path("figures", "Pham-PerPop-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerPop-River", "Pham-PerPop-River.jpeg"), width = 49, height = 33)
```

## Họ Hồ

```{r}
ho_sf <- dat_sf %>% mutate(prop.ho=(sum(subset(., Ho=="Hồ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hồ")
ho_plot <- ho_sf %>% select(pro.pop, prop.ho, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=ho_plot, aes(fill=pro.pop), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(ho_plot$prop.ho[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Hồ")
#ggsave(filename = file.path("figures", "Ho-PerPop-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerPop-River", "Ho-PerPop-River.jpeg"), width = 49, height = 33)
```

## Họ Tôn

```{r}
ton_sf <- dat_sf %>% mutate(prop.ton=(sum(subset(., Ho=="Tôn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Tôn")
ton_plot <- ton_sf %>% select(pro.pop, prop.ton, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=ton_plot, aes(fill=pro.pop), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(ton_plot$prop.ton[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Tôn")
#ggsave(filename = file.path("figures", "Ton-PerPop-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerPop-River", "Ton-PerPop-River.jpeg"), width = 49, height = 33)
```
## Họ Bùi

```{r}
bui_sf <- dat_sf %>% mutate(prop.bui=(sum(subset(., Ho=="Bùi")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Bùi")
bui_plot <- bui_sf %>% select(pro.pop, prop.bui, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=bui_plot, aes(fill=pro.pop), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(bui_plot$prop.bui[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Bùi")
#ggsave(filename = file.path("figures", "Bui-PerPop-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerPop-River", "Bui-PerPop-River.jpeg"), width = 49, height = 33)
```
## Họ Đào

```{r}
dao_sf <- dat_sf %>% mutate(prop.dao=(sum(subset(., Ho=="Đào")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đào")
dao_plot <- dao_sf %>% select(pro.pop, prop.dao, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=dao_plot, aes(fill=pro.pop), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(dao_plot$prop.dao[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Đào")
#ggsave(filename = file.path("figures", "Dao-PerPop-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerPop-River", "Dao-PerPop-River.jpeg"), width = 49, height = 33)
```

## Họ Đinh

```{r}
dinh_sf <- dat_sf %>% mutate(prop.dinh=(sum(subset(., Ho=="Đinh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đinh")
dinh_plot <- dinh_sf %>% select(pro.pop, prop.dinh, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=dinh_plot, aes(fill=pro.pop), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(dinh_plot$prop.dinh[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Đinh")
#ggsave(filename = file.path("figures", "Dinh-PerPop-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerPop-River", "Dinh-PerPop-River.jpeg"), width = 49, height = 33)
```
## Họ Đỗ

```{r}
do_sf <- dat_sf %>% mutate(prop.do=(sum(subset(., Ho=="Đỗ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đỗ")
do_plot <- do_sf %>% select(pro.pop, prop.do, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=do_plot, aes(fill=pro.pop), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(do_plot$prop.do[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Đỗ")
#ggsave(filename = file.path("figures", "Do-PerPop-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerPop-River", "Do-PerPop-River.jpeg"), width = 49, height = 33)
```
## Họ Hoàng

```{r}
hoang_sf <- dat_sf %>% mutate(prop.hoang=(sum(subset(., Ho=="Hoàng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hoàng")
hoang_plot <- hoang_sf %>% select(pro.pop, prop.hoang, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=hoang_plot, aes(fill=pro.pop), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(hoang_plot$prop.hoang[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Hoàng")
#ggsave(filename = file.path("figures", "Hoang-PerPop-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerPop-River", "Hoang-PerPop-River.jpeg"), width = 49, height = 33)
```
## Họ Huỳnh

```{r}
huynh_sf <- dat_sf %>% mutate(prop.huynh=(sum(subset(., Ho=="Huỳnh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Huỳnh")
huynh_plot <- huynh_sf %>% select(pro.pop, prop.huynh, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=huynh_plot, aes(fill=pro.pop), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(huynh_plot$prop.huynh[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Huỳnh")
#ggsave(filename = file.path("figures", "Huynh-PerPop-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerPop-River", "Huynh-PerPop-River.jpeg"), width = 49, height = 33)
```
## Họ Phan

```{r}
phan_sf <- dat_sf %>% mutate(prop.phan=(sum(subset(., Ho=="Phan")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phan")
phan_plot <- phan_sf %>% select(pro.pop, prop.phan, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=phan_plot, aes(fill=pro.pop), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(phan_plot$prop.phan[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Phan")
#ggsave(filename = file.path("figures", "Phan-PerPop-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerPop-River", "Phan-PerPop-River.jpeg"), width = 49, height = 33)
```

## Họ Quách

```{r}
quach_sf <- dat_sf %>% mutate(prop.quach=(sum(subset(., Ho=="Quách")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Quách")
quach_plot <- quach_sf %>% select(pro.pop, prop.quach, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=quach_plot, aes(fill=pro.pop), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(quach_plot$prop.quach[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Quách")
#ggsave(filename = file.path("figures", "Quach-PerPop-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerPop-River", "Quach-PerPop-River.jpeg"), width = 49, height = 33)
```

## Họ Trịnh

```{r}
trinh_sf <- dat_sf %>% mutate(prop.trinh=(sum(subset(., Ho=="Trịnh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trịnh")
trinh_plot <- trinh_sf %>% select(pro.pop, prop.trinh, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=trinh_plot, aes(fill=pro.pop), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(trinh_plot$prop.trinh[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Trịnh")
#ggsave(filename = file.path("figures", "Trinh-PerPop-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerPop-River", "Trinh-PerPop-River.jpeg"), width = 49, height = 33)
```

## Họ Trương

```{r}
truong_sf <- dat_sf %>% mutate(prop.truong=(sum(subset(., Ho=="Trương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trương")
truong_plot <- truong_sf %>% select(pro.pop, prop.truong, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=truong_plot, aes(fill=pro.pop), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(truong_plot$prop.truong[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Trương")
#ggsave(filename = file.path("figures", "Truong-PerPop-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerPop-River", "Truong-PerPop-River.jpeg"), width = 49, height = 33)
```

## Họ Vũ

```{r}
vu_sf <- dat_sf %>% mutate(prop.vu=(sum(subset(., Ho=="Vũ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Vũ")
vu_plot <- vu_sf %>% select(pro.pop, prop.vu, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=vu_plot, aes(fill=pro.pop), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(vu_plot$prop.vu[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Vũ")
#ggsave(filename = file.path("figures", "Vu-PerPop-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerPop-River", "Vu-PerPop-River.jpeg"), width = 49, height = 33)
```
## Họ Võ

```{r}
vo_sf <- dat_sf %>% mutate(prop.vo=(sum(subset(., Ho=="Võ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Võ")
vo_plot <- vo_sf %>% select(pro.pop, prop.vo, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=vo_plot, aes(fill=pro.pop), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(vo_plot$prop.vo[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Võ")
#ggsave(filename = file.path("figures", "Vo-PerPop-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerPop-River", "Vo-PerPop-River.jpeg"), width = 49, height = 33)
```
## Họ Vi

```{r}
vi_sf <- dat_sf %>% mutate(prop.vi=(sum(subset(., Ho=="Vi")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Vi")
vi_plot <- vi_sf %>% select(pro.pop, prop.vi, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=vi_plot, aes(fill=pro.pop), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(vi_plot$prop.vi[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Vi")
#ggsave(filename = file.path("figures", "Vi-PerPop-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerPop-River", "Vi-PerPop-River.jpeg"), width = 49, height = 33)
```

# Bản đồ mật độ họ trên diện tích tính đến xã có sông ngòi

## Họ Nguyễn

```{r}
library(sf)
nguyen_sff <- dat_sff %>% mutate(prop.nguyen=(sum(subset(., Ho=="Nguyễn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Nguyễn")
nguyen_plotf <- nguyen_sff %>% select(songuoi_km, prop.nguyen, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=nguyen_plotf, aes(fill=songuoi_km), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(nguyen_plotf$prop.nguyen[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Nguyễn")
#ggsave(filename = file.path("figures", "Nguyen-PerArea-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerArea-River", "Nguyen-PerArea-River.jpeg"), width = 49, height = 33)
```

## Họ Trần

```{r}
tran_sff <- dat_sff %>% mutate(prop.tran=(sum(subset(., Ho=="Trần")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trần")
tran_plotf <- tran_sff %>% select(songuoi_km, prop.tran, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=tran_plotf, aes(fill=songuoi_km), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(tran_plot$prop.tran[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Trần")
#ggsave(filename = file.path("figures", "Tran-PerArea-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerArea-River", "Tran-PerArea-River.jpeg"), width = 49, height = 33)
```

## Họ Lê

```{r}
le_sff <- dat_sff %>% mutate(prop.le=(sum(subset(., Ho=="Lê")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lê")
le_plotf <- le_sff %>% select(songuoi_km, prop.le, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=le_plotf, aes(fill=songuoi_km), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(le_plot$prop.le[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Lê")
#ggsave(filename = file.path("figures", "Le-PerArea-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerArea-River", "Le-PerArea-River.jpeg"), width = 49, height = 33)
```

## Họ Lã

```{r}
la_sff <- dat_sff %>% mutate(prop.la=(sum(subset(., Ho=="Lã")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lã")
la_plotf <- la_sff %>% select(songuoi_km, prop.la, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=la_plotf, aes(fill=songuoi_km), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(la_plot$prop.la[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Lã")
#ggsave(filename = file.path("figures", "La-PerArea-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerArea-River", "La-PerArea-River.jpeg"), width = 49, height = 33)
```

## Họ Dư

```{r}
du_sff <- dat_sff %>% mutate(prop.du=(sum(subset(., Ho=="Dư")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Dư")
du_plotf <- du_sff %>% select(songuoi_km, prop.du, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=du_plotf, aes(fill=songuoi_km), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(du_plot$prop.du[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Dư")
#ggsave(filename = file.path("figures", "Du-PerArea-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerArea-River", "Du-PerArea-River.jpeg"), width = 49, height = 33)
```
## Họ Dương

```{r}
duong_sff <- dat_sff %>% mutate(prop.duong=(sum(subset(., Ho=="Dương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Dương")
duong_plotf <- duong_sff %>% select(songuoi_km, prop.duong, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=duong_plotf, aes(fill=songuoi_km), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(duong_plot$prop.duong[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Dương")
#ggsave(filename = file.path("figures", "Duong-PerArea-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerArea-River", "Duong-PerArea-River.jpeg"), width = 49, height = 33)
```

## Họ Lý

```{r}
ly_sff <- dat_sff %>% mutate(prop.ly=(sum(subset(., Ho=="Lý")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lý")
ly_plotf <- ly_sff %>% select(songuoi_km, prop.ly, geometry) %>% st_as_sf(crs = 4326)
#colnames(ly_plot) <- c("Tỉ lệ % họ trên tổng dân số", "geometry")
ggplot() + geom_sf() + geom_sf(data=ly_plotf, aes(fill=songuoi_km), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(ly_plot$prop.ly[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Lý")
#ggsave(filename = file.path("figures", "Ly-PerArea-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerArea-River", "Ly-PerArea-River.jpeg"), width = 49, height = 33)
```
## Họ Đoàn

```{r}
doan_sff <- dat_sff %>% mutate(prop.doan=(sum(subset(., Ho=="Đoàn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đoàn")
doan_plotf <- doan_sff %>% select(songuoi_km, prop.doan, geometry) %>% st_as_sf(crs = 4326)
#colnames(doan_plot) <- c("Tỉ lệ % họ trên tổng dân số", "geometry")
ggplot() + geom_sf(data=doan_plotf, aes(fill=songuoi_km), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(doan_plot$prop.doan[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Đoàn")
#ggsave(filename = file.path("figures", "Doan-PerArea-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerArea-River", "Doan-PerArea-River.jpeg"), width = 49, height = 33)
```

## Họ Ngô

```{r}
ngo_sff <- dat_sff %>% mutate(prop.ngo=(sum(subset(., Ho=="Ngô")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ngô")
ngo_plotf <- ngo_sff %>% select(songuoi_km, prop.ngo, geometry) %>% st_as_sf(crs = 4326)
#colnames(doan_plot) <- c("Tỉ lệ % họ trên tổng dân số", "geometry")
ggplot() + geom_sf(data=ngo_plotf, aes(fill=songuoi_km), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(ngo_plot$prop.ngo[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Ngô")
#ggsave(filename = file.path("figures", "Ngo-PerArea-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerArea-River", "Ngo-PerArea-River.jpeg"), width = 49, height = 33)
```
## Họ Triệu

```{r}
trieu_sff <- dat_sff %>% mutate(prop.trieu=(sum(subset(., Ho=="Triệu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Triệu")
trieu_plotf <- trieu_sff %>% select(songuoi_km, prop.trieu, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=trieu_plotf, aes(fill=songuoi_km), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(trieu_plot$prop.trieu[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Triệu")
#ggsave(filename = file.path("figures", "Trieu-PerArea-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerArea-River", "Trieu-PerArea-River.jpeg"), width = 49, height = 33)
```

## Họ Mã

```{r}
ma_sff <- dat_sff %>% mutate(prop.ma=(sum(subset(., Ho=="Mã")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mã")
ma_plotf <- ma_sff %>% select(songuoi_km, prop.ma, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=ma_plotf, aes(fill=songuoi_km), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(ma_plot$prop.ma[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Mã")
#ggsave(filename = file.path("figures", "Ma-PerArea-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerArea-River", "Ma-PerArea-River.jpeg"), width = 49, height = 33)
```

## Họ Mạc

```{r}
mac_sff <- dat_sff %>% mutate(prop.mac=(sum(subset(., Ho=="Mạc")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mạc")
mac_plotf <- mac_sff %>% select(songuoi_km, prop.mac, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=mac_plotf, aes(fill=songuoi_km), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(mac_plot$prop.mac[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Mạc")
#ggsave(filename = file.path("figures", "Mac-PerArea-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerArea-River", "Mac-PerArea-River.jpeg"), width = 49, height = 33)
```

## Họ Mai

```{r}
mai_sff <- dat_sff %>% mutate(prop.mai=(sum(subset(., Ho=="Mai")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mai")
mai_plotf <- mai_sff %>% select(songuoi_km, prop.mai, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=mai_plotf, aes(fill=songuoi_km), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(mai_plot$prop.mai[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Mai")
#ggsave(filename = file.path("figures", "Mai-PerArea-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerArea-River", "Mai-PerArea-River.jpeg"), width = 49, height = 33)
```

## Họ Phùng

```{r}
phung_sff <- dat_sff %>% mutate(prop.phung=(sum(subset(., Ho=="Phùng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phùng")
phung_plotf <- phung_sff %>% select(songuoi_km, prop.phung, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=phung_plotf, aes(fill=songuoi_km), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(phung_plot$prop.phung[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Phùng")
#ggsave(filename = file.path("figures", "Phung-PerArea-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerArea-River", "Phung-PerArea-River.jpeg"), width = 49, height = 33)
```
## Họ Khúc

```{r}
khuc_sff <- dat_sff %>% mutate(prop.khuc=(sum(subset(., Ho=="Khúc")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Khúc")
khuc_plotf <- khuc_sff %>% select(songuoi_km, prop.khuc, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=khuc_plotf, aes(fill=songuoi_km), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(khuc_plot$prop.khuc[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Khúc")
#ggsave(filename = file.path("figures", "Khuc-PerArea-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerArea-River", "Khuc-PerArea-River.jpeg"), width = 49, height = 33)
```
## Họ Phạm

```{r}
pham_sff <- dat_sff %>% mutate(prop.pham=(sum(subset(., Ho=="Phạm")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phạm")
pham_plotf <- pham_sff %>% select(songuoi_km, prop.pham, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=pham_plotf, aes(fill=songuoi_km), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(pham_plot$prop.pham[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Phạm")
#ggsave(filename = file.path("figures", "Pham-PerArea-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerArea-River", "Pham-PerArea-River.jpeg"), width = 49, height = 33)
```

## Họ Hồ

```{r}
ho_sff <- dat_sff %>% mutate(prop.ho=(sum(subset(., Ho=="Hồ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hồ")
ho_plotf <- ho_sff %>% select(songuoi_km, prop.ho, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=ho_plotf, aes(fill=songuoi_km), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(ho_plotf$prop.ho[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Hồ")
#ggsave(filename = file.path("figures", "Ho-PerArea-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerArea-River", "Ho-PerArea-River.jpeg"), width = 49, height = 33)
```

## Họ Tôn

```{r}
ton_sff <- dat_sff %>% mutate(prop.ton=(sum(subset(., Ho=="Tôn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Tôn")
ton_plotf <- ton_sff %>% select(songuoi_km, prop.ton, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=ton_plotf, aes(fill=songuoi_km), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(ton_plotf$prop.ton[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Tôn")
#ggsave(filename = file.path("figures", "Ton-PerArea-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerArea-River", "Ton-PerArea-River.jpeg"), width = 49, height = 33)
```

## Họ Bùi

```{r}
bui_sff <- dat_sff %>% mutate(prop.bui=(sum(subset(., Ho=="Bùi")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Bùi")
bui_plotf <- bui_sff %>% select(songuoi_km, prop.bui, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=bui_plotf, aes(fill=songuoi_km), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(bui_plotf$prop.bui[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Bùi")
#ggsave(filename = file.path("figures", "Bui-PerArea-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerArea-River", "Bui-PerArea-River.jpeg"), width = 49, height = 33)
```
## Họ Đào

```{r}
dao_sff <- dat_sff %>% mutate(prop.dao=(sum(subset(., Ho=="Đào")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đào")
dao_plotf <- dao_sff %>% select(songuoi_km, prop.dao, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=dao_plotf, aes(fill=songuoi_km), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(dao_plotf$prop.dao[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Đào")
#ggsave(filename = file.path("figures", "Dao-PerArea-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerArea-River", "Dao-PerArea-River.jpeg"), width = 49, height = 33)
```

## Họ Đinh

```{r}
dinh_sff <- dat_sff %>% mutate(prop.dinh=(sum(subset(., Ho=="Đinh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đinh")
dinh_plotf <- dinh_sff %>% select(songuoi_km, prop.dinh, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=dinh_plotf, aes(fill=songuoi_km), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(dinh_plotf$prop.dinh[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Đinh")
#ggsave(filename = file.path("figures", "Dinh-PerArea-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerArea-River", "Dinh-PerArea-River.jpeg"), width = 49, height = 33)
```
## Họ Đỗ

```{r}
do_sff <- dat_sff %>% mutate(prop.do=(sum(subset(., Ho=="Đỗ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đỗ")
do_plotf <- do_sff %>% select(songuoi_km, prop.do, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=do_plotf, aes(fill=songuoi_km), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(do_plotf$prop.do[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Đỗ")
#ggsave(filename = file.path("figures", "Do-PerArea-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerArea-River", "Do-PerArea-River.jpeg"), width = 49, height = 33)
```
## Họ Hoàng

```{r}
hoang_sff <- dat_sff %>% mutate(prop.hoang=(sum(subset(., Ho=="Hoàng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hoàng")
hoang_plotf <- hoang_sff %>% select(songuoi_km, prop.hoang, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=hoang_plotf, aes(fill=songuoi_km), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(hoang_plotf$prop.hoang[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Hoàng")
#ggsave(filename = file.path("figures", "Hoang-PerArea-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerArea-River", "Hoang-PerArea-River.jpeg"), width = 49, height = 33)
```
## Họ Huỳnh

```{r}
huynh_sff <- dat_sff %>% mutate(prop.huynh=(sum(subset(., Ho=="Huỳnh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Huỳnh")
huynh_plotf <- huynh_sff %>% select(songuoi_km, prop.huynh, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=huynh_plotf, aes(fill=songuoi_km), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(huynh_plotf$prop.huynh[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Huỳnh")
#ggsave(filename = file.path("figures", "Huynh-PerArea-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerArea-River", "Huynh-PerArea-River.jpeg"), width = 49, height = 33)
```
## Họ Phan

```{r}
phan_sff <- dat_sff %>% mutate(prop.phan=(sum(subset(., Ho=="Phan")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phan")
phan_plotf <- phan_sff %>% select(songuoi_km, prop.phan, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=phan_plotf, aes(fill=songuoi_km), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(phan_plotf$prop.phan[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Phan")
#ggsave(filename = file.path("figures", "Phan-PerArea-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerArea-River", "Phan-PerArea-River.jpeg"), width = 49, height = 33)
```

## Họ Quách

```{r}
quach_sff <- dat_sff %>% mutate(prop.quach=(sum(subset(., Ho=="Quách")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Quách")
quach_plotf <- quach_sff %>% select(songuoi_km, prop.quach, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=quach_plotf, aes(fill=songuoi_km), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(quach_plotf$prop.quach[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Quách")
#ggsave(filename = file.path("figures", "Quach-PerArea-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerArea-River", "Quach-PerArea-River.jpeg"), width = 49, height = 33)
```

## Họ Trịnh

```{r}
trinh_sff <- dat_sff %>% mutate(prop.trinh=(sum(subset(., Ho=="Trịnh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trịnh")
trinh_plotf <- trinh_sff %>% select(songuoi_km, prop.trinh, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=trinh_plotf, aes(fill=songuoi_km), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(trinh_plotf$prop.trinh[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Trịnh")
#ggsave(filename = file.path("figures", "Trinh-PerArea-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerArea-River", "Trinh-PerArea-River.jpeg"), width = 49, height = 33)
```
## Họ Trương

```{r}
truong_sff <- dat_sff %>% mutate(prop.truong=(sum(subset(., Ho=="Trương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trương")
truong_plotf <- truong_sff %>% select(songuoi_km, prop.truong, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=truong_plotf, aes(fill=songuoi_km), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(truong_plotf$prop.truong[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Trương")
#ggsave(filename = file.path("figures", "Truong-PerArea-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerArea-River", "Truong-PerArea-River.jpeg"), width = 49, height = 33)
```

## Họ Vũ

```{r}
vu_sff <- dat_sff %>% mutate(prop.vu=(sum(subset(., Ho=="Vũ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Vũ")
vu_plotf <- vu_sff %>% select(songuoi_km, prop.vu, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=vu_plotf, aes(fill=songuoi_km), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(vu_plotf$prop.vu[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Vũ")
#ggsave(filename = file.path("figures", "Vu-PerArea-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerArea-River", "Vu-PerArea-River.jpeg"), width = 49, height = 33)
```
## Họ Võ

```{r}
vo_sff <- dat_sff %>% mutate(prop.vo=(sum(subset(., Ho=="Võ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Võ")
vo_plotf <- vo_sff %>% select(songuoi_km, prop.vo, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=vo_plotf, aes(fill=songuoi_km), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(vo_plotf$prop.vo[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Võ")
#ggsave(filename = file.path("figures", "Vo-PerArea-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerArea-River", "Vo-PerArea-River.jpeg"), width = 49, height = 33)
```
## Họ Vi

```{r}
vi_sff <- dat_sff %>% mutate(prop.vi=(sum(subset(., Ho=="Vi")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Vi")
vi_plotf <- vi_sff %>% select(songuoi_km, prop.vi, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=vi_plotf, aes(fill=songuoi_km), lwd=0) +
  geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(vi_plotf$prop.vi[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Vi")
#ggsave(filename = file.path("figures", "Vo-PerArea-River.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "PerArea-River", "Vi-PerArea-River.jpeg"), width = 49, height = 33)
```

# Bản đồ đường đồng mức tỉ lệ % họ tính đến xã có sông ngòi

## Contour lines

```{r, warning=FALSE, message=FALSE}
library(sf)
library(spatstat)
library(sp)
library(maptools)
library(raster)
library(cartography)
library(SpatialPosition)
library(potential)
# remotes::install_github("riatelab/SpatialPosition")
# remotes::install_github("riatelab/potential")
# library(tanaka)
```

## Functions


```{r}
# interact_density <- function(d, fun, beta, span) {
#   if (fun == "p") {
#     alpha <- (2^(1 / beta) - 1) / span
#     matDens <- (1 + alpha * d)^(-beta)
#   } else if (fun == "e") {
#     alpha <- exp(-log(2)  + (sqrt(span) - beta)^2)
#     matDens <- alpha * exp(-(sqrt(d) - beta)^2)
#   }
#   return(matDens)
# }
```

```{r}
# make a new geometry that is rotated 15 degrees (but retain original geom)
river_rot <- river3 %>% 
  mutate(geom_rot = st_geometry(.)*rot(pi/12)) %>%
  st_drop_geometry() %>%
  rename(geometry = geom_rot) %>%
  st_set_geometry("geometry") %>%
  st_set_crs(4326)
```

## Họ Bùi

```{r, message=FALSE, warning=FALSE}
bui_sf <- dat_sf %>% mutate(prop.bui=(sum(subset(., Ho=="Bùi")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Bùi")
bui_f <- bui_sf %>% select(MAXA, MATINH, songuoi, danso, pro.pop, geometry) %>% st_as_sf(crs = 4326)
bui_f <- sf::st_transform(bui_f, 2154)
bui_plot <- bui_sf %>% select(pro.pop, prop.bui, geometry) %>% st_as_sf(crs = 4326)
# Convert to Spatial class
bui_sf2 <- bui_sf %>% select(MAXA, MATINH, songuoi, danso, pro.pop, geometry) %>% st_as_sf(crs = 4326)
bui_sf2 <- sf::st_transform(bui_sf2, 2154)
bui_sp <- as(bui_sf2, Class = "Spatial")

# Compute the potentials of population on a regular grid (50km span)
# function = exponential, beta = 2, span = 75 km
poppot <- stewart(knownpts = bui_sp, 
                  varname = "danso", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 10, 
                  resolution = 50000, 
                  mask = bui_sp, 
                  returnclass = "sf")

# Compute the potentials of family name on a regular grid (50km span)
# function = exponential, beta = 2, span = 75 km
namepot <- stewart(knownpts = bui_sp, 
                  varname = "songuoi", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 10, 
                  resolution = 50000, 
                  mask = bui_sp, 
                  returnclass = "sf")

# Create the ratio variable
# Handle NaN
"/" <- function(x,y) ifelse(y==0,0,base:::"/"(x,y))
poppot$OUTPUT2 <- namepot$OUTPUT * 100 / poppot$OUTPUT

# Discretize the variable
bv <- quantile(bui_sf$pro.pop, seq(from = 0, to = 1, length.out = 9))

# Create an isopleth layer
pot <- isopoly(x = poppot, var = "OUTPUT2",
               breaks = bv, 
               mask = bui_sp, 
               returnclass = "sf")

# rotate function (see here: https://r-spatial.github.io/sf/articles/sf3.html#affine-transformations
rot <- function(a) matrix(c(cos(a), sin(a), -sin(a), cos(a)), 2, 2)

# make a new geometry that is rotated 90 degrees (but retain original geom)
bui_rot <- bui_f %>% 
  mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
  st_drop_geometry() %>%
  rename(geometry = geom_rot) %>%
  st_set_geometry("geometry")
bui_rot <- as(bui_rot, Class = "Spatial")

pot_rot <- pot %>% 
   mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
   st_drop_geometry() %>%
   rename(geometry = geom_rot) %>%
   st_set_geometry("geometry")
#pot_rot <- st_as_sfc(pot_rot)

# Draw the basemap
#png(filename = "Bui_contourpoly.jpeg", width=2400, height=3200, res=300, bg = NA)
plot(bui_rot, add = F, border = NA, bg = "white")
# Map the potential family name per Pop
plot(st_geometry(pot_rot), add=T, lwd = 0.5, border = "grey30")
if(require(cartography)){
# Get breaks values
bks <-  sort(unique(c(pot$min, pot$max)))
# Set a color palette
pal <- carto.pal(pal1 = "wine.pal", n1 = 8)
# Draw the map
par <- par(mar = c(0,0,1.2,0))
# Display the map
choroLayer(x = pot_rot, var = "center", 
          legend.pos = "left",
          breaks = bks, col = pal, add=T, 
          border = NA, lwd = 0.2,
          legend.title.txt = "Tỉ lệ (%) trên dân số địa phương",
          legend.title.cex = 1,
          legend.values.cex = 0.6,
          legend.values.rnd = 1)
# Set a layout
layoutLayer(title = paste("Đường đồng mức tỉ lệ (%) trên dân số họ Bùi", paste(round(bui_plot$prop.bui[1],1), "% dân số", sep = ""), sep=" - "),
sources = "Data source: Vietnam GSO", author = "Duc Du, 2022", theme = "wine.pal")
par(par)
}
#dev.off()

ggplot() + geom_sf() + geom_sf(data=pot, aes(fill=min), lwd=0) +
  geom_sf(data=river3, col="white") +
  scale_fill_viridis("Tỉ lệ (%) tối thiểu\n trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(bui_plot$prop.bui[1],1), "% dân số", sep = "")) +
  ggtitle("Đường đồng mức tỉ lệ (%) trên dân số họ Bùi") +
  coord_sf(crs = 4326)
ggsave(filename = file.path("figures", "Contour-River", "Bui-Contour-River.jpeg"), width = 49, height = 33)
```

```{r}
# #Create a regular grid
# library(potential)
# library(mapsf)
# potential <- potential::potential
# mf_map(bui_f, col= "grey80", border = "white", lwd = .4)
# y <- create_grid(x = bui_f, res = 100000)
# mf_map(y, pch = 23, add = TRUE, bg = "blue", cex = .5 )
```

```{r}
# #Create a distance matrix
# d <- create_matrix(x = bui_f, y = y)
# d[1:5, 1:5]
```

```{r}
# #Compute the potentials
# y$namepot <- potential(x = bui_f, y = y, d = d,
#                    var = "songuoi", fun = "e",
#                    span = 1000, beta = 2)
# mf_map(bui_f, col= "grey80", border = "white", lwd = .4)
# mf_map(y, var = "namepot", type = "prop", 
#        inches= .1, 
#        lwd = .5, 
#        leg_val_cex = .5, 
#        leg_val_rnd = -3,
#        leg_frame = TRUE, 
#        leg_pos = "topright")
```

```{r}
# #It’s possible to express the potential relatively to its maximum in order to display more understandable values (Rich 1980).
# y$poppot <- potential(x = bui_f, y = y, d = d,
#                    var = "danso", fun = "e",
#                    span = 1000, beta = 2)
# # Create the ratio variable
# # Handle NaN
# "/" <- function(x,y) ifelse(y==0,0,base:::"/"(x,y))
# y$pot <- y$namepot * 100 / y$poppot
# 
# mf_map(bui_f, col= "grey80", border = "white", lwd = .4)
# mf_map(y, var = "pot", type = "prop", 
#        inches= .1, 
#        lwd = .5, 
#        leg_val_cex = .5, 
#        leg_val_rnd = 0,
#        leg_frame = TRUE, 
#        leg_pos = "topright")
```

```{r, message=FALSE, warning=FALSE, results='hide'}
# library(potential)
# library(mapsf)
# #Create a regular grid
# y <- create_grid(x = bui_f, res = 100000)
# 
# #Create a distance matrix
# d <- create_matrix(x = bui_f, y = y)
# d[1:5, 1:5]
```

```{r}
# #Compute the potentials
# y$namepot <- potential(x = bui_f, y = y, d = d,
#                    var = "songuoi", fun = "e",
#                    span = 5000, beta = 2)
# 
# y$poppot <- potential(x = bui_f, y = y, d = d,
#                    var = "danso", fun = "e",
#                    span = 5000, beta = 2)
# # Create the ratio variable
# # Handle NaN
# "/" <- function(x,y) ifelse(y==0,0,base:::"/"(x,y))
# y$pot <- y$namepot * 100 / y$poppot
# 
# # Compute areas of equipotential with equipotential().
# bks <- seq(0, 100, 10)
# iso <- equipotential(x = y, var = "pot", breaks = bks, mask = bui_f)
# 
# ggplot() + geom_sf() + geom_sf(data=iso, aes(fill=min), lwd=0) +
#   geom_sf(data=river3, col="white") +
#   scale_fill_viridis("Tỉ lệ (%) trên\n dân số địa phương", direction = -1, option = "viridis") +
#   theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
#   ggtitle(paste("Đường đồng mức tỉ lệ (%) trên dân số họ Bùi", paste(round(bui_plot$prop.bui[1],1), "% dân số", sep = ""), sep=" - ")) +
#   coord_sf(crs = 4326)
# ggsave(filename = file.path("figures", "Contour-River", "Bui-Contour-River.jpeg"), width = 49, height = 33)
```

## Họ Nguyễn

```{r, message=FALSE, warning=FALSE}
#data
nguyen_sf <- dat_sf %>% mutate(prop.nguyen=(sum(subset(., Ho=="Nguyễn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Nguyễn")
nguyen_f <- nguyen_sf %>% select(MAXA, MATINH, songuoi, pro.pop, geometry) %>% st_as_sf(crs = 4326)
nguyen_f <- sf::st_transform(nguyen_f, 2154)
nguyen_plot <- nguyen_sf %>% select(pro.pop, prop.nguyen, geometry) %>% st_as_sf(crs = 4326)

#Smoothed Map of the family name per Pop

#In this case, the potential family name per Pop is computed on a regular grid.

# Convert to Spatial class
nguyen_sf2 <- nguyen_sf %>% select(MAXA, MATINH, songuoi, danso, pro.pop, geometry) %>% st_as_sf(crs = 4326)
nguyen_sf2 <- sf::st_transform(nguyen_sf2, 2154)
nguyen_sp <- as(nguyen_sf2, Class = "Spatial")

# Compute the potentials of population on a regular grid (50km span)
# function = exponential, beta = 2, span = 75 km
poppot <- stewart(knownpts = nguyen_sp, 
                  varname = "danso", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 10, 
                  resolution = 50000, 
                  mask = nguyen_sp, 
                  returnclass = "sf")

# Compute the potentials of family name on a regular grid (50km span)
# function = exponential, beta = 2, span = 75 km
namepot <- stewart(knownpts = nguyen_sp, 
                  varname = "songuoi", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 10, 
                  resolution = 50000, 
                  mask = nguyen_sp, 
                  returnclass = "sf")

# Create the ratio variable
# Handle NaN
"/" <- function(x,y) ifelse(y==0,0,base:::"/"(x,y))
poppot$OUTPUT2 <- namepot$OUTPUT * 100 / poppot$OUTPUT

# Discretize the variable
bv <- quantile(nguyen_sf$pro.pop, seq(from = 0, to = 1, length.out = 9))

# Create an isopleth layer
# pot <- isopoly(x = nguyen_f_stewart, var = "OUTPUT",
#                breaks = bv, 
#                mask = nguyen_sp, 
#                returnclass = "sf")

pot <- isopoly(x = poppot, var = "OUTPUT2",
               breaks = bv, 
               mask = nguyen_sp, 
               returnclass = "sf")

# rotate function (see here: https://r-spatial.github.io/sf/articles/sf3.html#affine-transformations
rot <- function(a) matrix(c(cos(a), sin(a), -sin(a), cos(a)), 2, 2)

# make a new geometry that is rotated 90 degrees (but retain original geom)
nguyen_rot <- nguyen_f %>% 
  mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
  st_drop_geometry() %>%
  rename(geometry = geom_rot) %>%
  st_set_geometry("geometry")
nguyen_rot <- as(nguyen_rot, Class = "Spatial")

pot_rot <- pot %>% 
   mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
   st_drop_geometry() %>%
   rename(geometry = geom_rot) %>%
   st_set_geometry("geometry")
#pot_rot <- st_as_sfc(pot_rot)
 
# Draw the basemap
#png(filename = "Nguyen_contourpoly.jpeg", width=2400, height=3200, res=300, bg = NA)
plot(nguyen_rot, add = F, border = NA, bg = "white")
# Map the potential family name per Pop
plot(st_geometry(pot_rot), add=T, lwd = 0.5, border = "grey30")
if(require(cartography)){
# Get breaks values
bks <-  sort(unique(c(pot$min, pot$max)))
# Set a color palette
pal <- carto.pal(pal1 = "wine.pal", n1 = 8)
# Draw the map
par <- par(mar = c(0,0,1.2,0))
# Display the map
choroLayer(x = pot_rot, var = "center", 
          legend.pos = "left",
          breaks = bks, col = pal, add=T, 
          border = NA, lwd = 0.2,
          legend.title.txt = "Tỉ lệ (%) trên dân số địa phương",
          legend.title.cex = 1,
          legend.values.cex = 0.6,
          legend.values.rnd = 1)
# # Set a text to explicit the function parameters
# text(x = 9035851, y = 9580781, 
#      labels = paste(round(nguyen_plot$prop.nguyen[1],1), "% dân số", sep = ""), 
#      cex = 0.8, adj = 0, font = 3)
# Set a layout
layoutLayer(title = paste("Đường đồng mức tỉ lệ (%) trên dân số họ Nguyễn", paste(round(nguyen_plot$prop.nguyen[1],1), "% dân số", sep = ""), sep=" - "),
sources = "Data source: Vietnam GSO", author = "Duc Du, 2022", theme = "wine.pal")
par(par)
}
#dev.off()

ggplot() + geom_sf() + geom_sf(data=pot, aes(fill=min), lwd=0) +
  geom_sf(data=river3, col="white") +
  scale_fill_viridis("Tỉ lệ (%) tối thiểu\n trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(nguyen_plot$prop.nguyen[1],1), "% dân số", sep = "")) +
  ggtitle("Đường đồng mức tỉ lệ (%) trên dân số họ Nguyễn") +
  coord_sf(crs = 4326)
ggsave(filename = file.path("figures", "Contour-River", "Nguyen-Contour-River.jpeg"), width = 49, height = 33)
```

## Họ Triệu

```{r, warning=FALSE, message=FALSE}
trieu_sf <- dat_sf %>% mutate(prop.trieu=(sum(subset(., Ho=="Triệu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Triệu")
trieu_f <- trieu_sf %>% select(MAXA, MATINH, songuoi, pro.pop, geometry) %>% st_as_sf(crs = 4326)
trieu_f <- sf::st_transform(trieu_f, 2154)
trieu_plot <- trieu_sf %>% select(pro.pop, prop.trieu, geometry) %>% st_as_sf(crs = 4326)
# Convert to Spatial class
trieu_sf2 <- trieu_sf %>% select(MAXA, MATINH, songuoi, danso, pro.pop, geometry) %>% st_as_sf(crs = 4326)
trieu_sf2 <- sf::st_transform(trieu_sf2, 2154)
trieu_sp <- as(trieu_sf2, Class = "Spatial")

# Compute the potentials of population on a regular grid (50km span)
# function = exponential, beta = 2, span = 75 km
poppot <- stewart(knownpts = trieu_sp, 
                  varname = "danso", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 10, 
                  resolution = 50000, 
                  mask = trieu_sp, 
                  returnclass = "sf")

# Compute the potentials of family name on a regular grid (50km span)
# function = exponential, beta = 2, span = 75 km
namepot <- stewart(knownpts = trieu_sp, 
                  varname = "songuoi", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 10, 
                  resolution = 50000, 
                  mask = trieu_sp, 
                  returnclass = "sf")

# Create the ratio variable
# Handle NaN
"/" <- function(x,y) ifelse(y==0,0,base:::"/"(x,y))
poppot$OUTPUT2 <- namepot$OUTPUT * 100 / poppot$OUTPUT

# Discretize the variable
bv <- quantile(trieu_sf$pro.pop, seq(from = 0, to = 1, length.out = 9))

# Create an isopleth layer
pot <- isopoly(x = poppot, var = "OUTPUT2",
               breaks = bv, 
               mask = trieu_sp, 
               returnclass = "sf")

# rotate function (see here: https://r-spatial.github.io/sf/articles/sf3.html#affine-transformations
rot <- function(a) matrix(c(cos(a), sin(a), -sin(a), cos(a)), 2, 2)

# make a new geometry that is rotated 90 degrees (but retain original geom)
trieu_rot <- trieu_f %>% 
  mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
  st_drop_geometry() %>%
  rename(geometry = geom_rot) %>%
  st_set_geometry("geometry")
trieu_rot <- as(trieu_rot, Class = "Spatial")

pot_rot <- pot %>% 
   mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
   st_drop_geometry() %>%
   rename(geometry = geom_rot) %>%
   st_set_geometry("geometry")
#pot_rot <- st_as_sfc(pot_rot)
 
# Draw the basemap
#png(filename = "Trieu_contourpoly.jpeg", width=2400, height=3200, res=300, bg = NA)
plot(trieu_rot, add = F, border = NA, bg = "white")
# Map the potential family name per Pop
plot(st_geometry(pot_rot), add=T, lwd = 0.5, border = "grey30")
if(require(cartography)){
# Get breaks values
bks <-  sort(unique(c(pot$min, pot$max)))
# Set a color palette
pal <- carto.pal(pal1 = "wine.pal", n1 = 8)
# Draw the map
par <- par(mar = c(0,0,1.2,0))
# Display the map
choroLayer(x = pot_rot, var = "center", 
          legend.pos = "left",
          breaks = bks, col = pal, add=T, 
          border = NA, lwd = 0.2,
          legend.title.txt = "Tỉ lệ (%) trên dân số địa phương",
          legend.title.cex = 1,
          legend.values.cex = 0.6,
          legend.values.rnd = 1)
# Set a layout
layoutLayer(title = paste("Đường đồng mức tỉ lệ (%) trên dân số họ Triệu", paste(round(trieu_plot$prop.trieu[1],1), "% dân số", sep = ""), sep=" - "),
sources = "Data source: Vietnam GSO", author = "Duc Du, 2022", theme = "wine.pal")
par(par)
}
#dev.off()

ggplot() + geom_sf() + geom_sf(data=pot, aes(fill=min), lwd=0) +
  geom_sf(data=river3, col="white") +
  scale_fill_viridis("Tỉ lệ (%) tối thiểu\n trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(trieu_plot$prop.trieu[1],1), "% dân số", sep = "")) +
  ggtitle("Đường đồng mức tỉ lệ (%) trên dân số họ Triệu") +
  coord_sf(crs = 4326)
ggsave(filename = file.path("figures", "Contour-River", "Trieu-Contour-River.jpeg"), width = 49, height = 33)
```

## Họ Đinh

```{r, warning=FALSE, message=FALSE}
dinh_sf <- dat_sf %>% mutate(prop.dinh=(sum(subset(., Ho=="Đinh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đinh")
dinh_f <- dinh_sf %>% select(MAXA, MATINH, songuoi, pro.pop, geometry) %>% st_as_sf(crs = 4326)
dinh_f <- sf::st_transform(dinh_f, 2154)
dinh_plot <- dinh_sf %>% select(pro.pop, prop.dinh, geometry) %>% st_as_sf(crs = 4326)
# Convert to Spatial class
dinh_sf2 <- dinh_sf %>% select(MAXA, MATINH, songuoi, danso, pro.pop, geometry) %>% st_as_sf(crs = 4326)
dinh_sf2 <- sf::st_transform(dinh_sf2, 2154)
dinh_sp <- as(dinh_sf2, Class = "Spatial")

# Compute the potentials of population on a regular grid (50km span)
# function = exponential, beta = 2, span = 75 km
poppot <- stewart(knownpts = dinh_sp, 
                  varname = "danso", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 10, 
                  resolution = 50000, 
                  mask = dinh_sp, 
                  returnclass = "sf")

# Compute the potentials of family name on a regular grid (50km span)
# function = exponential, beta = 2, span = 75 km
namepot <- stewart(knownpts = dinh_sp, 
                  varname = "songuoi", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 10, 
                  resolution = 50000, 
                  mask = dinh_sp, 
                  returnclass = "sf")

# Create the ratio variable
# Handle NaN
"/" <- function(x,y) ifelse(y==0,0,base:::"/"(x,y))
poppot$OUTPUT2 <- namepot$OUTPUT * 100 / poppot$OUTPUT

# Discretize the variable
bv <- quantile(dinh_sf$pro.pop, seq(from = 0, to = 1, length.out = 9))

# Create an isopleth layer
pot <- isopoly(x = poppot, var = "OUTPUT2",
               breaks = bv, 
               mask = dinh_sp, 
               returnclass = "sf")

# rotate function (see here: https://r-spatial.github.io/sf/articles/sf3.html#affine-transformations
rot <- function(a) matrix(c(cos(a), sin(a), -sin(a), cos(a)), 2, 2)

# make a new geometry that is rotated 90 degrees (but retain original geom)
dinh_rot <- dinh_f %>% 
  mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
  st_drop_geometry() %>%
  rename(geometry = geom_rot) %>%
  st_set_geometry("geometry")
dinh_rot <- as(dinh_rot, Class = "Spatial")

pot_rot <- pot %>% 
   mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
   st_drop_geometry() %>%
   rename(geometry = geom_rot) %>%
   st_set_geometry("geometry")
#pot_rot <- st_as_sfc(pot_rot)
 
# Draw the basemap
#png(filename = "Dinh_contourpoly.jpeg", width=2400, height=3200, res=300, bg = NA)
plot(dinh_rot, add = F, border = NA, bg = "white")
# Map the potential family name per Pop
plot(st_geometry(pot_rot), add=T, lwd = 0.5, border = "grey30")
if(require(cartography)){
# Get breaks values
bks <-  sort(unique(c(pot$min, pot$max)))
# Set a color palette
pal <- carto.pal(pal1 = "wine.pal", n1 = 8)
# Draw the map
par <- par(mar = c(0,0,1.2,0))
# Display the map
choroLayer(x = pot_rot, var = "center", 
          legend.pos = "left",
          breaks = bks, col = pal, add=T, 
          border = NA, lwd = 0.2,
          legend.title.txt = "Tỉ lệ (%) trên dân số địa phương",
          legend.title.cex = 1,
          legend.values.cex = 0.6,
          legend.values.rnd = 1)
# Set a layout
layoutLayer(title = paste("Đường đồng mức tỉ lệ (%) trên dân số họ Đinh", paste(round(dinh_plot$prop.dinh[1],1), "% dân số", sep = ""), sep=" - "),
sources = "Data source: Vietnam GSO", author = "Duc Du, 2022", theme = "wine.pal")
par(par)
}
#dev.off()

ggplot() + geom_sf() + geom_sf(data=pot, aes(fill=min), lwd=0) +
  geom_sf(data=river3, col="white") +
  scale_fill_viridis("Tỉ lệ (%) tối thiểu\n trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(dinh_plot$prop.dinh[1],1), "% dân số", sep = "")) +
  ggtitle("Đường đồng mức tỉ lệ (%) trên dân số họ Đinh") +
  coord_sf(crs = 4326)
ggsave(filename = file.path("figures", "Contour-River", "Dinh-Contour-River.jpeg"), width = 49, height = 33)
```

## Họ Lý

```{r, message=FALSE, warning=FALSE}
ly_sf <- dat_sf %>% mutate(prop.ly=(sum(subset(., Ho=="Lý")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lý")
ly_f <- ly_sf %>% select(MAXA, MATINH, songuoi, pro.pop, geometry) %>% st_as_sf(crs = 4326)
ly_f <- sf::st_transform(ly_f, 2154)
ly_plot <- ly_sf %>% select(pro.pop, prop.ly, geometry) %>% st_as_sf(crs = 4326)
# Convert to Spatial class
ly_sf2 <- ly_sf %>% select(MAXA, MATINH, songuoi, danso, pro.pop, geometry) %>% st_as_sf(crs = 4326)
ly_sf2 <- sf::st_transform(ly_sf2, 2154)
ly_sp <- as(ly_sf2, Class = "Spatial")

# Compute the potentials of population on a regular grid (50km span)
# function = exponential, beta = 2, span = 75 km
poppot <- stewart(knownpts = ly_sp, 
                  varname = "danso", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 10, 
                  resolution = 50000, 
                  mask = ly_sp, 
                  returnclass = "sf")

# Compute the potentials of family name on a regular grid (50km span)
# function = exponential, beta = 2, span = 75 km
namepot <- stewart(knownpts = ly_sp, 
                  varname = "songuoi", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 10, 
                  resolution = 50000, 
                  mask = ly_sp, 
                  returnclass = "sf")

# Create the ratio variable
# Handle NaN
"/" <- function(x,y) ifelse(y==0,0,base:::"/"(x,y))
poppot$OUTPUT2 <- namepot$OUTPUT * 100 / poppot$OUTPUT

# Discretize the variable
bv <- quantile(ly_sf$pro.pop, seq(from = 0, to = 1, length.out = 9))

# Create an isopleth layer
pot <- isopoly(x = poppot, var = "OUTPUT2",
               breaks = bv, 
               mask = ly_sp, 
               returnclass = "sf")

# rotate function (see here: https://r-spatial.github.io/sf/articles/sf3.html#affine-transformations
rot <- function(a) matrix(c(cos(a), sin(a), -sin(a), cos(a)), 2, 2)

# make a new geometry that is rotated 90 degrees (but retain original geom)
ly_rot <- ly_f %>% 
  mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
  st_drop_geometry() %>%
  rename(geometry = geom_rot) %>%
  st_set_geometry("geometry")
ly_rot <- as(ly_rot, Class = "Spatial")

pot_rot <- pot %>% 
   mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
   st_drop_geometry() %>%
   rename(geometry = geom_rot) %>%
   st_set_geometry("geometry")
#pot_rot <- st_as_sfc(pot_rot)
 
# Draw the basemap
#png(filename = "Ly_contourpoly.jpeg", width=2400, height=3200, res=300, bg = NA)
plot(ly_rot, add = F, border = NA, bg = "white")
# Map the potential family name per Pop
plot(st_geometry(pot_rot), add=T, lwd = 0.5, border = "grey30")
if(require(cartography)){
# Get breaks values
bks <-  sort(unique(c(pot$min, pot$max)))
# Set a color palette
pal <- carto.pal(pal1 = "wine.pal", n1 = 8)
# Draw the map
par <- par(mar = c(0,0,1.2,0))
# Display the map
choroLayer(x = pot_rot, var = "center", 
          legend.pos = "left",
          breaks = bks, col = pal, add=T, 
          border = NA, lwd = 0.2,
          legend.title.txt = "Tỉ lệ (%) trên dân số địa phương",
          legend.title.cex = 1,
          legend.values.cex = 0.6,
          legend.values.rnd = 1)
# Set a layout
layoutLayer(title = paste("Đường đồng mức tỉ lệ (%) trên dân số họ Lý", paste(round(ly_plot$prop.ly[1],1), "% dân số", sep = ""), sep=" - "),
sources = "Data source: Vietnam GSO", author = "Duc Du, 2022", theme = "wine.pal")
par(par)
}
#dev.off()

ggplot() + geom_sf() + geom_sf(data=pot, aes(fill=min), lwd=0) +
  geom_sf(data=river3, col="white") +
  scale_fill_viridis("Tỉ lệ (%) tối thiểu\n trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(ly_plot$prop.ly[1],1), "% dân số", sep = "")) +
  ggtitle("Đường đồng mức tỉ lệ (%) trên dân số họ Lý") +
  coord_sf(crs = 4326)
ggsave(filename = file.path("figures", "Contour-River", "Ly-Contour-River.jpeg"), width = 49, height = 33)
```

## Họ Lê

```{r, message=FALSE, warning=FALSE}
le_sf <- dat_sf %>% mutate(prop.le=(sum(subset(., Ho=="Lê")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lê")
le_f <- le_sf %>% select(MAXA, MATINH, songuoi, pro.pop, geometry) %>% st_as_sf(crs = 4326)
le_f <- sf::st_transform(le_f, 2154)
le_plot <- le_sf %>% select(pro.pop, prop.le, geometry) %>% st_as_sf(crs = 4326)
# Convert to Spatial class
le_sf2 <- le_sf %>% select(MAXA, MATINH, songuoi, danso, pro.pop, geometry) %>% st_as_sf(crs = 4326)
le_sf2 <- sf::st_transform(le_sf2, 2154)
le_sp <- as(le_sf2, Class = "Spatial")

# Compute the potentials of population on a regular grid (50km span)
# function = exponential, beta = 2, span = 75 km
poppot <- stewart(knownpts = le_sp, 
                  varname = "danso", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 10, 
                  resolution = 50000, 
                  mask = le_sp, 
                  returnclass = "sf")

# Compute the potentials of family name on a regular grid (50km span)
# function = exponential, beta = 2, span = 75 km
namepot <- stewart(knownpts = le_sp, 
                  varname = "songuoi", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 10, 
                  resolution = 50000, 
                  mask = le_sp, 
                  returnclass = "sf")

# Create the ratio variable
# Handle NaN
"/" <- function(x,y) ifelse(y==0,0,base:::"/"(x,y))
poppot$OUTPUT2 <- namepot$OUTPUT * 100 / poppot$OUTPUT

# Discretize the variable
bv <- quantile(le_sf$pro.pop, seq(from = 0, to = 1, length.out = 9))

# Create an isopleth layer
pot <- isopoly(x = poppot, var = "OUTPUT2",
               breaks = bv, 
               mask = le_sp, 
               returnclass = "sf")

# rotate function (see here: https://r-spatial.github.io/sf/articles/sf3.html#affine-transformations
rot <- function(a) matrix(c(cos(a), sin(a), -sin(a), cos(a)), 2, 2)

# make a new geometry that is rotated 90 degrees (but retain original geom)
le_rot <- le_f %>% 
  mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
  st_drop_geometry() %>%
  rename(geometry = geom_rot) %>%
  st_set_geometry("geometry")
le_rot <- as(le_rot, Class = "Spatial")

pot_rot <- pot %>% 
   mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
   st_drop_geometry() %>%
   rename(geometry = geom_rot) %>%
   st_set_geometry("geometry")
#pot_rot <- st_as_sfc(pot_rot)
 
# Draw the basemap
#png(filename = "Le_contourpoly.jpeg", width=2400, height=3200, res=300, bg = NA)
plot(le_rot, add = F, border = NA, bg = "white")
# Map the potential family name per Pop
plot(st_geometry(pot_rot), add=T, lwd = 0.5, border = "grey30")
if(require(cartography)){
# Get breaks values
bks <-  sort(unique(c(pot$min, pot$max)))
# Set a color palette
pal <- carto.pal(pal1 = "wine.pal", n1 = 8)
# Draw the map
par <- par(mar = c(0,0,1.2,0))
# Display the map
choroLayer(x = pot_rot, var = "center", 
          legend.pos = "left",
          breaks = bks, col = pal, add=T, 
          border = NA, lwd = 0.2,
          legend.title.txt = "Tỉ lệ (%) trên dân số địa phương",
          legend.title.cex = 1,
          legend.values.cex = 0.6,
          legend.values.rnd = 1)
# Set a layout
layoutLayer(title = paste("Đường đồng mức tỉ lệ (%) trên dân số họ Lê", paste(round(le_plot$prop.le[1],1), "% dân số", sep = ""), sep=" - "),
sources = "Data source: Vietnam GSO", author = "Duc Du, 2022", theme = "wine.pal")
par(par)
}
#dev.off()

ggplot() + geom_sf() + geom_sf(data=pot, aes(fill=min), lwd=0) +
  geom_sf(data=river3, col="white") +
  scale_fill_viridis("Tỉ lệ (%) tối thiểu\n trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(le_plot$prop.le[1],1), "% dân số", sep = "")) +
  ggtitle("Đường đồng mức tỉ lệ (%) trên dân số họ Lê") +
  coord_sf(crs = 4326)
ggsave(filename = file.path("figures", "Contour-River", "Le-Contour-River.jpeg"), width = 49, height = 33)
```

## Họ Lã

```{r, message=FALSE, warning=FALSE}
la_sf <- dat_sf %>% mutate(prop.la=(sum(subset(., Ho=="Lã")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lã")
la_f <- la_sf %>% select(MAXA, MATINH, songuoi, pro.pop, geometry) %>% st_as_sf(crs = 4326)
la_f <- sf::st_transform(la_f, 2154)
la_plot <- la_sf %>% select(pro.pop, prop.la, geometry) %>% st_as_sf(crs = 4326)
# Convert to Spatial class
la_sf2 <- la_sf %>% select(MAXA, MATINH, songuoi, danso, pro.pop, geometry) %>% st_as_sf(crs = 4326)
la_sf2 <- sf::st_transform(la_sf2, 2154)
la_sp <- as(la_sf2, Class = "Spatial")

# Compute the potentials of population on a regular grid (50km span)
# function = exponential, beta = 2, span = 75 km
poppot <- stewart(knownpts = la_sp, 
                  varname = "danso", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 10, 
                  resolution = 50000, 
                  mask = la_sp, 
                  returnclass = "sf")

# Compute the potentials of family name on a regular grid (50km span)
# function = exponential, beta = 2, span = 75 km
namepot <- stewart(knownpts = la_sp, 
                  varname = "songuoi", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 10, 
                  resolution = 50000, 
                  mask = la_sp, 
                  returnclass = "sf")

# Create the ratio variable
# Handle NaN
"/" <- function(x,y) ifelse(y==0,0,base:::"/"(x,y))
poppot$OUTPUT2 <- namepot$OUTPUT * 100 / poppot$OUTPUT

# Discretize the variable
bv <- quantile(la_sf$pro.pop, seq(from = 0, to = 1, length.out = 9))

# Create an isopleth layer
pot <- isopoly(x = poppot, var = "OUTPUT2",
               breaks = bv, 
               mask = la_sp, 
               returnclass = "sf")

# rotate function (see here: https://r-spatial.github.io/sf/articles/sf3.html#affine-transformations
rot <- function(a) matrix(c(cos(a), sin(a), -sin(a), cos(a)), 2, 2)

# make a new geometry that is rotated 90 degrees (but retain original geom)
la_rot <- la_f %>% 
  mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
  st_drop_geometry() %>%
  rename(geometry = geom_rot) %>%
  st_set_geometry("geometry")
la_rot <- as(la_rot, Class = "Spatial")

pot_rot <- pot %>% 
   mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
   st_drop_geometry() %>%
   rename(geometry = geom_rot) %>%
   st_set_geometry("geometry")
#pot_rot <- st_as_sfc(pot_rot)
 
# Draw the basemap
#png(filename = "La_contourpoly.jpeg", width=2400, height=3200, res=300, bg = NA)
plot(la_rot, add = F, border = NA, bg = "white")
# Map the potential family name per Pop
plot(st_geometry(pot_rot), add=T, lwd = 0.5, border = "grey30")
if(require(cartography)){
# Get breaks values
bks <-  sort(unique(c(pot$min, pot$max)))
# Set a color palette
pal <- carto.pal(pal1 = "wine.pal", n1 = 8)
# Draw the map
par <- par(mar = c(0,0,1.2,0))
# Display the map
choroLayer(x = pot_rot, var = "center", 
          legend.pos = "left",
          breaks = bks, col = pal, add=T, 
          border = NA, lwd = 0.2,
          legend.title.txt = "Tỉ lệ (%) trên dân số địa phương",
          legend.title.cex = 1,
          legend.values.cex = 0.6,
          legend.values.rnd = 1)
# Set a layout
layoutLayer(title = paste("Đường đồng mức tỉ lệ (%) trên dân số họ Lã", paste(round(la_plot$prop.la[1],1), "% dân số", sep = ""), sep=" - "),
sources = "Data source: Vietnam GSO", author = "Duc Du, 2022", theme = "wine.pal")
par(par)
}
#dev.off()

ggplot() + geom_sf() + geom_sf(data=pot, aes(fill=min), lwd=0) +
  geom_sf(data=river3, col="white") +
  scale_fill_viridis("Tỉ lệ (%) tối thiểu\n trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(la_plot$prop.la[1],1), "% dân số", sep = "")) +
  ggtitle("Đường đồng mức tỉ lệ (%) trên dân số họ Lã") +
  coord_sf(crs = 4326)
ggsave(filename = file.path("figures", "Contour-River", "La-Contour-River.jpeg"), width = 49, height = 33)
```

## Họ Trần

```{r, message=FALSE, warning=FALSE}
tran_sf <- dat_sf %>% mutate(prop.tran=(sum(subset(., Ho=="Trần")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trần")
tran_f <- tran_sf %>% select(MAXA, MATINH, songuoi, danso, pro.pop, geometry) %>% st_as_sf(crs = 4326)
tran_f <- sf::st_transform(tran_f, 2154)
tran_plot <- tran_sf %>% select(pro.pop, prop.tran, geometry) %>% st_as_sf(crs = 4326)
# Convert to Spatial class
tran_sf2 <- tran_sf %>% select(MAXA, MATINH, songuoi, danso, pro.pop, geometry) %>% st_as_sf(crs = 4326)
tran_sf2 <- sf::st_transform(tran_sf2, 2154)
tran_sp <- as(tran_sf2, Class = "Spatial")

# Compute the potentials of population on a regular grid (50km span)
# function = exponential, beta = 2, span = 75 km
poppot <- stewart(knownpts = tran_sp, 
                  varname = "danso", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 10, 
                  resolution = 50000, 
                  mask = tran_sp, 
                  returnclass = "sf")

# Compute the potentials of family name on a regular grid (50km span)
# function = exponential, beta = 2, span = 75 km
namepot <- stewart(knownpts = tran_sp, 
                  varname = "songuoi", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 10, 
                  resolution = 50000, 
                  mask = tran_sp, 
                  returnclass = "sf")

# Create the ratio variable
# Handle NaN
"/" <- function(x,y) ifelse(y==0,0,base:::"/"(x,y))
poppot$OUTPUT2 <- namepot$OUTPUT * 100 / poppot$OUTPUT

# Discretize the variable
bv <- quantile(tran_sf$pro.pop, seq(from = 0, to = 1, length.out = 9))

# Create an isopleth layer
pot <- isopoly(x = poppot, var = "OUTPUT2",
               breaks = bv, 
               mask = tran_sp, 
               returnclass = "sf")

# rotate function (see here: https://r-spatial.github.io/sf/articles/sf3.html#affine-transformations
rot <- function(a) matrix(c(cos(a), sin(a), -sin(a), cos(a)), 2, 2)

# make a new geometry that is rotated 90 degrees (but retain original geom)
tran_rot <- tran_f %>% 
  mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
  st_drop_geometry() %>%
  rename(geometry = geom_rot) %>%
  st_set_geometry("geometry")
tran_rot <- as(tran_rot, Class = "Spatial")

pot_rot <- pot %>% 
   mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
   st_drop_geometry() %>%
   rename(geometry = geom_rot) %>%
   st_set_geometry("geometry")
#pot_rot <- st_as_sfc(pot_rot)

# Draw the basemap
#png(filename = "Tran_contourpoly.jpeg", width=2400, height=3200, res=300, bg = NA)
plot(tran_rot, add = F, border = NA, bg = "white")
# Map the potential family name per Pop
plot(st_geometry(pot_rot), add=T, lwd = 0.5, border = "grey30")
if(require(cartography)){
# Get breaks values
bks <-  sort(unique(c(pot$min, pot$max)))
# Set a color palette
pal <- carto.pal(pal1 = "wine.pal", n1 = 8)
# Draw the map
par <- par(mar = c(0,0,1.2,0))
# Display the map
choroLayer(x = pot_rot, var = "center", 
          legend.pos = "left",
          breaks = bks, col = pal, add=T, 
          border = NA, lwd = 0.2,
          legend.title.txt = "Tỉ lệ (%) trên dân số địa phương",
          legend.title.cex = 1,
          legend.values.cex = 0.6,
          legend.values.rnd = 1)
plot(st_geometry(river3), add=T, lwd = 0.5, border = "grey30")
# Set a layout
layoutLayer(title = paste("Đường đồng mức tỉ lệ (%) trên dân số họ Trần", paste(round(tran_plot$prop.tran[1],1), "% dân số", sep = ""), sep=" - "),
sources = "Data source: Vietnam GSO", author = "Duc Du, 2022", theme = "wine.pal")
par(par)
}
#dev.off()

ggplot() + geom_sf() + geom_sf(data=pot, aes(fill=min), lwd=0) +
  geom_sf(data=river3, col="white") +
  scale_fill_viridis("Tỉ lệ (%) tối thiểu\n trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(tran_plot$prop.tran[1],1), "% dân số", sep = "")) +
  ggtitle("Đường đồng mức tỉ lệ (%) trên dân số họ Trần") +
  coord_sf(crs = 4326)
ggsave(filename = file.path("figures", "Contour-River", "Tran-Contour-River.jpeg"), width = 49, height = 33)
```

```{r, message=FALSE, warning=FALSE, results='hide'}
# #Create a regular grid
# y <- create_grid(x = tran_f, res = 100000)
# 
# #Create a distance matrix
# d <- create_matrix(x = tran_f, y = y)
# d[1:5, 1:5]
```

```{r}
#Compute the potentials
# y$namepot <- potential(x = tran_f, y = y, d = d,
#                    var = "songuoi", fun = "e",
#                    span = 5000, beta = 5)
# 
# y$poppot <- potential(x = tran_f, y = y, d = d,
#                    var = "danso", fun = "e",
#                    span = 5000, beta = 5)
# # Create the ratio variable
# # Handle NaN
# "/" <- function(x,y) ifelse(y==0,0,base:::"/"(x,y))
# y$pot <- y$namepot * 100 / y$poppot
# 
# # Compute areas of equipotential with equipotential().
# bks <- seq(0, 100, 10)
# iso <- equipotential(x = y, var = "pot", breaks = bks, mask = tran_f)
# 
# ggplot() + geom_sf() + geom_sf(data=iso, aes(fill=min), lwd=0) +
#   geom_sf(data=river3, col="white") +
#   scale_fill_viridis("Tỉ lệ (%) trên\n dân số địa phương", direction = -1, option = "viridis") +
#   theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
#   ggtitle(paste("Đường đồng mức tỉ lệ (%) trên dân số họ Trần", paste(round(tran_plot$prop.tran[1],1), "% dân số", sep = ""), sep=" - ")) +
#   coord_sf(crs = 4326)
# ggsave(filename = file.path("figures", "Contour-River", "Tran-Contour-River.jpeg"), width = 49, height = 33)
```

```{r}
# ggplot() + geom_sf() + geom_sf(data=pot, aes(fill=center), lwd=0) +
#   geom_sf(data=river3, col="white")
```

## Họ Dư

```{r, message=FALSE, warning=FALSE}
du_sf <- dat_sf %>% mutate(prop.du=(sum(subset(., Ho=="Dư")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Dư")
du_f <- du_sf %>% select(MAXA, MATINH, songuoi, pro.pop, geometry) %>% st_as_sf(crs = 4326)
du_f <- sf::st_transform(du_f, 2154)
du_plot <- du_sf %>% select(pro.pop, prop.du, geometry) %>% st_as_sf(crs = 4326)
# Convert to Spatial class
du_sf2 <- du_sf %>% select(MAXA, MATINH, songuoi, danso, pro.pop, geometry) %>% st_as_sf(crs = 4326)
du_sf2 <- sf::st_transform(du_sf2, 2154)
du_sp <- as(du_sf2, Class = "Spatial")

# Compute the potentials of population on a regular grid (50km span)
# function = exponential, beta = 2, span = 75 km
poppot <- stewart(knownpts = du_sp, 
                  varname = "danso", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 10, 
                  resolution = 50000, 
                  mask = du_sp, 
                  returnclass = "sf")

# Compute the potentials of family name on a regular grid (50km span)
# function = exponential, beta = 2, span = 75 km
namepot <- stewart(knownpts = du_sp, 
                  varname = "songuoi", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 10, 
                  resolution = 50000, 
                  mask = du_sp, 
                  returnclass = "sf")

# Create the ratio variable
# Handle NaN
"/" <- function(x,y) ifelse(y==0,0,base:::"/"(x,y))
poppot$OUTPUT2 <- namepot$OUTPUT * 100 / poppot$OUTPUT

# Discretize the variable
bv <- quantile(du_sf$pro.pop, seq(from = 0, to = 1, length.out = 9))

# Create an isopleth layer
pot <- isopoly(x = poppot, var = "OUTPUT2",
               breaks = bv, 
               mask = du_sp, 
               returnclass = "sf")

# rotate function (see here: https://r-spatial.github.io/sf/articles/sf3.html#affine-transformations
rot <- function(a) matrix(c(cos(a), sin(a), -sin(a), cos(a)), 2, 2)

# make a new geometry that is rotated 90 degrees (but retain original geom)
du_rot <- du_f %>% 
  mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
  st_drop_geometry() %>%
  rename(geometry = geom_rot) %>%
  st_set_geometry("geometry")
du_rot <- as(du_rot, Class = "Spatial")

pot_rot <- pot %>% 
   mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
   st_drop_geometry() %>%
   rename(geometry = geom_rot) %>%
   st_set_geometry("geometry")
#pot_rot <- st_as_sfc(pot_rot)
 
# Draw the basemap
#png(filename = "Du_contourpoly.jpeg", width=2400, height=3200, res=300, bg = NA)
plot(du_rot, add = F, border = NA, bg = "white")
# Map the potential family name per Pop
plot(st_geometry(pot_rot), add=T, lwd = 0.5, border = "grey30")
if(require(cartography)){
# Get breaks values
bks <-  sort(unique(c(pot$min, pot$max)))
# Set a color palette
pal <- carto.pal(pal1 = "wine.pal", n1 = 8)
# Draw the map
par <- par(mar = c(0,0,1.2,0))
# Display the map
choroLayer(x = pot_rot, var = "center", 
          legend.pos = "left",
          breaks = bks, col = pal, add=T, 
          border = NA, lwd = 0.2,
          legend.title.txt = "Tỉ lệ (%) trên dân số địa phương",
          legend.title.cex = 1,
          legend.values.cex = 0.6,
          legend.values.rnd = 2)
# Set a layout
layoutLayer(title = paste("Đường đồng mức tỉ lệ (%) trên dân số họ Dư", paste(round(du_plot$prop.du[1],2), "% dân số", sep = ""), sep=" - "),
sources = "Data source: Vietnam GSO", author = "Duc Du, 2022", theme = "wine.pal")
par(par)
}
#dev.off()

ggplot() + geom_sf() + geom_sf(data=pot, aes(fill=min), lwd=0) +
  geom_sf(data=river3, col="white") +
  scale_fill_viridis("Tỉ lệ (%) tối thiểu\n trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(du_plot$prop.du[1],2), "% dân số", sep = "")) +
  ggtitle("Đường đồng mức tỉ lệ (%) trên dân số họ Dư") +
  coord_sf(crs = 4326)
ggsave(filename = file.path("figures", "Contour-River", "Du-Contour-River.jpeg"), width = 49, height = 33)
```

## Họ Ngô

```{r, message=FALSE, warning=FALSE}
ngo_sf <- dat_sf %>% mutate(prop.ngo=(sum(subset(., Ho=="Ngô")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ngô")
ngo_f <- ngo_sf %>% select(MAXA, MATINH, songuoi, pro.pop, geometry) %>% st_as_sf(crs = 4326)
ngo_f <- sf::st_transform(ngo_f, 2154)
ngo_plot <- ngo_sf %>% select(pro.pop, prop.ngo, geometry) %>% st_as_sf(crs = 4326)
# Convert to Spatial class
ngo_sf2 <- ngo_sf %>% select(MAXA, MATINH, songuoi, danso, pro.pop, geometry) %>% st_as_sf(crs = 4326)
ngo_sf2 <- sf::st_transform(ngo_sf2, 2154)
ngo_sp <- as(ngo_sf2, Class = "Spatial")

# Compute the potentials of population on a regular grid (50km span)
# function = exponential, beta = 2, span = 75 km
poppot <- stewart(knownpts = ngo_sp, 
                  varname = "danso", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 10, 
                  resolution = 50000, 
                  mask = ngo_sp, 
                  returnclass = "sf")

# Compute the potentials of family name on a regular grid (50km span)
# function = exponential, beta = 2, span = 75 km
namepot <- stewart(knownpts = ngo_sp, 
                  varname = "songuoi", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 10, 
                  resolution = 50000, 
                  mask = ngo_sp, 
                  returnclass = "sf")

# Create the ratio variable
# Handle NaN
"/" <- function(x,y) ifelse(y==0,0,base:::"/"(x,y))
poppot$OUTPUT2 <- namepot$OUTPUT * 100 / poppot$OUTPUT

# Discretize the variable
bv <- quantile(ngo_sf$pro.pop, seq(from = 0, to = 1, length.out = 9))

# Create an isopleth layer
pot <- isopoly(x = poppot, var = "OUTPUT2",
               breaks = bv, 
               mask = ngo_sp, 
               returnclass = "sf")

# rotate function (see here: https://r-spatial.github.io/sf/articles/sf3.html#affine-transformations
rot <- function(a) matrix(c(cos(a), sin(a), -sin(a), cos(a)), 2, 2)

# make a new geometry that is rotated 90 degrees (but retain original geom)
ngo_rot <- ngo_f %>% 
  mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
  st_drop_geometry() %>%
  rename(geometry = geom_rot) %>%
  st_set_geometry("geometry")
ngo_rot <- as(ngo_rot, Class = "Spatial")

pot_rot <- pot %>% 
   mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
   st_drop_geometry() %>%
   rename(geometry = geom_rot) %>%
   st_set_geometry("geometry")
#pot_rot <- st_as_sfc(pot_rot)
 
# Draw the basemap
#png(filename = "Ngo_contourpoly.jpeg", width=2400, height=3200, res=300, bg = NA)
plot(ngo_rot, add = F, border = NA, bg = "white")
# Map the potential family name per Pop
plot(st_geometry(pot_rot), add=T, lwd = 0.5, border = "grey30")
if(require(cartography)){
# Get breaks values
bks <-  sort(unique(c(pot$min, pot$max)))
# Set a color palette
pal <- carto.pal(pal1 = "wine.pal", n1 = 8)
# Draw the map
par <- par(mar = c(0,0,1.2,0))
# Display the map
choroLayer(x = pot_rot, var = "center", 
          legend.pos = "left",
          breaks = bks, col = pal, add=T, 
          border = NA, lwd = 0.2,
          legend.title.txt = "Tỉ lệ (%) trên dân số địa phương",
          legend.title.cex = 1,
          legend.values.cex = 0.6,
          legend.values.rnd = 1)
# Set a layout
layoutLayer(title = paste("Đường đồng mức tỉ lệ (%) trên dân số họ Ngô", paste(round(ngo_plot$prop.ngo[1],1), "% dân số", sep = ""), sep=" - "),
sources = "Data source: Vietnam GSO", author = "Duc Du, 2022", theme = "wine.pal")
par(par)
}
#dev.off()

ggplot() + geom_sf() + geom_sf(data=pot, aes(fill=min), lwd=0) +
  geom_sf(data=river3, col="white") +
  scale_fill_viridis("Tỉ lệ (%) tối thiểu\n trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(ngo_plot$prop.ngo[1],1), "% dân số", sep = "")) +
  ggtitle("Đường đồng mức tỉ lệ (%) trên dân số họ Ngô") +
  coord_sf(crs = 4326)
ggsave(filename = file.path("figures", "Contour-River", "Ngo-Contour-River.jpeg"), width = 49, height = 33)
```

## Họ Đoàn

```{r, message=FALSE, warning=FALSE}
doan_sf <- dat_sf %>% mutate(prop.doan=(sum(subset(., Ho=="Đoàn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đoàn")
doan_f <- doan_sf %>% select(MAXA, MATINH, songuoi, pro.pop, geometry) %>% st_as_sf(crs = 4326)
doan_f <- sf::st_transform(doan_f, 2154)
doan_plot <- doan_sf %>% select(pro.pop, prop.doan, geometry) %>% st_as_sf(crs = 4326)
# Convert to Spatial class
doan_sf2 <- doan_sf %>% select(MAXA, MATINH, songuoi, danso, pro.pop, geometry) %>% st_as_sf(crs = 4326)
doan_sf2 <- sf::st_transform(doan_sf2, 2154)
doan_sp <- as(doan_sf2, Class = "Spatial")

# Compute the potentials of population on a regular grid (50km span)
# function = exponential, beta = 2, span = 75 km
poppot <- stewart(knownpts = doan_sp, 
                  varname = "danso", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 10, 
                  resolution = 50000, 
                  mask = doan_sp, 
                  returnclass = "sf")

# Compute the potentials of family name on a regular grid (50km span)
# function = exponential, beta = 2, span = 75 km
namepot <- stewart(knownpts = doan_sp, 
                  varname = "songuoi", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 10, 
                  resolution = 50000, 
                  mask = doan_sp, 
                  returnclass = "sf")

# Create the ratio variable
# Handle NaN
"/" <- function(x,y) ifelse(y==0,0,base:::"/"(x,y))
poppot$OUTPUT2 <- namepot$OUTPUT * 100 / poppot$OUTPUT

# Discretize the variable
bv <- quantile(doan_sf$pro.pop, seq(from = 0, to = 1, length.out = 9))

# Create an isopleth layer
pot <- isopoly(x = poppot, var = "OUTPUT2",
               breaks = bv, 
               mask = doan_sp, 
               returnclass = "sf")

# rotate function (see here: https://r-spatial.github.io/sf/articles/sf3.html#affine-transformations
rot <- function(a) matrix(c(cos(a), sin(a), -sin(a), cos(a)), 2, 2)

# make a new geometry that is rotated 90 degrees (but retain original geom)
doan_rot <- doan_f %>% 
  mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
  st_drop_geometry() %>%
  rename(geometry = geom_rot) %>%
  st_set_geometry("geometry")
doan_rot <- as(doan_rot, Class = "Spatial")

pot_rot <- pot %>% 
   mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
   st_drop_geometry() %>%
   rename(geometry = geom_rot) %>%
   st_set_geometry("geometry")
#pot_rot <- st_as_sfc(pot_rot)
 
# Draw the basemap
#png(filename = "Doan_contourpoly.jpeg", width=2400, height=3200, res=300, bg = NA)
plot(doan_rot, add = F, border = NA, bg = "white")
# Map the potential family name per Pop
plot(st_geometry(pot_rot), add=T, lwd = 0.5, border = "grey30")
if(require(cartography)){
# Get breaks values
bks <-  sort(unique(c(pot$min, pot$max)))
# Set a color palette
pal <- carto.pal(pal1 = "wine.pal", n1 = 8)
# Draw the map
par <- par(mar = c(0,0,1.2,0))
# Display the map
choroLayer(x = pot_rot, var = "center", 
          legend.pos = "left",
          breaks = bks, col = pal, add=T, 
          border = NA, lwd = 0.2,
          legend.title.txt = "Tỉ lệ (%) trên dân số địa phương",
          legend.title.cex = 1,
          legend.values.cex = 0.6,
          legend.values.rnd = 1)
# Set a layout
layoutLayer(title = paste("Đường đồng mức tỉ lệ (%) trên dân số họ Đoàn", paste(round(doan_plot$prop.doan[1],1), "% dân số", sep = ""), sep=" - "),
sources = "Data source: Vietnam GSO", author = "Duc Du, 2022", theme = "wine.pal")
par(par)
}
#dev.off()

ggplot() + geom_sf() + geom_sf(data=pot, aes(fill=min), lwd=0) +
  geom_sf(data=river3, col="white") +
  scale_fill_viridis("Tỉ lệ (%) tối thiểu\n trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(doan_plot$prop.doan[1],1), "% dân số", sep = "")) +
  ggtitle("Đường đồng mức tỉ lệ (%) trên dân số họ Đoàn") +
  coord_sf(crs = 4326)
ggsave(filename = file.path("figures", "Contour-River", "Doan-Contour-River.jpeg"), width = 49, height = 33)
```

## Họ Trịnh

```{r, message=FALSE, warning=FALSE}
trinh_sf <- dat_sf %>% mutate(prop.trinh=(sum(subset(., Ho=="Trịnh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trịnh")
trinh_f <- trinh_sf %>% select(MAXA, MATINH, songuoi, pro.pop, geometry) %>% st_as_sf(crs = 4326)
trinh_f <- sf::st_transform(trinh_f, 2154)
trinh_plot <- trinh_sf %>% select(pro.pop, prop.trinh, geometry) %>% st_as_sf(crs = 4326)
# Convert to Spatial class
trinh_sf2 <- trinh_sf %>% select(MAXA, MATINH, songuoi, danso, pro.pop, geometry) %>% st_as_sf(crs = 4326)
trinh_sf2 <- sf::st_transform(trinh_sf2, 2154)
trinh_sp <- as(trinh_sf2, Class = "Spatial")

# Compute the potentials of population on a regular grid (50km span)
# function = exponential, beta = 2, span = 75 km
poppot <- stewart(knownpts = trinh_sp, 
                  varname = "danso", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 10, 
                  resolution = 50000, 
                  mask = trinh_sp, 
                  returnclass = "sf")

# Compute the potentials of family name on a regular grid (50km span)
# function = exponential, beta = 2, span = 75 km
namepot <- stewart(knownpts = trinh_sp, 
                  varname = "songuoi", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 10, 
                  resolution = 50000, 
                  mask = trinh_sp, 
                  returnclass = "sf")

# Create the ratio variable
# Handle NaN
"/" <- function(x,y) ifelse(y==0,0,base:::"/"(x,y))
poppot$OUTPUT2 <- namepot$OUTPUT * 100 / poppot$OUTPUT

# Discretize the variable
bv <- quantile(trinh_sf$pro.pop, seq(from = 0, to = 1, length.out = 9))

# Create an isopleth layer
pot <- isopoly(x = poppot, var = "OUTPUT2",
               breaks = bv, 
               mask = trinh_sp, 
               returnclass = "sf")

# rotate function (see here: https://r-spatial.github.io/sf/articles/sf3.html#affine-transformations
rot <- function(a) matrix(c(cos(a), sin(a), -sin(a), cos(a)), 2, 2)

# make a new geometry that is rotated 90 degrees (but retain original geom)
trinh_rot <- trinh_f %>% 
  mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
  st_drop_geometry() %>%
  rename(geometry = geom_rot) %>%
  st_set_geometry("geometry")
trinh_rot <- as(trinh_rot, Class = "Spatial")

pot_rot <- pot %>% 
   mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
   st_drop_geometry() %>%
   rename(geometry = geom_rot) %>%
   st_set_geometry("geometry")
#pot_rot <- st_as_sfc(pot_rot)
 
# Draw the basemap
#png(filename = "Trinh_contourpoly.jpeg", width=2400, height=3200, res=300, bg = NA)
plot(trinh_rot, add = F, border = NA, bg = "white")
# Map the potential family name per Pop
plot(st_geometry(pot_rot), add=T, lwd = 0.5, border = "grey30")
if(require(cartography)){
# Get breaks values
bks <-  sort(unique(c(pot$min, pot$max)))
# Set a color palette
pal <- carto.pal(pal1 = "wine.pal", n1 = 8)
# Draw the map
par <- par(mar = c(0,0,1.2,0))
# Display the map
choroLayer(x = pot_rot, var = "center", 
          legend.pos = "left",
          breaks = bks, col = pal, add=T, 
          border = NA, lwd = 0.2,
          legend.title.txt = "Tỉ lệ (%) trên dân số địa phương",
          legend.title.cex = 1,
          legend.values.cex = 0.6,
          legend.values.rnd = 1)
# Set a layout
layoutLayer(title = paste("Đường đồng mức tỉ lệ (%) trên dân số họ Trịnh", paste(round(trinh_plot$prop.trinh[1],1), "% dân số", sep = ""), sep=" - "),
sources = "Data source: Vietnam GSO", author = "Duc Du, 2022", theme = "wine.pal")
par(par)
}
#dev.off()

ggplot() + geom_sf() + geom_sf(data=pot, aes(fill=min), lwd=0) +
  geom_sf(data=river3, col="white") +
  scale_fill_viridis("Tỉ lệ (%) tối thiểu\n trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(trinh_plot$prop.trinh[1],1), "% dân số", sep = "")) +
  ggtitle("Đường đồng mức tỉ lệ (%) trên dân số họ Trịnh") +
  coord_sf(crs = 4326)
ggsave(filename = file.path("figures", "Contour-River", "Trinh-Contour-River.jpeg"), width = 49, height = 33)
```

## Họ Dương

```{r, message=FALSE, warning=FALSE}
duong_sf <- dat_sf %>% mutate(prop.duong=(sum(subset(., Ho=="Dương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Dương")
duong_f <- duong_sf %>% select(MAXA, MATINH, songuoi, pro.pop, geometry) %>% st_as_sf(crs = 4326)
duong_f <- sf::st_transform(duong_f, 2154)
duong_plot <- duong_sf %>% select(pro.pop, prop.duong, geometry) %>% st_as_sf(crs = 4326)
# Convert to Spatial class
duong_sf2 <- duong_sf %>% select(MAXA, MATINH, songuoi, danso, pro.pop, geometry) %>% st_as_sf(crs = 4326)
duong_sf2 <- sf::st_transform(duong_sf2, 2154)
duong_sp <- as(duong_sf2, Class = "Spatial")

# Compute the potentials of population on a regular grid (50km span)
# function = exponential, beta = 2, span = 75 km
poppot <- stewart(knownpts = duong_sp, 
                  varname = "danso", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 10, 
                  resolution = 50000, 
                  mask = duong_sp, 
                  returnclass = "sf")

# Compute the potentials of family name on a regular grid (50km span)
# function = exponential, beta = 2, span = 75 km
namepot <- stewart(knownpts = duong_sp, 
                  varname = "songuoi", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 10, 
                  resolution = 50000, 
                  mask = duong_sp, 
                  returnclass = "sf")

# Create the ratio variable
# Handle NaN
"/" <- function(x,y) ifelse(y==0,0,base:::"/"(x,y))
poppot$OUTPUT2 <- namepot$OUTPUT * 100 / poppot$OUTPUT

# Discretize the variable
bv <- quantile(duong_sf$pro.pop, seq(from = 0, to = 1, length.out = 9))

# Create an isopleth layer
pot <- isopoly(x = poppot, var = "OUTPUT2",
               breaks = bv, 
               mask = duong_sp, 
               returnclass = "sf")

# rotate function (see here: https://r-spatial.github.io/sf/articles/sf3.html#affine-transformations
rot <- function(a) matrix(c(cos(a), sin(a), -sin(a), cos(a)), 2, 2)

# make a new geometry that is rotated 90 degrees (but retain original geom)
duong_rot <- duong_f %>% 
  mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
  st_drop_geometry() %>%
  rename(geometry = geom_rot) %>%
  st_set_geometry("geometry")
duong_rot <- as(duong_rot, Class = "Spatial")

pot_rot <- pot %>% 
   mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
   st_drop_geometry() %>%
   rename(geometry = geom_rot) %>%
   st_set_geometry("geometry")
#pot_rot <- st_as_sfc(pot_rot)
 
# Draw the basemap
#png(filename = "Duong_contourpoly.jpeg", width=2400, height=3200, res=300, bg = NA)
plot(duong_rot, add = F, border = NA, bg = "white")
# Map the potential family name per Pop
plot(st_geometry(pot_rot), add=T, lwd = 0.5, border = "grey30")
if(require(cartography)){
# Get breaks values
bks <-  sort(unique(c(pot$min, pot$max)))
# Set a color palette
pal <- carto.pal(pal1 = "wine.pal", n1 = 8)
# Draw the map
par <- par(mar = c(0,0,1.2,0))
# Display the map
choroLayer(x = pot_rot, var = "center", 
          legend.pos = "left",
          breaks = bks, col = pal, add=T, 
          border = NA, lwd = 0.2,
          legend.title.txt = "Tỉ lệ (%) trên dân số địa phương",
          legend.title.cex = 1,
          legend.values.cex = 0.6,
          legend.values.rnd = 1)
# Set a layout
layoutLayer(title = paste("Đường đồng mức tỉ lệ (%) trên dân số họ Dương", paste(round(duong_plot$prop.duong[1],1), "% dân số", sep = ""), sep=" - "),
sources = "Data source: Vietnam GSO", author = "Duc Du, 2022", theme = "wine.pal")
par(par)
}
#dev.off()

ggplot() + geom_sf() + geom_sf(data=pot, aes(fill=min), lwd=0) +
  geom_sf(data=river3, col="white") +
  scale_fill_viridis("Tỉ lệ (%) tối thiểu\n trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(duong_plot$prop.duong[1],1), "% dân số", sep = "")) +
  ggtitle("Đường đồng mức tỉ lệ (%) trên dân số họ Dương") +
  coord_sf(crs = 4326)
ggsave(filename = file.path("figures", "Contour-River", "Duong-Contour-River.jpeg"), width = 49, height = 33)
```
## Họ Hồ

```{r, message=FALSE, warning=FALSE}
ho_sf <- dat_sf %>% mutate(prop.ho=(sum(subset(., Ho=="Hồ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hồ")
ho_f <- ho_sf %>% select(MAXA, MATINH, songuoi, pro.pop, geometry) %>% st_as_sf(crs = 4326)
ho_f <- sf::st_transform(ho_f, 2154)
ho_plot <- ho_sf %>% select(pro.pop, prop.ho, geometry) %>% st_as_sf(crs = 4326)
# Convert to Spatial class
ho_sf2 <- ho_sf %>% select(MAXA, MATINH, songuoi, danso, pro.pop, geometry) %>% st_as_sf(crs = 4326)
ho_sf2 <- sf::st_transform(ho_sf2, 2154)
ho_sp <- as(ho_sf2, Class = "Spatial")

# Compute the potentials of population on a regular grid (50km span)
# function = exponential, beta = 2, span = 75 km
poppot <- stewart(knownpts = ho_sp, 
                  varname = "danso", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 10, 
                  resolution = 50000, 
                  mask = ho_sp, 
                  returnclass = "sf")

# Compute the potentials of family name on a regular grid (50km span)
# function = exponential, beta = 2, span = 75 km
namepot <- stewart(knownpts = ho_sp, 
                  varname = "songuoi", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 10, 
                  resolution = 50000, 
                  mask = ho_sp, 
                  returnclass = "sf")

# Create the ratio variable
# Handle NaN
"/" <- function(x,y) ifelse(y==0,0,base:::"/"(x,y))
poppot$OUTPUT2 <- namepot$OUTPUT * 100 / poppot$OUTPUT

# Discretize the variable
bv <- quantile(ho_sf$pro.pop, seq(from = 0, to = 1, length.out = 9))

# Create an isopleth layer
pot <- isopoly(x = poppot, var = "OUTPUT2",
               breaks = bv, 
               mask = ho_sp, 
               returnclass = "sf")

# rotate function (see here: https://r-spatial.github.io/sf/articles/sf3.html#affine-transformations
rot <- function(a) matrix(c(cos(a), sin(a), -sin(a), cos(a)), 2, 2)

# make a new geometry that is rotated 90 degrees (but retain original geom)
ho_rot <- ho_f %>% 
  mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
  st_drop_geometry() %>%
  rename(geometry = geom_rot) %>%
  st_set_geometry("geometry")
ho_rot <- as(ho_rot, Class = "Spatial")

pot_rot <- pot %>% 
   mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
   st_drop_geometry() %>%
   rename(geometry = geom_rot) %>%
   st_set_geometry("geometry")
#pot_rot <- st_as_sfc(pot_rot)
 
# Draw the basemap
#png(filename = "Ho_contourpoly.jpeg", width=2400, height=3200, res=300, bg = NA)
plot(ho_rot, add = F, border = NA, bg = "white")
# Map the potential family name per Pop
plot(st_geometry(pot_rot), add=T, lwd = 0.5, border = "grey30")
if(require(cartography)){
# Get breaks values
bks <-  sort(unique(c(pot$min, pot$max)))
# Set a color palette
pal <- carto.pal(pal1 = "wine.pal", n1 = 8)
# Draw the map
par <- par(mar = c(0,0,1.2,0))
# Display the map
choroLayer(x = pot_rot, var = "center", 
          legend.pos = "left",
          breaks = bks, col = pal, add=T, 
          border = NA, lwd = 0.2,
          legend.title.txt = "Tỉ lệ (%) trên dân số địa phương",
          legend.title.cex = 1,
          legend.values.cex = 0.6,
          legend.values.rnd = 1)
# Set a layout
layoutLayer(title = paste("Đường đồng mức tỉ lệ (%) trên dân số họ Hồ", paste(round(ho_plot$prop.ho[1],1), "% dân số", sep = ""), sep=" - "),
sources = "Data source: Vietnam GSO", author = "Duc Du, 2022", theme = "wine.pal")
par(par)
}
#dev.off()

ggplot() + geom_sf() + geom_sf(data=pot, aes(fill=min), lwd=0) +
  geom_sf(data=river3, col="white") +
  scale_fill_viridis("Tỉ lệ (%) tối thiểu\n trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(ho_plot$prop.ho[1],1), "% dân số", sep = "")) +
  ggtitle("Đường đồng mức tỉ lệ (%) trên dân số họ Hồ") +
  coord_sf(crs = 4326)
ggsave(filename = file.path("figures", "Contour-River", "Ho-Contour-River.jpeg"), width = 49, height = 33)
```
## Họ Hoàng

```{r, message=FALSE, warning=FALSE}
hoang_sf <- dat_sf %>% mutate(prop.hoang=(sum(subset(., Ho=="Hoàng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hoàng")
hoang_f <- hoang_sf %>% select(MAXA, MATINH, songuoi, pro.pop, geometry) %>% st_as_sf(crs = 4326)
hoang_f <- sf::st_transform(hoang_f, 2154)
hoang_plot <- hoang_sf %>% select(pro.pop, prop.hoang, geometry) %>% st_as_sf(crs = 4326)
# Convert to Spatial class
hoang_sf2 <- hoang_sf %>% select(MAXA, MATINH, songuoi, danso, pro.pop, geometry) %>% st_as_sf(crs = 4326)
hoang_sf2 <- sf::st_transform(hoang_sf2, 2154)
hoang_sp <- as(hoang_sf2, Class = "Spatial")

# Compute the potentials of population on a regular grid (50km span)
# function = exponential, beta = 2, span = 75 km
poppot <- stewart(knownpts = hoang_sp, 
                  varname = "danso", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 10, 
                  resolution = 50000, 
                  mask = hoang_sp, 
                  returnclass = "sf")

# Compute the potentials of family name on a regular grid (50km span)
# function = exponential, beta = 2, span = 75 km
namepot <- stewart(knownpts = hoang_sp, 
                  varname = "songuoi", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 10, 
                  resolution = 50000, 
                  mask = hoang_sp, 
                  returnclass = "sf")

# Create the ratio variable
# Handle NaN
"/" <- function(x,y) ifelse(y==0,0,base:::"/"(x,y))
poppot$OUTPUT2 <- namepot$OUTPUT * 100 / poppot$OUTPUT

# Discretize the variable
bv <- quantile(hoang_sf$pro.pop, seq(from = 0, to = 1, length.out = 9))

# Create an isopleth layer
pot <- isopoly(x = poppot, var = "OUTPUT2",
               breaks = bv, 
               mask = hoang_sp, 
               returnclass = "sf")

# rotate function (see here: https://r-spatial.github.io/sf/articles/sf3.html#affine-transformations
rot <- function(a) matrix(c(cos(a), sin(a), -sin(a), cos(a)), 2, 2)

# make a new geometry that is rotated 90 degrees (but retain original geom)
hoang_rot <- hoang_f %>% 
  mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
  st_drop_geometry() %>%
  rename(geometry = geom_rot) %>%
  st_set_geometry("geometry")
hoang_rot <- as(hoang_rot, Class = "Spatial")

pot_rot <- pot %>% 
   mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
   st_drop_geometry() %>%
   rename(geometry = geom_rot) %>%
   st_set_geometry("geometry")
#pot_rot <- st_as_sfc(pot_rot)
 
# Draw the basemap
#png(filename = "Hoang_contourpoly.jpeg", width=2400, height=3200, res=300, bg = NA)
plot(hoang_rot, add = F, border = NA, bg = "white")
# Map the potential family name per Pop
plot(st_geometry(pot_rot), add=T, lwd = 0.5, border = "grey30")
if(require(cartography)){
# Get breaks values
bks <-  sort(unique(c(pot$min, pot$max)))
# Set a color palette
pal <- carto.pal(pal1 = "wine.pal", n1 = 8)
# Draw the map
par <- par(mar = c(0,0,1.2,0))
# Display the map
choroLayer(x = pot_rot, var = "center", 
          legend.pos = "left",
          breaks = bks, col = pal, add=T, 
          border = NA, lwd = 0.2,
          legend.title.txt = "Tỉ lệ (%) trên dân số địa phương",
          legend.title.cex = 1,
          legend.values.cex = 0.6,
          legend.values.rnd = 1)
# Set a layout
layoutLayer(title = paste("Đường đồng mức tỉ lệ (%) trên dân số họ Hoàng", paste(round(hoang_plot$prop.hoang[1],1), "% dân số", sep = ""), sep=" - "),
sources = "Data source: Vietnam GSO", author = "Duc Du, 2022", theme = "wine.pal")
par(par)
}
#dev.off()

ggplot() + geom_sf() + geom_sf(data=pot, aes(fill=min), lwd=0) +
  geom_sf(data=river3, col="white") +
  scale_fill_viridis("Tỉ lệ (%) tối thiểu\n trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(hoang_plot$prop.hoang[1],1), "% dân số", sep = "")) +
  ggtitle("Đường đồng mức tỉ lệ (%) trên dân số họ Hoàng") +
  coord_sf(crs = 4326)
ggsave(filename = file.path("figures", "Contour-River", "Hoang-Contour-River.jpeg"), width = 49, height = 33)
```

## Họ Huỳnh

```{r, message=FALSE, warning=FALSE}
huynh_sf <- dat_sf %>% mutate(prop.huynh=(sum(subset(., Ho=="Huỳnh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Huỳnh")
huynh_f <- huynh_sf %>% select(MAXA, MATINH, songuoi, pro.pop, geometry) %>% st_as_sf(crs = 4326)
huynh_f <- sf::st_transform(huynh_f, 2154)
huynh_plot <- huynh_sf %>% select(pro.pop, prop.huynh, geometry) %>% st_as_sf(crs = 4326)
# Convert to Spatial class
huynh_sf2 <- huynh_sf %>% select(MAXA, MATINH, songuoi, danso, pro.pop, geometry) %>% st_as_sf(crs = 4326)
huynh_sf2 <- sf::st_transform(huynh_sf2, 2154)
huynh_sp <- as(huynh_sf2, Class = "Spatial")

# Compute the potentials of population on a regular grid (50km span)
# function = exponential, beta = 2, span = 75 km
poppot <- stewart(knownpts = huynh_sp, 
                  varname = "danso", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 10, 
                  resolution = 50000, 
                  mask = huynh_sp, 
                  returnclass = "sf")

# Compute the potentials of family name on a regular grid (50km span)
# function = exponential, beta = 2, span = 75 km
namepot <- stewart(knownpts = huynh_sp, 
                  varname = "songuoi", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 10, 
                  resolution = 50000, 
                  mask = huynh_sp, 
                  returnclass = "sf")

# Create the ratio variable
# Handle NaN
"/" <- function(x,y) ifelse(y==0,0,base:::"/"(x,y))
poppot$OUTPUT2 <- namepot$OUTPUT * 100 / poppot$OUTPUT

# Discretize the variable
bv <- quantile(huynh_sf$pro.pop, seq(from = 0, to = 1, length.out = 9))

# Create an isopleth layer
pot <- isopoly(x = poppot, var = "OUTPUT2",
               breaks = bv, 
               mask = huynh_sp, 
               returnclass = "sf")

# rotate function (see here: https://r-spatial.github.io/sf/articles/sf3.html#affine-transformations
rot <- function(a) matrix(c(cos(a), sin(a), -sin(a), cos(a)), 2, 2)

# make a new geometry that is rotated 90 degrees (but retain original geom)
huynh_rot <- huynh_f %>% 
  mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
  st_drop_geometry() %>%
  rename(geometry = geom_rot) %>%
  st_set_geometry("geometry")
hoang_rot <- as(huynh_rot, Class = "Spatial")

pot_rot <- pot %>% 
   mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
   st_drop_geometry() %>%
   rename(geometry = geom_rot) %>%
   st_set_geometry("geometry")
#pot_rot <- st_as_sfc(pot_rot)
 
# Draw the basemap
#png(filename = "Huynh_contourpoly.jpeg", width=2400, height=3200, res=300, bg = NA)
plot(hoang_rot, add = F, border = NA, bg = "white")
# Map the potential family name per Pop
plot(st_geometry(pot_rot), add=T, lwd = 0.5, border = "grey30")
if(require(cartography)){
# Get breaks values
bks <-  sort(unique(c(pot$min, pot$max)))
# Set a color palette
pal <- carto.pal(pal1 = "wine.pal", n1 = 8)
# Draw the map
par <- par(mar = c(0,0,1.2,0))
# Display the map
choroLayer(x = pot_rot, var = "center", 
          legend.pos = "left",
          breaks = bks, col = pal, add=T, 
          border = NA, lwd = 0.2,
          legend.title.txt = "Tỉ lệ (%) trên dân số địa phương",
          legend.title.cex = 1,
          legend.values.cex = 0.6,
          legend.values.rnd = 1)
# Set a layout
layoutLayer(title = paste("Đường đồng mức tỉ lệ (%) trên dân số họ Huỳnh", paste(round(huynh_plot$prop.huynh[1],1), "% dân số", sep = ""), sep=" - "),
sources = "Data source: Vietnam GSO", author = "Duc Du, 2022", theme = "wine.pal")
par(par)
}
#dev.off()

ggplot() + geom_sf() + geom_sf(data=pot, aes(fill=min), lwd=0) +
  geom_sf(data=river3, col="white") +
  scale_fill_viridis("Tỉ lệ (%) tối thiểu\n trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(huynh_plot$prop.huynh[1],1), "% dân số", sep = "")) +
  ggtitle("Đường đồng mức tỉ lệ (%) trên dân số họ Huỳnh") +
  coord_sf(crs = 4326)
ggsave(filename = file.path("figures", "Contour-River", "Huynh-Contour-River.jpeg"), width = 49, height = 33)
```

## Họ Phan

```{r, message=FALSE, warning=FALSE}
phan_sf <- dat_sf %>% mutate(prop.phan=(sum(subset(., Ho=="Phan")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phan")
phan_f <- phan_sf %>% select(MAXA, MATINH, songuoi, pro.pop, geometry) %>% st_as_sf(crs = 4326)
phan_f <- sf::st_transform(phan_f, 2154)
phan_plot <- phan_sf %>% select(pro.pop, prop.phan, geometry) %>% st_as_sf(crs = 4326)
# Convert to Spatial class
phan_sf2 <- phan_sf %>% select(MAXA, MATINH, songuoi, danso, pro.pop, geometry) %>% st_as_sf(crs = 4326)
phan_sf2 <- sf::st_transform(phan_sf2, 2154)
phan_sp <- as(phan_sf2, Class = "Spatial")

# Compute the potentials of population on a regular grid (50km span)
# function = exponential, beta = 2, span = 75 km
poppot <- stewart(knownpts = phan_sp, 
                  varname = "danso", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 10, 
                  resolution = 50000, 
                  mask = phan_sp, 
                  returnclass = "sf")

# Compute the potentials of family name on a regular grid (50km span)
# function = exponential, beta = 2, span = 75 km
namepot <- stewart(knownpts = phan_sp, 
                  varname = "songuoi", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 10, 
                  resolution = 50000, 
                  mask = phan_sp, 
                  returnclass = "sf")

# Create the ratio variable
# Handle NaN
"/" <- function(x,y) ifelse(y==0,0,base:::"/"(x,y))
poppot$OUTPUT2 <- namepot$OUTPUT * 100 / poppot$OUTPUT

# Discretize the variable
bv <- quantile(phan_sf$pro.pop, seq(from = 0, to = 1, length.out = 9))

# Create an isopleth layer
pot <- isopoly(x = poppot, var = "OUTPUT2",
               breaks = bv, 
               mask = phan_sp, 
               returnclass = "sf")

# rotate function (see here: https://r-spatial.github.io/sf/articles/sf3.html#affine-transformations
rot <- function(a) matrix(c(cos(a), sin(a), -sin(a), cos(a)), 2, 2)

# make a new geometry that is rotated 90 degrees (but retain original geom)
phan_rot <- phan_f %>% 
  mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
  st_drop_geometry() %>%
  rename(geometry = geom_rot) %>%
  st_set_geometry("geometry")
phan_rot <- as(phan_rot, Class = "Spatial")

pot_rot <- pot %>% 
   mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
   st_drop_geometry() %>%
   rename(geometry = geom_rot) %>%
   st_set_geometry("geometry")
#pot_rot <- st_as_sfc(pot_rot)
 
# Draw the basemap
#png(filename = "Phan_contourpoly.jpeg", width=2400, height=3200, res=300, bg = NA)
plot(phan_rot, add = F, border = NA, bg = "white")
# Map the potential family name per Pop
plot(st_geometry(pot_rot), add=T, lwd = 0.5, border = "grey30")
if(require(cartography)){
# Get breaks values
bks <-  sort(unique(c(pot$min, pot$max)))
# Set a color palette
pal <- carto.pal(pal1 = "wine.pal", n1 = 8)
# Draw the map
par <- par(mar = c(0,0,1.2,0))
# Display the map
choroLayer(x = pot_rot, var = "center", 
          legend.pos = "left",
          breaks = bks, col = pal, add=T, 
          border = NA, lwd = 0.2,
          legend.title.txt = "Tỉ lệ (%) trên dân số địa phương",
          legend.title.cex = 1,
          legend.values.cex = 0.6,
          legend.values.rnd = 1)
# Set a layout
layoutLayer(title = paste("Đường đồng mức tỉ lệ (%) trên dân số họ Phan", paste(round(phan_plot$prop.phan[1],1), "% dân số", sep = ""), sep=" - "),
sources = "Data source: Vietnam GSO", author = "Duc Du, 2022", theme = "wine.pal")
par(par)
}
#dev.off()

ggplot() + geom_sf() + geom_sf(data=pot, aes(fill=min), lwd=0) +
  geom_sf(data=river3, col="white") +
  scale_fill_viridis("Tỉ lệ (%) tối thiểu\n trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(phan_plot$prop.phan[1],1), "% dân số", sep = "")) +
  ggtitle("Đường đồng mức tỉ lệ (%) trên dân số họ Phan") +
  coord_sf(crs = 4326)
ggsave(filename = file.path("figures", "Contour-River", "Phan-Contour-River.jpeg"), width = 49, height = 33)
```

## Họ Phạm

```{r, message=FALSE, warning=FALSE}
pham_sf <- dat_sf %>% mutate(prop.pham=(sum(subset(., Ho=="Phạm")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phạm")
pham_f <- pham_sf %>% select(MAXA, MATINH, songuoi, pro.pop, geometry) %>% st_as_sf(crs = 4326)
pham_f <- sf::st_transform(pham_f, 2154)
pham_plot <- pham_sf %>% select(pro.pop, prop.pham, geometry) %>% st_as_sf(crs = 4326)
# Convert to Spatial class
pham_sf2 <- pham_sf %>% select(MAXA, MATINH, songuoi, danso, pro.pop, geometry) %>% st_as_sf(crs = 4326)
pham_sf2 <- sf::st_transform(pham_sf2, 2154)
pham_sp <- as(pham_sf2, Class = "Spatial")

# Compute the potentials of population on a regular grid (50km span)
# function = exponential, beta = 2, span = 75 km
poppot <- stewart(knownpts = pham_sp, 
                  varname = "danso", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 10, 
                  resolution = 50000, 
                  mask = pham_sp, 
                  returnclass = "sf")

# Compute the potentials of family name on a regular grid (50km span)
# function = exponential, beta = 2, span = 75 km
namepot <- stewart(knownpts = pham_sp, 
                  varname = "songuoi", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 10, 
                  resolution = 50000, 
                  mask = pham_sp, 
                  returnclass = "sf")

# Create the ratio variable
# Handle NaN
"/" <- function(x,y) ifelse(y==0,0,base:::"/"(x,y))
poppot$OUTPUT2 <- namepot$OUTPUT * 100 / poppot$OUTPUT

# Discretize the variable
bv <- quantile(pham_sf$pro.pop, seq(from = 0, to = 1, length.out = 9))

# Create an isopleth layer
pot <- isopoly(x = poppot, var = "OUTPUT2",
               breaks = bv, 
               mask = pham_sp, 
               returnclass = "sf")

# rotate function (see here: https://r-spatial.github.io/sf/articles/sf3.html#affine-transformations
rot <- function(a) matrix(c(cos(a), sin(a), -sin(a), cos(a)), 2, 2)

# make a new geometry that is rotated 90 degrees (but retain original geom)
pham_rot <- pham_f %>% 
  mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
  st_drop_geometry() %>%
  rename(geometry = geom_rot) %>%
  st_set_geometry("geometry")
pham_rot <- as(pham_rot, Class = "Spatial")

pot_rot <- pot %>% 
   mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
   st_drop_geometry() %>%
   rename(geometry = geom_rot) %>%
   st_set_geometry("geometry")
#pot_rot <- st_as_sfc(pot_rot)
 
# Draw the basemap
#png(filename = "Pham_contourpoly.jpeg", width=2400, height=3200, res=300, bg = NA)
plot(pham_rot, add = F, border = NA, bg = "white")
# Map the potential family name per Pop
plot(st_geometry(pot_rot), add=T, lwd = 0.5, border = "grey30")
if(require(cartography)){
# Get breaks values
bks <-  sort(unique(c(pot$min, pot$max)))
# Set a color palette
pal <- carto.pal(pal1 = "wine.pal", n1 = 8)
# Draw the map
par <- par(mar = c(0,0,1.2,0))
# Display the map
choroLayer(x = pot_rot, var = "center", 
          legend.pos = "left",
          breaks = bks, col = pal, add=T, 
          border = NA, lwd = 0.2,
          legend.title.txt = "Tỉ lệ (%) trên dân số địa phương",
          legend.title.cex = 1,
          legend.values.cex = 0.6,
          legend.values.rnd = 1)
# Set a layout
layoutLayer(title = paste("Đường đồng mức tỉ lệ (%) trên dân số họ Phạm", paste(round(pham_plot$prop.pham[1],1), "% dân số", sep = ""), sep=" - "),
sources = "Data source: Vietnam GSO", author = "Duc Du, 2022", theme = "wine.pal")
par(par)
}
#dev.off()

ggplot() + geom_sf() + geom_sf(data=pot, aes(fill=min), lwd=0) +
  geom_sf(data=river3, col="white") +
  scale_fill_viridis("Tỉ lệ (%) tối thiểu\n trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(pham_plot$prop.pham[1],1), "% dân số", sep = "")) +
  ggtitle("Đường đồng mức tỉ lệ (%) trên dân số họ Phạm") +
  coord_sf(crs = 4326)
ggsave(filename = file.path("figures", "Contour-River", "Pham-Contour-River.jpeg"), width = 49, height = 33)
```

## Họ Vũ

```{r, message=FALSE, warning=FALSE}
vu_sf <- dat_sf %>% mutate(prop.vu=(sum(subset(., Ho=="Vũ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Vũ")
vu_f <- vu_sf %>% select(MAXA, MATINH, songuoi, pro.pop, geometry) %>% st_as_sf(crs = 4326)
vu_f <- sf::st_transform(vu_f, 2154)
vu_plot <- vu_sf %>% select(pro.pop, prop.vu, geometry) %>% st_as_sf(crs = 4326)
# Convert to Spatial class
vu_sf2 <- vu_sf %>% select(MAXA, MATINH, songuoi, danso, pro.pop, geometry) %>% st_as_sf(crs = 4326)
vu_sf2 <- sf::st_transform(vu_sf2, 2154)
vu_sp <- as(vu_sf2, Class = "Spatial")

# Compute the potentials of population on a regular grid (50km span)
# function = exponential, beta = 2, span = 75 km
poppot <- stewart(knownpts = vu_sp, 
                  varname = "danso", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 10, 
                  resolution = 50000, 
                  mask = vu_sp, 
                  returnclass = "sf")

# Compute the potentials of family name on a regular grid (50km span)
# function = exponential, beta = 2, span = 75 km
namepot <- stewart(knownpts = vu_sp, 
                  varname = "songuoi", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 10, 
                  resolution = 50000, 
                  mask = vu_sp, 
                  returnclass = "sf")

# Create the ratio variable
# Handle NaN
"/" <- function(x,y) ifelse(y==0,0,base:::"/"(x,y))
poppot$OUTPUT2 <- namepot$OUTPUT * 100 / poppot$OUTPUT

# Discretize the variable
bv <- quantile(vu_sf$pro.pop, seq(from = 0, to = 1, length.out = 9))

# Create an isopleth layer
pot <- isopoly(x = poppot, var = "OUTPUT2",
               breaks = bv, 
               mask = vu_sp, 
               returnclass = "sf")

# rotate function (see here: https://r-spatial.github.io/sf/articles/sf3.html#affine-transformations
rot <- function(a) matrix(c(cos(a), sin(a), -sin(a), cos(a)), 2, 2)

# make a new geometry that is rotated 90 degrees (but retain original geom)
vu_rot <- vu_f %>% 
  mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
  st_drop_geometry() %>%
  rename(geometry = geom_rot) %>%
  st_set_geometry("geometry")
vu_rot <- as(vu_rot, Class = "Spatial")

pot_rot <- pot %>% 
   mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
   st_drop_geometry() %>%
   rename(geometry = geom_rot) %>%
   st_set_geometry("geometry")
#pot_rot <- st_as_sfc(pot_rot)
 
# Draw the basemap
#png(filename = "Vu_contourpoly.jpeg", width=2400, height=3200, res=300, bg = NA)
plot(vu_rot, add = F, border = NA, bg = "white")
# Map the potential family name per Pop
plot(st_geometry(pot_rot), add=T, lwd = 0.5, border = "grey30")
if(require(cartography)){
# Get breaks values
bks <-  sort(unique(c(pot$min, pot$max)))
# Set a color palette
pal <- carto.pal(pal1 = "wine.pal", n1 = 8)
# Draw the map
par <- par(mar = c(0,0,1.2,0))
# Display the map
choroLayer(x = pot_rot, var = "center", 
          legend.pos = "left",
          breaks = bks, col = pal, add=T, 
          border = NA, lwd = 0.2,
          legend.title.txt = "Tỉ lệ (%) trên dân số địa phương",
          legend.title.cex = 1,
          legend.values.cex = 0.6,
          legend.values.rnd = 1)
# Set a layout
layoutLayer(title = paste("Đường đồng mức tỉ lệ (%) trên dân số họ Vũ", paste(round(vu_plot$prop.vu[1],1), "% dân số", sep = ""), sep=" - "),
sources = "Data source: Vietnam GSO", author = "Duc Du, 2022", theme = "wine.pal")
par(par)
}
#dev.off()

ggplot() + geom_sf() + geom_sf(data=pot, aes(fill=min), lwd=0) +
  geom_sf(data=river3, col="white") +
  scale_fill_viridis("Tỉ lệ (%) tối thiểu\n trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(vu_plot$prop.vu[1],1), "% dân số", sep = "")) +
  ggtitle("Đường đồng mức tỉ lệ (%) trên dân số họ Vũ") +
  coord_sf(crs = 4326)
ggsave(filename = file.path("figures", "Contour-River", "Vu-Contour-River.jpeg"), width = 49, height = 33)
```

## Họ Võ

```{r, message=FALSE, warning=FALSE}
vo_sf <- dat_sf %>% mutate(prop.vo=(sum(subset(., Ho=="Võ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Võ")
vo_f <- vo_sf %>% select(MAXA, MATINH, songuoi, pro.pop, geometry) %>% st_as_sf(crs = 4326)
vo_f <- sf::st_transform(vo_f, 2154)
vo_plot <- vo_sf %>% select(pro.pop, prop.vo, geometry) %>% st_as_sf(crs = 4326)
# Convert to Spatial class
vo_sf2 <- vo_sf %>% select(MAXA, MATINH, songuoi, danso, pro.pop, geometry) %>% st_as_sf(crs = 4326)
vo_sf2 <- sf::st_transform(vo_sf2, 2154)
vo_sp <- as(vo_sf2, Class = "Spatial")

# Compute the potentials of population on a regular grid (50km span)
# function = exponential, beta = 2, span = 75 km
poppot <- stewart(knownpts = vo_sp, 
                  varname = "danso", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 10, 
                  resolution = 50000, 
                  mask = vo_sp, 
                  returnclass = "sf")

# Compute the potentials of family name on a regular grid (50km span)
# function = exponential, beta = 2, span = 75 km
namepot <- stewart(knownpts = vo_sp, 
                  varname = "songuoi", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 10, 
                  resolution = 50000, 
                  mask = vo_sp, 
                  returnclass = "sf")

# Create the ratio variable
# Handle NaN
"/" <- function(x,y) ifelse(y==0,0,base:::"/"(x,y))
poppot$OUTPUT2 <- namepot$OUTPUT * 100 / poppot$OUTPUT

# Discretize the variable
bv <- quantile(vo_sf$pro.pop, seq(from = 0, to = 1, length.out = 9))

# Create an isopleth layer
pot <- isopoly(x = poppot, var = "OUTPUT2",
               breaks = bv, 
               mask = vo_sp, 
               returnclass = "sf")

# rotate function (see here: https://r-spatial.github.io/sf/articles/sf3.html#affine-transformations
rot <- function(a) matrix(c(cos(a), sin(a), -sin(a), cos(a)), 2, 2)

# make a new geometry that is rotated 90 degrees (but retain original geom)
vo_rot <- vo_f %>% 
  mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
  st_drop_geometry() %>%
  rename(geometry = geom_rot) %>%
  st_set_geometry("geometry")
vo_rot <- as(vo_rot, Class = "Spatial")

pot_rot <- pot %>% 
   mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
   st_drop_geometry() %>%
   rename(geometry = geom_rot) %>%
   st_set_geometry("geometry")
#pot_rot <- st_as_sfc(pot_rot)
 
# Draw the basemap
#png(filename = "Vo_contourpoly.jpeg", width=2400, height=3200, res=300, bg = NA)
plot(vo_rot, add = F, border = NA, bg = "white")
# Map the potential family name per Pop
plot(st_geometry(pot_rot), add=T, lwd = 0.5, border = "grey30")
if(require(cartography)){
# Get breaks values
bks <-  sort(unique(c(pot$min, pot$max)))
# Set a color palette
pal <- carto.pal(pal1 = "wine.pal", n1 = 8)
# Draw the map
par <- par(mar = c(0,0,1.2,0))
# Display the map
choroLayer(x = pot_rot, var = "center", 
          legend.pos = "left",
          breaks = bks, col = pal, add=T, 
          border = NA, lwd = 0.2,
          legend.title.txt = "Tỉ lệ (%) trên dân số địa phương",
          legend.title.cex = 1,
          legend.values.cex = 0.6,
          legend.values.rnd = 1)
# Set a layout
layoutLayer(title = paste("Đường đồng mức tỉ lệ (%) trên dân số họ Võ", paste(round(vo_plot$prop.vo[1],1), "% dân số", sep = ""), sep=" - "),
sources = "Data source: Vietnam GSO", author = "Duc Du, 2022", theme = "wine.pal")
par(par)
}
#dev.off()

ggplot() + geom_sf() + geom_sf(data=pot, aes(fill=min), lwd=0) +
  geom_sf(data=river3, col="white") +
  scale_fill_viridis("Tỉ lệ (%) tối thiểu\n trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(vo_plot$prop.vo[1],1), "% dân số", sep = "")) +
  ggtitle("Đường đồng mức tỉ lệ (%) trên dân số họ Võ") +
  coord_sf(crs = 4326)
ggsave(filename = file.path("figures", "Contour-River", "Vo-Contour-River.jpeg"), width = 49, height = 33)
```

## Họ Phùng

```{r, message=FALSE, warning=FALSE}
phung_sf <- dat_sf %>% mutate(prop.phung=(sum(subset(., Ho=="Phùng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phùng")
phung_f <- phung_sf %>% select(MAXA, MATINH, songuoi, pro.pop, geometry) %>% st_as_sf(crs = 4326)
phung_f <- sf::st_transform(phung_f, 2154)
phung_plot <- phung_sf %>% select(pro.pop, prop.phung, geometry) %>% st_as_sf(crs = 4326)
# Convert to Spatial class
phung_sf2 <- phung_sf %>% select(MAXA, MATINH, songuoi, danso, pro.pop, geometry) %>% st_as_sf(crs = 4326)
phung_sf2 <- sf::st_transform(phung_sf2, 2154)
phung_sp <- as(phung_sf2, Class = "Spatial")

# Compute the potentials of population on a regular grid (50km span)
# function = exponential, beta = 2, span = 75 km
poppot <- stewart(knownpts = phung_sp, 
                  varname = "danso", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 10, 
                  resolution = 50000, 
                  mask = phung_sp, 
                  returnclass = "sf")

# Compute the potentials of family name on a regular grid (50km span)
# function = exponential, beta = 2, span = 75 km
namepot <- stewart(knownpts = phung_sp, 
                  varname = "songuoi", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 10, 
                  resolution = 50000, 
                  mask = phung_sp, 
                  returnclass = "sf")

# Create the ratio variable
# Handle NaN
"/" <- function(x,y) ifelse(y==0,0,base:::"/"(x,y))
poppot$OUTPUT2 <- namepot$OUTPUT * 100 / poppot$OUTPUT

# Discretize the variable
bv <- quantile(phung_sf$pro.pop, seq(from = 0, to = 1, length.out = 9))

# Create an isopleth layer
pot <- isopoly(x = poppot, var = "OUTPUT2",
               breaks = bv, 
               mask = phung_sp, 
               returnclass = "sf")

# rotate function (see here: https://r-spatial.github.io/sf/articles/sf3.html#affine-transformations
rot <- function(a) matrix(c(cos(a), sin(a), -sin(a), cos(a)), 2, 2)

# make a new geometry that is rotated 90 degrees (but retain original geom)
phung_rot <- phung_f %>% 
  mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
  st_drop_geometry() %>%
  rename(geometry = geom_rot) %>%
  st_set_geometry("geometry")
phung_rot <- as(phung_rot, Class = "Spatial")

pot_rot <- pot %>% 
   mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
   st_drop_geometry() %>%
   rename(geometry = geom_rot) %>%
   st_set_geometry("geometry")
#pot_rot <- st_as_sfc(pot_rot)
 
# Draw the basemap
#png(filename = "Phung_contourpoly.jpeg", width=2400, height=3200, res=300, bg = NA)
plot(phung_rot, add = F, border = NA, bg = "white")
# Map the potential family name per Pop
plot(st_geometry(pot_rot), add=T, lwd = 0.5, border = "grey30")
if(require(cartography)){
# Get breaks values
bks <-  sort(unique(c(pot$min, pot$max)))
# Set a color palette
pal <- carto.pal(pal1 = "wine.pal", n1 = 8)
# Draw the map
par <- par(mar = c(0,0,1.2,0))
# Display the map
choroLayer(x = pot_rot, var = "center", 
          legend.pos = "left",
          breaks = bks, col = pal, add=T, 
          border = NA, lwd = 0.2,
          legend.title.txt = "Tỉ lệ (%) trên dân số địa phương",
          legend.title.cex = 1,
          legend.values.cex = 0.6,
          legend.values.rnd = 1)
# Set a layout
layoutLayer(title = paste("Đường đồng mức tỉ lệ (%) trên dân số họ Phùng", paste(round(phung_plot$prop.phung[1],1), "% dân số", sep = ""), sep=" - "),
sources = "Data source: Vietnam GSO", author = "Duc Du, 2022", theme = "wine.pal")
par(par)
}
#dev.off()

ggplot() + geom_sf() + geom_sf(data=pot, aes(fill=min), lwd=0) +
  geom_sf(data=river3, col="white") +
  scale_fill_viridis("Tỉ lệ (%) tối thiểu\n trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(phung_plot$prop.phung[1],1), "% dân số", sep = "")) +
  ggtitle("Đường đồng mức tỉ lệ (%) trên dân số họ Phùng") +
  coord_sf(crs = 4326)
ggsave(filename = file.path("figures", "Contour-River", "Phung-Contour-River.jpeg"), width = 49, height = 33)
```

## Họ Đỗ

```{r, message=FALSE, warning=FALSE}
do_sf <- dat_sf %>% mutate(prop.do=(sum(subset(., Ho=="Đỗ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đỗ")
do_f <- do_sf %>% select(MAXA, MATINH, songuoi, pro.pop, geometry) %>% st_as_sf(crs = 4326)
do_f <- sf::st_transform(do_f, 2154)
do_plot <- do_sf %>% select(pro.pop, prop.do, geometry) %>% st_as_sf(crs = 4326)
# Convert to Spatial class
do_sf2 <- do_sf %>% select(MAXA, MATINH, songuoi, danso, pro.pop, geometry) %>% st_as_sf(crs = 4326)
do_sf2 <- sf::st_transform(do_sf2, 2154)
do_sp <- as(do_sf2, Class = "Spatial")

# Compute the potentials of population on a regular grid (50km span)
# function = exponential, beta = 2, span = 75 km
poppot <- stewart(knownpts = do_sp, 
                  varname = "danso", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 10, 
                  resolution = 50000, 
                  mask = do_sp, 
                  returnclass = "sf")

# Compute the potentials of family name on a regular grid (50km span)
# function = exponential, beta = 2, span = 75 km
namepot <- stewart(knownpts = do_sp, 
                  varname = "songuoi", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 10, 
                  resolution = 50000, 
                  mask = do_sp, 
                  returnclass = "sf")

# Create the ratio variable
# Handle NaN
"/" <- function(x,y) ifelse(y==0,0,base:::"/"(x,y))
poppot$OUTPUT2 <- namepot$OUTPUT * 100 / poppot$OUTPUT

# Discretize the variable
bv <- quantile(do_sf$pro.pop, seq(from = 0, to = 1, length.out = 9))

# Create an isopleth layer
pot <- isopoly(x = poppot, var = "OUTPUT2",
               breaks = bv, 
               mask = do_sp, 
               returnclass = "sf")

# rotate function (see here: https://r-spatial.github.io/sf/articles/sf3.html#affine-transformations
rot <- function(a) matrix(c(cos(a), sin(a), -sin(a), cos(a)), 2, 2)

# make a new geometry that is rotated 90 degrees (but retain original geom)
do_rot <- do_f %>% 
  mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
  st_drop_geometry() %>%
  rename(geometry = geom_rot) %>%
  st_set_geometry("geometry")
do_rot <- as(do_rot, Class = "Spatial")

pot_rot <- pot %>% 
   mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
   st_drop_geometry() %>%
   rename(geometry = geom_rot) %>%
   st_set_geometry("geometry")
#pot_rot <- st_as_sfc(pot_rot)
 
# Draw the basemap
#png(filename = "Do_contourpoly.jpeg", width=2400, height=3200, res=300, bg = NA)
plot(do_rot, add = F, border = NA, bg = "white")
# Map the potential family name per Pop
plot(st_geometry(pot_rot), add=T, lwd = 0.5, border = "grey30")
if(require(cartography)){
# Get breaks values
bks <-  sort(unique(c(pot$min, pot$max)))
# Set a color palette
pal <- carto.pal(pal1 = "wine.pal", n1 = 8)
# Draw the map
par <- par(mar = c(0,0,1.2,0))
# Display the map
choroLayer(x = pot_rot, var = "center", 
          legend.pos = "left",
          breaks = bks, col = pal, add=T, 
          border = NA, lwd = 0.2,
          legend.title.txt = "Tỉ lệ (%) trên dân số địa phương",
          legend.title.cex = 1,
          legend.values.cex = 0.6,
          legend.values.rnd = 1)
# Set a layout
layoutLayer(title = paste("Đường đồng mức tỉ lệ (%) trên dân số họ Đỗ", paste(round(do_plot$prop.do[1],1), "% dân số", sep = ""), sep=" - "),
sources = "Data source: Vietnam GSO", author = "Duc Du, 2022", theme = "wine.pal")
par(par)
}
#dev.off()

ggplot() + geom_sf() + geom_sf(data=pot, aes(fill=min), lwd=0) +
  geom_sf(data=river3, col="white") +
  scale_fill_viridis("Tỉ lệ (%) tối thiểu\n trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(do_plot$prop.do[1],1), "% dân số", sep = "")) +
  ggtitle("Đường đồng mức tỉ lệ (%) trên dân số họ Đỗ") +
  coord_sf(crs = 4326)
ggsave(filename = file.path("figures", "Contour-River", "Do-Contour-River.jpeg"), width = 49, height = 33)
```

## Họ Khúc

```{r, message=FALSE, warning=FALSE}
khuc_sf <- dat_sf %>% mutate(prop.khuc=(sum(subset(., Ho=="Khúc")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Khúc")
khuc_f <- khuc_sf %>% select(MAXA, MATINH, songuoi, pro.pop, geometry) %>% st_as_sf(crs = 4326)
khuc_f <- sf::st_transform(khuc_f, 2154)
khuc_plot <- khuc_sf %>% select(pro.pop, prop.khuc, geometry) %>% st_as_sf(crs = 4326)
# Convert to Spatial class
khuc_sf2 <- khuc_sf %>% select(MAXA, MATINH, songuoi, danso, pro.pop, geometry) %>% st_as_sf(crs = 4326)
khuc_sf2 <- sf::st_transform(khuc_sf2, 2154)
khuc_sp <- as(khuc_sf2, Class = "Spatial")

# Compute the potentials of population on a regular grid (50km span)
# function = exponential, beta = 2, span = 75 km
poppot <- stewart(knownpts = khuc_sp, 
                  varname = "danso", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 10, 
                  resolution = 50000, 
                  mask = khuc_sp, 
                  returnclass = "sf")

# Compute the potentials of family name on a regular grid (50km span)
# function = exponential, beta = 2, span = 75 km
namepot <- stewart(knownpts = khuc_sp, 
                  varname = "songuoi", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 10, 
                  resolution = 50000, 
                  mask = khuc_sp, 
                  returnclass = "sf")

# Create the ratio variable
# Handle NaN
"/" <- function(x,y) ifelse(y==0,0,base:::"/"(x,y))
poppot$OUTPUT2 <- namepot$OUTPUT * 100 / poppot$OUTPUT

# Discretize the variable
bv <- quantile(khuc_sf$pro.pop, seq(from = 0, to = 1, length.out = 9))

# Create an isopleth layer
pot <- isopoly(x = poppot, var = "OUTPUT2",
               breaks = bv, 
               mask = khuc_sp, 
               returnclass = "sf")

# rotate function (see here: https://r-spatial.github.io/sf/articles/sf3.html#affine-transformations
rot <- function(a) matrix(c(cos(a), sin(a), -sin(a), cos(a)), 2, 2)

# make a new geometry that is rotated 90 degrees (but retain original geom)
khuc_rot <- khuc_f %>% 
  mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
  st_drop_geometry() %>%
  rename(geometry = geom_rot) %>%
  st_set_geometry("geometry")
khuc_rot <- as(khuc_rot, Class = "Spatial")

pot_rot <- pot %>% 
   mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
   st_drop_geometry() %>%
   rename(geometry = geom_rot) %>%
   st_set_geometry("geometry")
#pot_rot <- st_as_sfc(pot_rot)
 
# Draw the basemap
#png(filename = "Khuc_contourpoly.jpeg", width=2400, height=3200, res=300, bg = NA)
plot(khuc_rot, add = F, border = NA, bg = "white")
# Map the potential family name per Pop
plot(st_geometry(pot_rot), add=T, lwd = 0.5, border = "grey30")
if(require(cartography)){
# Get breaks values
bks <-  sort(unique(c(pot$min, pot$max)))
# Set a color palette
pal <- carto.pal(pal1 = "wine.pal", n1 = 8)
# Draw the map
par <- par(mar = c(0,0,1.2,0))
# Display the map
choroLayer(x = pot_rot, var = "center", 
          legend.pos = "left",
          breaks = bks, col = pal, add=T, 
          border = NA, lwd = 0.2,
          legend.title.txt = "Tỉ lệ (%) trên dân số địa phương",
          legend.title.cex = 1,
          legend.values.cex = 0.6,
          legend.values.rnd = 1)
# Set a layout
layoutLayer(title = paste("Đường đồng mức tỉ lệ (%) trên dân số họ Khúc", paste(round(khuc_plot$prop.khuc[1],2), "% dân số", sep = ""), sep=" - "),
sources = "Data source: Vietnam GSO", author = "Duc Du, 2022", theme = "wine.pal")
par(par)
}
#dev.off()

ggplot() + geom_sf() + geom_sf(data=pot, aes(fill=min), lwd=0) +
  geom_sf(data=river3, col="white") +
  scale_fill_viridis("Tỉ lệ (%) tối thiểu\n trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(khuc_plot$prop.khuc[1],2), "% dân số", sep = "")) +
  ggtitle("Đường đồng mức tỉ lệ (%) trên dân số họ Khúc") +
  coord_sf(crs = 4326)
ggsave(filename = file.path("figures", "Contour-River", "Khuc-Contour-River.jpeg"), width = 49, height = 33)
```

## Họ Mã

```{r, message=FALSE, warning=FALSE}
ma_sf <- dat_sf %>% mutate(prop.ma=(sum(subset(., Ho=="Mã")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mã")
ma_f <- ma_sf %>% select(MAXA, MATINH, songuoi, pro.pop, geometry) %>% st_as_sf(crs = 4326)
ma_f <- sf::st_transform(ma_f, 2154)
ma_plot <- ma_sf %>% select(pro.pop, prop.ma, geometry) %>% st_as_sf(crs = 4326)
# Convert to Spatial class
ma_sf2 <- ma_sf %>% select(MAXA, MATINH, songuoi, danso, pro.pop, geometry) %>% st_as_sf(crs = 4326)
ma_sf2 <- sf::st_transform(ma_sf2, 2154)
ma_sp <- as(ma_sf2, Class = "Spatial")

# Compute the potentials of population on a regular grid (50km span)
# function = exponential, beta = 2, span = 75 km
poppot <- stewart(knownpts = ma_sp, 
                  varname = "danso", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 10, 
                  resolution = 50000, 
                  mask = ma_sp, 
                  returnclass = "sf")

# Compute the potentials of family name on a regular grid (50km span)
# function = exponential, beta = 2, span = 75 km
namepot <- stewart(knownpts = ma_sp, 
                  varname = "songuoi", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 10, 
                  resolution = 50000, 
                  mask = ma_sp, 
                  returnclass = "sf")

# Create the ratio variable
# Handle NaN
"/" <- function(x,y) ifelse(y==0,0,base:::"/"(x,y))
poppot$OUTPUT2 <- namepot$OUTPUT * 100 / poppot$OUTPUT

# Discretize the variable
bv <- quantile(ma_sf$pro.pop, seq(from = 0, to = 1, length.out = 9))

# Create an isopleth layer
pot <- isopoly(x = poppot, var = "OUTPUT2",
               breaks = bv, 
               mask = ma_sp, 
               returnclass = "sf")

# rotate function (see here: https://r-spatial.github.io/sf/articles/sf3.html#affine-transformations
rot <- function(a) matrix(c(cos(a), sin(a), -sin(a), cos(a)), 2, 2)

# make a new geometry that is rotated 90 degrees (but retain original geom)
ma_rot <- ma_f %>% 
  mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
  st_drop_geometry() %>%
  rename(geometry = geom_rot) %>%
  st_set_geometry("geometry")
ma_rot <- as(ma_rot, Class = "Spatial")

pot_rot <- pot %>% 
   mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
   st_drop_geometry() %>%
   rename(geometry = geom_rot) %>%
   st_set_geometry("geometry")
#pot_rot <- st_as_sfc(pot_rot)
 
# Draw the basemap
#png(filename = "Ma_contourpoly.jpeg", width=2400, height=3200, res=300, bg = NA)
plot(ma_rot, add = F, border = NA, bg = "white")
# Map the potential family name per Pop
plot(st_geometry(pot_rot), add=T, lwd = 0.5, border = "grey30")
if(require(cartography)){
# Get breaks values
bks <-  sort(unique(c(pot$min, pot$max)))
# Set a color palette
pal <- carto.pal(pal1 = "wine.pal", n1 = 8)
# Draw the map
par <- par(mar = c(0,0,1.2,0))
# Display the map
choroLayer(x = pot_rot, var = "center", 
          legend.pos = "left",
          breaks = bks, col = pal, add=T, 
          border = NA, lwd = 0.2,
          legend.title.txt = "Tỉ lệ (%) trên dân số địa phương",
          legend.title.cex = 1,
          legend.values.cex = 0.6,
          legend.values.rnd = 1)
# Set a layout
layoutLayer(title = paste("Đường đồng mức tỉ lệ (%) trên dân số họ Mã", paste(round(ma_plot$prop.ma[1],1), "% dân số", sep = ""), sep=" - "),
sources = "Data source: Vietnam GSO", author = "Duc Du, 2022", theme = "wine.pal")
par(par)
}
#dev.off()

ggplot() + geom_sf() + geom_sf(data=pot, aes(fill=min), lwd=0) +
  geom_sf(data=river3, col="white") +
  scale_fill_viridis("Tỉ lệ (%) tối thiểu\n trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(ma_plot$prop.ma[1],1), "% dân số", sep = "")) +
  ggtitle("Đường đồng mức tỉ lệ (%) trên dân số họ Mã") +
  coord_sf(crs = 4326)
ggsave(filename = file.path("figures", "Contour-River", "Ma-Contour-River.jpeg"), width = 49, height = 33)
```

## Họ Mạc

```{r, message=FALSE, warning=FALSE}
mac_sf <- dat_sf %>% mutate(prop.mac=(sum(subset(., Ho=="Mạc")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mạc")
mac_f <- mac_sf %>% select(MAXA, MATINH, songuoi, pro.pop, geometry) %>% st_as_sf(crs = 4326)
mac_f <- sf::st_transform(mac_f, 2154)
mac_plot <- mac_sf %>% select(pro.pop, prop.mac, geometry) %>% st_as_sf(crs = 4326)
# Convert to Spatial class
mac_sf2 <- mac_sf %>% select(MAXA, MATINH, songuoi, danso, pro.pop, geometry) %>% st_as_sf(crs = 4326)
mac_sf2 <- sf::st_transform(mac_sf2, 2154)
mac_sp <- as(mac_sf2, Class = "Spatial")

# Compute the potentials of population on a regular grid (50km span)
# function = exponential, beta = 2, span = 75 km
poppot <- stewart(knownpts = mac_sp, 
                  varname = "danso", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 10, 
                  resolution = 50000, 
                  mask = mac_sp, 
                  returnclass = "sf")

# Compute the potentials of family name on a regular grid (50km span)
# function = exponential, beta = 2, span = 75 km
namepot <- stewart(knownpts = mac_sp, 
                  varname = "songuoi", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 10, 
                  resolution = 50000, 
                  mask = mac_sp, 
                  returnclass = "sf")

# Create the ratio variable
# Handle NaN
"/" <- function(x,y) ifelse(y==0,0,base:::"/"(x,y))
poppot$OUTPUT2 <- namepot$OUTPUT * 100 / poppot$OUTPUT

# Discretize the variable
bv <- quantile(mac_sf$pro.pop, seq(from = 0, to = 1, length.out = 9))

# Create an isopleth layer
pot <- isopoly(x = poppot, var = "OUTPUT2",
               breaks = bv, 
               mask = mac_sp, 
               returnclass = "sf")

# rotate function (see here: https://r-spatial.github.io/sf/articles/sf3.html#affine-transformations
rot <- function(a) matrix(c(cos(a), sin(a), -sin(a), cos(a)), 2, 2)

# make a new geometry that is rotated 90 degrees (but retain original geom)
mac_rot <- mac_f %>% 
  mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
  st_drop_geometry() %>%
  rename(geometry = geom_rot) %>%
  st_set_geometry("geometry")
mac_rot <- as(mac_rot, Class = "Spatial")

pot_rot <- pot %>% 
   mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
   st_drop_geometry() %>%
   rename(geometry = geom_rot) %>%
   st_set_geometry("geometry")
#pot_rot <- st_as_sfc(pot_rot)
 
# Draw the basemap
#png(filename = "Mac_contourpoly.jpeg", width=2400, height=3200, res=300, bg = NA)
plot(mac_rot, add = F, border = NA, bg = "white")
# Map the potential family name per Pop
plot(st_geometry(pot_rot), add=T, lwd = 0.5, border = "grey30")
if(require(cartography)){
# Get breaks values
bks <-  sort(unique(c(pot$min, pot$max)))
# Set a color palette
pal <- carto.pal(pal1 = "wine.pal", n1 = 8)
# Draw the map
par <- par(mar = c(0,0,1.2,0))
# Display the map
choroLayer(x = pot_rot, var = "center", 
          legend.pos = "left",
          breaks = bks, col = pal, add=T, 
          border = NA, lwd = 0.2,
          legend.title.txt = "Tỉ lệ (%) trên dân số địa phương",
          legend.title.cex = 1,
          legend.values.cex = 0.6,
          legend.values.rnd = 1)
# Set a layout
layoutLayer(title = paste("Đường đồng mức tỉ lệ (%) trên dân số họ Mạc", paste(round(mac_plot$prop.mac[1],1), "% dân số", sep = ""), sep=" - "),
sources = "Data source: Vietnam GSO", author = "Duc Du, 2022", theme = "wine.pal")
par(par)
}
#dev.off()

ggplot() + geom_sf() + geom_sf(data=pot, aes(fill=min), lwd=0) +
  geom_sf(data=river3, col="white") +
  scale_fill_viridis("Tỉ lệ (%) tối thiểu\n trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(mac_plot$prop.mac[1],1), "% dân số", sep = "")) +
  ggtitle("Đường đồng mức tỉ lệ (%) trên dân số họ Mạc") +
  coord_sf(crs = 4326)
ggsave(filename = file.path("figures", "Contour-River", "Mac-Contour-River.jpeg"), width = 49, height = 33)
```

## Họ Mai

```{r, message=FALSE, warning=FALSE}
mai_sf <- dat_sf %>% mutate(prop.mai=(sum(subset(., Ho=="Mai")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mai")
mai_f <- mai_sf %>% select(MAXA, MATINH, songuoi, pro.pop, geometry) %>% st_as_sf(crs = 4326)
mai_f <- sf::st_transform(mai_f, 2154)
mai_plot <- mai_sf %>% select(pro.pop, prop.mai, geometry) %>% st_as_sf(crs = 4326)
# Convert to Spatial class
mai_sf2 <- mai_sf %>% select(MAXA, MATINH, songuoi, danso, pro.pop, geometry) %>% st_as_sf(crs = 4326)
mai_sf2 <- sf::st_transform(mai_sf2, 2154)
mai_sp <- as(mai_sf2, Class = "Spatial")

# Compute the potentials of population on a regular grid (50km span)
# function = exponential, beta = 2, span = 75 km
poppot <- stewart(knownpts = mai_sp, 
                  varname = "danso", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 10, 
                  resolution = 50000, 
                  mask = mai_sp, 
                  returnclass = "sf")

# Compute the potentials of family name on a regular grid (50km span)
# function = exponential, beta = 2, span = 75 km
namepot <- stewart(knownpts = mai_sp, 
                  varname = "songuoi", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 10, 
                  resolution = 50000, 
                  mask = mai_sp, 
                  returnclass = "sf")

# Create the ratio variable
# Handle NaN
"/" <- function(x,y) ifelse(y==0,0,base:::"/"(x,y))
poppot$OUTPUT2 <- namepot$OUTPUT * 100 / poppot$OUTPUT

# Discretize the variable
bv <- quantile(mai_sf$pro.pop, seq(from = 0, to = 1, length.out = 9))

# Create an isopleth layer
pot <- isopoly(x = poppot, var = "OUTPUT2",
               breaks = bv, 
               mask = mai_sp, 
               returnclass = "sf")

# rotate function (see here: https://r-spatial.github.io/sf/articles/sf3.html#affine-transformations
rot <- function(a) matrix(c(cos(a), sin(a), -sin(a), cos(a)), 2, 2)

# make a new geometry that is rotated 90 degrees (but retain original geom)
mai_rot <- mai_f %>% 
  mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
  st_drop_geometry() %>%
  rename(geometry = geom_rot) %>%
  st_set_geometry("geometry")
mai_rot <- as(mai_rot, Class = "Spatial")

pot_rot <- pot %>% 
   mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
   st_drop_geometry() %>%
   rename(geometry = geom_rot) %>%
   st_set_geometry("geometry")
#pot_rot <- st_as_sfc(pot_rot)
 
# Draw the basemap
#png(filename = "Mai_contourpoly.jpeg", width=2400, height=3200, res=300, bg = NA)
plot(mai_rot, add = F, border = NA, bg = "white")
# Map the potential family name per Pop
plot(st_geometry(pot_rot), add=T, lwd = 0.5, border = "grey30")
if(require(cartography)){
# Get breaks values
bks <-  sort(unique(c(pot$min, pot$max)))
# Set a color palette
pal <- carto.pal(pal1 = "wine.pal", n1 = 8)
# Draw the map
par <- par(mar = c(0,0,1.2,0))
# Display the map
choroLayer(x = pot_rot, var = "center", 
          legend.pos = "left",
          breaks = bks, col = pal, add=T, 
          border = NA, lwd = 0.2,
          legend.title.txt = "Tỉ lệ (%) trên dân số địa phương",
          legend.title.cex = 1,
          legend.values.cex = 0.6,
          legend.values.rnd = 1)
# Set a layout
layoutLayer(title = paste("Đường đồng mức tỉ lệ (%) trên dân số họ Mai", paste(round(mai_plot$prop.mai[1],1), "% dân số", sep = ""), sep=" - "),
sources = "Data source: Vietnam GSO", author = "Duc Du, 2022", theme = "wine.pal")
par(par)
}
#dev.off()

ggplot() + geom_sf() + geom_sf(data=pot, aes(fill=min), lwd=0) +
  geom_sf(data=river3, col="white") +
  scale_fill_viridis("Tỉ lệ (%) tối thiểu\n trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(mai_plot$prop.mai[1],1), "% dân số", sep = "")) +
  ggtitle("Đường đồng mức tỉ lệ (%) trên dân số họ Mai") +
  coord_sf(crs = 4326)
ggsave(filename = file.path("figures", "Contour-River", "Mai-Contour-River.jpeg"), width = 49, height = 33)
```

## Họ Tôn

```{r, message=FALSE, warning=FALSE}
ton_sf <- dat_sf %>% mutate(prop.ton=(sum(subset(., Ho=="Tôn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Tôn")
ton_f <- ton_sf %>% select(MAXA, MATINH, songuoi, pro.pop, geometry) %>% st_as_sf(crs = 4326)
ton_f <- sf::st_transform(ton_f, 2154)
ton_plot <- ton_sf %>% select(pro.pop, prop.ton, geometry) %>% st_as_sf(crs = 4326)
# Convert to Spatial class
ton_sf2 <- ton_sf %>% select(MAXA, MATINH, songuoi, danso, pro.pop, geometry) %>% st_as_sf(crs = 4326)
ton_sf2 <- sf::st_transform(ton_sf2, 2154)
ton_sp <- as(ton_sf2, Class = "Spatial")

# Compute the potentials of population on a regular grid (50km span)
# function = exponential, beta = 2, span = 75 km
poppot <- stewart(knownpts = ton_sp, 
                  varname = "danso", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 10, 
                  resolution = 50000, 
                  mask = ton_sp, 
                  returnclass = "sf")

# Compute the potentials of family name on a regular grid (50km span)
# function = exponential, beta = 2, span = 75 km
namepot <- stewart(knownpts = ton_sp, 
                  varname = "songuoi", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 10, 
                  resolution = 50000, 
                  mask = ton_sp, 
                  returnclass = "sf")

# Create the ratio variable
# Handle NaN
"/" <- function(x,y) ifelse(y==0,0,base:::"/"(x,y))
poppot$OUTPUT2 <- namepot$OUTPUT * 100 / poppot$OUTPUT

# Discretize the variable
bv <- quantile(ton_sf$pro.pop, seq(from = 0, to = 1, length.out = 9))

# Create an isopleth layer
pot <- isopoly(x = poppot, var = "OUTPUT2",
               breaks = bv, 
               mask = ton_sp, 
               returnclass = "sf")

# rotate function (see here: https://r-spatial.github.io/sf/articles/sf3.html#affine-transformations
rot <- function(a) matrix(c(cos(a), sin(a), -sin(a), cos(a)), 2, 2)

# make a new geometry that is rotated 90 degrees (but retain original geom)
ton_rot <- ton_f %>% 
  mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
  st_drop_geometry() %>%
  rename(geometry = geom_rot) %>%
  st_set_geometry("geometry")
ton_rot <- as(ton_rot, Class = "Spatial")

pot_rot <- pot %>% 
   mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
   st_drop_geometry() %>%
   rename(geometry = geom_rot) %>%
   st_set_geometry("geometry")
#pot_rot <- st_as_sfc(pot_rot)
 
# Draw the basemap
#png(filename = "Ton_contourpoly.jpeg", width=2400, height=3200, res=300, bg = NA)
plot(ton_rot, add = F, border = NA, bg = "white")
# Map the potential family name per Pop
plot(st_geometry(pot_rot), add=T, lwd = 0.5, border = "grey30")
if(require(cartography)){
# Get breaks values
bks <-  sort(unique(c(pot$min, pot$max)))
# Set a color palette
pal <- carto.pal(pal1 = "wine.pal", n1 = 8)
# Draw the map
par <- par(mar = c(0,0,1.2,0))
# Display the map
choroLayer(x = pot_rot, var = "center", 
          legend.pos = "left",
          breaks = bks, col = pal, add=T, 
          border = NA, lwd = 0.2,
          legend.title.txt = "Tỉ lệ (%) trên dân số địa phương",
          legend.title.cex = 1,
          legend.values.cex = 0.6,
          legend.values.rnd = 1)
# Set a layout
layoutLayer(title = paste("Đường đồng mức tỉ lệ (%) trên dân số họ Tôn", paste(round(ton_plot$prop.ton[1],2), "% dân số", sep = ""), sep=" - "),
sources = "Data source: Vietnam GSO", author = "Duc Du, 2022", theme = "wine.pal")
par(par)
}
#dev.off()

ggplot() + geom_sf() + geom_sf(data=pot, aes(fill=min), lwd=0) +
  geom_sf(data=river3, col="white") +
  scale_fill_viridis("Tỉ lệ (%) tối thiểu\n trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(ton_plot$prop.ton[1],2), "% dân số", sep = "")) +
  ggtitle("Đường đồng mức tỉ lệ (%) trên dân số họ Tôn") +
  coord_sf(crs = 4326)
ggsave(filename = file.path("figures", "Contour-River", "Ton-Contour-River.jpeg"), width = 49, height = 33)
```

## Họ Trương

```{r, message=FALSE, warning=FALSE}
truong_sf <- dat_sf %>% mutate(prop.truong=(sum(subset(., Ho=="Trương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trương")
truong_f <- truong_sf %>% select(MAXA, MATINH, songuoi, pro.pop, geometry) %>% st_as_sf(crs = 4326)
truong_f <- sf::st_transform(truong_f, 2154)
truong_plot <- truong_sf %>% select(pro.pop, prop.truong, geometry) %>% st_as_sf(crs = 4326)
# Convert to Spatial class
truong_sf2 <- truong_sf %>% select(MAXA, MATINH, songuoi, danso, pro.pop, geometry) %>% st_as_sf(crs = 4326)
truong_sf2 <- sf::st_transform(truong_sf2, 2154)
truong_sp <- as(truong_sf2, Class = "Spatial")

# Compute the potentials of population on a regular grid (50km span)
# function = exponential, beta = 2, span = 75 km
poppot <- stewart(knownpts = truong_sp, 
                  varname = "danso", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 10, 
                  resolution = 50000, 
                  mask = truong_sp, 
                  returnclass = "sf")

# Compute the potentials of family name on a regular grid (50km span)
# function = exponential, beta = 2, span = 75 km
namepot <- stewart(knownpts = truong_sp, 
                  varname = "songuoi", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 10, 
                  resolution = 50000, 
                  mask = truong_sp, 
                  returnclass = "sf")

# Create the ratio variable
# Handle NaN
"/" <- function(x,y) ifelse(y==0,0,base:::"/"(x,y))
poppot$OUTPUT2 <- namepot$OUTPUT * 100 / poppot$OUTPUT

# Discretize the variable
bv <- quantile(truong_sf$pro.pop, seq(from = 0, to = 1, length.out = 9))

# Create an isopleth layer
pot <- isopoly(x = poppot, var = "OUTPUT2",
               breaks = bv, 
               mask = truong_sp, 
               returnclass = "sf")

# rotate function (see here: https://r-spatial.github.io/sf/articles/sf3.html#affine-transformations
rot <- function(a) matrix(c(cos(a), sin(a), -sin(a), cos(a)), 2, 2)

# make a new geometry that is rotated 90 degrees (but retain original geom)
truong_rot <- truong_f %>% 
  mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
  st_drop_geometry() %>%
  rename(geometry = geom_rot) %>%
  st_set_geometry("geometry")
truong_rot <- as(truong_rot, Class = "Spatial")

pot_rot <- pot %>% 
   mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
   st_drop_geometry() %>%
   rename(geometry = geom_rot) %>%
   st_set_geometry("geometry")
#pot_rot <- st_as_sfc(pot_rot)
 
# Draw the basemap
#png(filename = "Truong_contourpoly.jpeg", width=2400, height=3200, res=300, bg = NA)
plot(truong_rot, add = F, border = NA, bg = "white")
# Map the potential family name per Pop
plot(st_geometry(pot_rot), add=T, lwd = 0.5, border = "grey30")
if(require(cartography)){
# Get breaks values
bks <-  sort(unique(c(pot$min, pot$max)))
# Set a color palette
pal <- carto.pal(pal1 = "wine.pal", n1 = 8)
# Draw the map
par <- par(mar = c(0,0,1.2,0))
# Display the map
choroLayer(x = pot_rot, var = "center", 
          legend.pos = "left",
          breaks = bks, col = pal, add=T, 
          border = NA, lwd = 0.2,
          legend.title.txt = "Tỉ lệ (%) trên dân số địa phương",
          legend.title.cex = 1,
          legend.values.cex = 0.6,
          legend.values.rnd = 1)
# Set a layout
layoutLayer(title = paste("Đường đồng mức tỉ lệ (%) trên dân số họ Trương", paste(round(truong_plot$prop.truong[1],1), "% dân số", sep = ""), sep=" - "),
sources = "Data source: Vietnam GSO", author = "Duc Du, 2022", theme = "wine.pal")
par(par)
}
#dev.off()

ggplot() + geom_sf() + geom_sf(data=pot, aes(fill=min), lwd=0) +
  geom_sf(data=river3, col="white") +
  scale_fill_viridis("Tỉ lệ (%) tối thiểu\n trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(truong_plot$prop.truong[1],1), "% dân số", sep = "")) +
  ggtitle("Đường đồng mức tỉ lệ (%) trên dân số họ Trương") +
  coord_sf(crs = 4326)
ggsave(filename = file.path("figures", "Contour-River", "Truong-Contour-River.jpeg"), width = 49, height = 33)
```

## Họ Vi

```{r, message=FALSE, warning=FALSE}
vi_sf <- dat_sf %>% mutate(prop.vi=(sum(subset(., Ho=="Vi")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Vi")
vi_f <- vi_sf %>% select(MAXA, MATINH, songuoi, pro.pop, geometry) %>% st_as_sf(crs = 4326)
vi_f <- sf::st_transform(vi_f, 2154)
vi_plot <- vi_sf %>% select(pro.pop, prop.vi, geometry) %>% st_as_sf(crs = 4326)
# Convert to Spatial class
vi_sf2 <- vi_sf %>% select(MAXA, MATINH, songuoi, danso, pro.pop, geometry) %>% st_as_sf(crs = 4326)
vi_sf2 <- sf::st_transform(vi_sf2, 2154)
vi_sp <- as(vi_sf2, Class = "Spatial")

# Compute the potentials of population on a regular grid (50km span)
# function = exponential, beta = 2, span = 75 km
poppot <- stewart(knownpts = vi_sp, 
                  varname = "danso", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 10, 
                  resolution = 50000, 
                  mask = vi_sp, 
                  returnclass = "sf")

# Compute the potentials of family name on a regular grid (50km span)
# function = exponential, beta = 2, span = 75 km
namepot <- stewart(knownpts = vi_sp, 
                  varname = "songuoi", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 10, 
                  resolution = 50000, 
                  mask = vi_sp, 
                  returnclass = "sf")

# Create the ratio variable
# Handle NaN
"/" <- function(x,y) ifelse(y==0,0,base:::"/"(x,y))
poppot$OUTPUT2 <- namepot$OUTPUT * 100 / poppot$OUTPUT

# Discretize the variable
bv <- quantile(vi_sf$pro.pop, seq(from = 0, to = 1, length.out = 9))

# Create an isopleth layer
pot <- isopoly(x = poppot, var = "OUTPUT2",
               breaks = bv, 
               mask = vi_sp, 
               returnclass = "sf")

# rotate function (see here: https://r-spatial.github.io/sf/articles/sf3.html#affine-transformations
rot <- function(a) matrix(c(cos(a), sin(a), -sin(a), cos(a)), 2, 2)

# make a new geometry that is rotated 90 degrees (but retain original geom)
vi_rot <- vi_f %>% 
  mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
  st_drop_geometry() %>%
  rename(geometry = geom_rot) %>%
  st_set_geometry("geometry")
vi_rot <- as(vi_rot, Class = "Spatial")

pot_rot <- pot %>% 
   mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
   st_drop_geometry() %>%
   rename(geometry = geom_rot) %>%
   st_set_geometry("geometry")
#pot_rot <- st_as_sfc(pot_rot)
 
# Draw the basemap
#png(filename = "Vi_contourpoly.jpeg", width=2400, height=3200, res=300, bg = NA)
plot(vi_rot, add = F, border = NA, bg = "white")
# Map the potential family name per Pop
plot(st_geometry(pot_rot), add=T, lwd = 0.5, border = "grey30")
if(require(cartography)){
# Get breaks values
bks <-  sort(unique(c(pot$min, pot$max)))
# Set a color palette
pal <- carto.pal(pal1 = "wine.pal", n1 = 8)
# Draw the map
par <- par(mar = c(0,0,1.2,0))
# Display the map
choroLayer(x = pot_rot, var = "center", 
          legend.pos = "left",
          breaks = bks, col = pal, add=T, 
          border = NA, lwd = 0.2,
          legend.title.txt = "Tỉ lệ (%) trên dân số địa phương",
          legend.title.cex = 1,
          legend.values.cex = 0.6,
          legend.values.rnd = 1)
# Set a layout
layoutLayer(title = paste("Đường đồng mức tỉ lệ (%) trên dân số họ Vi", paste(round(vi_plot$prop.vi[1],1), "% dân số", sep = ""), sep=" - "),
sources = "Data source: Vietnam GSO", author = "Duc Du, 2022", theme = "wine.pal")
par(par)
}
#dev.off()

ggplot() + geom_sf() + geom_sf(data=pot, aes(fill=min), lwd=0) +
  geom_sf(data=river3, col="white") +
  scale_fill_viridis("Tỉ lệ (%) tối thiểu\n trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(vi_plot$prop.vi[1],1), "% dân số", sep = "")) +
  ggtitle("Đường đồng mức tỉ lệ (%) trên dân số họ Vi") +
  coord_sf(crs = 4326)
ggsave(filename = file.path("figures", "Contour-River", "Vi-Contour-River.jpeg"), width = 49, height = 33)
```

## Contour Areas

## Họ Bùi

```{r, message=FALSE, warning=FALSE}
bui_sff <- dat_sff %>% mutate(prop.bui=(sum(subset(., Ho=="Bùi")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Bùi")
bui_ff <- bui_sff %>% select(MAXA, MATINH, songuoi, danso, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
bui_ff <- sf::st_transform(bui_ff, 2154)
bui_plotf <- bui_sff %>% select(songuoi_km, prop.bui, geometry) %>% st_as_sf(crs = 4326)

# Convert to Spatial class
bui_sff2 <- bui_sff %>% select(MAXA, MATINH, songuoi, danso, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
bui_sff2 <- sf::st_transform(bui_sff2, 2154)
bui_spf <- as(bui_sff2, Class = "Spatial")

# Compute the potentials of population on a regular grid (50km span)
# function = exponential, beta = 2, span = 75 km
poppotf <- stewart(knownpts = bui_spf, 
                  varname = "songuoi_km", 
                  typefct = "exponential", 
                  span = 1000, 
                  beta = 2, 
                  resolution = 50000, 
                  mask = bui_spf, 
                  returnclass = "sf")

# Discretize the variable
bv <- quantile(bui_sff$songuoi_km, seq(from = 0, to = 1, length.out = 9))

# Create an isopleth layer
potf <- isopoly(x = poppotf, var = "OUTPUT",
               breaks = bv, 
               mask = bui_spf, 
               returnclass = "sf")

# rotate function (see here: https://r-spatial.github.io/sf/articles/sf3.html#affine-transformations
rot <- function(a) matrix(c(cos(a), sin(a), -sin(a), cos(a)), 2, 2)

# make a new geometry that is rotated 90 degrees (but retain original geom)
bui_rotf <- bui_ff %>% 
  mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
  st_drop_geometry() %>%
  rename(geometry = geom_rot) %>%
  st_set_geometry("geometry")
bui_rotf <- as(bui_rotf, Class = "Spatial")

pot_rotf <- potf %>% 
   mutate(geom_rot = st_geometry(.)*rot(pi/2.5)) %>%
   st_drop_geometry() %>%
   rename(geometry = geom_rot) %>%
   st_set_geometry("geometry")
#pot_rotf <- st_as_sfc(pot_rotf)

# Draw the basemap
#png(filename = "Bui_contourpoly_area.jpeg", width=2400, height=3200, res=300, bg = NA)
plot(bui_rotf, add = F, border = NA, bg = "white")
# Map the potential family name per Pop
plot(st_geometry(pot_rotf), add=T, lwd = 0.5, border = "grey30")
if(require(cartography)){
# Get breaks values
bks <-  sort(unique(c(potf$min, potf$max)))
# Set a color palette
pal <- carto.pal(pal1 = "wine.pal", n1 = 8)
# Draw the map
par <- par(mar = c(0,0,1.2,0))
# Display the map
choroLayer(x = pot_rotf, var = "center", 
          legend.pos = "left",
          breaks = bks, col = pal, add=T, 
          border = NA, lwd = 0.2,
          legend.title.txt = "Số người trên 1 km2 tại địa phương",
          legend.title.cex = 1,
          legend.values.cex = 0.6,
          legend.values.rnd = 1)
# Set a layout
layoutLayer(title = paste("Đường đồng mức số người/km2 dân số họ Bùi", paste(round(bui_plotf$prop.bui[1],1), "% dân số", sep = ""), sep=" - "),
sources = "Data source: Vietnam GSO", author = "Duc Du, 2022", theme = "wine.pal")
par(par)
}
#dev.off()

ggplot() + geom_sf() + geom_sf(data=potf, aes(fill=min), lwd=0) +
  geom_sf(data=river3, col="white") +
  scale_fill_viridis("Số người/km2 tối thiểu\n tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(bui_plotf$prop.bui[1],1), "% dân số", sep = "")) +
  ggtitle("Đường đồng mức số người/km2 dân số họ Bùi") +
  coord_sf(crs = 4326)
ggsave(filename = file.path("figures", "Contour-River", "Bui-Contour-River-Area.jpeg"), width = 49, height = 33)
```

```{r}
# #Create a regular grid
# library(potential)
# library(mapsf)
# potential <- potential::potential
# mf_map(bui_ff, col= "grey80", border = "white", lwd = .4)
# y <- create_grid(x = bui_ff, res = 100000)
# mf_map(y, pch = 23, add = TRUE, bg = "blue", cex = .5 )
```

```{r}
# #Create a distance matrix
# d <- create_matrix(x = bui_ff, y = y)
# d[1:5, 1:5]
```

```{r}
#Compute the potentials
# y$poppot <- potential(x = bui_ff, y = y, d = d,
#                    var = "songuoi_km", fun = "e",
#                    span = 1000, beta = 2)
# mf_map(bui_ff, col= "grey80", border = "white", lwd = .4)
# mf_map(y, var = "poppot", type = "prop",
#        inches= .1,
#        lwd = .5,
#        leg_val_cex = .5,
#        leg_val_rnd = -3,
#        leg_frame = TRUE,
#        leg_pos = "topright")
```

```{r}
# #It’s possible to express the potential relatively to its maximum in order to display more understandable values (Rich 1980).
# y$poppot <- potential(x = bui_f, y = y, d = d,
#                    var = "danso", fun = "e",
#                    span = 1000, beta = 2)
# # Create the ratio variable
# # Handle NaN
# "/" <- function(x,y) ifelse(y==0,0,base:::"/"(x,y))
# y$pot <- y$namepot * 100 / y$poppot
# 
# mf_map(bui_f, col= "grey80", border = "white", lwd = .4)
# mf_map(y, var = "pot", type = "prop", 
#        inches= .1, 
#        lwd = .5, 
#        leg_val_cex = .5, 
#        leg_val_rnd = 0,
#        leg_frame = TRUE, 
#        leg_pos = "topright")
```

```{r, message=FALSE, warning=FALSE, results='hide'}
# library(potential)
# library(mapsf)
# #Create a regular grid
# y <- create_grid(x = bui_ff, res = 100000)
# 
# #Create a distance matrix
# d <- create_matrix(x = bui_ff, y = y)
# d[1:5, 1:5]
```

```{r}
# #Compute the potentials
# y$poppot <- potential(x = bui_ff, y = y, d = d,
#                    var = "songuoi_km", fun = "e",
#                    span = 1000, beta = 2)
# 
# # Compute areas of equipotential with equipotential().
# bks <- seq(0, 100, 10)
# iso <- equipotential(x = y, var = "poppot", breaks = bks, mask = bui_ff)
# 
# ggplot() + geom_sf() + geom_sf(data=iso, aes(fill=min), lwd=0) +
#   geom_sf(data=river3, col="white") +
#   scale_fill_viridis("Số người/km2 tối thiểu\n tại địa phương", direction = -1, option = "viridis") +
#   theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
#   ggtitle(paste("Đường đồng mức số người/km2 dân số họ Bùi", paste(round(bui_plotf$prop.bui[1],1), "% dân số", sep = ""), sep=" - ")) +
#   coord_sf(crs = 4326)
# #ggsave(filename = file.path("figures", "Hoang-PerArea-River.png"), width = 49, height = 33)
# ggsave(filename = file.path("figures", "Contour-River", "Bui-Contour-River-Area(2).jpeg"), width = 49, height = 33)
```

# Phân tích chi tiết dạng phân phối của từng họ

## Chi tiết họ theo tỉnh

## Họ Khúc

```{r}
khuc_tinh <- data_ho_tinh %>% filter(Ho=="Khúc") %>%
  arrange(desc(pro.pop))
khuc_tinh = merge(khuc_tinh, data_tinh, by="MATINH") %>%
  arrange(desc(pro.pop))
write_xlsx(khuc_tinh, "output/Khuc_tinh.xlsx")
```

## Họ Dư

```{r}
du_tinh <- data_ho_tinh %>% filter(Ho=="Dư") %>%
  arrange(desc(pro.pop))
du_tinh = merge(du_tinh, data_tinh, by="MATINH") %>%
  arrange(desc(pro.pop))
write_xlsx(du_tinh, "output/Du_tinh.xlsx")
```

```{r}
#save(dat_f, dat_sf, dat_sff, data_ho, data_ho_overall, data_ho_tinh, data_ho_xa, data_huyen, data_pop, data_tinh, data_xa, river3, file = "data/hoviet.RData")
```

## Phân bố mật độ tỉ lệ người mang 1 họ

```{r}
nguyen_his <- nguyen_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(nguyen_sf$pro.pop), sd = sd(nguyen_sf$pro.pop))) +
  ggtitle("Nguyễn")

tran_his <- tran_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(tran_sf$pro.pop), sd = sd(tran_sf$pro.pop))) +
  ggtitle("Trần")

le_his <- le_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(le_sf$pro.pop), sd = sd(le_sf$pro.pop))) +
  ggtitle("Lê")

ly_his <- ly_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(ly_sf$pro.pop), sd = sd(ly_sf$pro.pop))) +
  ggtitle("Lý")

trieu_his <- trieu_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(trieu_sf$pro.pop), sd = sd(trieu_sf$pro.pop))) +
  ggtitle("Triệu")

khuc_his <- khuc_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(khuc_sf$pro.pop), sd = sd(khuc_sf$pro.pop))) +
  ggtitle("Khúc")
```

```{r}
ggarrange(nguyen_his, tran_his, le_his, ly_his, trieu_his, khuc_his)
ggsave(filename = file.path("figures", "General", "Density(1).jpeg"), width = 10, height = 7)
```

```{r}
tinh_ho <- merge(data_ho_tinh, data_tinh %>% select(MATINH, TENTINH), by=c("MATINH"))
```

```{r}
nguyen_bar <- tinh_ho %>% filter(Ho=="Nguyễn") %>%
  ggplot(aes(x = reorder(TENTINH, pro.pop, decreasing=F), y =pro.pop)) +
  geom_bar(stat = "identity", fill="grey", width = 0.75) +
  scale_x_discrete(name = NULL) +
  theme_bw() + 
  theme(axis.text.y = element_text(size = 7),
        panel.grid.major = element_blank()) + coord_flip() +
  ggtitle("Nguyễn")
ggsave(filename = file.path("figures", "General", "Nguyen-Density-tinh.jpeg"), width = 10, height = 7)
```

```{r}
tran_bar <- tinh_ho %>% filter(Ho=="Trần") %>%
  ggplot(aes(x = reorder(TENTINH, pro.pop, decreasing=F), y =pro.pop)) +
  geom_bar(stat = "identity", fill="grey", width = 0.75) +
  scale_x_discrete(name = NULL) +
  theme_bw() + 
  theme(axis.text.y = element_text(size = 7),
        panel.grid.major = element_blank()) + coord_flip() +
  ggtitle("Trần")
ggsave(filename = file.path("figures", "General", "Tran-Density-tinh.jpeg"), width = 10, height = 7)
```

```{r}
le_bar <- tinh_ho %>% filter(Ho=="Lê") %>%
  ggplot(aes(x = reorder(TENTINH, pro.pop, decreasing=F), y =pro.pop)) +
  geom_bar(stat = "identity", fill="grey", width = 0.75) +
  scale_x_discrete(name = NULL) +
  theme_bw() + 
  theme(axis.text.y = element_text(size = 7),
        panel.grid.major = element_blank()) + coord_flip() +
  ggtitle("Lê")
ggsave(filename = file.path("figures", "General", "Le-Density-tinh.jpeg"), width = 10, height = 7)
```

```{r}
ly_bar <- tinh_ho %>% filter(Ho=="Lý") %>%
  ggplot(aes(x = reorder(TENTINH, pro.pop, decreasing=F), y =pro.pop)) +
  geom_bar(stat = "identity", fill="grey", width = 0.75) +
  scale_x_discrete(name = NULL) +
  theme_bw() + 
  theme(axis.text.y = element_text(size = 7),
        panel.grid.major = element_blank()) + coord_flip() +
  ggtitle("Lý")
ggsave(filename = file.path("figures", "General", "Ly-Density-tinh.jpeg"), width = 10, height = 7)
```

```{r}
trieu_bar <- tinh_ho %>% filter(Ho=="Triệu") %>%
  ggplot(aes(x = reorder(TENTINH, pro.pop, decreasing=F), y =pro.pop)) +
  geom_bar(stat = "identity", fill="grey", width = 0.75) +
  scale_x_discrete(name = NULL) +
  theme_bw() + 
  theme(axis.text.y = element_text(size = 7),
        panel.grid.major = element_blank()) + coord_flip() +
  ggtitle("Triệu")
ggsave(filename = file.path("figures", "General", "Trieu-Density-tinh.jpeg"), width = 10, height = 7)
```

```{r}
khuc_bar <- tinh_ho %>% filter(Ho=="Khúc") %>%
  ggplot(aes(x = reorder(TENTINH, pro.pop, decreasing=F), y =pro.pop)) +
  geom_bar(stat = "identity", fill="grey", width = 0.75) +
  scale_x_discrete(name = NULL) +
  theme_bw() + 
  theme(axis.text.y = element_text(size = 7),
        panel.grid.major = element_blank()) + coord_flip() +
  ggtitle("Khúc")
ggsave(filename = file.path("figures", "General", "Khuc-Density-tinh.jpeg"), width = 10, height = 7)
```

## Phân bố mật độ người/km2 mang 1 họ

```{r}
nguyen_hisf <- nguyen_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(nguyen_sff$songuoi_km), sd = sd(nguyen_sff$songuoi_km))) +
  ggtitle("Nguyễn")

tran_hisf <- tran_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(tran_sff$songuoi_km), sd = sd(tran_sff$songuoi_km))) +
  ggtitle("Trần")

le_hisf <- le_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(le_sff$songuoi_km), sd = sd(le_sff$songuoi_km))) +
  ggtitle("Lê")

ly_hisf <- ly_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(ly_sff$songuoi_km), sd = sd(ly_sff$songuoi_km))) +
  ggtitle("Lý")

trieu_hisf <- trieu_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(trieu_sff$songuoi_km), sd = sd(trieu_sff$songuoi_km))) +
  ggtitle("Triệu")

khuc_hisf <- khuc_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(khuc_sff$songuoi_km), sd = sd(khuc_sff$songuoi_km))) +
  ggtitle("Khúc")
```

```{r}
ggarrange(nguyen_hisf, tran_hisf, le_hisf, ly_hisf, trieu_hisf, khuc_hisf)
ggsave(filename = file.path("figures", "General", "Density(2).jpeg"), width = 10, height = 7)
```

```{r}
tinh_ho <- merge(data_ho_tinh, data_tinh %>% select(MATINH, TENTINH), by=c("MATINH"))
```

```{r}
nguyen_barf <- dat_sff %>% filter(Ho=="Nguyễn") %>% filter(rank(desc(songuoi_km))<=50) %>%
  ggplot(aes(x = reorder(NAME_3, songuoi_km, decreasing=F), y =songuoi_km, fill=factor(NAME_1))) +
  geom_bar(stat = "identity", width = 0.75) +
  scale_x_discrete(name = NULL) +
  scale_fill_discrete(name="Tỉnh/thành phố") +
  theme_bw() + 
  theme(axis.text.y = element_text(size = 7),
        panel.grid.major = element_blank()) + coord_flip() +
  ggtitle("Nguyễn")
ggsave(filename = file.path("figures", "General", "Nguyen-Density-xa(2).jpeg"), width = 10, height = 7)
```

```{r}
tran_barf <- dat_sff %>% filter(Ho=="Trần") %>% filter(rank(desc(songuoi_km))<=50) %>%
  ggplot(aes(x = reorder(NAME_3, songuoi_km, decreasing=F), y =songuoi_km, fill=factor(NAME_1))) +
  geom_bar(stat = "identity", width = 0.75) +
  scale_x_discrete(name = NULL) +
  scale_fill_discrete(name="Tỉnh/thành phố") +
  theme_bw() + 
  theme(axis.text.y = element_text(size = 7),
        panel.grid.major = element_blank()) + coord_flip() +
  ggtitle("Trần")
ggsave(filename = file.path("figures", "General", "Tran-Density-xa(2).jpeg"), width = 10, height = 7)
```

```{r}
tran_bar_namdinh <- dat_sff %>% filter(Ho=="Trần" & NAME_1=="Nam Dinh") %>% filter(rank(desc(pro.pop))<=50) %>%
  ggplot(aes(x = reorder(NAME_3, pro.pop, decreasing=F), y =pro.pop, fill=factor(NAME_1))) +
  geom_bar(stat = "identity", width = 0.75) +
  scale_x_discrete(name = NULL) +
  scale_fill_discrete(name="Tỉnh/thành phố") +
  theme_bw() + 
  theme(axis.text.y = element_text(size = 7),
        panel.grid.major = element_blank()) + coord_flip() +
  ggtitle("Trần-Nam Định")
ggsave(filename = file.path("figures", "General", "Tran-Nam Dinh-Density-xa.jpeg"), width = 10, height = 7)
```

## Họ Trần - Nam Định

```{r}
tran_barf_namdinh <- dat_sff %>% filter(Ho=="Trần" & NAME_1=="Nam Dinh") %>% filter(rank(desc(songuoi_km))<=50) %>%
  ggplot(aes(x = reorder(NAME_3, songuoi_km, decreasing=F), y =songuoi_km, fill=factor(NAME_1))) +
  geom_bar(stat = "identity", width = 0.75) +
  scale_x_discrete(name = NULL) +
  scale_fill_discrete(name="Tỉnh/thành phố") +
  theme_bw() + 
  theme(axis.text.y = element_text(size = 7),
        panel.grid.major = element_blank()) + coord_flip() +
  ggtitle("Trần-Nam Định")
ggsave(filename = file.path("figures", "General", "Tran-Nam Dinh-Density-xa(2).jpeg"), width = 10, height = 7)
```

```{r}
tran_namdinh <- dat_sff %>% filter(Ho=="Trần" & NAME_1=="Nam Dinh") %>% st_as_sf(crs = 4326)
tran_namdinh$centroid <- sf::st_transform(tran_namdinh, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()
#write_xlsx(tran_namdinh, "output/tran_namdinh.xlsx")

library(geosphere)
# distHaversine()
# distMeeus()
# distRhumb()
# distVincentyEllipsoid()
# distVincentySphere()
tran_namdinh <- tran_namdinh %>%
  mutate(centroid_0 = centroid[NAME_3=="Phuong Loc Vuong"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

tran_namdinh_radius <- tran_namdinh %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())
#write_xlsx(tran_namdinh_radius, "output/tran_namdinh_radius.xlsx")
```

```{r}
# ## Fit data
# fit1 <- lm(distm_km~rank, data=tran_namdinh_radius)
# fit2 <- lm(distm_km~poly(rank,2,raw=TRUE), data=tran_namdinh_radius)
# fit3 <- lm(distm_km~poly(rank,3,raw=TRUE), data=tran_namdinh_radius)
# fit4 <- lm(distm_km~poly(rank,4,raw=TRUE), data=tran_namdinh_radius)
# fit5 <- lm(distm_km~poly(rank,5,raw=TRUE), data=tran_namdinh_radius)
# 
# #create a scatterplot of x vs. y
# plot(tran_namdinh_radius$rank, tran_namdinh_radius$distm_km, pch=19, xlab='x', ylab='y')
# 
# #define x-axis values
# x_axis <- seq(1, 227, length=227)
# 
# #add curve of each model to plot
# lines(x_axis, predict(fit1, data.frame(x=x_axis)), col='green')
# lines(x_axis, predict(fit2, data.frame(x=x_axis)), col='red')
# lines(x_axis, predict(fit3, data.frame(x=x_axis)), col='purple')
# lines(x_axis, predict(fit4, data.frame(x=x_axis)), col='blue')
# lines(x_axis, predict(fit5, data.frame(x=x_axis)), col='orange')
# 
# summary(fit1)$adj.r.squared
# summary(fit2)$adj.r.squared
# summary(fit3)$adj.r.squared
# summary(fit4)$adj.r.squared
# summary(fit5)$adj.r.squared
# 
# summary(fit5)
# predict(fit5)
```

```{r}
distm_km<-tran_namdinh_radius$distm_km
songuoi_km<-tran_namdinh_radius$songuoi_km
rank<-tran_namdinh_radius$rank
commune<-tran_namdinh_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-70*exp(-(distm_km^2)/(2*sqrt(685)))

df<-data.frame(distm_km, rank, commune, estimate, songuoi_km)

# plot_df <- df %>%
#   #gather(key, value, estimate, songuoi_km) %>%
#   ggplot(aes(x=reorder(factor(rank), -distm_km), y=distm_km)) +
#   #coord_flip() +
#   geom_bar(aes(x=reorder(factor(rank), -distm_km), y=distm_km), stat = "identity", width = 0.5) + 
#   geom_line(aes(x=as.numeric(reorder(factor(rank), -distm_km)), y=estimate)) +
#   scale_x_continuous(name = "Xã/Phường", labels = rank)
# plot_df

plot_df <- df %>%
  ggplot(aes(x=reorder(factor(rank), -distm_km), y=distm_km)) +
  geom_bar(aes(x=as.numeric(reorder(factor(rank), -distm_km)), y=distm_km), stat = "identity", width = 0.5) + 
  geom_line(aes(x=as.numeric(reorder(factor(rank), -distm_km)), y=estimate))

plot_df
```

```{r}
tran_namdinh_dens2 <- tran_namdinh_radius %>%
  ggplot(aes(x = reorder(NAME_3, -distm_km), y =distm_km)) +
  #geom_point() +
  geom_bar(stat = "identity", width = 0.5) +
  geom_line(y =distm_km) +
  #geom_line(aes(x=reorder(NAME_3, -distm_km), y=predict(fit5), col='blue')) +
  stat_summary(aes(label=paste0(round(songuoi_km,0), "", "ng/km2")), geom="text", size=2, position = position_dodge(width= 1), vjust= 0.5, hjust = 0) +
  #stat_smooth(method = 'lm', formula = distm_km ~ poly(reorder(NAME_3, -distm_km),5), aes(colour = 'polynomial'), se= TRUE) +
  #stat_function(fun = dnorm, args = list(mean = 0, sd = 26.2)) +
  #geom_line(aes(x = exp(-distm_km^2/685), y=distm_km)) +
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_smooth(method = "lm", se = FALSE) +
  #geom_smooth(method = "loess", se = FALSE) +
  scale_x_discrete(name = "Xã/Phường") +
  scale_y_continuous(name="Khoảng cách tới tâm (km)") +
  theme_bw() + 
  theme(text = element_text(size=20), axis.text.x = element_text(size=20), axis.text.y = element_text(size=5)) +
  theme(panel.grid.major = element_blank()) + 
  annotate(geom='text', x=200, y=30, label="y == 70*e^-{(x^{2}+y^{2})/2*(26.2)}", parse = TRUE,size=10) +
  coord_flip() +
  ggtitle("Trần-Nam Định")
ggsave(filename = file.path("figures", "General", "Tran-Nam Dinh-Density-2.jpeg"), width = 25, height = 16)
```

```{r}
tran_namdinh_dens1 <- tran_namdinh_radius %>%
  ggplot(aes(x = reorder(NAME_3, -distm_km), y =distm_km)) +
  #geom_point() +
  geom_bar(stat = "identity", width = 0.5) +
  geom_line(y =distm_km) +
  #geom_line(aes(x=reorder(NAME_3, -distm_km), y=predict(fit5), col='blue')) +
  stat_summary(aes(label=paste0(round(pro.pop,1), "%")), geom="text", size=2, position = position_dodge(width= 1), vjust= 0.5, hjust = 0) +
  #stat_smooth(method = 'lm', formula = distm_km ~ poly(reorder(NAME_3, -distm_km),5), aes(colour = 'polynomial'), se= TRUE) +
  #stat_function(fun = dnorm, args = list(mean = 0, sd = 26.2)) +
  #geom_line(aes(x = exp(-distm_km^2/685), y=distm_km)) +
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_smooth(method = "lm", se = FALSE) +
  #geom_smooth(method = "loess", se = FALSE) +
  scale_x_discrete(name = "Xã/Phường") +
  scale_y_continuous(name="Khoảng cách tới tâm (km)") +
  theme_bw() + 
  theme(text = element_text(size=20), axis.text.x = element_text(size=20), axis.text.y = element_text(size=5)) +
  theme(panel.grid.major = element_blank()) + 
  annotate(geom='text', x=200, y=30, label="y == 70*e^-{(x^{2}+y^{2})/2*(26.2)}", parse = TRUE,size=10) +
  coord_flip() +
  ggtitle("Trần-Nam Định")
ggsave(filename = file.path("figures", "General", "Tran-Nam Dinh-Density-1.jpeg"), width = 25, height = 16)
```

```{r}
# Phương án 2
tran_namdinh <- dat_sff %>% filter(Ho=="Trần" & NAME_1=="Nam Dinh") %>% st_as_sf(crs = 4326)
tran_namdinh$centroid <- sf::st_transform(tran_namdinh, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
tran_namdinh <- tran_namdinh %>%
  mutate(centroid_0 = centroid[NAME_3=="Phuong Quang Trung"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

tran_namdinh_radius <- tran_namdinh %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())
#write_xlsx(tran_namdinh_radius, "output/tran_namdinh_radius.xlsx")

distm_km<-tran_namdinh_radius$distm_km
songuoi_km<-tran_namdinh_radius$songuoi_km
rank<-tran_namdinh_radius$rank
commune<-tran_namdinh_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-55*exp(-(distm_km^2)/(2*160))

df<-data.frame(distm_km, rank, commune, estimate, songuoi_km) %>%
  mutate(num=sum((songuoi_km-estimate)^2),
         den=(length(df)-1),
         var=num/den,
         sd=sqrt(var))
  
breaks <- c(0, 10, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200, 220, 240, 260, 280, 300)

plot_df <- df %>%
  #filter(row_number()<=100) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=songuoi_km, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=songuoi_km), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=songuoi_km, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=7)) +
  scale_x_discrete(name = "Xã/Phường", 
                     breaks = reorder(factor(rank), distm_km), 
                     labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Mật độ người/km2") +
  theme_bw() + 
  theme(text = element_text(size=20), axis.text.x = element_text(size=7, angle = 90), axis.text.y = element_text(size=20),
        legend.text=element_text(size=20), legend.key.size = unit(5, "cm"), legend.key.height = unit(2, "cm"), legend.key.width = unit(4, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Trần-Nam Định")

plot_df
ggsave(filename = file.path("figures", "General", "Tran-Nam Dinh-Density-2(3).jpeg"), width = 25, height = 16)
```

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

gg_tran_namdinh = ggplot(tran_namdinh) +
  geom_sf(aes(fill = songuoi_km)) +
  scale_fill_viridis("Mật độ người/km2", direction = -1, option = "viridis") +
  ggtitle("Trần-Nam Định") +
  theme_bw()

plot_gg(gg_tran_namdinh, multicore = TRUE, width = 6 ,height=3, fov = 70)
render_depth(focallength=100,focus=0.72)
render_movie("figures/tran_namdinh.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
```

## Họ Mai - Nghệ An

```{r}
mai_barf <- dat_sff %>% filter(Ho=="Mai") %>% filter(rank(desc(songuoi_km))<=100) %>%
  ggplot(aes(x = reorder(NAME_3, songuoi_km, decreasing=F), y =songuoi_km, fill=factor(NAME_1))) +
  geom_bar(stat = "identity", width = 0.75) +
  scale_x_discrete(name = NULL) +
  scale_fill_discrete(name="Tỉnh/thành phố") +
  theme_bw() + 
  theme(axis.text.y = element_text(size = 7),
        panel.grid.major = element_blank()) + coord_flip() +
  ggtitle("Mai")
ggsave(filename = file.path("figures", "General", "Mai-Density-xa(2).jpeg"), width = 10, height = 7)
```

```{r}
mai_nghean <- dat_sff %>% filter(Ho=="Mai" & NAME_1=="Nghe An") %>% st_as_sf(crs = 4326)
mai_nghean$centroid <- sf::st_transform(mai_nghean, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
mai_nghean <- mai_nghean %>%
  mutate(centroid_0 = centroid[NAME_3=="Thi tran Nam Dan"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

mai_nghean_radius <- mai_nghean %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())
#write_xlsx(mai_nghean_radius, "output/mai_nghean_radius.xlsx")
```

```{r}
distm_km<-mai_nghean_radius$distm_km
songuoi_km<-mai_nghean_radius$songuoi_km
rank<-mai_nghean_radius$rank
commune<-mai_nghean_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-400*exp(-(distm_km^2)/(2*sqrt(2736)))

df<-data.frame(distm_km, rank, commune, estimate, songuoi_km)

plot_df <- df %>%
  ggplot(aes(x=reorder(factor(rank), -distm_km), y=distm_km)) +
  geom_bar(aes(x=as.numeric(reorder(factor(rank), -distm_km)), y=distm_km), stat = "identity", width = 0.5) + 
  geom_line(aes(x=as.numeric(reorder(factor(rank), -distm_km)), y=estimate))

plot_df
```

```{r}
mai_nghean_dens2 <- mai_nghean_radius %>%
  filter(rank<=100) %>%
  ggplot(aes(x = reorder(NAME_3, -distm_km), y =distm_km)) +
  #geom_point() +
  geom_bar(stat = "identity", width = 0.5) +
  #geom_line(y =distm_km) +
  #geom_line(aes(x=reorder(NAME_3, -distm_km), y=predict(fit5), col='blue')) +
  stat_summary(aes(label=paste0(round(songuoi_km,0), "", "ng/km2")), geom="text", size=4, position = position_dodge(width= 1), vjust= 0.5, hjust = 0) +
  #stat_smooth(method = 'lm', formula = distm_km ~ poly(reorder(NAME_3, -distm_km),5), aes(colour = 'polynomial'), se= TRUE) +
  #stat_function(fun = dnorm, args = list(mean = 0, sd = 26.2)) +
  #geom_line(aes(x = exp(-distm_km^2/685), y=distm_km)) +
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_smooth(method = "lm", se = FALSE) +
  #geom_smooth(method = "loess", se = FALSE) +
  scale_x_discrete(name = "Xã/Phường") +
  scale_y_continuous(name="Khoảng cách tới tâm (km)") +
  theme_bw() + 
  theme(text = element_text(size=20), axis.text.x = element_text(size=20), axis.text.y = element_text(size=12)) +
  theme(panel.grid.major = element_blank()) + 
  annotate(geom='text', x=80, y=15, label="y == 400*e^-{(x^{2}+y^{2})/2*(52.3)}", parse = TRUE,size=10) +
  coord_flip() +
  ggtitle("Mai-Nghệ An")
ggsave(filename = file.path("figures", "General", "Mai-Nghe An-Density-2.jpeg"), width = 25, height = 16)
```

```{r}
# Phương án 2
mai_nghean <- dat_sff %>% filter(Ho=="Mai" & NAME_1=="Nghe An") %>% st_as_sf(crs = 4326)
mai_nghean$centroid <- sf::st_transform(mai_nghean, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
mai_nghean <- mai_nghean %>%
  mutate(centroid_0 = centroid[NAME_3=="Phuong Nghi Thuy"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

mai_nghean_radius <- mai_nghean %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())
#write_xlsx(mai_nghean_radius, "output/mai_nghean_radius.xlsx")

distm_km<-mai_nghean_radius$distm_km
songuoi_km<-mai_nghean_radius$songuoi_km
rank<-mai_nghean_radius$rank
commune<-mai_nghean_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-55*exp(-(distm_km^2)/(2*160))

df<-data.frame(distm_km, rank, commune, estimate, songuoi_km) %>%
  mutate(num=sum((songuoi_km-estimate)^2),
         den=(length(df)-1),
         var=num/den,
         sd=sqrt(var))
  
breaks <- c(0, 10, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200, 220, 240, 260, 280, 300)

plot_df <- df %>%
  #filter(row_number()<=100) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=songuoi_km, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=songuoi_km), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=songuoi_km, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=7)) +
  scale_x_discrete(name = "Xã/Phường", 
                     breaks = reorder(factor(rank), distm_km), 
                     labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Mật độ người/km2") +
  theme_bw() + 
  theme(text = element_text(size=20), axis.text.x = element_text(size=5, angle = 90), axis.text.y = element_text(size=20),
        legend.text=element_text(size=20), legend.key.size = unit(5, "cm"), legend.key.height = unit(2, "cm"), legend.key.width = unit(4, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Mai-Nghệ An")

plot_df
ggsave(filename = file.path("figures", "General", "Mai-Nghe An-Density-2(2).jpeg"), width = 25, height = 16)
```

# 3D plot

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

gg_mai_nghean = ggplot(mai_nghean) +
  geom_sf(aes(fill = songuoi_km)) +
  scale_fill_viridis("Mật độ người/km2", direction = -1, option = "viridis") +
  ggtitle("Mai-Nghệ An") +
  theme_bw()

plot_gg(gg_mai_nghean, multicore = TRUE, width = 6 ,height=3, fov = 70)
render_depth(focallength=100,focus=0.72)
render_movie("figures/mai_nghean.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
```

## Họ Mai - Thanh Hóa

```{r}
mai_thanhhoa <- dat_sff %>% filter(Ho=="Mai" & NAME_1=="Thanh Hoa") %>% st_as_sf(crs = 4326)
mai_thanhhoa$centroid <- sf::st_transform(mai_thanhhoa, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
mai_thanhhoa <- mai_thanhhoa %>%
  mutate(centroid_0 = centroid[NAME_3=="Thi tran Nga Son"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

mai_thanhhoa_radius <- mai_thanhhoa %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())
write_xlsx(mai_thanhhoa_radius, "output/mai_thanhhoa_radius.xlsx")
```

```{r}
distm_km<-mai_thanhhoa_radius$distm_km
songuoi_km<-mai_thanhhoa_radius$songuoi_km
rank<-mai_thanhhoa_radius$rank
commune<-mai_thanhhoa_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-450*exp(-(distm_km^2)/(2*sqrt(2781)))

df<-data.frame(distm_km, rank, commune, estimate, songuoi_km)

plot_df <- df %>%
  ggplot(aes(x=reorder(factor(rank), -distm_km), y=distm_km)) +
  geom_bar(aes(x=as.numeric(reorder(factor(rank), -distm_km)), y=distm_km), stat = "identity", width = 0.5) + 
  geom_line(aes(x=as.numeric(reorder(factor(rank), -distm_km)), y=estimate))

plot_df
```

```{r}
mai_thanhhoa_dens2 <- mai_thanhhoa_radius %>%
  filter(rank<=100) %>%
  ggplot(aes(x = reorder(NAME_3, -distm_km), y =distm_km)) +
  #geom_point() +
  geom_bar(stat = "identity", width = 0.5) +
  #geom_line(y =distm_km) +
  #geom_line(aes(x=reorder(NAME_3, -distm_km), y=predict(fit5), col='blue')) +
  stat_summary(aes(label=paste0(round(songuoi_km,0), "", "ng/km2")), geom="text", size=4, position = position_dodge(width= 1), vjust= 0.5, hjust = 0) +
  #stat_smooth(method = 'lm', formula = distm_km ~ poly(reorder(NAME_3, -distm_km),5), aes(colour = 'polynomial'), se= TRUE) +
  #stat_function(fun = dnorm, args = list(mean = 0, sd = 26.2)) +
  #geom_line(aes(x = exp(-distm_km^2/685), y=distm_km)) +
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_smooth(method = "lm", se = FALSE) +
  #geom_smooth(method = "loess", se = FALSE) +
  scale_x_discrete(name = "Xã/Phường") +
  scale_y_continuous(name="Khoảng cách tới tâm (km)") +
  theme_bw() + 
  theme(text = element_text(size=20), axis.text.x = element_text(size=20), axis.text.y = element_text(size=12)) +
  theme(panel.grid.major = element_blank()) + 
  annotate(geom='text', x=80, y=10, label="y == 450*e^-{(x^{2}+y^{2})/2*(52.7)}", parse = TRUE,size=10) +
  coord_flip() +
  ggtitle("Mai-Thanh Hóa")
ggsave(filename = file.path("figures", "General", "Mai-Thanh Hoa-Density-2.jpeg"), width = 25, height = 16)
```

```{r}
# Phương án 2
mai_thanhhoa <- dat_sff %>% filter(Ho=="Mai" & NAME_1=="Thanh Hoa") %>% st_as_sf(crs = 4326)
mai_thanhhoa$centroid <- sf::st_transform(mai_thanhhoa, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
mai_thanhhoa <- mai_thanhhoa %>%
  mutate(centroid_0 = centroid[NAME_3=="Thi tran Nga Son"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

mai_thanhhoa_radius <- mai_thanhhoa %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())
#write_xlsx(mai_thanhhoa_radius, "output/mai_thanhhoa_radius.xlsx")

distm_km<-mai_thanhhoa_radius$distm_km
songuoi_km<-mai_thanhhoa_radius$songuoi_km
rank<-mai_thanhhoa_radius$rank
commune<-mai_thanhhoa_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-200*exp(-(distm_km^2)/(2*100))

df<-data.frame(distm_km, rank, commune, estimate, songuoi_km) %>%
  mutate(num=sum((songuoi_km-estimate)^2),
         den=(length(df)-1),
         var=num/den,
         sd=sqrt(var))
  

breaks <- c(0, 10, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200, 220, 240, 260, 280, 300)

plot_df <- df %>%
  #filter(row_number()<=100) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=songuoi_km, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=songuoi_km), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=songuoi_km, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=7)) +
  scale_x_discrete(name = "Xã/Phường", 
                     breaks = reorder(factor(rank), distm_km), 
                     labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Mật độ người/km2") +
  theme_bw() + 
  theme(text = element_text(size=20), axis.text.x = element_text(size=5, angle = 90), axis.text.y = element_text(size=20),
        legend.text=element_text(size=20), legend.key.size = unit(5, "cm"), legend.key.height = unit(2, "cm"), legend.key.width = unit(4, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Mai-Thanh Hóa")

plot_df
ggsave(filename = file.path("figures", "General", "Mai-Thanh Hoa-Density-2(2).jpeg"), width = 25, height = 16)
```

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

gg_mai_thanhhoa = ggplot(mai_thanhhoa) +
  geom_sf(aes(fill = songuoi_km)) +
  scale_fill_viridis("Mật độ người/km2", direction = -1, option = "viridis") +
  ggtitle("Mai-Thanh Hóa") +
  theme_bw()

plot_gg(gg_mai_thanhhoa, multicore = TRUE, width = 6 ,height=3, fov = 70)
render_depth(focallength=100,focus=0.72)
render_movie("figures/mai_thanhhoa.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
```

## Họ Mai - Nam Định

```{r}
mai_namdinh <- dat_sff %>% filter(Ho=="Mai" & NAME_1=="Nam Dinh") %>% st_as_sf(crs = 4326)
mai_namdinh$centroid <- sf::st_transform(mai_namdinh, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
mai_namdinh <- mai_namdinh %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Xuan Tien"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

mai_namdinh_radius <- mai_namdinh %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())
write_xlsx(mai_namdinh_radius, "output/mai_namdinh_radius.xlsx")
```

```{r}
distm_km<-mai_namdinh_radius$distm_km
songuoi_km<-mai_namdinh_radius$songuoi_km
rank<-mai_namdinh_radius$rank
commune<-mai_namdinh_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-110*exp(-(distm_km^2)/(2*sqrt(535)))

df<-data.frame(distm_km, rank, commune, estimate, songuoi_km)

plot_df <- df %>%
  ggplot(aes(x=reorder(factor(rank), -distm_km), y=distm_km)) +
  geom_bar(aes(x=as.numeric(reorder(factor(rank), -distm_km)), y=distm_km), stat = "identity", width = 0.5) + 
  geom_line(aes(x=as.numeric(reorder(factor(rank), -distm_km)), y=estimate))

plot_df
```

```{r}
mai_namdinhdens2 <- mai_namdinh_radius %>%
  filter(rank<=100) %>%
  ggplot(aes(x = reorder(NAME_3, -distm_km), y =distm_km)) +
  #geom_point() +
  geom_bar(stat = "identity", width = 0.5) +
  #geom_line(y =distm_km) +
  #geom_line(aes(x=reorder(NAME_3, -distm_km), y=predict(fit5), col='blue')) +
  stat_summary(aes(label=paste0(round(songuoi_km,0), "", "ng/km2")), geom="text", size=4, position = position_dodge(width= 1), vjust= 0.5, hjust = 0) +
  #stat_smooth(method = 'lm', formula = distm_km ~ poly(reorder(NAME_3, -distm_km),5), aes(colour = 'polynomial'), se= TRUE) +
  #stat_function(fun = dnorm, args = list(mean = 0, sd = 26.2)) +
  #geom_line(aes(x = exp(-distm_km^2/685), y=distm_km)) +
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_smooth(method = "lm", se = FALSE) +
  #geom_smooth(method = "loess", se = FALSE) +
  scale_x_discrete(name = "Xã/Phường") +
  scale_y_continuous(name="Khoảng cách tới tâm (km)") +
  theme_bw() + 
  theme(text = element_text(size=20), axis.text.x = element_text(size=20), axis.text.y = element_text(size=12)) +
  theme(panel.grid.major = element_blank()) + 
  annotate(geom='text', x=80, y=10, label="y == 110*e^-{(x^{2}+y^{2})/2*(23.1)}", parse = TRUE,size=10) +
  coord_flip() +
  ggtitle("Mai-Nam Định")
ggsave(filename = file.path("figures", "General", "Mai-Nam Dinh-Density-2.jpeg"), width = 25, height = 16)
```

```{r}
# Phương án 2
mai_namdinh <- dat_sff %>% filter(Ho=="Mai" & NAME_1=="Nam Dinh") %>% st_as_sf(crs = 4326)
mai_namdinh$centroid <- sf::st_transform(mai_namdinh, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
mai_namdinh <- mai_namdinh %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Xuan Tien"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

mai_namdinh_radius <- mai_namdinh %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())
#write_xlsx(mai_namdinh_radius, "output/mai_namdinh_radius.xlsx")

distm_km<-mai_namdinh_radius$distm_km
songuoi_km<-mai_namdinh_radius$songuoi_km
rank<-mai_namdinh_radius$rank
commune<-mai_namdinh_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-220*exp(-(distm_km^2)/(2*40))

df<-data.frame(distm_km, rank, commune, estimate, songuoi_km) %>%
  mutate(num=sum((songuoi_km-estimate)^2),
         den=(length(df)-1),
         var=num/den,
         sd=sqrt(var))
  

breaks <- c(0, 10, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200, 220, 240, 260, 280, 300)

plot_df <- df %>%
  #filter(row_number()<=100) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=songuoi_km, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=songuoi_km), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=songuoi_km, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=7)) +
  scale_x_discrete(name = "Xã/Phường", 
                     breaks = reorder(factor(rank), distm_km), 
                     labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Mật độ người/km2") +
  theme_bw() + 
  theme(text = element_text(size=20), axis.text.x = element_text(size=5, angle = 90), axis.text.y = element_text(size=20),
        legend.text=element_text(size=20), legend.key.size = unit(5, "cm"), legend.key.height = unit(2, "cm"), legend.key.width = unit(4, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Mai-Nam Định")

plot_df
ggsave(filename = file.path("figures", "General", "Mai-Nam Dinh-Density-2(2).jpeg"), width = 25, height = 16)
```

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

gg_mai_namdinh = ggplot(mai_namdinh) +
  geom_sf(aes(fill = songuoi_km)) +
  scale_fill_viridis("Mật độ người/km2", direction = -1, option = "viridis") +
  ggtitle("Mai-Nam Định") +
  theme_bw()

plot_gg(gg_mai_namdinh, multicore = TRUE, width = 6 ,height=3, fov = 70)
render_depth(focallength=100,focus=0.72)
render_movie("figures/mai_namdinh.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
```

## Họ Khúc - Hưng Yên

```{r}
khuc_barf <- dat_sff %>% filter(Ho=="Khúc") %>% filter(rank(desc(songuoi_km))<=50) %>%
  ggplot(aes(x = reorder(NAME_3, songuoi_km, decreasing=F), y =songuoi_km, fill=factor(NAME_1))) +
  geom_bar(stat = "identity", width = 0.75) +
  scale_x_discrete(name = NULL) +
  scale_fill_discrete(name="Tỉnh/thành phố") +
  theme_bw() + 
  theme(axis.text.y = element_text(size = 7),
        panel.grid.major = element_blank()) + coord_flip() +
  ggtitle("Khúc")
ggsave(filename = file.path("figures", "General", "Khuc-Density-xa(2).jpeg"), width = 10, height = 7)
```

```{r}
khuc_hungyen <- dat_sff %>% filter(Ho=="Khúc" & NAME_1=="Hung Yen") %>% st_as_sf(crs = 4326)
khuc_hungyen$centroid <- sf::st_transform(khuc_hungyen, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
khuc_hungyen <- khuc_hungyen %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Cam Xa"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

khuc_hungyen_radius <- khuc_hungyen %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())
#write_xlsx(khuc_hungyen_radius, "output/khuc_hungyen_radius.xlsx")
```

```{r}
distm_km<-khuc_hungyen_radius$distm_km
songuoi_km<-khuc_hungyen_radius$songuoi_km
rank<-khuc_hungyen_radius$rank
commune<-khuc_hungyen_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-40*exp(-(distm_km^2)/(2*sqrt(338)))

df<-data.frame(distm_km, rank, commune, estimate, songuoi_km)

plot_df <- df %>%
  ggplot(aes(x=reorder(factor(rank), -distm_km), y=distm_km)) +
  geom_bar(aes(x=as.numeric(reorder(factor(rank), -distm_km)), y=distm_km), stat = "identity", width = 0.5) + 
  geom_line(aes(x=as.numeric(reorder(factor(rank), -distm_km)), y=estimate))
plot_df
```

```{r}
khuc_hungyen_dens2 <- khuc_hungyen_radius %>%
  ggplot(aes(x = reorder(NAME_3, -distm_km), y =distm_km)) +
  #geom_point() +
  geom_bar(stat = "identity", width = 0.5) +
  geom_line(y =distm_km) +
  #geom_line(aes(x=reorder(NAME_3, -distm_km), y=predict(fit5), col='blue')) +
  stat_summary(aes(label=paste0(round(songuoi_km,0), "", "ng/km2")), geom="text", size=5, position = position_dodge(width= 1), vjust= 0.5, hjust = 0) +
  #stat_smooth(method = 'lm', formula = distm_km ~ poly(reorder(NAME_3, -distm_km),5), aes(colour = 'polynomial'), se= TRUE) +
  #stat_function(fun = dnorm, args = list(mean = 0, sd = 26.2)) +
  #geom_line(aes(x = exp(-distm_km^2/685), y=distm_km)) +
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_smooth(method = "lm", se = FALSE) +
  #geom_smooth(method = "loess", se = FALSE) +
  scale_x_discrete(name = "Xã/Phường") +
  scale_y_continuous(name="Khoảng cách tới tâm (km)") +
  theme_bw() + 
  theme(text = element_text(size=20), axis.text.x = element_text(size=20), axis.text.y = element_text(size=15)) +
  theme(panel.grid.major = element_blank()) + 
  annotate(geom='text', x=40, y=20, label="y == 40*e^-{(x^{2}+y^{2})/2*(18.4)}", parse = TRUE,size=10) +
  coord_flip() +
  ggtitle("Khúc-Hưng Yên")
ggsave(filename = file.path("figures", "General", "Khuc-Hung Yen-Density-2.jpeg"), width = 25, height = 16)
```

```{r}
# Phương án 2
khuc_hungyen <- dat_sff %>% filter(Ho=="Khúc" & NAME_1=="Hung Yen") %>% st_as_sf(crs = 4326)
khuc_hungyen$centroid <- sf::st_transform(khuc_hungyen, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
khuc_hungyen <- khuc_hungyen %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Cam Xa"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

khuc_hungyen_radius <- khuc_hungyen %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())
#write_xlsx(khuc_hungyen_radius, "output/khuc_hungyen_radius.xlsx")

distm_km<-khuc_hungyen_radius$distm_km
songuoi_km<-khuc_hungyen_radius$songuoi_km
rank<-khuc_hungyen_radius$rank
commune<-khuc_hungyen_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-50*exp(-(distm_km^2)/(2*36))

df<-data.frame(distm_km, rank, commune, estimate, songuoi_km) %>%
  mutate(num=sum((songuoi_km-estimate)^2),
         den=(length(df)-1),
         var=num/den,
         sd=sqrt(var))
  

breaks <- c(0, 10, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200, 220, 240, 260, 280, 300)

plot_df <- df %>%
  #filter(row_number()<=100) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=songuoi_km, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=songuoi_km), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=songuoi_km, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=7)) +
  scale_x_discrete(name = "Xã/Phường", 
                     breaks = reorder(factor(rank), distm_km), 
                     labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Mật độ người/km2") +
  theme_bw() + 
  theme(text = element_text(size=20), axis.text.x = element_text(size=10, angle = 90), axis.text.y = element_text(size=20),
        legend.text=element_text(size=20), legend.key.size = unit(5, "cm"), legend.key.height = unit(2, "cm"), legend.key.width = unit(4, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Khúc-Hưng Yên")

plot_df
ggsave(filename = file.path("figures", "General", "Khuc-Hung Yen-Density-2(2).jpeg"), width = 25, height = 16)
```

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

gg_khuc_hungyen = ggplot(khuc_hungyen) +
  geom_sf(aes(fill = songuoi_km)) +
  scale_fill_viridis("Mật độ người/km2", direction = -1, option = "viridis") +
  ggtitle("Khúc-Hưng Yên") +
  theme_bw()

plot_gg(gg_khuc_hungyen, multicore = TRUE, width = 6 ,height=3, fov = 70)
render_depth(focallength=100,focus=0.72)
render_movie("figures/khuc_hungyen.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
```

## Họ Ngô - Hà Nội

```{r}
ngo_barf <- dat_sff %>% filter(Ho=="Ngô") %>% filter(rank(desc(songuoi_km))<=50) %>%
  ggplot(aes(x = reorder(NAME_3, songuoi_km, decreasing=F), y =songuoi_km, fill=factor(NAME_1))) +
  geom_bar(stat = "identity", width = 0.75) +
  scale_x_discrete(name = NULL) +
  scale_fill_discrete(name="Tỉnh/thành phố") +
  theme_bw() + 
  theme(axis.text.y = element_text(size = 7),
        panel.grid.major = element_blank()) + coord_flip() +
  ggtitle("Ngô")
ggsave(filename = file.path("figures", "General", "Ngo-Density-xa(2).jpeg"), width = 10, height = 7)
```

```{r}
ngo_hanoi <- dat_sff %>% filter(Ho=="Ngô" & NAME_1=="Ha Noi") %>% st_as_sf(crs = 4326)
ngo_hanoi$centroid <- sf::st_transform(ngo_hanoi, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
ngo_hanoi <- ngo_hanoi %>%
  mutate(centroid_0 = centroid[NAME_3=="Phuong Dong Xuan" & NAME_2=="Hoan Kiem"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

ngo_hanoi_radius <- ngo_hanoi %>%
  arrange(distm_km) %>%
  mutate(rank=row_number(),
         NAME_3=gsub("Xa","",NAME_3),
         NAME_3=gsub("Phuong","",NAME_3),
         NAME_3=gsub("Thi tran","",NAME_3),
         commune=paste(NAME_3, NAME_2, sep = "-"))
write_xlsx(ngo_hanoi_radius, "output/ngo_hanoi_radius.xlsx")
```

```{r}
distm_km<-ngo_hanoi_radius$distm_km
songuoi_km<-ngo_hanoi_radius$songuoi_km
rank<-ngo_hanoi_radius$rank
commune<-ngo_hanoi_radius$commune
rank<-factor(rank, labels = commune)
estimate<-80*exp(-(distm_km^2)/(2*sqrt(633)))

df<-data.frame(distm_km, rank, commune, estimate, songuoi_km)

plot_df <- df %>%
  ggplot(aes(x=reorder(factor(rank), -distm_km), y=distm_km)) +
  geom_bar(aes(x=as.numeric(reorder(factor(rank), -distm_km)), y=distm_km), stat = "identity", width = 0.5) + 
  geom_line(aes(x=as.numeric(reorder(factor(rank), -distm_km)), y=estimate))

plot_df
```

```{r}
ngo_hanoi_dens2 <- ngo_hanoi_radius %>% 
  filter(rank<=100) %>%
  ggplot(aes(x = reorder(commune, -distm_km), y =distm_km)) +
  #geom_point() +
  geom_bar(stat = "identity", width = 0.5) +
  #geom_line(aes(x=reorder(NAME_3, -distm_km), y=predict(fit5), col='blue')) +
  stat_summary(aes(label=paste0(round(songuoi_km,0), "", "ng/km2")), geom="text", size=4, position = position_dodge(width= 1), vjust= 0.5, hjust = 0) +
  #stat_smooth(method = 'lm', formula = distm_km ~ poly(reorder(NAME_3, -distm_km),5), aes(colour = 'polynomial'), se= TRUE) +
  #stat_function(fun = dnorm, args = list(mean = 0, sd = 26.2)) +
  #geom_line(aes(x = exp(-distm_km^2/685), y=distm_km)) +
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_smooth(method = "lm", se = FALSE) +
  #geom_smooth(method = "loess", se = FALSE) +
  scale_x_discrete(name = "Xã/Phường") +
  scale_y_continuous(name="Khoảng cách tới tâm (km)") +
  theme_bw() + 
  theme(text = element_text(size=20), axis.text.x = element_text(size=20), axis.text.y = element_text(size=12)) +
  theme(panel.grid.major = element_blank()) + 
  annotate(geom='text', x=80, y=4, label="y == 80*e^-{(x^{2}+y^{2})/2*(25.2)}", parse = TRUE,size=10) +
  coord_flip() +
  ggtitle("Ngô-Hà Nội")
ggsave(filename = file.path("figures", "General", "Ngo-Ha Noi-Density-2.jpeg"), width = 25, height = 16)
```

```{r}
# Phương án 2
ngo_hanoi <- dat_sff %>% filter(Ho=="Ngô" & NAME_1=="Ha Noi") %>% st_as_sf(crs = 4326)
ngo_hanoi$centroid <- sf::st_transform(ngo_hanoi, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
ngo_hanoi <- ngo_hanoi %>%
  mutate(centroid_0 = centroid[NAME_3=="Phuong Dong Xuan"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

ngo_hanoi_radius <- ngo_hanoi %>%
  arrange(distm_km) %>%
  mutate(rank=row_number(),
         NAME_3=gsub("Xa","",NAME_3),
         NAME_3=gsub("Phuong","",NAME_3),
         NAME_3=gsub("Thi tran","",NAME_3),
         commune=paste(NAME_3, NAME_2, sep = "-"))
#write_xlsx(ngo_hanoi_radius, "output/ngo_hanoi_radius.xlsx")

distm_km<-ngo_hanoi_radius$distm_km
songuoi_km<-ngo_hanoi_radius$songuoi_km
rank<-ngo_hanoi_radius$rank
commune<-ngo_hanoi_radius$commune
rank<-factor(rank, labels = commune)
estimate<-55*exp(-(distm_km^2)/(2*160))

df<-data.frame(distm_km, rank, commune, estimate, songuoi_km) %>%
  mutate(num=sum((songuoi_km-estimate)^2),
         den=(length(df)-1),
         var=num/den,
         sd=sqrt(var))
  
breaks <- c(0, 10, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200, 220, 240, 260, 280, 300)

plot_df <- df %>%
  #filter(row_number()<=100) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=songuoi_km, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=songuoi_km), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=songuoi_km, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=7)) +
  scale_x_discrete(name = "Xã/Phường", 
                     breaks = reorder(factor(rank), distm_km), 
                     labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Mật độ người/km2") +
  theme_bw() + 
  theme(text = element_text(size=20), axis.text.x = element_text(size=5, angle = 90), axis.text.y = element_text(size=20),
        legend.text=element_text(size=20), legend.key.size = unit(5, "cm"), legend.key.height = unit(2, "cm"), legend.key.width = unit(4, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Ngô-Hà Nội")

plot_df
ggsave(filename = file.path("figures", "General", "Ngo-Ha Noi-Density-2(2).jpeg"), width = 25, height = 16)
```

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

gg_ngo_hanoi = ggplot(ngo_hanoi) +
  geom_sf(aes(fill = songuoi_km)) +
  scale_fill_viridis("Mật độ người/km2", direction = -1, option = "viridis") +
  ggtitle("Ngô-Hà Nội") +
  theme_bw()

plot_gg(gg_ngo_hanoi, multicore = TRUE, width = 6 ,height=3, fov = 70)
render_depth(focallength=100,focus=0.72)
render_movie("figures/ngo_hanoi.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
```

## Họ Phùng - Hà Nội

```{r}
phung_barf <- dat_sff %>% filter(Ho=="Phùng") %>% filter(rank(desc(songuoi_km))<=50) %>%
  ggplot(aes(x = reorder(NAME_3, songuoi_km, decreasing=F), y =songuoi_km, fill=factor(NAME_1))) +
  geom_bar(stat = "identity", width = 0.75) +
  scale_x_discrete(name = NULL) +
  scale_fill_discrete(name="Tỉnh/thành phố") +
  theme_bw() + 
  theme(axis.text.y = element_text(size = 7),
        panel.grid.major = element_blank()) + coord_flip() +
  ggtitle("Phùng")
ggsave(filename = file.path("figures", "General", "Phung-Density-xa(2).jpeg"), width = 10, height = 7)
```

```{r}
phung_hanoi <- dat_sff %>% filter(Ho=="Phùng" & NAME_1=="Ha Noi") %>% st_as_sf(crs = 4326)
phung_hanoi$centroid <- sf::st_transform(phung_hanoi, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
phung_hanoi <- phung_hanoi %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Dong Thai" & NAME_2=="Ba Vi"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

phung_hanoi_radius <- phung_hanoi %>%
  arrange(distm_km) %>%
  mutate(rank=row_number(),
         NAME_3=gsub("Xa","",NAME_3),
         NAME_3=gsub("Phuong","",NAME_3),
         NAME_3=gsub("Thi tran","",NAME_3),
         commune=paste(NAME_3, NAME_2, sep = "-"))
write_xlsx(phung_hanoi_radius, "output/phung_hanoi_radius.xlsx")
```

```{r}
distm_km<-phung_hanoi_radius$distm_km
songuoi_km<-phung_hanoi_radius$songuoi_km
rank<-phung_hanoi_radius$rank
commune<-phung_hanoi_radius$commune
rank<-factor(rank, labels = commune)
estimate<-600*exp(-(distm_km^2)/(2*sqrt(2503)))

df<-data.frame(distm_km, rank, commune, estimate, songuoi_km)

plot_df <- df %>%
  ggplot(aes(x=reorder(factor(rank), -distm_km), y=distm_km)) +
  geom_bar(aes(x=as.numeric(reorder(factor(rank), -distm_km)), y=distm_km), stat = "identity", width = 0.5) + 
  geom_line(aes(x=as.numeric(reorder(factor(rank), -distm_km)), y=estimate))

plot_df
```

```{r}
phung_hanoi_dens2 <- phung_hanoi_radius %>% 
  filter(rank<=100) %>%
  ggplot(aes(x = reorder(commune, -distm_km), y =distm_km)) +
  #geom_point() +
  geom_bar(stat = "identity", width = 0.5) +
  #geom_line(aes(x=reorder(NAME_3, -distm_km), y=predict(fit5), col='blue')) +
  stat_summary(aes(label=paste0(round(songuoi_km,0), "", "ng/km2")), geom="text", size=4, position = position_dodge(width= 1), vjust= 0.5, hjust = 0) +
  #stat_smooth(method = 'lm', formula = distm_km ~ poly(reorder(NAME_3, -distm_km),5), aes(colour = 'polynomial'), se= TRUE) +
  #stat_function(fun = dnorm, args = list(mean = 0, sd = 26.2)) +
  #geom_line(aes(x = exp(-distm_km^2/685), y=distm_km)) +
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_smooth(method = "lm", se = FALSE) +
  #geom_smooth(method = "loess", se = FALSE) +
  scale_x_discrete(name = "Xã/Phường") +
  scale_y_continuous(name="Khoảng cách tới tâm (km)") +
  theme_bw() + 
  theme(text = element_text(size=20), axis.text.x = element_text(size=20), axis.text.y = element_text(size=12)) +
  theme(panel.grid.major = element_blank()) + 
  annotate(geom='text', x=80, y=20, label="y == 600*e^-{(x^{2}+y^{2})/2*(50)}", parse = TRUE,size=10) +
  coord_flip() +
  ggtitle("Phùng-Hà Nội")
ggsave(filename = file.path("figures", "General", "Phung-Ha Noi-Density-2.jpeg"), width = 25, height = 16)
```

```{r}
# Phương án 2
phung_hanoi <- dat_sff %>% filter(Ho=="Phùng" & NAME_1=="Ha Noi") %>% st_as_sf(crs = 4326)
phung_hanoi$centroid <- sf::st_transform(phung_hanoi, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
phung_hanoi <- phung_hanoi %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Dong Thai"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

phung_hanoi_radius <- phung_hanoi %>%
  arrange(distm_km) %>%
  mutate(rank=row_number(),
         NAME_3=gsub("Xa","",NAME_3),
         NAME_3=gsub("Phuong","",NAME_3),
         NAME_3=gsub("Thi tran","",NAME_3),
         commune=paste(NAME_3, NAME_2, sep = "-"))
#write_xlsx(phung_hanoi_radius, "output/phung_hanoi_radius.xlsx")

distm_km<-phung_hanoi_radius$distm_km
songuoi_km<-phung_hanoi_radius$songuoi_km
rank<-phung_hanoi_radius$rank
commune<-phung_hanoi_radius$commune
rank<-factor(rank, labels = commune)
estimate<-55*exp(-(distm_km^2)/(2*160))

df<-data.frame(distm_km, rank, commune, estimate, songuoi_km) %>%
  mutate(num=sum((songuoi_km-estimate)^2),
         den=(length(df)-1),
         var=num/den,
         sd=sqrt(var))
  
breaks <- c(0, 10, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200, 220, 240, 260, 280, 300)

plot_df <- df %>%
  #filter(row_number()<=100) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=songuoi_km, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=songuoi_km), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=songuoi_km, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=7)) +
  scale_x_discrete(name = "Xã/Phường", 
                     breaks = reorder(factor(rank), distm_km), 
                     labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Mật độ người/km2") +
  theme_bw() + 
  theme(text = element_text(size=20), axis.text.x = element_text(size=5, angle = 90), axis.text.y = element_text(size=20),
        legend.text=element_text(size=20), legend.key.size = unit(5, "cm"), legend.key.height = unit(2, "cm"), legend.key.width = unit(4, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Phùng-Hà Nội")

plot_df
ggsave(filename = file.path("figures", "General", "Phung-Ha Noi-Density-2(2).jpeg"), width = 25, height = 16)
```

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

gg_phung_hanoi = ggplot(phung_hanoi) +
  geom_sf(aes(fill = songuoi_km)) +
  scale_fill_viridis("Mật độ người/km2", direction = -1, option = "viridis") +
  ggtitle("Phùng-Hà Nội") +
  theme_bw()

plot_gg(gg_phung_hanoi, multicore = TRUE, width = 6 ,height=3, fov = 70)
render_depth(focallength=100,focus=0.72)
render_movie("figures/phung_hanoi.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
```

## Họ Phùng - Nghệ An

```{r}
# Phương án 2
phung_nghean <- dat_sff %>% filter(Ho=="Phùng" & NAME_1=="Nghe An") %>% st_as_sf(crs = 4326)
phung_nghean$centroid <- sf::st_transform(phung_nghean, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
phung_nghean <- phung_nghean %>%
  mutate(centroid_0 = centroid[NAME_3=="Phuong Nghi Thuy"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

phung_nghean_radius <- phung_nghean %>%
  arrange(distm_km) %>%
  mutate(rank=row_number(),
         NAME_3=gsub("Xa","",NAME_3),
         NAME_3=gsub("Phuong","",NAME_3),
         NAME_3=gsub("Thi tran","",NAME_3),
         commune=paste(NAME_3, NAME_2, sep = "-"))
#write_xlsx(phung_nghean_radius, "output/phung_nghean_radius.xlsx")

distm_km<-phung_nghean_radius$distm_km
songuoi_km<-phung_nghean_radius$songuoi_km
rank<-phung_nghean_radius$rank
commune<-phung_nghean_radius$commune
rank<-factor(rank, labels = commune)
estimate<-55*exp(-(distm_km^2)/(2*160))

df<-data.frame(distm_km, rank, commune, estimate, songuoi_km) %>%
  mutate(num=sum((songuoi_km-estimate)^2),
         den=(length(df)-1),
         var=num/den,
         sd=sqrt(var))
  
breaks <- c(0, 10, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200, 220, 240, 260, 280, 300)

plot_df <- df %>%
  #filter(row_number()<=100) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=songuoi_km, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=songuoi_km), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=songuoi_km, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=7)) +
  scale_x_discrete(name = "Xã/Phường", 
                     breaks = reorder(factor(rank), distm_km), 
                     labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Mật độ người/km2") +
  theme_bw() + 
  theme(text = element_text(size=20), axis.text.x = element_text(size=5, angle = 90), axis.text.y = element_text(size=20),
        legend.text=element_text(size=20), legend.key.size = unit(5, "cm"), legend.key.height = unit(2, "cm"), legend.key.width = unit(4, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Phùng-Nghệ An")

plot_df
ggsave(filename = file.path("figures", "General", "Phung-Nghe An-Density-2(2).jpeg"), width = 25, height = 16)
```

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

gg_phung_nghean = ggplot(phung_nghean) +
  geom_sf(aes(fill = songuoi_km)) +
  scale_fill_viridis("Mật độ người/km2", direction = -1, option = "viridis") +
  ggtitle("Phùng-Nghệ An") +
  theme_bw()

plot_gg(gg_phung_nghean, multicore = TRUE, width = 6 ,height=3, fov = 70)
render_depth(focallength=100,focus=0.72)
render_movie("figures/phung_nghean.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
```

## Họ Phùng - Vĩnh Phúc

```{r}
# Phương án 2
phung_vinhphuc <- dat_sff %>% filter(Ho=="Phùng" & NAME_1=="Vinh Phuc") %>% st_as_sf(crs = 4326)
phung_vinhphuc$centroid <- sf::st_transform(phung_vinhphuc, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
phung_vinhphuc <- phung_vinhphuc %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Hop Thinh"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

phung_vinhphuc_radius <- phung_vinhphuc %>%
  arrange(distm_km) %>%
  mutate(rank=row_number(),
         NAME_3=gsub("Xa","",NAME_3),
         NAME_3=gsub("Phuong","",NAME_3),
         NAME_3=gsub("Thi tran","",NAME_3),
         commune=paste(NAME_3, NAME_2, sep = "-"))
#write_xlsx(phung_vinhphuc_radius, "output/phung_vinhphuc_radius.xlsx")

distm_km<-phung_vinhphuc_radius$distm_km
songuoi_km<-phung_vinhphuc_radius$songuoi_km
rank<-phung_vinhphuc_radius$rank
commune<-phung_vinhphuc_radius$commune
rank<-factor(rank, labels = commune)
estimate<-55*exp(-(distm_km^2)/(2*160))

df<-data.frame(distm_km, rank, commune, estimate, songuoi_km) %>%
  mutate(num=sum((songuoi_km-estimate)^2),
         den=(length(df)-1),
         var=num/den,
         sd=sqrt(var))

breaks <- c(0, 10, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200, 220, 240, 260, 280, 300)

plot_df <- df %>%
  #filter(row_number()<=100) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=songuoi_km, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=songuoi_km), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=songuoi_km, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=7)) +
  scale_x_discrete(name = "Xã/Phường", 
                     breaks = reorder(factor(rank), distm_km), 
                     labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Mật độ người/km2") +
  theme_bw() + 
  theme(text = element_text(size=20), axis.text.x = element_text(size=10, angle = 90), axis.text.y = element_text(size=20),
        legend.text=element_text(size=20), legend.key.size = unit(5, "cm"), legend.key.height = unit(2, "cm"), legend.key.width = unit(4, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Phùng-Vĩnh Phúc")

plot_df
ggsave(filename = file.path("figures", "General", "Phung-Vinh Phuc-Density-2(2).jpeg"), width = 25, height = 16)
```

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

gg_phung_vinhphuc = ggplot(phung_vinhphuc) +
  geom_sf(aes(fill = songuoi_km)) +
  scale_fill_viridis("Mật độ người/km2", direction = -1, option = "viridis") +
  ggtitle("Phùng-Vĩnh Phúc") +
  theme_bw()

plot_gg(gg_phung_vinhphuc, multicore = TRUE, width = 6 ,height=3, fov = 70)
render_depth(focallength=100,focus=0.72)
render_movie("figures/phung_vinhphuc.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
```

## Họ Dương - Thanh Hóa

```{r}
duong_barf <- dat_sff %>% filter(Ho=="Dương") %>% filter(rank(desc(songuoi_km))<=50) %>%
  ggplot(aes(x = reorder(NAME_3, songuoi_km, decreasing=F), y =songuoi_km, fill=factor(NAME_1))) +
  geom_bar(stat = "identity", width = 0.75) +
  scale_x_discrete(name = NULL) +
  scale_fill_discrete(name="Tỉnh/thành phố") +
  theme_bw() + 
  theme(axis.text.y = element_text(size = 7),
        panel.grid.major = element_blank()) + coord_flip() +
  ggtitle("Dương")
ggsave(filename = file.path("figures", "General", "Duong-Density-xa(2).jpeg"), width = 10, height = 7)
```

```{r}
duong_thanhhoa <- dat_sff %>% filter(Ho=="Dương" & NAME_1=="Thanh Hoa") %>% st_as_sf(crs = 4326)
duong_thanhhoa$centroid <- sf::st_transform(duong_thanhhoa, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
duong_thanhhoa <- duong_thanhhoa %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Thieu Duong" & NAME_2=="Thanh Hoa"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

duong_thanhhoa_radius <- duong_thanhhoa %>%
  arrange(distm_km) %>%
  mutate(rank=row_number(),
         NAME_3=gsub("Xa","",NAME_3),
         NAME_3=gsub("Phuong","",NAME_3),
         NAME_3=gsub("Thi tran","",NAME_3),
         commune=paste(NAME_3, NAME_2, sep = "-"))
write_xlsx(duong_thanhhoa_radius, "output/duong_thanhhoa_radius.xlsx")
```

```{r}
distm_km<-duong_thanhhoa_radius$distm_km
songuoi_km<-duong_thanhhoa_radius$songuoi_km
rank<-duong_thanhhoa_radius$rank
commune<-duong_thanhhoa_radius$commune
rank<-factor(rank, labels = commune)
estimate<-135*exp(-(distm_km^2)/(2*sqrt(1659)))

df<-data.frame(distm_km, rank, commune, estimate, songuoi_km)

plot_df <- df %>%
  ggplot(aes(x=reorder(factor(rank), -distm_km), y=distm_km)) +
  geom_bar(aes(x=as.numeric(reorder(factor(rank), -distm_km)), y=distm_km), stat = "identity", width = 0.5) + 
  geom_line(aes(x=as.numeric(reorder(factor(rank), -distm_km)), y=estimate))

plot_df
```

```{r}
duong_thanhhoa_dens2 <- duong_thanhhoa_radius %>% 
  filter(rank<=100) %>%
  ggplot(aes(x = reorder(commune, -distm_km), y =distm_km)) +
  #geom_point() +
  geom_bar(stat = "identity", width = 0.5) +
  #geom_line(aes(x=reorder(NAME_3, -distm_km), y=predict(fit5), col='blue')) +
  stat_summary(aes(label=paste0(round(songuoi_km,0), "", "ng/km2")), geom="text", size=4, position = position_dodge(width= 1), vjust= 0.5, hjust = 0) +
  #stat_smooth(method = 'lm', formula = distm_km ~ poly(reorder(NAME_3, -distm_km),5), aes(colour = 'polynomial'), se= TRUE) +
  #stat_function(fun = dnorm, args = list(mean = 0, sd = 26.2)) +
  #geom_line(aes(x = exp(-distm_km^2/685), y=distm_km)) +
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_smooth(method = "lm", se = FALSE) +
  #geom_smooth(method = "loess", se = FALSE) +
  scale_x_discrete(name = "Xã/Phường") +
  scale_y_continuous(name="Khoảng cách tới tâm (km)") +
  theme_bw() + 
  theme(text = element_text(size=20), axis.text.x = element_text(size=20), axis.text.y = element_text(size=12)) +
  theme(panel.grid.major = element_blank()) + 
  annotate(geom='text', x=80, y=10, label="y == 135*e^-{(x^{2}+y^{2})/2*(40.7)}", parse = TRUE,size=10) +
  coord_flip() +
  ggtitle("Dương-Thanh Hóa")
ggsave(filename = file.path("figures", "General", "Duong-Thanh Hoa-Density-2.jpeg"), width = 25, height = 16)
```

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

gg_duong_thanhhoa = ggplot(duong_thanhhoa) +
  geom_sf(aes(fill = songuoi_km)) +
  scale_fill_viridis("Mật độ người/km2", direction = -1, option = "viridis") +
  ggtitle("Dương-Thanh Hóa") +
  theme_bw()

plot_gg(gg_duong_thanhhoa, multicore = TRUE, width = 6 ,height=3, fov = 70)
render_depth(focallength=100,focus=0.72)
render_movie("figures/duong_thanhhoa.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
```

## Họ Lê - Thanh Hóa

```{r}
le_barf <- dat_sff %>% filter(Ho=="Lê") %>% filter(rank(desc(songuoi_km))<=50) %>%
  ggplot(aes(x = reorder(NAME_3, songuoi_km, decreasing=F), y =songuoi_km, fill=factor(NAME_1))) +
  geom_bar(stat = "identity", width = 0.75) +
  scale_x_discrete(name = NULL) +
  scale_fill_discrete(name="Tỉnh/thành phố") +
  theme_bw() + 
  theme(axis.text.y = element_text(size = 7),
        panel.grid.major = element_blank()) + coord_flip() +
  ggtitle("Lê")
ggsave(filename = file.path("figures", "General", "Le-Density-xa(2).jpeg"), width = 10, height = 7)
```

```{r}
le_thanhhoa <- dat_sff %>% filter(Ho=="Lê" & NAME_1=="Thanh Hoa") %>% st_as_sf(crs = 4326)
le_thanhhoa$centroid <- sf::st_transform(le_thanhhoa, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
le_thanhhoa <- le_thanhhoa %>%
  mutate(centroid_0 = centroid[NAME_3=="Phuong Ngoc Trao" & NAME_2=="Thanh Hoa"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

le_thanhhoa_radius <- le_thanhhoa %>%
  arrange(distm_km) %>%
  mutate(rank=row_number(),
         NAME_3=gsub("Xa","",NAME_3),
         NAME_3=gsub("Phuong","",NAME_3),
         NAME_3=gsub("Thi tran","",NAME_3),
         commune=paste(NAME_3, NAME_2, sep = "-"))
write_xlsx(le_thanhhoa_radius, "output/le_thanhhoa_radius.xlsx")
```

```{r}
distm_km<-le_thanhhoa_radius$distm_km
songuoi_km<-le_thanhhoa_radius$songuoi_km
rank<-le_thanhhoa_radius$rank
commune<-le_thanhhoa_radius$commune
rank<-factor(rank, labels = commune)
estimate<-165*exp(-(distm_km^2)/(2*sqrt(2123)))

df<-data.frame(distm_km, rank, commune, estimate, songuoi_km)

plot_df <- df %>%
  ggplot(aes(x=reorder(factor(rank), -distm_km), y=distm_km)) +
  geom_bar(aes(x=as.numeric(reorder(factor(rank), -distm_km)), y=distm_km), stat = "identity", width = 0.5) + 
  geom_line(aes(x=as.numeric(reorder(factor(rank), -distm_km)), y=estimate))

plot_df
```

```{r}
le_thanhhoa_dens2 <- le_thanhhoa_radius %>% 
  filter(rank<=100) %>%
  ggplot(aes(x = reorder(commune, -distm_km), y =distm_km)) +
  #geom_point() +
  geom_bar(stat = "identity", width = 0.5) +
  #geom_line(aes(x=reorder(NAME_3, -distm_km), y=predict(fit5), col='blue')) +
  stat_summary(aes(label=paste0(round(songuoi_km,0), "", "ng/km2")), geom="text", size=4, position = position_dodge(width= 1), vjust= 0.5, hjust = 0) +
  #stat_smooth(method = 'lm', formula = distm_km ~ poly(reorder(NAME_3, -distm_km),5), aes(colour = 'polynomial'), se= TRUE) +
  #stat_function(fun = dnorm, args = list(mean = 0, sd = 26.2)) +
  #geom_line(aes(x = exp(-distm_km^2/685), y=distm_km)) +
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_smooth(method = "lm", se = FALSE) +
  #geom_smooth(method = "loess", se = FALSE) +
  scale_x_discrete(name = "Xã/Phường") +
  scale_y_continuous(name="Khoảng cách tới tâm (km)") +
  theme_bw() + 
  theme(text = element_text(size=20), axis.text.x = element_text(size=20), axis.text.y = element_text(size=12)) +
  theme(panel.grid.major = element_blank()) + 
  annotate(geom='text', x=80, y=8, label="y == 165*e^-{(x^{2}+y^{2})/2*(46.1)}", parse = TRUE,size=10) +
  coord_flip() +
  ggtitle("Lê-Thanh Hóa")
ggsave(filename = file.path("figures", "General", "Le-Thanh Hoa-Density-2.jpeg"), width = 25, height = 16)
```

## Họ Lã - Thái Bình

```{r}
la_barf <- dat_sff %>% filter(Ho=="Lã") %>% filter(rank(desc(songuoi_km))<=50) %>%
  ggplot(aes(x = reorder(NAME_3, songuoi_km, decreasing=F), y =songuoi_km, fill=factor(NAME_1))) +
  geom_bar(stat = "identity", width = 0.75) +
  scale_x_discrete(name = NULL) +
  scale_fill_discrete(name="Tỉnh/thành phố") +
  theme_bw() + 
  theme(axis.text.y = element_text(size = 7),
        panel.grid.major = element_blank()) + coord_flip() +
  ggtitle("Lã")
ggsave(filename = file.path("figures", "General", "La-Density-xa(2).jpeg"), width = 10, height = 7)
```

```{r}
la_thaibinh <- dat_sff %>% filter(Ho=="Lã" & NAME_1=="Thai Binh") %>% st_as_sf(crs = 4326)
la_thaibinh$centroid <- sf::st_transform(la_thaibinh, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
la_thaibinh <- la_thaibinh %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Thuy Duong"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

la_thaibinh_radius <- la_thaibinh %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())
write_xlsx(la_thaibinh_radius, "output/la_thaibinh_radius.xlsx")
```

```{r}
distm_km<-la_thaibinh_radius$distm_km
songuoi_km<-la_thaibinh_radius$songuoi_km
rank<-la_thaibinh_radius$rank
commune<-la_thaibinh_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-165*exp(-(distm_km^2)/(2*sqrt(2123)))

df<-data.frame(distm_km, rank, commune, estimate, songuoi_km)

plot_df <- df %>%
  ggplot(aes(x=reorder(factor(rank), -distm_km), y=distm_km)) +
  geom_bar(aes(x=as.numeric(reorder(factor(rank), -distm_km)), y=distm_km), stat = "identity", width = 0.5) + 
  geom_line(aes(x=as.numeric(reorder(factor(rank), -distm_km)), y=estimate))

plot_df
```

```{r}
la_thaibinh_dens2 <- la_thaibinh_radius %>% 
  #filter(rank<=100) %>%
  ggplot(aes(x = reorder(commune, -distm_km), y =distm_km)) +
  #geom_point() +
  geom_bar(stat = "identity", width = 0.5) +
  #geom_line(aes(x=reorder(NAME_3, -distm_km), y=predict(fit5), col='blue')) +
  #stat_summary(aes(label=paste0(round(songuoi_km,0), "", "ng/km2")), geom="text", size=4, position = position_dodge(width= 1), vjust= 0.5, hjust = 0) +
  #stat_smooth(method = 'lm', formula = distm_km ~ poly(reorder(NAME_3, -distm_km),5), aes(colour = 'polynomial'), se= TRUE) +
  #stat_function(fun = dnorm, args = list(mean = 0, sd = 26.2)) +
  #geom_line(aes(x = exp(-distm_km^2/685), y=distm_km)) +
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_smooth(method = "lm", se = FALSE) +
  #geom_smooth(method = "loess", se = FALSE) +
  scale_x_discrete(name = "Xã/Phường") +
  scale_y_continuous(name="Khoảng cách tới tâm (km)") +
  theme_bw() + 
  theme(text = element_text(size=20), axis.text.x = element_text(size=20), axis.text.y = element_text(size=12)) +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=80, y=8, label="y == 165*e^-{(x^{2}+y^{2})/2*(46.1)}", parse = TRUE,size=10) +
  coord_flip() +
  ggtitle("Lã-Thái Bình")
ggsave(filename = file.path("figures", "General", "La-Thai Binh-Density-2.jpeg"), width = 25, height = 16)
```

```{r}
# Phương án 2
la_thaibinh <- dat_sff %>% filter(Ho=="Lã" & NAME_1=="Thai Binh") %>% st_as_sf(crs = 4326)
la_thaibinh$centroid <- sf::st_transform(la_thaibinh, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
la_thaibinh <- la_thaibinh %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Thuy Duong"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

la_thaibinh_radius <- la_thaibinh %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())
#write_xlsx(la_thaibinh_radius, "output/la_thaibinh_radius.xlsx")

distm_km<-la_thaibinh_radius$distm_km
songuoi_km<-la_thaibinh_radius$songuoi_km
rank<-la_thaibinh_radius$rank
commune<-la_thaibinh_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-55*exp(-(distm_km^2)/(2*160))

df<-data.frame(distm_km, rank, commune, estimate, songuoi_km) %>%
  mutate(num=sum((songuoi_km-estimate)^2),
         den=(length(df)-1),
         var=num/den,
         sd=sqrt(var))

breaks <- c(0, 10, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200, 220, 240, 260, 280, 300)

plot_df <- df %>%
  #filter(row_number()<=100) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=songuoi_km, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=songuoi_km), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=songuoi_km, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=7)) +
  scale_x_discrete(name = "Xã/Phường", 
                     breaks = reorder(factor(rank), distm_km), 
                     labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Mật độ người/km2") +
  theme_bw() + 
  theme(text = element_text(size=20), axis.text.x = element_text(size=10, angle = 90), axis.text.y = element_text(size=20),
        legend.text=element_text(size=20), legend.key.size = unit(5, "cm"), legend.key.height = unit(2, "cm"), legend.key.width = unit(4, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Lã-Thái Bình")

plot_df
ggsave(filename = file.path("figures", "General", "La-Thai Binh-Density-2(2).jpeg"), width = 25, height = 16)
```

## Họ Lã - TPHCM

```{r}
# Phương án 2
la_hcm <- dat_sff %>% filter(Ho=="Lã" & NAME_1=="Ho Chi Minh") %>% st_as_sf(crs = 4326)
la_hcm$centroid <- sf::st_transform(la_hcm, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
la_hcm <- la_hcm %>%
  mutate(centroid_0 = centroid[NAME_3=="Phuong Phu Trung"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

la_hcm_radius <- la_hcm %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())
#write_xlsx(la_hcm_radius, "output/la_hcm_radius.xlsx")

distm_km<-la_hcm_radius$distm_km
songuoi_km<-la_hcm_radius$songuoi_km
rank<-la_hcm_radius$rank
commune<-la_hcm_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-55*exp(-(distm_km^2)/(2*160))

df<-data.frame(distm_km, rank, commune, estimate, songuoi_km) %>%
  mutate(num=sum((songuoi_km-estimate)^2),
         den=(length(df)-1),
         var=num/den,
         sd=sqrt(var))

breaks <- c(0, 10, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200, 220, 240, 260, 280, 300)

plot_df <- df %>%
  #filter(row_number()<=100) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=songuoi_km, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=songuoi_km), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=songuoi_km, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=7)) +
  scale_x_discrete(name = "Xã/Phường", 
                     breaks = reorder(factor(rank), distm_km), 
                     labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Mật độ người/km2") +
  theme_bw() + 
  theme(text = element_text(size=20), axis.text.x = element_text(size=10, angle = 90), axis.text.y = element_text(size=20),
        legend.text=element_text(size=20), legend.key.size = unit(5, "cm"), legend.key.height = unit(2, "cm"), legend.key.width = unit(4, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Lã-TP Hồ Chí Minh")

plot_df
ggsave(filename = file.path("figures", "General", "La-Ho Chi Minh-Density-2(2).jpeg"), width = 25, height = 16)
```

## Họ Mã - Thái Nguyên

```{r}
ma_barf <- dat_sff %>% filter(Ho=="Mã") %>% filter(rank(desc(songuoi_km))<=50) %>%
  ggplot(aes(x = reorder(NAME_3, songuoi_km, decreasing=F), y =songuoi_km, fill=factor(NAME_1))) +
  geom_bar(stat = "identity", width = 0.75) +
  scale_x_discrete(name = NULL) +
  scale_fill_discrete(name="Tỉnh/thành phố") +
  theme_bw() + 
  theme(axis.text.y = element_text(size = 7),
        panel.grid.major = element_blank()) + coord_flip() +
  ggtitle("Mã")
ggsave(filename = file.path("figures", "General", "Ma-Density-xa(2).jpeg"), width = 10, height = 7)
```

```{r}
ma_thanhhoa <- dat_sff %>% filter(Ho=="Mã" & NAME_1=="Thanh Hoa") %>% st_as_sf(crs = 4326)
ma_thanhhoa$centroid <- sf::st_transform(ma_thanhhoa, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
ma_thanhhoa <- ma_thanhhoa %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Nga Thach"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

ma_thanhhoa_radius <- ma_thanhhoa %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())
write_xlsx(ma_thanhhoa_radius, "output/ma_thanhhoa_radius.xlsx")
```

```{r}
distm_km<-la_thaibinh_radius$distm_km
songuoi_km<-la_thaibinh_radius$songuoi_km
rank<-la_thaibinh_radius$rank
commune<-la_thaibinh_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-165*exp(-(distm_km^2)/(2*sqrt(2123)))

df<-data.frame(distm_km, rank, commune, estimate, songuoi_km)

plot_df <- df %>%
  ggplot(aes(x=reorder(factor(rank), -distm_km), y=distm_km)) +
  geom_bar(aes(x=as.numeric(reorder(factor(rank), -distm_km)), y=distm_km), stat = "identity", width = 0.5) + 
  geom_line(aes(x=as.numeric(reorder(factor(rank), -distm_km)), y=estimate))

plot_df
```

```{r}
la_thaibinh_dens2 <- la_thaibinh_radius %>% 
  #filter(rank<=100) %>%
  ggplot(aes(x = reorder(commune, -distm_km), y =distm_km)) +
  #geom_point() +
  geom_bar(stat = "identity", width = 0.5) +
  #geom_line(aes(x=reorder(NAME_3, -distm_km), y=predict(fit5), col='blue')) +
  #stat_summary(aes(label=paste0(round(songuoi_km,0), "", "ng/km2")), geom="text", size=4, position = position_dodge(width= 1), vjust= 0.5, hjust = 0) +
  #stat_smooth(method = 'lm', formula = distm_km ~ poly(reorder(NAME_3, -distm_km),5), aes(colour = 'polynomial'), se= TRUE) +
  #stat_function(fun = dnorm, args = list(mean = 0, sd = 26.2)) +
  #geom_line(aes(x = exp(-distm_km^2/685), y=distm_km)) +
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_smooth(method = "lm", se = FALSE) +
  #geom_smooth(method = "loess", se = FALSE) +
  scale_x_discrete(name = "Xã/Phường") +
  scale_y_continuous(name="Khoảng cách tới tâm (km)") +
  theme_bw() + 
  theme(text = element_text(size=20), axis.text.x = element_text(size=20), axis.text.y = element_text(size=12)) +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=80, y=8, label="y == 165*e^-{(x^{2}+y^{2})/2*(46.1)}", parse = TRUE,size=10) +
  coord_flip() +
  ggtitle("Lã-Thái Bình")
ggsave(filename = file.path("figures", "General", "La-Thai Binh-Density-2.jpeg"), width = 25, height = 16)
```

```{r}
# Phương án 2
la_thaibinh <- dat_sff %>% filter(Ho=="Lã" & NAME_1=="Thai Binh") %>% st_as_sf(crs = 4326)
la_thaibinh$centroid <- sf::st_transform(la_thaibinh, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
la_thaibinh <- la_thaibinh %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Thuy Duong"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

la_thaibinh_radius <- la_thaibinh %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())
#write_xlsx(la_thaibinh_radius, "output/la_thaibinh_radius.xlsx")

distm_km<-la_thaibinh_radius$distm_km
songuoi_km<-la_thaibinh_radius$songuoi_km
rank<-la_thaibinh_radius$rank
commune<-la_thaibinh_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-55*exp(-(distm_km^2)/(2*160))

df<-data.frame(distm_km, rank, commune, estimate, songuoi_km) %>%
  mutate(num=sum((songuoi_km-estimate)^2),
         den=(length(df)-1),
         var=num/den,
         sd=sqrt(var))

breaks <- c(0, 10, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200, 220, 240, 260, 280, 300)

plot_df <- df %>%
  #filter(row_number()<=100) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=songuoi_km, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=songuoi_km), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=songuoi_km, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=7)) +
  scale_x_discrete(name = "Xã/Phường", 
                     breaks = reorder(factor(rank), distm_km), 
                     labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Mật độ người/km2") +
  theme_bw() + 
  theme(text = element_text(size=20), axis.text.x = element_text(size=10, angle = 90), axis.text.y = element_text(size=20),
        legend.text=element_text(size=20), legend.key.size = unit(5, "cm"), legend.key.height = unit(2, "cm"), legend.key.width = unit(4, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Lã-Thái Bình")

plot_df
ggsave(filename = file.path("figures", "General", "La-Thai Binh-Density-2(2).jpeg"), width = 25, height = 16)
```

## Họ Dư - Hà Nội

```{r}
du_barf <- dat_sff %>% filter(Ho=="Dư") %>% filter(rank(desc(songuoi_km))<=50) %>%
  ggplot(aes(x = reorder(NAME_3, songuoi_km, decreasing=F), y =songuoi_km, fill=factor(NAME_1))) +
  geom_bar(stat = "identity", width = 0.75) +
  scale_x_discrete(name = NULL) +
  scale_fill_discrete(name="Tỉnh/thành phố") +
  theme_bw() + 
  theme(axis.text.y = element_text(size = 7),
        panel.grid.major = element_blank()) + coord_flip() +
  ggtitle("Dư")
ggsave(filename = file.path("figures", "General", "Du-Density-xa(2).jpeg"), width = 10, height = 7)
```

```{r}
du_hanoi <- dat_sff %>% filter(Ho=="Dư" & NAME_1=="Ha Noi") %>% st_as_sf(crs = 4326)
du_hanoi$centroid <- sf::st_transform(du_hanoi, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
du_hanoi <- du_hanoi %>%
  mutate(centroid_0 = centroid[NAME_3=="Phuong Quynh Loi" & NAME_2=="Hai Ba Trung"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

du_hanoi_radius <- du_hanoi %>%
  arrange(distm_km) %>%
  mutate(rank=row_number(),
         NAME_3=gsub("Xa","",NAME_3),
         NAME_3=gsub("Phuong","",NAME_3),
         NAME_3=gsub("Thi tran","",NAME_3),
         commune=paste(NAME_3, NAME_2, sep = "-"))
write_xlsx(du_hanoi_radius, "output/du_hanoi_radius.xlsx")
```

```{r}
distm_km<-du_hanoi_radius$distm_km
songuoi_km<-du_hanoi_radius$songuoi_km
rank<-du_hanoi_radius$rank
commune<-du_hanoi_radius$commune
rank<-factor(rank, labels = commune)
estimate<-60*exp(-(distm_km^2)/(2*sqrt(483)))

df<-data.frame(distm_km, rank, commune, estimate, songuoi_km)

plot_df <- df %>%
  ggplot(aes(x=reorder(factor(rank), -distm_km), y=distm_km)) +
  geom_bar(aes(x=as.numeric(reorder(factor(rank), -distm_km)), y=distm_km), stat = "identity", width = 0.5) + 
  geom_line(aes(x=as.numeric(reorder(factor(rank), -distm_km)), y=estimate))

plot_df
```

```{r}
du_hanoi_dens2 <- du_hanoi_radius %>% 
  filter(rank<=100) %>%
  ggplot(aes(x = reorder(commune, -distm_km), y =distm_km)) +
  #geom_point() +
  geom_bar(stat = "identity", width = 0.5) +
  #geom_line(aes(x=reorder(NAME_3, -distm_km), y=predict(fit5), col='blue')) +
  stat_summary(aes(label=paste0(round(songuoi_km,0), "", "ng/km2")), geom="text", size=4, position = position_dodge(width= 1), vjust= 0.5, hjust = 0) +
  #stat_smooth(method = 'lm', formula = distm_km ~ poly(reorder(NAME_3, -distm_km),5), aes(colour = 'polynomial'), se= TRUE) +
  #stat_function(fun = dnorm, args = list(mean = 0, sd = 26.2)) +
  #geom_line(aes(x = exp(-distm_km^2/685), y=distm_km)) +
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_smooth(method = "lm", se = FALSE) +
  #geom_smooth(method = "loess", se = FALSE) +
  scale_x_discrete(name = "Xã/Phường") +
  scale_y_continuous(name="Khoảng cách tới tâm (km)") +
  theme_bw() + 
  theme(text = element_text(size=20), axis.text.x = element_text(size=20), axis.text.y = element_text(size=12)) +
  theme(panel.grid.major = element_blank()) + 
  annotate(geom='text', x=80, y=4, label="y == 60*e^-{(x^{2}+y^{2})/2*(22)}", parse = TRUE,size=10) +
  coord_flip() +
  ggtitle("Dư-Hà Nội")
ggsave(filename = file.path("figures", "General", "Dư-Hà Nội-Density-2.jpeg"), width = 25, height = 16)
```

```{r}
ly_barf <- dat_sff %>% filter(Ho=="Lý") %>% filter(rank(desc(songuoi_km))<=50) %>%
  ggplot(aes(x = reorder(NAME_3, songuoi_km, decreasing=F), y =songuoi_km, fill=factor(NAME_1))) +
  geom_bar(stat = "identity", width = 0.75) +
  scale_x_discrete(name = NULL) +
  scale_fill_discrete(name="Tỉnh/thành phố") +
  theme_bw() + 
  theme(axis.text.y = element_text(size = 7),
        panel.grid.major = element_blank()) + coord_flip() +
  ggtitle("Lý")
ggsave(filename = file.path("figures", "General", "Ly-Density-xa(2).jpeg"), width = 10, height = 7)
```

```{r}
trieu_barf <- dat_sff %>% filter(Ho=="Triệu") %>% filter(rank(desc(songuoi_km))<=50) %>%
  ggplot(aes(x = reorder(NAME_3, songuoi_km, decreasing=F), y =songuoi_km, fill=factor(NAME_1))) +
  geom_bar(stat = "identity", width = 0.75) +
  scale_x_discrete(name = NULL) +
  scale_fill_discrete(name="Tỉnh/thành phố") +
  theme_bw() + 
  theme(axis.text.y = element_text(size = 7),
        panel.grid.major = element_blank()) + coord_flip() +
  ggtitle("Triệu")
ggsave(filename = file.path("figures", "General", "Trieu-Density-xa(2).jpeg"), width = 10, height = 7)
```

## Export data

```{r}
bacbo <- c("Bac Giang", "Bac Kan", "Bac Ninh", "Cao Bang", "Dien Bien",  "Ha Giang", "Ha Nam", "Ha Noi", "Ha Tinh", "Hai Duong", "Hai Phong", "Hoa Binh", "Hung Yen", "Lai Chau", "Lang Son", "Lao Cai", "Nam Dinh", "Nghe An", "Ninh Binh", "Phu Tho", "Quang Binh", "Quang Ninh", "Quang Tri", "Son La", "Thai Binh", "Thai Nguyen", "Thanh Hoa", "Tuyen Quang", "Vinh Phuc", "Yen Bai")

data_bacbo <- dat_sff %>% filter(NAME_1 %in% bacbo) %>% st_as_sf(crs = 4326)
data_bacbo$centroid <- sf::st_transform(data_bacbo, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()
```

# Họ Trần - Bắc Bộ

```{r}
library(geosphere)
data_bacbo_tran <- data_bacbo %>% filter(Ho=="Trần") %>%
  mutate(centroid_0 = centroid[NAME_3=="Phuong Hang Trong" & NAME_2=="Hoan Kiem"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

tran_bacbo <- data_bacbo_tran %>%
  arrange(distm_km) %>%
  mutate(rank=row_number(),
         tinh=NAME_1,
         huyen=NAME_2,
         xa=NAME_3,
         danso_km = danso/area_km,
         x = map(centroid,1),
         y = map(centroid,2),
         x = as.numeric(x),
         y = as.numeric(y)) %>%
  select(tinh, huyen, xa, Ho, x, y, songuoi, danso, pro.pop, area_km, songuoi_km, danso_km, distm_km, rank)
write_xlsx(tran_bacbo, "output/tran_bacbo.xlsx")
```

# Họ Mai - Bắc Bộ

```{r}
library(geosphere)
data_bacbo_mai <- data_bacbo %>% filter(Ho=="Mai") %>%
  mutate(centroid_0 = centroid[NAME_3=="Phuong Hang Trong" & NAME_2=="Hoan Kiem"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

mai_bacbo <- data_bacbo_mai %>%
  arrange(distm_km) %>%
  mutate(rank=row_number(),
         tinh=NAME_1,
         huyen=NAME_2,
         xa=NAME_3,
         danso_km = danso/area_km,
         x = map(centroid,1),
         y = map(centroid,2),
         x = as.numeric(x),
         y = as.numeric(y)) %>%
  select(tinh, huyen, xa, Ho, x, y, songuoi, danso, pro.pop, area_km, songuoi_km, danso_km, distm_km, rank)
write_xlsx(mai_bacbo, "output/mai_bacbo.xlsx")
```

# Họ Mai

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#mai_bacbo_sf <- data_bacbo %>% filter(Ho=="Mai")
mai_sff <- dat_sff %>% 
  mutate(prop.mai=(sum(subset(., Ho=="Mai")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Mai") %>% 
  st_as_sf(crs = 4326)
gg_mai = ggplot(mai_sff) +
  geom_sf(aes(fill = songuoi_km), lwd=0) +
  annotate(geom="text", x=104.5, y=16, color="red", size=3, label= paste(round(mai_sff$prop.mai[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ người/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Mai") +
  theme_bw()

plot_gg(gg_mai, multicore = TRUE, raytrace = TRUE, width = 7, height = 4, 
       scale = 300, windowsize = c(1400, 866), zoom = 0.6, phi = 30, theta = 30)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Mai.png")
#render_movie("figures/3D/mai.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
render_snapshot(filename = "figures/3D/Mai.png", clear=T)
```

# Họ Ngô - Bắc Bộ

```{r}
library(geosphere)
data_bacbo_ngo <- data_bacbo %>% filter(Ho=="Ngô") %>%
  mutate(centroid_0 = centroid[NAME_3=="Phuong Hang Trong" & NAME_2=="Hoan Kiem"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

ngo_bacbo <- data_bacbo_ngo %>%
  arrange(distm_km) %>%
  mutate(rank=row_number(),
         tinh=NAME_1,
         huyen=NAME_2,
         xa=NAME_3,
         danso_km = danso/area_km,
         x = map(centroid,1),
         y = map(centroid,2),
         x = as.numeric(x),
         y = as.numeric(y)) %>%
  select(tinh, huyen, xa, Ho, x, y, songuoi, danso, pro.pop, area_km, songuoi_km, danso_km, distm_km, rank)
write_xlsx(ngo_bacbo, "output/ngo_bacbo.xlsx")
```

# Họ Phùng - Bắc Bộ

```{r}
library(geosphere)
data_bacbo_phung <- data_bacbo %>% filter(Ho=="Phùng") %>%
  mutate(centroid_0 = centroid[NAME_3=="Phuong Hang Trong" & NAME_2=="Hoan Kiem"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

phung_bacbo <- data_bacbo_phung %>%
  arrange(distm_km) %>%
  mutate(rank=row_number(),
         tinh=NAME_1,
         huyen=NAME_2,
         xa=NAME_3,
         danso_km = danso/area_km,
         x = map(centroid,1),
         y = map(centroid,2),
         x = as.numeric(x),
         y = as.numeric(y)) %>%
  select(tinh, huyen, xa, Ho, x, y, songuoi, danso, pro.pop, area_km, songuoi_km, danso_km, distm_km, rank)
write_xlsx(phung_bacbo, "output/phung_bacbo.xlsx")
```

# Họ Khúc - Bắc Bộ

```{r}
library(geosphere)
data_bacbo_khuc <- data_bacbo %>% filter(Ho=="Khúc") %>%
  mutate(centroid_0 = centroid[NAME_3=="Phuong Hang Trong" & NAME_2=="Hoan Kiem"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

khuc_bacbo <- data_bacbo_khuc %>%
  arrange(distm_km) %>%
  mutate(rank=row_number(),
         tinh=NAME_1,
         huyen=NAME_2,
         xa=NAME_3,
         danso_km = danso/area_km,
         x = map(centroid,1),
         y = map(centroid,2),
         x = as.numeric(x),
         y = as.numeric(y)) %>%
  select(tinh, huyen, xa, Ho, x, y, songuoi, danso, pro.pop, area_km, songuoi_km, danso_km, distm_km, rank)
write_xlsx(khuc_bacbo, "output/khuc_bacbo.xlsx")
```

# Họ Dư - Bắc Bộ

```{r}
library(geosphere)
data_bacbo_du <- data_bacbo %>% filter(Ho=="Dư") %>%
  mutate(centroid_0 = centroid[NAME_3=="Phuong Hang Trong" & NAME_2=="Hoan Kiem"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

du_bacbo <- data_bacbo_du %>%
  arrange(distm_km) %>%
  mutate(rank=row_number(),
         tinh=NAME_1,
         huyen=NAME_2,
         xa=NAME_3,
         danso_km = danso/area_km,
         x = map(centroid,1),
         y = map(centroid,2),
         x = as.numeric(x),
         y = as.numeric(y)) %>%
  select(tinh, huyen, xa, Ho, x, y, songuoi, danso, pro.pop, area_km, songuoi_km, danso_km, distm_km, rank)
write_xlsx(du_bacbo, "output/du_bacbo.xlsx")
```

# Họ Dương - Bắc Bộ

```{r}
library(geosphere)
data_bacbo_duong <- data_bacbo %>% filter(Ho=="Dương") %>%
  mutate(centroid_0 = centroid[NAME_3=="Phuong Hang Trong" & NAME_2=="Hoan Kiem"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

duong_bacbo <- data_bacbo_duong %>%
  arrange(distm_km) %>%
  mutate(rank=row_number(),
         tinh=NAME_1,
         huyen=NAME_2,
         xa=NAME_3,
         danso_km = danso/area_km,
         x = map(centroid,1),
         y = map(centroid,2),
         x = as.numeric(x),
         y = as.numeric(y)) %>%
  select(tinh, huyen, xa, Ho, x, y, songuoi, danso, pro.pop, area_km, songuoi_km, danso_km, distm_km, rank)
write_xlsx(duong_bacbo, "output/duong_bacbo.xlsx")
```

# Cả nước

## Họ Trần

```{r}
library(geosphere)
library(sf)

tran_all <- dat_sff %>% 
  mutate(prop.ho=(sum(subset(., Ho=="Trần")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Trần") %>% 
  st_as_sf(crs = 4326)

tran_all$centroid <- sf::st_transform(tran_all, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

data_tran <- tran_all %>% 
   mutate(centroid_0 = centroid[NAME_3=="Phuong Hang Trong" & NAME_2=="Hoan Kiem"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

tran <- data_tran %>%
  arrange(distm_km) %>%
  mutate(rank=row_number(),
         tinh=NAME_1,
         huyen=NAME_2,
         xa=NAME_3,
         danso_km = danso/area_km,
         x = map(centroid,1),
         y = map(centroid,2),
         x = as.numeric(x),
         y = as.numeric(y)) %>%
  select(tinh, huyen, xa, Ho, x, y, prop.ho, songuoi, danso, pro.pop, area_km, songuoi_km, danso_km, distm_km, rank)
write_xlsx(tran, "output/tran.xlsx")
```

## Họ Mai

```{r}
library(geosphere)
library(sf)

mai_all <- dat_sff %>% 
  mutate(prop.ho=(sum(subset(., Ho=="Mai")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Mai") %>% 
  st_as_sf(crs = 4326)

mai_all$centroid <- sf::st_transform(mai_all, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

data_mai <- mai_all %>% 
   mutate(centroid_0 = centroid[NAME_3=="Phuong Hang Trong" & NAME_2=="Hoan Kiem"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

mai <- data_mai %>%
  arrange(distm_km) %>%
  mutate(rank=row_number(),
         tinh=NAME_1,
         huyen=NAME_2,
         xa=NAME_3,
         danso_km = danso/area_km,
         x = map(centroid,1),
         y = map(centroid,2),
         x = as.numeric(x),
         y = as.numeric(y)) %>%
  select(tinh, huyen, xa, Ho, x, y, prop.ho, songuoi, danso, pro.pop, area_km, songuoi_km, danso_km, distm_km, rank)
write_xlsx(mai, "output/mai.xlsx")
```

## Họ Mã

```{r}
library(geosphere)
library(sf)

ma_all <- dat_sff %>% 
  mutate(prop.ho=(sum(subset(., Ho=="Mã")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Mã") %>% 
  st_as_sf(crs = 4326)

ma_all$centroid <- sf::st_transform(ma_all, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

data_ma <- ma_all %>% 
   mutate(centroid_0 = centroid[NAME_3=="Phuong Hang Buom" & NAME_2=="Hoan Kiem"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

ma <- data_ma %>%
  arrange(distm_km) %>%
  mutate(rank=row_number(),
         tinh=NAME_1,
         huyen=NAME_2,
         xa=NAME_3,
         danso_km = danso/area_km,
         x = map(centroid,1),
         y = map(centroid,2),
         x = as.numeric(x),
         y = as.numeric(y)) %>%
  select(tinh, huyen, xa, Ho, x, y, prop.ho, songuoi, danso, pro.pop, area_km, songuoi_km, danso_km, distm_km, rank)
write_xlsx(ma, "output/ma.xlsx")
```

## Họ Ngô

```{r}
library(geosphere)
library(sf)

ngo_all <- dat_sff %>% 
  mutate(prop.ho=(sum(subset(., Ho=="Ngô")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Ngô") %>% 
  st_as_sf(crs = 4326)

ngo_all$centroid <- sf::st_transform(ngo_all, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

data_ngo <- ngo_all %>% 
   mutate(centroid_0 = centroid[NAME_3=="Phuong Hang Trong" & NAME_2=="Hoan Kiem"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

ngo <- data_ngo %>%
  arrange(distm_km) %>%
  mutate(rank=row_number(),
         tinh=NAME_1,
         huyen=NAME_2,
         xa=NAME_3,
         danso_km = danso/area_km,
         x = map(centroid,1),
         y = map(centroid,2),
         x = as.numeric(x),
         y = as.numeric(y)) %>%
  select(tinh, huyen, xa, Ho, x, y, prop.ho, songuoi, danso, pro.pop, area_km, songuoi_km, danso_km, distm_km, rank)
write_xlsx(ngo, "output/ngo.xlsx")
```

## Họ Phùng

```{r}
library(geosphere)
library(sf)

phung_all <- dat_sff %>% 
  mutate(prop.ho=(sum(subset(., Ho=="Phùng")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Phùng") %>% 
  st_as_sf(crs = 4326)

phung_all$centroid <- sf::st_transform(phung_all, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

data_phung <- phung_all %>% 
   mutate(centroid_0 = centroid[NAME_3=="Phuong Hang Trong" & NAME_2=="Hoan Kiem"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

phung <- data_phung %>%
  arrange(distm_km) %>%
  mutate(rank=row_number(),
         tinh=NAME_1,
         huyen=NAME_2,
         xa=NAME_3,
         danso_km = danso/area_km,
         x = map(centroid,1),
         y = map(centroid,2),
         x = as.numeric(x),
         y = as.numeric(y)) %>%
  select(tinh, huyen, xa, Ho, x, y, prop.ho, songuoi, danso, pro.pop, area_km, songuoi_km, danso_km, distm_km, rank)
write_xlsx(phung, "output/phung.xlsx")
```

# Họ Khúc

```{r}
library(geosphere)
library(sf)

khuc_all <- dat_sff %>% 
  mutate(prop.ho=(sum(subset(., Ho=="Khúc")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Khúc") %>% 
  st_as_sf(crs = 4326)

khuc_all$centroid <- sf::st_transform(khuc_all, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

data_khuc <- khuc_all %>% 
   mutate(centroid_0 = centroid[NAME_3=="Phuong Hang Trong" & NAME_2=="Hoan Kiem"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

khuc <- data_khuc %>%
  arrange(distm_km) %>%
  mutate(rank=row_number(),
         tinh=NAME_1,
         huyen=NAME_2,
         xa=NAME_3,
         danso_km = danso/area_km,
         x = map(centroid,1),
         y = map(centroid,2),
         x = as.numeric(x),
         y = as.numeric(y)) %>%
  select(tinh, huyen, xa, Ho, x, y, prop.ho, songuoi, danso, pro.pop, area_km, songuoi_km, danso_km, distm_km, rank)
write_xlsx(khuc, "output/khuc.xlsx")
```

# Họ Dư

```{r}
library(geosphere)
library(sf)

du_all <- dat_sff %>% 
  mutate(prop.ho=(sum(subset(., Ho=="Dư")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Dư") %>% 
  st_as_sf(crs = 4326)

du_all$centroid <- sf::st_transform(du_all, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

data_du <- du_all %>% 
   mutate(centroid_0 = centroid[NAME_3=="Phuong Hang Trong" & NAME_2=="Hoan Kiem"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

du <- data_du %>%
  arrange(distm_km) %>%
  mutate(rank=row_number(),
         tinh=NAME_1,
         huyen=NAME_2,
         xa=NAME_3,
         danso_km = danso/area_km,
         x = map(centroid,1),
         y = map(centroid,2),
         x = as.numeric(x),
         y = as.numeric(y)) %>%
  select(tinh, huyen, xa, Ho, x, y, prop.ho, songuoi, danso, pro.pop, area_km, songuoi_km, danso_km, distm_km, rank)
write_xlsx(du, "output/du.xlsx")
```

# Họ Dương

```{r}
library(geosphere)
library(sf)

duong_all <- dat_sff %>% 
  mutate(prop.ho=(sum(subset(., Ho=="Dương")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Dương") %>% 
  st_as_sf(crs = 4326)

duong_all$centroid <- sf::st_transform(duong_all, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

data_duong <- duong_all %>% 
   mutate(centroid_0 = centroid[NAME_3=="Phuong Hang Trong" & NAME_2=="Hoan Kiem"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

duong <- data_duong %>%
  arrange(distm_km) %>%
  mutate(rank=row_number(),
         tinh=NAME_1,
         huyen=NAME_2,
         xa=NAME_3,
         danso_km = danso/area_km,
         x = map(centroid,1),
         y = map(centroid,2),
         x = as.numeric(x),
         y = as.numeric(y)) %>%
  select(tinh, huyen, xa, Ho, x, y, prop.ho, songuoi, danso, pro.pop, area_km, songuoi_km, danso_km, distm_km, rank)
write_xlsx(duong, "output/duong.xlsx")
```


# 3D Plot - Area

## Họ Mai

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#mai_bacbo_sf <- data_bacbo %>% filter(Ho=="Mai")
mai_sff <- dat_sff %>% 
  mutate(prop.mai=(sum(subset(., Ho=="Mai")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Mai") %>% 
  st_as_sf(crs = 4326)

gg_mai = ggplot(mai_sff) +
  geom_sf(aes(fill = songuoi_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(mai_sff$prop.mai[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ người/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Mai") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_mai, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)

#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Mai.png")
#render_movie("figures/3D/mai.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
#render_snapshot(filename = "figures/3D/Mai.png", clear=T)
render_snapshot(filename = "figures/3D2/Mai-PerArea.png", clear=T)

# Close the window when you're done
rgl::rgl.close()
```

# Họ Mai

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)
library(av)

#mai_bacbo_sf <- data_bacbo %>% filter(Ho=="Mai")
mai_sff <- dat_sff %>% 
  mutate(prop.mai=(sum(subset(., Ho=="Mai")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Mai") %>% 
  st_as_sf(crs = 4326)

mai_df <- mai_sff %>% st_drop_geometry() %>% arrange(desc(songuoi_km))

gg_mai = ggplot(mai_sff) +
  geom_sf(aes(fill = songuoi_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(mai_sff$prop.mai[1],1), "% dân số", sep = "")) +
  annotate(geom="text", x=107, y=20, color="purple", size=5, label= mai_df[1,"NAME_3"]) +
  scale_fill_viridis("Mật độ người/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Mai") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_mai, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)
render_movie("figures/3D2/mai.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
#rglwidget()

# Set up the camera position and angle
phivechalf = 30 + 60 * 1/(1 + exp(seq(-7, 20, length.out = 180)/2))
phivecfull = c(phivechalf, rev(phivechalf))
thetavec = 0 + 60 * sin(seq(0,359,length.out = 360) * pi/180)
zoomvec = 0.45 + 0.2 * 1/(1 + exp(seq(-5, 20, length.out = 180)))
zoomvecfull = c(zoomvec, rev(zoomvec))
render_movie("figures/3D2/mai(2).mp4",type = "custom", frames = 360, zoom = zoomvecfull, phi = phivecfull, theta = thetavec)

# Close the window when you're done
rgl::rgl.close()
```

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)
library(av)

#mai_bacbo_sf <- data_bacbo %>% filter(Ho=="Mai")
mai_sff <- dat_sff %>% 
  mutate(prop.mai=(sum(subset(., Ho=="Mai")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Mai") %>% 
  st_as_sf(crs = 4326)

mai_df <- mai_sff %>% st_drop_geometry() %>% arrange(desc(songuoi_km))

gg_mai = ggplot(mai_sff) +
  geom_sf(aes(fill = songuoi_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=22.5, label= paste(round(mai_sff$prop.mai[1],1), "% dân số", sep = "")) +
  annotate(geom="text", x=107, y=20, color="purple", size=15, label= mai_df[1,"NAME_3"]) +
  scale_fill_viridis("Mật độ người/km2", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=45), axis.text.y = element_text(size=45), legend.text=element_text(size=45)) +
  ggtitle("Họ Mai") +
  theme_bw() +
  theme(legend.key.height = unit(18, "mm"),
        legend.key.width = unit(3, "mm"))


plot_gg(gg_mai, multicore = TRUE, raytrace = T, width = 30, height = 45, 
       scale = 1500, windowsize = c(10500, 6495), zoom = 0.6, phi = 30, theta = 30)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Mai.png")
#render_movie("figures/3D/mai.mp4",frames = 1440, fps=60,zoom=0.6,fov = 30)
render_snapshot(filename = "figures/3D2/Mai-PerArea-HD.png", clear=T)

# Close the window when you're done
rgl::rgl.close()
# render_highquality(filename = "figures/3D2/Mai-HD.png", parallel = TRUE, samples = 300, intensity_env = 1.5, rotate_env = 180, width = round(6000 * wr), height = round(6000 * hr))
```

## Họ Mã

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#ma_bacbo_sf <- data_bacbo %>% filter(Ho=="Mã")
ma_sff <- dat_sff %>% 
  mutate(prop.ma=(sum(subset(., Ho=="Mã")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Mã") %>% 
  st_as_sf(crs = 4326)

gg_ma = ggplot(ma_sff) +
  geom_sf(aes(fill = songuoi_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(ma_sff$prop.ma[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ người/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Mã") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_ma, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)

#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Ma.png")
#render_movie("figures/3D/ma.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
#render_snapshot(filename = "figures/3D/Ma.png", clear=T)
render_snapshot(filename = "figures/3D2/Ma-PerArea.png", clear=T)

# Close the window when you're done
rgl::rgl.close()
```

## Họ Phùng

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#phung_bacbo_sf <- data_bacbo %>% filter(Ho=="Phùng")
phung_sff <- dat_sff %>% 
  mutate(prop.phung=(sum(subset(., Ho=="Phùng")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Phùng") %>% 
  st_as_sf(crs = 4326)

gg_phung = ggplot(phung_sff) +
  geom_sf(aes(fill = songuoi_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(phung_sff$prop.phung[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ người/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Phùng") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_phung, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)
render_movie("figures/3D2/phung(2).mp4",type = "custom", frames = 360, zoom = zoomvecfull, phi = phivecfull, theta = thetavec)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Phung.png")
#render_movie("figures/3D/phung.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
render_snapshot(filename = "figures/3D2/Phung-PerArea.png", clear=T)
# Close the window when you're done
rgl::rgl.close()
```

## Họ Ngô

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#ngo_bacbo_sf <- data_bacbo %>% filter(Ho=="Ngô")
ngo_sff <- dat_sff %>% 
  mutate(prop.ngo=(sum(subset(., Ho=="Ngô")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Ngô") %>% 
  st_as_sf(crs = 4326)

gg_ngo = ggplot(ngo_sff) +
  geom_sf(aes(fill = songuoi_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(ngo_sff$prop.ngo[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ người/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Ngô") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_ngo, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Ngo.png")
#render_movie("figures/3D/ngo.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
render_movie("figures/3D2/ngo(2).mp4",type = "custom", frames = 360, zoom = zoomvecfull, phi = phivecfull, theta = thetavec)
render_snapshot(filename = "figures/3D2/Ngo-PerArea.png", clear=T)
# Close the window when you're done
rgl::rgl.close()
```

## Họ Khúc

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#khuc_bacbo_sf <- data_bacbo %>% filter(Ho=="Khúc")
khuc_sff <- dat_sff %>% 
  mutate(prop.khuc=(sum(subset(., Ho=="Khúc")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Khúc") %>% 
  st_as_sf(crs = 4326)

gg_khuc = ggplot(khuc_sff) +
  geom_sf(aes(fill = songuoi_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(khuc_sff$prop.khuc[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ người/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Khúc") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_khuc, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)
render_movie("figures/3D2/khuc(2).mp4",type = "custom", frames = 360, zoom = zoomvecfull, phi = phivecfull, theta = thetavec)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Khuc.png")
#render_movie("figures/3D/khuc.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
render_snapshot(filename = "figures/3D2/Khuc-PerArea.png", clear=T)
# Close the window when you're done
rgl::rgl.close()
```

## Họ Trần

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#tran_bacbo_sf <- data_bacbo %>% filter(Ho=="Trần")
tran_sff <- dat_sff %>% 
  mutate(prop.tran=(sum(subset(., Ho=="Trần")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Trần") %>% 
  st_as_sf(crs = 4326)

gg_tran = ggplot(tran_sff) +
  geom_sf(aes(fill = songuoi_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(tran_sff$prop.tran[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ người/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Trần") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_tran, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)
render_movie("figures/3D2/tran(2).mp4",type = "custom", frames = 360, zoom = zoomvecfull, phi = phivecfull, theta = thetavec)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Tran.png")
#render_movie("figures/3D/tran.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
render_snapshot(filename = "figures/3D2/Tran-PerArea.png", clear=T)
# Close the window when you're done
rgl::rgl.close()
```

## Họ Dương

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#duong_bacbo_sf <- data_bacbo %>% filter(Ho=="Dương")
duong_sff <- dat_sff %>% 
  mutate(prop.duong=(sum(subset(., Ho=="Dương")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Dương") %>% 
  st_as_sf(crs = 4326)

gg_duong = ggplot(duong_sff) +
  geom_sf(aes(fill = songuoi_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(duong_sff$prop.duong[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ người/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Dương") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_duong, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)
render_movie("figures/3D2/duong(2).mp4",type = "custom", frames = 360, zoom = zoomvecfull, phi = phivecfull, theta = thetavec)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Duong.png")
#render_movie("figures/3D/duong.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
render_snapshot(filename = "figures/3D2/Duong-PerArea.png", clear=T)
# Close the window when you're done
rgl::rgl.close()
```

## Họ Bùi

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#bui_bacbo_sf <- data_bacbo %>% filter(Ho=="Bùi")
bui_sff <- dat_sff %>% 
  mutate(prop.bui=(sum(subset(., Ho=="Bùi")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Bùi") %>% 
  st_as_sf(crs = 4326)

gg_bui = ggplot(bui_sff) +
  geom_sf(aes(fill = songuoi_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(bui_sff$prop.bui[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ người/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Bùi") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_bui, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Bui.png")
#render_movie("figures/3D/bui.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
render_snapshot(filename = "figures/3D2/Bui-PerArea.png", clear=T)
```

## Họ Đinh

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#dinh_bacbo_sf <- data_bacbo %>% filter(Ho=="Đinh")
dinh_sff <- dat_sff %>% 
  mutate(prop.dinh=(sum(subset(., Ho=="Đinh")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Đinh") %>% 
  st_as_sf(crs = 4326)

gg_dinh = ggplot(dinh_sff) +
  geom_sf(aes(fill = songuoi_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(dinh_sff$prop.dinh[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ người/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Đinh") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_dinh, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)
render_movie("figures/3D2/dinh(2).mp4",type = "custom", frames = 360, zoom = zoomvecfull, phi = phivecfull, theta = thetavec)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Dinh.png")
#render_movie("figures/3D/dinh.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
render_snapshot(filename = "figures/3D2/Dinh-PerArea.png", clear=T)
# Close the window when you're done
rgl::rgl.close()
```

## Họ Đỗ

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#do_bacbo_sf <- data_bacbo %>% filter(Ho=="Đỗ")
do_sff <- dat_sff %>% 
  mutate(prop.do=(sum(subset(., Ho=="Đỗ")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Đỗ") %>% 
  st_as_sf(crs = 4326)

gg_do = ggplot(do_sff) +
  geom_sf(aes(fill = songuoi_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(do_sff$prop.do[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ người/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Đỗ") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_do, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Do.png")
#render_movie("figures/3D/do.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
render_snapshot(filename = "figures/3D2/Do-PerArea.png", clear=T)
```

## Họ Đào

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#dao_bacbo_sf <- data_bacbo %>% filter(Ho=="Đào")
dao_sff <- dat_sff %>% 
  mutate(prop.dao=(sum(subset(., Ho=="Đào")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Đào") %>% 
  st_as_sf(crs = 4326)

gg_dao = ggplot(dao_sff) +
  geom_sf(aes(fill = songuoi_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(dao_sff$prop.dao[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ người/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Đào") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_dao, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Dao.png")
#render_movie("figures/3D/dao.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
render_snapshot(filename = "figures/3D2/Dao-PerArea.png", clear=T)
```

## Họ Đoàn

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#doan_bacbo_sf <- data_bacbo %>% filter(Ho=="Đoàn")
doan_sff <- dat_sff %>% 
  mutate(prop.doan=(sum(subset(., Ho=="Đoàn")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Đào") %>% 
  st_as_sf(crs = 4326)

gg_doan = ggplot(doan_sff) +
  geom_sf(aes(fill = songuoi_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(doan_sff$prop.doan[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ người/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Đoàn") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_doan, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Doan.png")
#render_movie("figures/3D/doan.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
render_snapshot(filename = "figures/3D2/Doan-PerArea.png", clear=T)
```

## Họ Dư

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#du_bacbo_sf <- data_bacbo %>% filter(Ho=="Dư")
du_sff <- dat_sff %>% 
  mutate(prop.du=(sum(subset(., Ho=="Dư")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Dư") %>% 
  st_as_sf(crs = 4326)

gg_du = ggplot(du_sff) +
  geom_sf(aes(fill = songuoi_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(du_sff$prop.du[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ người/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Dư") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_du, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Du.png")
#render_movie("figures/3D/du.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
render_snapshot(filename = "figures/3D2/Du-PerArea.png", clear=T)
```

## Họ Hồ

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#ho_bacbo_sf <- data_bacbo %>% filter(Ho=="Hồ")
ho_sff <- dat_sff %>% 
  mutate(prop.ho=(sum(subset(., Ho=="Hồ")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Hồ") %>% 
  st_as_sf(crs = 4326)

gg_ho = ggplot(ho_sff) +
  geom_sf(aes(fill = songuoi_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(ho_sff$prop.ho[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ người/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Hồ") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_ho, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Ho.png")
#render_movie("figures/3D/ho.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
render_snapshot(filename = "figures/3D2/Ho-PerArea.png", clear=T)
```

## Họ Hoàng

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#hoang_bacbo_sf <- data_bacbo %>% filter(Ho=="Hoàng")
hoang_sff <- dat_sff %>% 
  mutate(prop.hoang=(sum(subset(., Ho=="Hoàng")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Hoàng") %>% 
  st_as_sf(crs = 4326)

gg_hoang = ggplot(hoang_sff) +
  geom_sf(aes(fill = songuoi_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(hoang_sff$prop.hoang[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ người/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Hoàng") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_hoang, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Hoang.png")
#render_movie("figures/3D/hoang.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
render_snapshot(filename = "figures/3D2/Hoang-PerArea.png", clear=T)
```

## Họ Huỳnh

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#huynh_bacbo_sf <- data_bacbo %>% filter(Ho=="Huỳnh")
huynh_sff <- dat_sff %>% 
  mutate(prop.huynh=(sum(subset(., Ho=="Huỳnh")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Huỳnh") %>% 
  st_as_sf(crs = 4326)

gg_huynh = ggplot(huynh_sff) +
  geom_sf(aes(fill = songuoi_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(huynh_sff$prop.huynh[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ người/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Huỳnh") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_huynh, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Huynh.png")
#render_movie("figures/3D/huynh.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
render_snapshot(filename = "figures/3D2/Huynh-PerArea.png", clear=T)
```

## Họ Lã

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#la_bacbo_sf <- data_bacbo %>% filter(Ho=="Lã")
la_sff <- dat_sff %>% 
  mutate(prop.la=(sum(subset(., Ho=="Lã")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Lã") %>% 
  st_as_sf(crs = 4326)

gg_la = ggplot(la_sff) +
  geom_sf(aes(fill = songuoi_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(la_sff$prop.la[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ người/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Lã") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_la, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/La.png")
#render_movie("figures/3D/la.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
render_snapshot(filename = "figures/3D2/La-PerArea.png", clear=T)
```

## Họ Lê

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#le_bacbo_sf <- data_bacbo %>% filter(Ho=="Lê")
le_sff <- dat_sff %>% 
  mutate(prop.le=(sum(subset(., Ho=="Lê")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Lê") %>% 
  st_as_sf(crs = 4326)

gg_le = ggplot(le_sff) +
  geom_sf(aes(fill = songuoi_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(le_sff$prop.le[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ người/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Lê") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_le, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)
render_movie("figures/3D2/le(2).mp4",type = "custom", frames = 360, zoom = zoomvecfull, phi = phivecfull, theta = thetavec)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Le.png")
#render_movie("figures/3D/le.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
render_snapshot(filename = "figures/3D2/Le-PerArea.png", clear=T)
# Close the window when you're done
rgl::rgl.close()
```

## Họ Lý

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#ly_bacbo_sf <- data_bacbo %>% filter(Ho=="Lý")
ly_sff <- dat_sff %>% 
  mutate(prop.ly=(sum(subset(., Ho=="Lý")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Lý") %>% 
  st_as_sf(crs = 4326)

gg_ly = ggplot(ly_sff) +
  geom_sf(aes(fill = songuoi_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(ly_sff$prop.ly[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ người/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Lý") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_ly, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)
render_movie("figures/3D2/ly(2).mp4",type = "custom", frames = 360, zoom = zoomvecfull, phi = phivecfull, theta = thetavec)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Ly.png")
#render_movie("figures/3D/ly.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
render_snapshot(filename = "figures/3D2/Ly-PerArea.png", clear=T)
# Close the window when you're done
rgl::rgl.close()
```

## Họ Mạc

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#mac_bacbo_sf <- data_bacbo %>% filter(Ho=="Mạc")
mac_sff <- dat_sff %>% 
  mutate(prop.mac=(sum(subset(., Ho=="Mạc")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Mạc") %>% 
  st_as_sf(crs = 4326)

gg_mac = ggplot(mac_sff) +
  geom_sf(aes(fill = songuoi_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(mac_sff$prop.mac[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ người/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Mạc") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_mac, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Mac.png")
#render_movie("figures/3D/mac.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
render_snapshot(filename = "figures/3D2/Mac-PerArea.png", clear=T)
```

## Họ Nguyễn

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#nguyen_bacbo_sf <- data_bacbo %>% filter(Ho=="Nguyễn")
nguyen_sff <- dat_sff %>% 
  mutate(prop.nguyen=(sum(subset(., Ho=="Nguyễn")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Nguyễn") %>% 
  st_as_sf(crs = 4326)

gg_nguyen = ggplot(nguyen_sff) +
  geom_sf(aes(fill = songuoi_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(nguyen_sff$prop.nguyen[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ người/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Nguyễn") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_nguyen, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Nguyen.png")
#render_movie("figures/3D/nguyen.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
render_snapshot(filename = "figures/3D2/Nguyen-PerArea.png", clear=T)
```

## Họ Phạm

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#pham_bacbo_sf <- data_bacbo %>% filter(Ho=="Phạm")
pham_sff <- dat_sff %>% 
  mutate(prop.pham=(sum(subset(., Ho=="Phạm")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Phạm") %>% 
  st_as_sf(crs = 4326)

gg_pham = ggplot(pham_sff) +
  geom_sf(aes(fill = songuoi_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(pham_sff$prop.pham[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ người/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Phạm") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_pham, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Pham.png")
#render_movie("figures/3D/pham.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
render_snapshot(filename = "figures/3D2/Pham-PerArea.png", clear=T)
```

## Họ Phan

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#phan_bacbo_sf <- data_bacbo %>% filter(Ho=="Phan")
phan_sff <- dat_sff %>% 
  mutate(prop.phan=(sum(subset(., Ho=="Phan")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Phan") %>% 
  st_as_sf(crs = 4326)

gg_phan = ggplot(mai_sff) +
  geom_sf(aes(fill = songuoi_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(phan_sff$prop.phan[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ người/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Phan") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_phan, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Phan.png")
#render_movie("figures/3D/phan.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
render_snapshot(filename = "figures/3D2/Phan-PerArea.png", clear=T)
```

## Họ Quách

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#quach_bacbo_sf <- data_bacbo %>% filter(Ho=="Quách")
quach_sff <- dat_sff %>% 
  mutate(prop.quach=(sum(subset(., Ho=="Quách")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Quách") %>% 
  st_as_sf(crs = 4326)

gg_quach = ggplot(quach_sff) +
  geom_sf(aes(fill = songuoi_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(quach_sff$prop.quach[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ người/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Quách") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_quach, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Quach.png")
#render_movie("figures/3D/quach.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
render_snapshot(filename = "figures/3D2/Quach-PerArea.png", clear=T)
```

## Họ Tôn

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#ton_bacbo_sf <- data_bacbo %>% filter(Ho=="Tôn")
ton_sff <- dat_sff %>% 
  mutate(prop.ton=(sum(subset(., Ho=="Tôn")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Tôn") %>% 
  st_as_sf(crs = 4326)

gg_ton = ggplot(ton_sff) +
  geom_sf(aes(fill = songuoi_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(ton_sff$prop.ton[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ người/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Tôn") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_ton, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Ton.png")
#render_movie("figures/3D/ton.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
render_snapshot(filename = "figures/3D2/Ton-PerArea.png", clear=T)
```

## Họ Triệu

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#trieu_bacbo_sf <- data_bacbo %>% filter(Ho=="Triệu")
trieu_sff <- dat_sff %>% 
  mutate(prop.trieu=(sum(subset(., Ho=="Triệu")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Triệu") %>% 
  st_as_sf(crs = 4326)

gg_trieu = ggplot(trieu_sff) +
  geom_sf(aes(fill = songuoi_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(trieu_sff$prop.trieu[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ người/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Triệu") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_trieu, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)
render_movie("figures/3D2/trieu(2).mp4",type = "custom", frames = 360, zoom = zoomvecfull, phi = phivecfull, theta = thetavec)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Trieu.png")
#render_movie("figures/3D/trieu.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
render_snapshot(filename = "figures/3D2/Trieu-PerArea.png", clear=T)
# Close the window when you're done
rgl::rgl.close()
```

## Họ Trịnh

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#trinh_bacbo_sf <- data_bacbo %>% filter(Ho=="Trịnh")
trinh_sff <- dat_sff %>% 
  mutate(prop.trinh=(sum(subset(., Ho=="Trịnh")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Trịnh") %>% 
  st_as_sf(crs = 4326)

gg_trinh = ggplot(trinh_sff) +
  geom_sf(aes(fill = songuoi_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(trinh_sff$prop.trinh[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ người/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Trịnh") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_trinh, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Trinh.png")
#render_movie("figures/3D/trinh.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
render_snapshot(filename = "figures/3D2/Trinh-PerArea.png", clear=T)
```

## Họ Trương

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#truong_bacbo_sf <- data_bacbo %>% filter(Ho=="Trương")
truong_sff <- dat_sff %>% 
  mutate(prop.truong=(sum(subset(., Ho=="Trương")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Trương") %>% 
  st_as_sf(crs = 4326)

gg_truong = ggplot(truong_sff) +
  geom_sf(aes(fill = songuoi_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(truong_sff$prop.truong[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ người/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Trương") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_truong, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Truong.png")
#render_movie("figures/3D/truong.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
render_snapshot(filename = "figures/3D2/Truong-PerArea.png", clear=T)
```

## Họ Vi

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#vi_bacbo_sf <- data_bacbo %>% filter(Ho=="Vi")
vi_sff <- dat_sff %>% 
  mutate(prop.vi=(sum(subset(., Ho=="Vi")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Vi") %>% 
  st_as_sf(crs = 4326)

gg_vi = ggplot(vi_sff) +
  geom_sf(aes(fill = songuoi_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(vi_sff$prop.vi[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ người/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Vi") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_vi, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Vi.png")
#render_movie("figures/3D/vi.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
render_snapshot(filename = "figures/3D2/Vi-PerArea.png", clear=T)
```

## Họ Võ

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#vo_bacbo_sf <- data_bacbo %>% filter(Ho=="Võ")
vo_sff <- dat_sff %>% 
  mutate(prop.vo=(sum(subset(., Ho=="Võ")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Võ") %>% 
  st_as_sf(crs = 4326)

gg_vo = ggplot(vo_sff) +
  geom_sf(aes(fill = songuoi_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(vo_sff$prop.vo[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ người/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Võ") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_vo, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Vo.png")
#render_movie("figures/3D/vo.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
render_snapshot(filename = "figures/3D2/Vo-PerArea.png", clear=T)
```

## Họ Vũ

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#vu_bacbo_sf <- data_bacbo %>% filter(Ho=="Vũ")
vu_sff <- dat_sff %>% 
  mutate(prop.vu=(sum(subset(., Ho=="Vũ")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Vũ") %>% 
  st_as_sf(crs = 4326)

gg_vu = ggplot(vu_sff) +
  geom_sf(aes(fill = songuoi_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(vu_sff$prop.vu[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ người/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Vũ") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_vu, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Vu.png")
#render_movie("figures/3D/vu.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
render_snapshot(filename = "figures/3D2/Vu-PerArea.png", clear=T)
```

# 3D Plot - Pro Population

## Họ Mai

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#mai_bacbo_sf <- data_bacbo %>% filter(Ho=="Mai")
mai_sff <- dat_sff %>% 
  mutate(prop.mai=(sum(subset(., Ho=="Mai")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Mai") %>% 
  st_as_sf(crs = 4326)

gg_mai = ggplot(mai_sff) +
  geom_sf(aes(fill = pro.pop_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(mai_sff$prop.mai[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("% người/dân cư/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Mai") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_mai, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)

#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Mai.png")
#render_movie("figures/3D/mai.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
#render_snapshot(filename = "figures/3D/Mai.png", clear=T)
render_snapshot(filename = "figures/3D2/Mai-PerPop.png", clear=T)

# Close the window when you're done
rgl::rgl.close()
```

## Họ Mã

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#ma_bacbo_sf <- data_bacbo %>% filter(Ho=="Mã")
ma_sff <- dat_sff %>% 
  mutate(prop.ma=(sum(subset(., Ho=="Mã")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Mã") %>% 
  st_as_sf(crs = 4326)

gg_ma = ggplot(ma_sff) +
  geom_sf(aes(fill = pro.pop_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(ma_sff$prop.ma[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("% người/dân cư/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Mã") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_ma, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)

#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Ma.png")
#render_movie("figures/3D/ma.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
#render_snapshot(filename = "figures/3D/Ma.png", clear=T)
render_snapshot(filename = "figures/3D2/Ma-PerPop.png", clear=T)

# Close the window when you're done
rgl::rgl.close()
```

## Họ Phùng

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#phung_bacbo_sf <- data_bacbo %>% filter(Ho=="Phùng")
phung_sff <- dat_sff %>% 
  mutate(prop.phung=(sum(subset(., Ho=="Phùng")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Phùng") %>% 
  st_as_sf(crs = 4326)

gg_phung = ggplot(phung_sff) +
  geom_sf(aes(fill = pro.pop_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(phung_sff$prop.phung[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("% người/dân cư/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Phùng") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_phung, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Phung.png")
#render_movie("figures/3D/phung.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
render_snapshot(filename = "figures/3D2/Phung-PerPop.png", clear=T)
```

## Họ Ngô

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#ngo_bacbo_sf <- data_bacbo %>% filter(Ho=="Ngô")
ngo_sff <- dat_sff %>% 
  mutate(prop.ngo=(sum(subset(., Ho=="Ngô")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Ngô") %>% 
  st_as_sf(crs = 4326)

gg_ngo = ggplot(ngo_sff) +
  geom_sf(aes(fill = pro.pop_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(ngo_sff$prop.ngo[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("% người/dân cư/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Ngô") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_ngo, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Ngo.png")
#render_movie("figures/3D/ngo.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
render_snapshot(filename = "figures/3D2/Ngo-PerPop.png", clear=T)
```

## Họ Khúc

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#khuc_bacbo_sf <- data_bacbo %>% filter(Ho=="Khúc")
khuc_sff <- dat_sff %>% 
  mutate(prop.khuc=(sum(subset(., Ho=="Khúc")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Khúc") %>% 
  st_as_sf(crs = 4326)

gg_khuc = ggplot(khuc_sff) +
  geom_sf(aes(fill = pro.pop_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(khuc_sff$prop.khuc[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("% người/dân cư/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Khúc") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_khuc, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Khuc.png")
#render_movie("figures/3D/khuc.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
render_snapshot(filename = "figures/3D2/Khuc-PerPop.png", clear=T)
```

## Họ Trần

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#tran_bacbo_sf <- data_bacbo %>% filter(Ho=="Trần")
tran_sff <- dat_sff %>% 
  mutate(prop.tran=(sum(subset(., Ho=="Trần")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Trần") %>% 
  st_as_sf(crs = 4326)

gg_tran = ggplot(tran_sff) +
  geom_sf(aes(fill = pro.pop_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(tran_sff$prop.tran[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("% người/dân cư/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Trần") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_tran, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Tran.png")
#render_movie("figures/3D/tran.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
render_snapshot(filename = "figures/3D2/Tran-PerPop.png", clear=T)
```

## Họ Dương

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#duong_bacbo_sf <- data_bacbo %>% filter(Ho=="Dương")
duong_sff <- dat_sff %>% 
  mutate(prop.duong=(sum(subset(., Ho=="Dương")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Dương") %>% 
  st_as_sf(crs = 4326)

gg_duong = ggplot(duong_sff) +
  geom_sf(aes(fill = pro.pop_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(duong_sff$prop.duong[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("% người/dân cư/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Dương") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_duong, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Duong.png")
#render_movie("figures/3D/duong.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
render_snapshot(filename = "figures/3D2/Duong-PerPop.png", clear=T)
```

## Họ Bùi

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#bui_bacbo_sf <- data_bacbo %>% filter(Ho=="Bùi")
bui_sff <- dat_sff %>% 
  mutate(prop.bui=(sum(subset(., Ho=="Bùi")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Bùi") %>% 
  st_as_sf(crs = 4326)

gg_bui = ggplot(bui_sff) +
  geom_sf(aes(fill = pro.pop_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(bui_sff$prop.bui[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("% người/dân cư/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Bùi") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_bui, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Bui.png")
#render_movie("figures/3D/bui.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
render_snapshot(filename = "figures/3D2/Bui-PerPop.png", clear=T)
```

## Họ Đinh

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#dinh_bacbo_sf <- data_bacbo %>% filter(Ho=="Đinh")
dinh_sff <- dat_sff %>% 
  mutate(prop.dinh=(sum(subset(., Ho=="Đinh")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Đinh") %>% 
  st_as_sf(crs = 4326)

gg_dinh = ggplot(dinh_sff) +
  geom_sf(aes(fill = pro.pop_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(dinh_sff$prop.dinh[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("% người/dân cư/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Đinh") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_dinh, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Dinh.png")
#render_movie("figures/3D/dinh.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
render_snapshot(filename = "figures/3D2/Dinh-PerPop.png", clear=T)
```

## Họ Đỗ

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#do_bacbo_sf <- data_bacbo %>% filter(Ho=="Đỗ")
do_sff <- dat_sff %>% 
  mutate(prop.do=(sum(subset(., Ho=="Đỗ")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Đỗ") %>% 
  st_as_sf(crs = 4326)

gg_do = ggplot(do_sff) +
  geom_sf(aes(fill = pro.pop_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(do_sff$prop.do[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("% người/dân cư/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Đỗ") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_do, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Do.png")
#render_movie("figures/3D/do.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
render_snapshot(filename = "figures/3D2/Do-PerPop.png", clear=T)
```

## Họ Đào

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#dao_bacbo_sf <- data_bacbo %>% filter(Ho=="Đào")
dao_sff <- dat_sff %>% 
  mutate(prop.dao=(sum(subset(., Ho=="Đào")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Đào") %>% 
  st_as_sf(crs = 4326)

gg_dao = ggplot(dao_sff) +
  geom_sf(aes(fill = pro.pop_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(dao_sff$prop.dao[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("% người/dân cư/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Đào") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_dao, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Dao.png")
#render_movie("figures/3D/dao.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
render_snapshot(filename = "figures/3D2/Dao-PerPop.png", clear=T)
```

## Họ Đoàn

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#doan_bacbo_sf <- data_bacbo %>% filter(Ho=="Đoàn")
doan_sff <- dat_sff %>% 
  mutate(prop.doan=(sum(subset(., Ho=="Đoàn")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Đào") %>% 
  st_as_sf(crs = 4326)

gg_doan = ggplot(doan_sff) +
  geom_sf(aes(fill = pro.pop_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(doan_sff$prop.doan[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("% người/dân cư/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Đoàn") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_doan, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Doan.png")
#render_movie("figures/3D/doan.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
render_snapshot(filename = "figures/3D2/Doan-PerPop.png", clear=T)
```

## Họ Dư

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#du_bacbo_sf <- data_bacbo %>% filter(Ho=="Dư")
du_sff <- dat_sff %>% 
  mutate(prop.du=(sum(subset(., Ho=="Dư")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Dư") %>% 
  st_as_sf(crs = 4326)

gg_du = ggplot(du_sff) +
  geom_sf(aes(fill = pro.pop_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(du_sff$prop.du[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("% người/dân cư/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Dư") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_du, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Du.png")
#render_movie("figures/3D/du.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
render_snapshot(filename = "figures/3D2/Du-PerPop.png", clear=T)
```

## Họ Hồ

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#ho_bacbo_sf <- data_bacbo %>% filter(Ho=="Hồ")
ho_sff <- dat_sff %>% 
  mutate(prop.ho=(sum(subset(., Ho=="Hồ")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Hồ") %>% 
  st_as_sf(crs = 4326)

gg_ho = ggplot(ho_sff) +
  geom_sf(aes(fill = pro.pop_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(ho_sff$prop.ho[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("% người/dân cư/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Hồ") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_ho, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Ho.png")
#render_movie("figures/3D/ho.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
render_snapshot(filename = "figures/3D2/Ho-PerPop.png", clear=T)
```

## Họ Hoàng

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#hoang_bacbo_sf <- data_bacbo %>% filter(Ho=="Hoàng")
hoang_sff <- dat_sff %>% 
  mutate(prop.hoang=(sum(subset(., Ho=="Hoàng")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Hoàng") %>% 
  st_as_sf(crs = 4326)

gg_hoang = ggplot(hoang_sff) +
  geom_sf(aes(fill = pro.pop_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(hoang_sff$prop.hoang[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("% người/dân cư/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Hoàng") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_hoang, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Hoang.png")
#render_movie("figures/3D/hoang.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
render_snapshot(filename = "figures/3D2/Hoang-PerPop.png", clear=T)
```

## Họ Huỳnh

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#huynh_bacbo_sf <- data_bacbo %>% filter(Ho=="Huỳnh")
huynh_sff <- dat_sff %>% 
  mutate(prop.huynh=(sum(subset(., Ho=="Huỳnh")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Huỳnh") %>% 
  st_as_sf(crs = 4326)

gg_huynh = ggplot(huynh_sff) +
  geom_sf(aes(fill = pro.pop_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(huynh_sff$prop.huynh[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("% người/dân cư/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Huỳnh") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_huynh, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Huynh.png")
#render_movie("figures/3D/huynh.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
render_snapshot(filename = "figures/3D2/Huynh-PerPop.png", clear=T)
```

## Họ Lã

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#la_bacbo_sf <- data_bacbo %>% filter(Ho=="Lã")
la_sff <- dat_sff %>% 
  mutate(prop.la=(sum(subset(., Ho=="Lã")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Lã") %>% 
  st_as_sf(crs = 4326)

gg_la = ggplot(la_sff) +
  geom_sf(aes(fill = pro.pop_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(la_sff$prop.la[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("% người/dân cư/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Lã") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_la, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/La.png")
#render_movie("figures/3D/la.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
render_snapshot(filename = "figures/3D2/La-PerPop.png", clear=T)
```

## Họ Lê

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#le_bacbo_sf <- data_bacbo %>% filter(Ho=="Lê")
le_sff <- dat_sff %>% 
  mutate(prop.le=(sum(subset(., Ho=="Lê")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Lê") %>% 
  st_as_sf(crs = 4326)

gg_le = ggplot(le_sff) +
  geom_sf(aes(fill = pro.pop_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(le_sff$prop.le[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("% người/dân cư/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Lê") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_le, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Le.png")
#render_movie("figures/3D/le.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
render_snapshot(filename = "figures/3D2/Le-PerPop.png", clear=T)
```

## Họ Lý

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#ly_bacbo_sf <- data_bacbo %>% filter(Ho=="Lý")
ly_sff <- dat_sff %>% 
  mutate(prop.ly=(sum(subset(., Ho=="Lý")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Lý") %>% 
  st_as_sf(crs = 4326)

gg_ly = ggplot(ly_sff) +
  geom_sf(aes(fill = pro.pop_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(ly_sff$prop.ly[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("% người/dân cư/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Lý") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_ly, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Ly.png")
#render_movie("figures/3D/ly.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
render_snapshot(filename = "figures/3D2/Ly-PerPop.png", clear=T)
```

## Họ Mạc

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#mac_bacbo_sf <- data_bacbo %>% filter(Ho=="Mạc")
mac_sff <- dat_sff %>% 
  mutate(prop.mac=(sum(subset(., Ho=="Mạc")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Mạc") %>% 
  st_as_sf(crs = 4326)

gg_mac = ggplot(mac_sff) +
  geom_sf(aes(fill = pro.pop_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(mac_sff$prop.mac[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("% người/dân cư/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Mạc") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_mac, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Mac.png")
#render_movie("figures/3D/mac.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
render_snapshot(filename = "figures/3D2/Mac-PerPop.png", clear=T)
```

## Họ Nguyễn

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#nguyen_bacbo_sf <- data_bacbo %>% filter(Ho=="Nguyễn")
nguyen_sff <- dat_sff %>% 
  mutate(prop.nguyen=(sum(subset(., Ho=="Nguyễn")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Nguyễn") %>% 
  st_as_sf(crs = 4326)

gg_nguyen = ggplot(nguyen_sff) +
  geom_sf(aes(fill = pro.pop_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(nguyen_sff$prop.nguyen[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("% người/dân cư/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Nguyễn") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_nguyen, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Nguyen.png")
#render_movie("figures/3D/nguyen.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
render_snapshot(filename = "figures/3D2/Nguyen-PerPop.png", clear=T)
```

## Họ Phạm

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#pham_bacbo_sf <- data_bacbo %>% filter(Ho=="Phạm")
pham_sff <- dat_sff %>% 
  mutate(prop.pham=(sum(subset(., Ho=="Phạm")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Phạm") %>% 
  st_as_sf(crs = 4326)

gg_pham = ggplot(pham_sff) +
  geom_sf(aes(fill = pro.pop_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(pham_sff$prop.pham[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("% người/dân cư/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Phạm") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_pham, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Pham.png")
#render_movie("figures/3D/pham.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
render_snapshot(filename = "figures/3D2/Pham-PerPop.png", clear=T)
```

## Họ Phan

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#phan_bacbo_sf <- data_bacbo %>% filter(Ho=="Phan")
phan_sff <- dat_sff %>% 
  mutate(prop.phan=(sum(subset(., Ho=="Phan")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Phan") %>% 
  st_as_sf(crs = 4326)

gg_phan = ggplot(mai_sff) +
  geom_sf(aes(fill = pro.pop_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(phan_sff$prop.phan[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("% người/dân cư/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Phan") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_phan, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Phan.png")
#render_movie("figures/3D/phan.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
render_snapshot(filename = "figures/3D2/Phan-PerPop.png", clear=T)
```

## Họ Quách

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#quach_bacbo_sf <- data_bacbo %>% filter(Ho=="Quách")
quach_sff <- dat_sff %>% 
  mutate(prop.quach=(sum(subset(., Ho=="Quách")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Quách") %>% 
  st_as_sf(crs = 4326)

gg_quach = ggplot(quach_sff) +
  geom_sf(aes(fill = pro.pop_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(quach_sff$prop.quach[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("% người/dân cư/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Quách") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_quach, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Quach.png")
#render_movie("figures/3D/quach.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
render_snapshot(filename = "figures/3D2/Quach-PerPop.png", clear=T)
```

## Họ Tôn

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#ton_bacbo_sf <- data_bacbo %>% filter(Ho=="Tôn")
ton_sff <- dat_sff %>% 
  mutate(prop.ton=(sum(subset(., Ho=="Tôn")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Tôn") %>% 
  st_as_sf(crs = 4326)

gg_ton = ggplot(ton_sff) +
  geom_sf(aes(fill = pro.pop_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(ton_sff$prop.ton[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("% người/dân cư/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Tôn") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_ton, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Ton.png")
#render_movie("figures/3D/ton.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
render_snapshot(filename = "figures/3D2/Ton-PerPop.png", clear=T)
```

## Họ Triệu

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#trieu_bacbo_sf <- data_bacbo %>% filter(Ho=="Triệu")
trieu_sff <- dat_sff %>% 
  mutate(prop.trieu=(sum(subset(., Ho=="Triệu")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Triệu") %>% 
  st_as_sf(crs = 4326)

gg_trieu = ggplot(trieu_sff) +
  geom_sf(aes(fill = pro.pop_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(trieu_sff$prop.trieu[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("% người/dân cư/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Triệu") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_trieu, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Trieu.png")
#render_movie("figures/3D/trieu.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
render_snapshot(filename = "figures/3D2/Trieu-PerPop.png", clear=T)
```

## Họ Trịnh

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#trinh_bacbo_sf <- data_bacbo %>% filter(Ho=="Trịnh")
trinh_sff <- dat_sff %>% 
  mutate(prop.trinh=(sum(subset(., Ho=="Trịnh")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Trịnh") %>% 
  st_as_sf(crs = 4326)

gg_trinh = ggplot(trinh_sff) +
  geom_sf(aes(fill = pro.pop_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(trinh_sff$prop.trinh[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("% người/dân cư/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Trịnh") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_trinh, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Trinh.png")
#render_movie("figures/3D/trinh.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
render_snapshot(filename = "figures/3D2/Trinh-PerPop.png", clear=T)
```

## Họ Trương

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#truong_bacbo_sf <- data_bacbo %>% filter(Ho=="Trương")
truong_sff <- dat_sff %>% 
  mutate(prop.truong=(sum(subset(., Ho=="Trương")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Trương") %>% 
  st_as_sf(crs = 4326)

gg_truong = ggplot(truong_sff) +
  geom_sf(aes(fill = pro.pop_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(truong_sff$prop.truong[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("% người/dân cư/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Trương") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_truong, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Truong.png")
#render_movie("figures/3D/truong.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
render_snapshot(filename = "figures/3D2/Truong-PerPop.png", clear=T)
```

## Họ Vi

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#vi_bacbo_sf <- data_bacbo %>% filter(Ho=="Vi")
vi_sff <- dat_sff %>% 
  mutate(prop.vi=(sum(subset(., Ho=="Vi")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Vi") %>% 
  st_as_sf(crs = 4326)

gg_vi = ggplot(vi_sff) +
  geom_sf(aes(fill = pro.pop_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(vi_sff$prop.vi[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("% người/dân cư/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Vi") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_vi, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Vi.png")
#render_movie("figures/3D/vi.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
render_snapshot(filename = "figures/3D2/Vi-PerPop.png", clear=T)
```

## Họ Võ

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#vo_bacbo_sf <- data_bacbo %>% filter(Ho=="Võ")
vo_sff <- dat_sff %>% 
  mutate(prop.vo=(sum(subset(., Ho=="Võ")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Võ") %>% 
  st_as_sf(crs = 4326)

gg_vo = ggplot(vo_sff) +
  geom_sf(aes(fill = pro.pop_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(vo_sff$prop.vo[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("% người/dân cư/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Võ") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_vo, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Vo.png")
#render_movie("figures/3D/vo.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
render_snapshot(filename = "figures/3D2/Vo-PerPop.png", clear=T)
```

## Họ Vũ

```{r, message=FALSE, warning=FALSE}
#3D
#remotes::install_github("tylermorganwall/rayshader")
library(rayshader)
library(sf)

#vu_bacbo_sf <- data_bacbo %>% filter(Ho=="Vũ")
vu_sff <- dat_sff %>% 
  mutate(prop.vu=(sum(subset(., Ho=="Vũ")[, "songuoi"])/sum(songuoi))*100) %>% 
  filter(Ho=="Vũ") %>% 
  st_as_sf(crs = 4326)

gg_vu = ggplot(vu_sff) +
  geom_sf(aes(fill = pro.pop_km), lwd=0) +
  geom_sf(data=river3, col="white") +
  annotate(geom="text", x=104.5, y=16, color="red", size=7.5, label= paste(round(vu_sff$prop.vu[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("% người/dân cư/km2", direction = -1, option = "viridis") +
  ggtitle("Họ Vũ") +
  theme_bw() +
  theme(text = element_text(size=15), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15)) +
  theme(legend.key.height = unit(10, "mm"),
        legend.key.width = unit(1, "mm"))

plot_gg(gg_vu, multicore = TRUE, raytrace = T, width = 10, height = 15, 
       scale = 500, windowsize = c(3500, 2165), zoom = 0.6, phi = 30, theta = 30)
#render_depth(focallength=100,focus=0.72, filename = "figures/3D/Vu.png")
#render_movie("figures/3D/vu.mp4",frames = 720, fps=30,zoom=0.6,fov = 30)
render_snapshot(filename = "figures/3D2/Vu-PerPop.png", clear=T)
```


