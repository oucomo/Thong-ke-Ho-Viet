---
title: "Ho Viet"
author: "Duc Du"
date: '`r format(Sys.time(), "%d %B, %Y")`'
output: html_document
---

```{r setup, include=FALSE}
rm(list = ls(all.names = TRUE))
knitr::opts_chunk$set(echo = FALSE, 
                      cache=TRUE,
                      autodep = TRUE,
                      lazy = TRUE,
                      tidy.opts=list(width.cutoff=60),
                      tidy=TRUE,
                      fig.width = 16,
                      fig.height = 25)
#library(rmarkdown)
#library(knitr)
library(markdown)
library(stringr)
library(forcats)
library(RColorBrewer)
library(tidyverse)
library(dplyr)
library(ggplot2)
library(Hmisc)
library(gtsummary)
#library(flextable)
library(huxtable)
library(data.table)
library(lubridate)
library(stringi)
library(forcats)
library(ggpubr)
library(rstatix)
#library(dlookr)
library(flextable)
library(haven)
library(raster)
library(rgdal)
library(viridis)
library(sf)
library(DT)

select<-dplyr::select
filter<-dplyr::filter
recode<-dplyr::recode
getData<-raster::getData

# rotate function (see here: https://r-spatial.github.io/sf/articles/sf3.html#affine-transformations
rot <- function(a) matrix(c(cos(a), sin(a), -sin(a), cos(a)), 2, 2)

options(scipen=999, digits = 3)
options(max.print=1000000)
```

# Load data

```{r load data2}
load("data/hoviet.RData")
```

# Tổng họ Việt Nam

```{r, results='hide', message=FALSE, warning=FALSE}
data_ho_overall <- data_ho_overall %>%
  mutate(pro.pop=(songuoi/sum(songuoi))*100)

data_ho_top200 <- data_ho_overall %>%
  arrange(desc(pro.pop))
data_ho_top200 <- head(data_ho_top200, n=200)

data_ho_top50 <- data_ho_overall %>%
  arrange(desc(pro.pop))
data_ho_top50 <- head(data_ho_top50, n=50)
```

## Top 50 họ cao nhất cả nước

```{r, lazy=TRUE}
ggplot(data = data_ho_top50, aes(x = reorder(Ho, songuoi, decreasing=F), y =pro.pop)) +
  geom_bar(stat = "identity", fill="red", width = 0.75) +
  geom_text(aes(label = paste(round(pro.pop, 1), "%", sep = ""), y = pro.pop + 1), size = 5) +
  scale_x_discrete(name = NULL) +
  scale_y_continuous(name = NULL, breaks = seq(from = 0, to = 40, by = 10)) +
  theme_bw() +
  theme(axis.text.x = element_text(size = 15),
        axis.text.y = element_text(size = 15),
        plot.title = element_text(size = 20),
        panel.grid.major = element_blank()) + coord_flip() +
  ggtitle("Top 50 họ có tỉ lệ cao nhất")
```

## Phân bố mật độ tỉ lệ từng họ

```{r}
nguyen_sf <- dat_sf %>% mutate(prop.nguyen=(sum(subset(., Ho=="Nguyễn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Nguyễn")
tran_sf <- dat_sf %>% mutate(prop.tran=(sum(subset(., Ho=="Trần")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trần")
le_sf <- dat_sf %>% mutate(prop.le=(sum(subset(., Ho=="Lê")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lê")
pham_sf <- dat_sf %>% mutate(prop.pham=(sum(subset(., Ho=="Phạm")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phạm")
hoang_sf <- dat_sf %>% mutate(prop.hoang=(sum(subset(., Ho=="Hoàng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hoàng")
bui_sf <- dat_sf %>% mutate(prop.bui=(sum(subset(., Ho=="Bùi")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Bùi")
vu_sf <- dat_sf %>% mutate(prop.vu=(sum(subset(., Ho=="Vũ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Vũ")
vo_sf <- dat_sf %>% mutate(prop.vo=(sum(subset(., Ho=="Võ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Võ")
phan_sf <- dat_sf %>% mutate(prop.phan=(sum(subset(., Ho=="Phan")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phan")
do_sf <- dat_sf %>% mutate(prop.do=(sum(subset(., Ho=="Đỗ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đỗ")
huynh_sf <- dat_sf %>% mutate(prop.huynh=(sum(subset(., Ho=="Huỳnh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Huỳnh")
dang_sf <- dat_sf %>% mutate(prop.dang=(sum(subset(., Ho=="Đặng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đặng")
ngo_sf <- dat_sf %>% mutate(prop.ngo=(sum(subset(., Ho=="Ngô")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ngô")
truong_sf <- dat_sf %>% mutate(prop.truong=(sum(subset(., Ho=="Trương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trương")
dinh_sf <- dat_sf %>% mutate(prop.dinh=(sum(subset(., Ho=="Đinh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đinh")
ho_sf <- dat_sf %>% mutate(prop.ho=(sum(subset(., Ho=="Hồ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hồ")
duong_sf <- dat_sf %>% mutate(prop.duong=(sum(subset(., Ho=="Dương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Dương")
ha_sf <- dat_sf %>% mutate(prop.ha=(sum(subset(., Ho=="Hà")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hà")
dao_sf <- dat_sf %>% mutate(prop.dao=(sum(subset(., Ho=="Đào")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đào")
ly_sf <- dat_sf %>% mutate(prop.ly=(sum(subset(., Ho=="Lý")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lý")
doan_sf <- dat_sf %>% mutate(prop.doan=(sum(subset(., Ho=="Đoàn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đoàn")
trinh_sf <- dat_sf %>% mutate(prop.trinh=(sum(subset(., Ho=="Trịnh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trịnh")
mai_sf <- dat_sf %>% mutate(prop.mai=(sum(subset(., Ho=="Mai")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mai")
luong_sf <- dat_sf %>% mutate(prop.luong=(sum(subset(., Ho=="Lương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lương")
cao_sf <- dat_sf %>% mutate(prop.cao=(sum(subset(., Ho=="Cao")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Cao")
lo_sf <- dat_sf %>% mutate(prop.lo=(sum(subset(., Ho=="Lò")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lò")
lam_sf <- dat_sf %>% mutate(prop.lam=(sum(subset(., Ho=="Lâm")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lâm")
luu_sf <- dat_sf %>% mutate(prop.luu=(sum(subset(., Ho=="Lưu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lưu")
phung_sf <- dat_sf %>% mutate(prop.phung=(sum(subset(., Ho=="Phùng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phùng")
ta_sf <- dat_sf %>% mutate(prop.ta=(sum(subset(., Ho=="Tạ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Tạ")
thach_sf <- dat_sf %>% mutate(prop.thach=(sum(subset(., Ho=="Thạch")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Thạch")
trieu_sf <- dat_sf %>% mutate(prop.trieu=(sum(subset(., Ho=="Triệu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Triệu")
y_sf <- dat_sf %>% mutate(prop.y=(sum(subset(., Ho=="Y")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Y")
vi_sf <- dat_sf %>% mutate(prop.vi=(sum(subset(., Ho=="Vi")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Vi")
chu_sf <- dat_sf %>% mutate(prop.chu=(sum(subset(., Ho=="Chu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Chu")
nong_sf <- dat_sf %>% mutate(prop.nong=(sum(subset(., Ho=="Nông")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Nông")
to_sf <- dat_sf %>% mutate(prop.to=(sum(subset(., Ho=="Tô")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Tô")
thai_sf <- dat_sf %>% mutate(prop.thai=(sum(subset(., Ho=="Thái")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Thái")
chau_sf <- dat_sf %>% mutate(prop.chau=(sum(subset(., Ho=="Châu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Châu")
giang_sf <- dat_sf %>% mutate(prop.giang=(sum(subset(., Ho=="Giàng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Giàng")
vuong_sf <- dat_sf %>% mutate(prop.vuong=(sum(subset(., Ho=="Vương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Vương")
h_sf <- dat_sf %>% mutate(prop.h=(sum(subset(., Ho=="H")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="H")
quach_sf <- dat_sf %>% mutate(prop.quach=(sum(subset(., Ho=="Quách")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Quách")
vang_sf <- dat_sf %>% mutate(prop.vang=(sum(subset(., Ho=="Vàng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Vàng")
danh_sf <- dat_sf %>% mutate(prop.danh=(sum(subset(., Ho=="Danh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Danh")
luong2_sf <- dat_sf %>% mutate(prop.luong2=(sum(subset(., Ho=="Lường")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lường")
dam_sf <- dat_sf %>% mutate(prop.dam=(sum(subset(., Ho=="Đàm")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đàm")
sung_sf <- dat_sf %>% mutate(prop.sung=(sum(subset(., Ho=="Sùng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Sùng")
thi_sf <- dat_sf %>% mutate(prop.thi=(sum(subset(., Ho=="Thị")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Thị")
a_sf <- dat_sf %>% mutate(prop.a=(sum(subset(., Ho=="A")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="A")
```

```{r}
nguyen_his <- nguyen_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(nguyen_sf$pro.pop), sd = sd(nguyen_sf$pro.pop))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Nguyễn")

tran_his <- tran_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(tran_sf$pro.pop), sd = sd(tran_sf$pro.pop))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Trần")

le_his <- le_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(le_sf$pro.pop), sd = sd(le_sf$pro.pop))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Lê")

pham_his <- pham_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(pham_sf$pro.pop), sd = sd(pham_sf$pro.pop))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Phạm")

hoang_his <- hoang_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(hoang_sf$pro.pop), sd = sd(hoang_sf$pro.pop))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Hoàng")

bui_his <- bui_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(bui_sf$pro.pop), sd = sd(bui_sf$pro.pop))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Bùi")

vu_his <- vu_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(vu_sf$pro.pop), sd = sd(vu_sf$pro.pop))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Vũ")

vo_his <- vo_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(vo_sf$pro.pop), sd = sd(vo_sf$pro.pop))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Võ")

phan_his <- phan_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(phan_sf$pro.pop), sd = sd(phan_sf$pro.pop))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Phan")

do_his <- do_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(do_sf$pro.pop), sd = sd(do_sf$pro.pop))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Đỗ")

huynh_his <- huynh_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(huynh_sf$pro.pop), sd = sd(huynh_sf$pro.pop))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Huỳnh")

dang_his <- dang_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(dang_sf$pro.pop), sd = sd(dang_sf$pro.pop))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Đặng")

ngo_his <- ngo_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(ngo_sf$pro.pop), sd = sd(ngo_sf$pro.pop))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Ngô")

truong_his <- truong_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(truong_sf$pro.pop), sd = sd(truong_sf$pro.pop))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Trương")

dinh_his <- dinh_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(dinh_sf$pro.pop), sd = sd(dinh_sf$pro.pop))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Đinh")

duong_his <- duong_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(duong_sf$pro.pop), sd = sd(duong_sf$pro.pop))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Dương")

ho_his <- ho_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(ho_sf$pro.pop), sd = sd(ho_sf$pro.pop))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Hồ")

ha_his <- ha_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(ha_sf$pro.pop), sd = sd(ha_sf$pro.pop))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Hà")

dao_his <- dao_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(dao_sf$pro.pop), sd = sd(dao_sf$pro.pop))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Đào")

doan_his <- doan_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(doan_sf$pro.pop), sd = sd(doan_sf$pro.pop))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Đoàn")

ly_his <- ly_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(ly_sf$pro.pop), sd = sd(ly_sf$pro.pop))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Lý")

trinh_his <- trinh_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(trinh_sf$pro.pop), sd = sd(trinh_sf$pro.pop))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Trịnh")

mai_his <- mai_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(mai_sf$pro.pop), sd = sd(mai_sf$pro.pop))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Mai")

luong_his <- luong_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(luong_sf$pro.pop), sd = sd(luong_sf$pro.pop))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Lương")

cao_his <- cao_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(cao_sf$pro.pop), sd = sd(cao_sf$pro.pop))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Cao")

lam_his <- lam_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(lam_sf$pro.pop), sd = sd(lam_sf$pro.pop))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Lâm")

lo_his <- lo_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(lo_sf$pro.pop), sd = sd(lo_sf$pro.pop))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Lò")

luu_his <- luu_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(luu_sf$pro.pop), sd = sd(luu_sf$pro.pop))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Lưu")

phung_his <- phung_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(phung_sf$pro.pop), sd = sd(phung_sf$pro.pop))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Phùng")

ta_his <- ta_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(ta_sf$pro.pop), sd = sd(ta_sf$pro.pop))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Tạ")

thach_his <- thach_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(thach_sf$pro.pop), sd = sd(thach_sf$pro.pop))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Thạch")

trieu_his <- trieu_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(trieu_sf$pro.pop), sd = sd(trieu_sf$pro.pop))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Triệu")

y_his <- y_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(y_sf$pro.pop), sd = sd(y_sf$pro.pop))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Y")

vi_his <- vi_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(vi_sf$pro.pop), sd = sd(vi_sf$pro.pop))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Vi")

chu_his <- chu_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(chu_sf$pro.pop), sd = sd(chu_sf$pro.pop))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Chu")

nong_his <- nong_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(nong_sf$pro.pop), sd = sd(nong_sf$pro.pop))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Nông")

to_his <- to_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(to_sf$pro.pop), sd = sd(to_sf$pro.pop))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Tô")

thai_his <- thai_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(thai_sf$pro.pop), sd = sd(thai_sf$pro.pop))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Thái")

chau_his <- chau_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(chau_sf$pro.pop), sd = sd(chau_sf$pro.pop))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Châu")

giang_his <- giang_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(giang_sf$pro.pop), sd = sd(giang_sf$pro.pop))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Giàng")

vuong_his <- vuong_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(vuong_sf$pro.pop), sd = sd(vuong_sf$pro.pop))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Vương")

h_his <- h_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(h_sf$pro.pop), sd = sd(h_sf$pro.pop))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("H")

quach_his <- quach_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(quach_sf$pro.pop), sd = sd(quach_sf$pro.pop))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Quách")

vang_his <- vang_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(vang_sf$pro.pop), sd = sd(vang_sf$pro.pop))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Vàng")

danh_his <- danh_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(danh_sf$pro.pop), sd = sd(danh_sf$pro.pop))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Danh")

luong2_his <- luong2_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(luong2_sf$pro.pop), sd = sd(luong2_sf$pro.pop))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Lường")

dam_his <- dam_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(dam_sf$pro.pop), sd = sd(dam_sf$pro.pop))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Đàm")

sung_his <- sung_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(sung_sf$pro.pop), sd = sd(sung_sf$pro.pop))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Sùng")

thi_his <- thi_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(thi_sf$pro.pop), sd = sd(thi_sf$pro.pop))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Thị")

a_his <- a_sf %>% 
  ggplot(aes(x=pro.pop)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(a_sf$pro.pop), sd = sd(a_sf$pro.pop))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("A")
```


```{r, message=FALSE, warning=FALSE, lazy=TRUE}
ggarrange(nguyen_his, tran_his, le_his, pham_his, hoang_his,
          bui_his, vu_his, vo_his, phan_his, do_his,
          huynh_his, dang_his, ngo_his, truong_his, dinh_his,
          ho_his, duong_his, ha_his, dao_his, ly_his,
          doan_his, trinh_his, mai_his, luong_his, cao_his,
          lo_his, lam_his, luu_his, phung_his, ta_his,
          thach_his, y_his, trieu_his, vi_his, chu_his,
          nong_his, to_his, thai_his, chau_his, giang_his,
          vuong_his, h_his, quach_his, vang_his, danh_his,
          luong2_his, dam_his, sung_his, thi_his, a_his,
          ncol = 5, nrow = 10)
```

## Phân bố mật độ từng họ

```{r}
nguyen_sff <- dat_sff %>% mutate(prop.nguyen=(sum(subset(., Ho=="Nguyễn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Nguyễn")
tran_sff <- dat_sff %>% mutate(prop.tran=(sum(subset(., Ho=="Trần")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trần")
le_sff <- dat_sff %>% mutate(prop.le=(sum(subset(., Ho=="Lê")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lê")
pham_sff <- dat_sff %>% mutate(prop.pham=(sum(subset(., Ho=="Phạm")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phạm")
hoang_sff <- dat_sff %>% mutate(prop.hoang=(sum(subset(., Ho=="Hoàng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hoàng")
bui_sff <- dat_sff %>% mutate(prop.bui=(sum(subset(., Ho=="Bùi")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Bùi")
vu_sff <- dat_sff %>% mutate(prop.vu=(sum(subset(., Ho=="Vũ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Vũ")
vo_sff <- dat_sff %>% mutate(prop.vo=(sum(subset(., Ho=="Võ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Võ")
phan_sff <- dat_sff %>% mutate(prop.phan=(sum(subset(., Ho=="Phan")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phan")
do_sff <- dat_sff %>% mutate(prop.do=(sum(subset(., Ho=="Đỗ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đỗ")
huynh_sff <- dat_sff %>% mutate(prop.huynh=(sum(subset(., Ho=="Huỳnh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Huỳnh")
dang_sff <- dat_sff %>% mutate(prop.dang=(sum(subset(., Ho=="Đặng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đặng")
ngo_sff <- dat_sff %>% mutate(prop.ngo=(sum(subset(., Ho=="Ngô")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ngô")
truong_sff <- dat_sff %>% mutate(prop.truong=(sum(subset(., Ho=="Trương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trương")
dinh_sff <- dat_sff %>% mutate(prop.dinh=(sum(subset(., Ho=="Đinh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đinh")
ho_sff <- dat_sff %>% mutate(prop.ho=(sum(subset(., Ho=="Hồ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hồ")
duong_sff <- dat_sff %>% mutate(prop.duong=(sum(subset(., Ho=="Dương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Dương")
ha_sff <- dat_sff %>% mutate(prop.ha=(sum(subset(., Ho=="Hà")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hà")
dao_sff <- dat_sff %>% mutate(prop.dao=(sum(subset(., Ho=="Đào")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đào")
ly_sff <- dat_sff %>% mutate(prop.ly=(sum(subset(., Ho=="Lý")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lý")
doan_sff <- dat_sff %>% mutate(prop.doan=(sum(subset(., Ho=="Đoàn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đoàn")
trinh_sff <- dat_sff %>% mutate(prop.trinh=(sum(subset(., Ho=="Trịnh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trịnh")
mai_sff <- dat_sff %>% mutate(prop.mai=(sum(subset(., Ho=="Mai")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mai")
luong_sff <- dat_sff %>% mutate(prop.luong=(sum(subset(., Ho=="Lương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lương")
cao_sff <- dat_sff %>% mutate(prop.cao=(sum(subset(., Ho=="Cao")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Cao")
lo_sff <- dat_sff %>% mutate(prop.lo=(sum(subset(., Ho=="Lò")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lò")
lam_sff <- dat_sff %>% mutate(prop.lam=(sum(subset(., Ho=="Lâm")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lâm")
luu_sff <- dat_sff %>% mutate(prop.luu=(sum(subset(., Ho=="Lưu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lưu")
phung_sff <- dat_sff %>% mutate(prop.phung=(sum(subset(., Ho=="Phùng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phùng")
ta_sff <- dat_sff %>% mutate(prop.ta=(sum(subset(., Ho=="Tạ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Tạ")
thach_sff <- dat_sff %>% mutate(prop.thach=(sum(subset(., Ho=="Thạch")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Thạch")
trieu_sff <- dat_sff %>% mutate(prop.trieu=(sum(subset(., Ho=="Triệu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Triệu")
y_sff <- dat_sff %>% mutate(prop.y=(sum(subset(., Ho=="Y")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Y")
vi_sff <- dat_sff %>% mutate(prop.vi=(sum(subset(., Ho=="Vi")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Vi")
chu_sff <- dat_sff %>% mutate(prop.chu=(sum(subset(., Ho=="Chu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Chu")
nong_sff <- dat_sff %>% mutate(prop.nong=(sum(subset(., Ho=="Nông")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Nông")
to_sff <- dat_sff %>% mutate(prop.to=(sum(subset(., Ho=="Tô")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Tô")
thai_sff <- dat_sff %>% mutate(prop.thai=(sum(subset(., Ho=="Thái")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Thái")
chau_sff <- dat_sff %>% mutate(prop.chau=(sum(subset(., Ho=="Châu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Châu")
giang_sff <- dat_sff %>% mutate(prop.giang=(sum(subset(., Ho=="Giàng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Giàng")
vuong_sff <- dat_sff %>% mutate(prop.vuong=(sum(subset(., Ho=="Vương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Vương")
h_sff <- dat_sff %>% mutate(prop.h=(sum(subset(., Ho=="H")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="H")
quach_sff <- dat_sff %>% mutate(prop.quach=(sum(subset(., Ho=="Quách")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Quách")
vang_sff <- dat_sff %>% mutate(prop.vang=(sum(subset(., Ho=="Vàng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Vàng")
danh_sff <- dat_sff %>% mutate(prop.danh=(sum(subset(., Ho=="Danh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Danh")
luong2_sff <- dat_sff %>% mutate(prop.luong2=(sum(subset(., Ho=="Lường")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lường")
dam_sff <- dat_sff %>% mutate(prop.dam=(sum(subset(., Ho=="Đàm")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đàm")
sung_sff <- dat_sff %>% mutate(prop.sung=(sum(subset(., Ho=="Sùng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Sùng")
thi_sff <- dat_sff %>% mutate(prop.thi=(sum(subset(., Ho=="Thị")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Thị")
a_sff <- dat_sff %>% mutate(prop.a=(sum(subset(., Ho=="A")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="A")
```

```{r}
nguyen_hisf <- nguyen_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(nguyen_sff$songuoi_km), sd = sd(nguyen_sff$songuoi_km))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Nguyễn")

tran_hisf <- tran_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(tran_sff$songuoi_km), sd = sd(tran_sff$songuoi_km))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Trần")

le_hisf <- le_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(le_sff$songuoi_km), sd = sd(le_sff$songuoi_km))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Lê")

pham_hisf <- pham_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(pham_sff$songuoi_km), sd = sd(pham_sff$songuoi_km))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Phạm")

hoang_hisf <- hoang_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(hoang_sff$songuoi_km), sd = sd(hoang_sff$songuoi_km))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Hoàng")

bui_hisf <- bui_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(bui_sff$songuoi_km), sd = sd(bui_sff$songuoi_km))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Bùi")

vu_hisf <- vu_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(vu_sff$songuoi_km), sd = sd(vu_sff$songuoi_km))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Vũ")

vo_hisf <- vo_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(vo_sff$songuoi_km), sd = sd(vo_sff$songuoi_km))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Võ")

phan_hisf <- phan_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(phan_sff$songuoi_km), sd = sd(phan_sff$songuoi_km))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Phan")

do_hisf <- do_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(do_sff$songuoi_km), sd = sd(do_sff$songuoi_km))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Đỗ")

huynh_hisf <- huynh_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(huynh_sff$songuoi_km), sd = sd(huynh_sff$songuoi_km))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Huỳnh")

dang_hisf <- dang_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(dang_sff$songuoi_km), sd = sd(dang_sff$songuoi_km))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Đặng")

ngo_hisf <- ngo_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(ngo_sff$songuoi_km), sd = sd(ngo_sff$songuoi_km))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Ngô")

truong_hisf <- truong_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(truong_sff$songuoi_km), sd = sd(truong_sff$songuoi_km))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Trương")

dinh_hisf <- dinh_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(dinh_sff$songuoi_km), sd = sd(dinh_sff$songuoi_km))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Đinh")

duong_hisf <- duong_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(duong_sff$songuoi_km), sd = sd(duong_sff$songuoi_km))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Dương")

ho_hisf <- ho_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(ho_sff$songuoi_km), sd = sd(ho_sff$songuoi_km))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Hồ")

ha_hisf <- ha_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(ha_sff$songuoi_km), sd = sd(ha_sff$songuoi_km))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Hà")

dao_hisf <- dao_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(dao_sff$songuoi_km), sd = sd(dao_sff$songuoi_km))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Đào")

doan_hisf <- doan_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(doan_sff$songuoi_km), sd = sd(doan_sff$songuoi_km))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Đoàn")

ly_hisf <- ly_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(ly_sff$songuoi_km), sd = sd(ly_sff$songuoi_km))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Lý")

trinh_hisf <- trinh_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(trinh_sff$songuoi_km), sd = sd(trinh_sff$songuoi_km))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Trịnh")

mai_hisf <- mai_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(mai_sff$songuoi_km), sd = sd(mai_sff$songuoi_km))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Mai")

luong_hisf <- luong_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(luong_sff$songuoi_km), sd = sd(luong_sff$songuoi_km))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Lương")

cao_hisf <- cao_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(cao_sff$songuoi_km), sd = sd(cao_sff$songuoi_km))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Cao")

lam_hisf <- lam_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(lam_sff$songuoi_km), sd = sd(lam_sff$songuoi_km))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Lâm")

lo_hisf <- lo_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(lo_sff$songuoi_km), sd = sd(lo_sff$songuoi_km))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Lò")

luu_hisf <- luu_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(luu_sff$songuoi_km), sd = sd(luu_sff$songuoi_km))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Lưu")

phung_hisf <- phung_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(phung_sff$songuoi_km), sd = sd(phung_sff$songuoi_km))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Phùng")

ta_hisf <- ta_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(ta_sff$songuoi_km), sd = sd(ta_sff$songuoi_km))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Tạ")

thach_hisf <- thach_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(thach_sff$songuoi_km), sd = sd(thach_sff$songuoi_km))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Thạch")

trieu_hisf <- trieu_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(trieu_sff$songuoi_km), sd = sd(trieu_sff$songuoi_km))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Triệu")

y_hisf <- y_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(y_sff$songuoi_km), sd = sd(y_sff$songuoi_km))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Y")

vi_hisf <- vi_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(vi_sff$songuoi_km), sd = sd(vi_sff$songuoi_km))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Vi")

chu_hisf <- chu_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(chu_sff$songuoi_km), sd = sd(chu_sff$songuoi_km))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Chu")

nong_hisf <- nong_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(nong_sff$songuoi_km), sd = sd(nong_sff$songuoi_km))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Nông")

to_hisf <- to_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(to_sff$songuoi_km), sd = sd(to_sff$songuoi_km))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Tô")

thai_hisf <- thai_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(thai_sff$songuoi_km), sd = sd(thai_sff$songuoi_km))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Thái")

chau_hisf <- chau_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(chau_sff$songuoi_km), sd = sd(chau_sff$songuoi_km))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Châu")

giang_hisf <- giang_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(giang_sff$songuoi_km), sd = sd(giang_sff$songuoi_km))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Giàng")

vuong_hisf <- vuong_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(vuong_sff$songuoi_km), sd = sd(vuong_sff$songuoi_km))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Vương")

h_hisf <- h_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(h_sff$songuoi_km), sd = sd(h_sff$songuoi_km))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("H")

quach_hisf <- quach_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(quach_sff$songuoi_km), sd = sd(quach_sff$songuoi_km))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Quách")

vang_hisf <- vang_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(vang_sff$songuoi_km), sd = sd(vang_sff$songuoi_km))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Vàng")

danh_hisf <- danh_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(danh_sff$songuoi_km), sd = sd(danh_sff$songuoi_km))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Danh")

luong2_hisf <- luong2_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(luong2_sff$songuoi_km), sd = sd(luong2_sff$songuoi_km))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Lường")

dam_hisf <- dam_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(dam_sff$songuoi_km), sd = sd(dam_sff$songuoi_km))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Đàm")

sung_hisf <- sung_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(sung_sff$songuoi_km), sd = sd(sung_sff$songuoi_km))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Sùng")

thi_hisf <- thi_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(thi_sff$songuoi_km), sd = sd(thi_sff$songuoi_km))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("Thị")

a_hisf <- a_sff %>% 
  ggplot(aes(x=songuoi_km)) +
  geom_histogram(aes(y =..density..), color="#e9ecef", alpha=0.6, position = 'identity') +
  theme_bw() + 
  stat_function(fun = dnorm, args = list(mean = mean(a_sff$songuoi_km), sd = sd(a_sff$songuoi_km))) +
  theme(text = element_text(size=10), axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), legend.text=element_text(size=8), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 10)) +
  ggtitle("A")
```

```{r, message=FALSE, warning=FALSE, lazy=TRUE}
ggarrange(nguyen_hisf, tran_hisf, le_hisf, pham_hisf, hoang_hisf,
          bui_hisf, vu_hisf, vo_hisf, phan_hisf, do_hisf,
          huynh_hisf, dang_hisf, ngo_hisf, truong_hisf, dinh_hisf,
          ho_hisf, duong_hisf, ha_hisf, dao_hisf, ly_hisf,
          doan_hisf, trinh_hisf, mai_hisf, luong_hisf, cao_hisf,
          lo_hisf, lam_hisf, luu_hisf, phung_hisf, ta_hisf,
          thach_hisf, y_hisf, trieu_hisf, vi_hisf, chu_hisf,
          nong_hisf, to_hisf, thai_hisf, chau_hisf, giang_hisf,
          vuong_hisf, h_hisf, quach_hisf, vang_hisf, danh_hisf,
          luong2_hisf, dam_hisf, sung_hisf, thi_hisf, a_hisf,
          ncol = 5, nrow = 10)
```

## Top 200 họ phổ biến nhất Việt Nam theo cả nước và tỉnh

```{r}
data_ho_top200 <- data_ho_overall %>%
  mutate(pro.pop=round(pro.pop, 2)) %>%
  arrange(desc(pro.pop))
data_ho_top200 <- head(data_ho_top200, n=200)

songuoi<-as.matrix(dat_sf$songuoi)
NAME_1 <- dat_sf$NAME_1
Ho <- dat_sf$Ho
data_ho_tinh_sum <- aggregate(songuoi, data.frame(NAME_1, Ho), sum) %>% setDT() %>%
  rename(songuoi=V1)
data_ho_tinh_sum <- data_ho_tinh_sum %>%
  group_by(NAME_1) %>%
  mutate(danso=sum(songuoi)) %>% ungroup() %>%
  mutate(pro.pop=round((songuoi/danso)*100,2)) %>% 
  filter(Ho %in% data_ho_top200$Ho) %>%
  select(NAME_1, Ho, pro.pop)

data_ho_tinh_wide <- data_ho_tinh_sum %>% spread(NAME_1, pro.pop)

data_ho_top200 <- merge(data_ho_top200 %>% select(Ho, pro.pop), data_ho_tinh_wide, by="Ho")
data_ho_top200[is.na(data_ho_top200)] <- 0
data_ho_top200 <- data_ho_top200 %>%
  arrange(desc(pro.pop)) %>%
  rownames_to_column() %>%
  rename("TT"=rowname,
         "Họ"=Ho,
         "Cả nước (%)"=pro.pop)
```

```{r}
mycolor <- function(x) {
  output <- ifelse(x == 0, "#FFFFFF",
                   ifelse(x < 1, "#6baed6",
                          ifelse(x < 5, "#fee5d9",
                                 ifelse(x < 10, "#fcae91",
                                        ifelse(x < 30, "#fb6a4a",
                                               ifelse(x < 60, "#cb181d", "#FFFFFF"))))))
  return(output)
}

ft <- flextable(data_ho_top200) %>%
  bg(j=c(-1), bg = mycolor) %>%
  fontsize(size = 7, part = "all") %>%
    set_table_properties(width=1, layout = "autofit")
ft
```

# Phân bố dòng họ cả nước

Về vấn đề xác định các dòng họ trước thế kỷ thứ 10.

Theo quan điểm của tác giả, các dòng họ liên quan tới vua trước thế kỷ thứ 10 như Mai, Khúc, Dương, Phùng, Ngô không có sự biến động lớn kiểu như đổi họ Lý sang Nguyễn hay Trần sang các dòng họ khác. Như thế phân bố dòng họ tương đối ổn định trong một khu vực nhỏ. Phân bố ở khu vực nhỏ là vì đã trải qua 1000 năm, nên các dòng họ của vua đời sau lấn át. Phân bố tương đối ổn định vì không gây ra xung đột với các đời vua sau, kiểu như Lê, Lý, Trần, Nguyễn... 

## Mai

Mai Hắc Đế (梅黑帝; 670 – 723). 

Dã sử kể rằng
Mai An Tiêm vốn là con nuôi của Hùng Vương thứ XVII, được vua quý mến gả mị nương tức là nàng Ba cho. Sau vì làm phật ý vua, An Tiêm bị đày ra đảo hoang, tương truyền nay là vùng Nga Sơn, Thanh Hóa. Tại đây, An Tiêm cùng vợ chăm chỉ làm ăn. Một hôm, An Tiêm nhặt được hạt giống cây lạ do chim mang tới, anh đem gieo trồng và cuối cùng gây được giống dưa hấu quý, nhiều người tìm đến trao đổi, tiếng đồn khắp xa gần. Vua biết tin, xuống chiếu gọi về cho phục chức cũ. An Tiêm được coi là ông tổ của nghề trồng dưa hấu tại Việt Nam.

Đền thờ Mai An Tiêm dưới chân núi Mai An Tiêm ở Nga Sơn
Ngày nay, tại xã Nga Phú, huyện Nga Sơn, có một dãy núi mang tên Mai An Tiêm, tương truyền chính là hòn đảo xưa kia vợ chồng An Tiêm đi đày. Dưới chân núi này có đền thờ ông và được nhân dân địa phương tổ chức lễ hội vào ngày 12 đến 15 tháng Ba âm lịch hàng năm.
Tên thật của Mai Hắc Đế (梅黑帝; 670 – 723) là Mai Thúc Loan (梅叔鸞), người lãnh đạo thành công cuộc khởi nghĩa chống lại sự chiếm đóng của nhà Đường ở Việt Nam và xưng Đế. 

Mai Thúc Loan sinh vào năm Canh Ngọ (670) tại thôn Ngọc Trừng, Hoan Châu, nay thuộc huyện Nam Đàn, Nghệ An. Theo Việt Điện U Linh (do Lý Tế Xuyên soạn năm 1329), cha của Mai Thúc Loan là Mai Hoàn, mẹ là Mai An Hòa nguyên gốc Lộc Hà, Hà Tĩnh, lưu lạc sang vùng Nam Đàn, Nghệ An.

Theo sách Việt Sử Tiêu Án (Ngô Thì Sĩ viết năm 1775), Mai Thúc Loan là người làng Hương Lãm, huyện Nam Đường, nay là thị trấn Nam Đàn, tỉnh Nghệ An, dân lập đền thờ ông ở thôn chợ Sa Nam
Dịch nghĩa phần nói về Mai Hắc Đế trong "Cựu Đường Thư, Liệt truyện 134, Hoạn quan, Quyển 184". 

Những năm đầu niên hiệu Khai Nguyên (713-741), thủ lĩnh An Nam là Mai Huyền Thành làm phản, tự xưng là "Vua Đen" (Hắc Đế), chiêu tập quân 32 châu, ngoài liên kết với các nước Lâm Ấp, Chân Lạp và Kim Lân, giữ vùng biển nam, quân số có đến 40 vạn, đánh phá phủ thành An Nam. Tháng 7, mùa thu năm Khai Nguyên thứ 10, (Hoàng đế) Đường Huyền Tông, ra lời chiếu sai hoạn quan Tả Giám môn Vệ tướng quân là Dương Tư Húc và quan Đô hộ là Quang Sở Khách đem quân dánh dẹp. Tư Húc đến Lĩnh Nam, chiêu mộ con em bọn thủ lĩnh ở đó, người và ngựa được hơn mười vạn, theo đường cũ của Mã Viện mà tiến đánh bất ngờ. Bọn Huyền Thành chợt nghe tin quân (của Tư Húc) đến, hoảng sợ không nghĩ được kế gì, liền bị quan quân bắt hoặc chém chết tại trận, giết hết phe đảng, dồn xác chết thành đống rồi rút quân về.
Cuộc khởi nghĩa nổ ra tại Rú Đụn, còn gọi là Hùng Sơn (Nghệ An). Mai Thúc Loan lên ngôi vua, lấy hiệu là Mai Hắc Đế. Theo Việt điện u linh, Mai Hắc Đế mang mệnh thủy tức là nước, mà nước được tượng trưng là màu đen. Vì vậy, ông lấy hiệu là Hắc Đế để hợp với mệnh của mình. Một số nguồn cũng cho hay, ông lấy hiệu là Mai Hắc Đế vì ông có màu da đen. Ông cho xây thành lũy, lập kinh đô Vạn An (thuộc thị trấn Nam Đàn hiện nay), tích cực rèn tập tướng sỹ. Cuộc nổi dậy của ông được hưởng ứng rộng rãi ở trong nước và có cả sự liên kết với Lâm Ấp và Chân Lạp.

Do phân bố dòng họ có dạng phân bố chuẩn. Xét trên sơ đồ phân bố dòng họ do Đức Dư tổng hợp theo dữ liệu của TCTK, chúng ta có thể khẳng định:
1- Sự kiện về dòng họ vua Mai Hắc Đế là có thật
2- Dòng họ của Mai Hắc Đế phát tích ở vùng Nga Sơn thuộc Thanh Hóa, nơi có đền thờ Mai An Tiêm. Vào thời Mai Hắc Đế vùng này là bờ biển. 

Có vẻ như dã sử về Mai An Tiêm có chứa ở trong nó một phần nào đó sự thật. Không biết sự thật ấy có liên quan tới Mai Hắc Đế không.
Về nguyên nhân cuộc khởi nghĩa do Mai Thúc Loan lãnh đạo là sự phản kháng chống lại sự áp bức của chính quyền đô hộ Phương Bắc, Nhà Hán. Cuộc khởi nghĩa có lẽ đã xảy ra, bắt đầu ở vùng có mỏ khai thác thiếc, thuộc khu vực Nghệ An, Thanh Hóa, Hòa Bình.
Thiếc có thể là mối liên hệ giữa các cuộc khởi nghĩa từ Mai Thúc Loan tới Ngô Quyền. Thậm chí có thể là từ Lý Bí. 

Trước hết chúng ta truy tìm ngược lại đồ cống nạp cho Nhà Đường. 
Trong truyện 西门庆择吉佳期　应伯爵追欢喜庆 có đề cập tới "Bạch Lạp"
”妇人因指道：“奴这床后茶叶箱内，还藏三四十斤沉香、二百斤白蜡、两罐子水银、八十斤胡椒。你明日都搬出来，替我卖了银子，凑著你盖房子使。
Dịch nghĩa 
"Người phụ nữ nói," Trong hộp trà phía sau chiếc giường này, vẫn còn ba 34 lạng trầm hương, 200 lạng 白蜡 (白蠟), hai lọ thủy ngân, và 80 lạng 胡椒 (hạt tiêu). Ngày mai anh bán lấy tiền cho em và cùng anh xây nhà.
Trong truyện 愿同穴一时丧礼盛　守孤灵半夜口脂香
có đoạn đề cập tới 白蜡 là 
”有二青衣官吏跪下，毡包内捧出一对金段、一根沉香、两根白蜡、一分绵纸。黄主事道：“此乃宋公致赙之仪。那两封，是两司八府官员办酒分资──两司官十二员、府官八员，计二十二分，共一百零六两。
dịch nghĩa 
"Có hai viên chức quỳ xuống dâng hai miếng vàng, một miếng trầm hương, hai miếng sáp trắng, và một mẩu giấy để trong túi nỉ. Sư Hoàng nói: "Đây là nghi thức của Tống gia. Hai bức thư đó là để cho hai vị quan và tám quan xử uống rượu, trả công. ... " 
Ngày nay từ Bạch Lạp 白蜡 (白蠟) đều được hiểu là sáp ong. Tuy nhiên với bối cảnh như các đoạn văn trên thì có thể Bạch Lạp 白蜡 là kim loại quý màu trắng. Bạc 银 và Gang Trắng 白铁 được dùng ở  Tây Hán, Tống và Thanh khá lâu trước Công Nguyên, vì thế không thể có sự nhầm lẫn về con chữ. Vậy có lẽ Bạch Lạp 白蜡 là thiếc. 
Tìm trong Thái Bình hoàn vũ kí 太平寰宇記 (quyển 171) dòng 65 trong https://ctext.org/wiki.pl?if=gb&chapter=185380
phần  維基 -> 太平寰宇記 -> 卷一百七十一 
với nội dung
土産
貢白蠟　紫緋　騏麟竭　無名異
dịch 
Thổ sản: cống gồm bạch lạp 貢白蠟 (sáp trắng), tử phi, sừng tê, và nhiều thứ lạ không biết tên. 
Xem ra 貢白蠟 cống bạch lạp ở trong mục cống thổ sản (sản vật từ đất) thì gần như hàm ý là cống quặng. 
Trong phân tích này chúng ta tạm cho 白蠟 là thiếc.  
Hợp kim thiếc với đồng khiến cho đồng cứng hơn. Như vậy thời kỳ nhà Đường đã tiến hành khai thác Thiếc ở các mỏ lộ thiên. Nếu vậy thì khả năng 白蠟 là thiếc được dùng để cống nạp. Cũng có thể do bị áp bức mà người dân ở khu vực này đã phản kháng khởi nghĩa. 

Chúng ta đi tìm hiểu nhu cầu luyện kim vào thời kỳ này. 
Tài liệu về vị trí của các mỏ thiếc lộ thiên và sa khoáng ở Vn
https://thuvienphapluat.vn/.../Quyet-dinh-05-2008-QD-BCT...
https://hieuluat.vn/.../quyet-dinh-956-qd-ttg-thu-tuong...

Mỏ thiếc Hồ Kín ở tọa độ (19.904399, 105.324138) Thường Xuân thuộc Thanh Hoa cách Lam Kinh khoảng 9km và đều năm bên bờ sông Chu.  
Các hạt bụi núi lửa nhỏ hơn một micron, nhỏ hơn độ dày của một sợi tóc người khoảng một trăm lần. Nhưng chúng rộng hơn một chút so với bước sóng của ánh sáng đỏ, vì vậy khi bị tán xạ, chúng sẽ hấp thụ ánh sáng đỏ trong khi cho phép các màu khác đi qua. Điều này dẫn đến Mặt Trăng có màu xanh và ánh sáng mặt trời không tới được bề mặt trái đất. Như thế bụi mịn làm thay đổi nhiệt độ trên bề mặt trái đất khiến cho đồng hồ sinh học bị thay đổi. Điều này dẫn đến mất mùa và bệnh tật. 
Vào thời điểm năm 536 đến 545 đã có các đợt phun trào núi lửa với tổng sức mạnh nhiều nghìn megatonne. Chính các đợt phun trào núi lửa này đã làm suy yếu nhà Lương, là nguyên nhân sâu xa dẫn đến cuộc khởi nghĩa của Lý Bí, và sự hình thành ra nhà nước Vạn Xuân.
Cuộc khai quật được tiến hành trong khoảng thời gian từ năm 1991 đến 2007 đã khám phá 10500 bộ xương thời Trung cổ tại chợ Spitalfields ở phía đông London (Anh). Sau khi tiến hành xác định tuổi xương bằng phương pháp carbon phóng xạ, các chuyên gia của Bảo tàng Khảo cổ học London đã đi đến kết luận "đó là hài cốt của những nạn nhân trong đợt phun trào núi lửa hồi thế kỷ 13" - một trong những thảm họa núi lửa lớn nhất 10 nghìn năm qua.

Các nhà khoa học nói rằng đợt phun trào lớn đến nỗi khí sulfur đã tạo ra một tấm màn sường mù khô che phủ tầng bình lưu của trái đất, ngăn chặn ánh sáng mặt trời, thay đổi khí quyển và làm mát bề mặt trái đất, gây ra nạn đói, bệnh dịch và chết chóc. Địa điểm núi lửa chưa rõ ở đâu nhưng sự ảnh hưởng là toàn cầu và sức mạnh của đợt phun mạnh hơn gấp 8 lần so với đợt phun trào của núi Krakatoa (Indonesia) hồi năm 1883.

Krakatau là một đảo núi lửa thuộc vành đai lửa Thái Bình Dương. Cấu trúc địa lý của đảo đã thay đổi ít nhất hai lần, sau hai vụ phun trào núi lửa vào năm 535 và năm 1883.
27 tháng 8 năm 1883, vụ phun của núi lửa Krakatoa (Krakatau) có sức nổ của một quả bom 200 megatonne, giết chết hơn 36 nghìn người và làm nhiệt độ bề mặt trên toàn Trái Đất giảm trung bình 0.6°C trong nhiều tháng liên tiếp. Dư chấn của vụ nổ cũng đã tạo nên một cơn sóng thần cao tới 30m gây ra tình trạng lạnh bất thường kéo dài 4 năm sau vụ nổ. Tuyết rơi kỷ lục đã được ghi nhận trên toàn thế giới.

Vào năm 2013 tại Colle Gnifetti Glacier trên dãy núi Alps của Thụy Sĩ người ta đã khoan lấy mẫu cột băng dài 72m. Cột băng có đã ghi lại sự hiện diện trong suốt 2000 năm về tình trạng bụi bặm từ núi lửa, bão cát Sahara và các hoạt động của con người rơi xuống trung tâm châu Âu. Nhóm nghiên cứu đã dùng tia laser cắt dọc theo chiều dài cột băng ra những lát băng mỏng 120 micron, ứng một vài ngày hoặc vài tuần tuyết rơi. Mỗi lát được phân tích ra khoảng một chục thành tố. Phương pháp tiếp cận này cho phép nhóm nghiên cứu xác định các cơn bão, phun trào núi lửa và ô nhiễm bụi chì chi tiết đến từng tháng hoặc thậm chí ít hơn, trong suốt 2000 năm qua. Laura Hartman, sinh viên tốt nghiệp Đại học UM đã tìm thấy hai hạt thủy tinh núi lửa cực nhỏ trong cột băng sâu 72m này. Lớp băng ứng với thời điểm mùa xuân năm 536. Qua nghiên cứu Laura và Kurbatov nhận thấy hai hạt thủy tin trên giống như các hạt thủy tinh núi lửa được tìm thấy trước đó trong các hồ và vũng than bùn ở châu Âu và trong lõi băng ở Greenland. Nhóm nghiên cứu cho rằng từ đầu năm 536 cho tới 541 đã có nhiều đợt phun trào núi lửa tại Iceland và tro núi lửa phủ đầy Bắc Bán Cầu. Lớp tro đã làm mờ mặt Trời trong trong nhiều tháng khiến cho nhiệt độ mùa hè giảm xuống bớt 1.5°C đến 2.5°C. Mười năm từ 536 tới 545 là thời kỳ lạnh nhất trong suốt 2000 năm qua. 

Để so sánh.  Vụ phun của núi lửa Krakatoa (Krakatau) năm 1883 có sức nổ của một quả bom 200 megatonne, giết chết hơn 36 nghìn người mà nhiệt độ bề mặt trên toàn Trái Đất chỉ giảm trung bình 0.6°C trong nhiều tháng, thì có thể thấy quy mô của các đợt phun trào núi lửa từ năm 536 cho tới 541 khiến cho nhiệt độ giảm bớt từ 1.5°C đến 2.5°C trong mười năm từ 536 tới 545 lớn đến thế nào.
Kết hợp với nhà sử học Kyle Harper nhóm nghiên cứu đã tìm thấy tương ứng sự kiện thay đổi thời tiết này với những sự kiện có trong các biên niên sử. Cụ thể biên niên sử của Gaelic Ailen có ghi "Mất mùa vào năm 536". Biên niên sử của Ulster cũng có ghi "mất mùa những năm 536–539". Biên niên sử của Inisfallen có ghi “Nhiệt độ thấp, thậm chí có tuyết trong mùa hè vào tháng 8 ở Trung Quốc. Mất mùa trên diện rộng”. Vào năm 541 cho tới 543 bệnh dịch hạch “Justinian” đã giết chết 35% –55% dân số và đẩy nhanh sự sụp đổ của Đế Chế Đông La Mã. Như vậy là sự kiện núi lửa phun vào các năm 536 cho tới 541 đã để lại hậu quả là mất mùa, đói rét, dịch bệnh ở khắp các vùng phía nửa Bắc Bán Cầu như Ireland, Scandinavia, Mesopotamia và Trung Quốc.

Sự ảnh hưởng này được ghi nhận lịch sử các triều đại thay đổi liên tục
• 549-551 -- Lương Giản Văn Đế: 2 năm
• 552-555 -- Lương Nguyên Đế: 3 năm
• 555-557 -- Lương Kính Đế: 2 năm
• 555-562 -- Lương Tuyên Đế: 7 năm
• 585-587 -- Lương Hiếu Tĩnh Đế: 2 năm

Như vậy do các vụ nổ phun núi lửa Krakatau và các núi lửa vùng Iceland từ năm 536 tới 546 mà đói rét đã tàn phá và làm suy yếu Phương Bắc. Chế độ đô hộ của Phương Bắc đối với Việt Nam trở nên tàn khốc hơn. Chính do đói rét tàn phá làm suy yếu Phương Bắc mà cuộc khởi nghĩa của Lý Nam Đế đã thành công, làm sống lại dân tộc Việt Nam. Đại Việt Sử Ký toàn thư viết “Tháng Giêng năm 544, Lý Nam Đế lên ngôi vua tự xưng là Nam Việt Đế, đóng đô tại Long Biên, dựng quốc hiệu là Vạn Xuân”. Cuộc khởi nghĩa của Lý Nam Đế bắt đầu từ năm 541, là thời điểm Nhà Lương bị mất mùa vì thời tiết thay đổi cục bộ do bụi tro núi lửa ở Bắc Âu. Phải 4 năm sau, mãi tới năm 545 nhà Lương mới điều được quân sang trấn áp. Tuy nhiên tới năm 550 đội quân Nhà Lương này đã bị đánh bại. Nhà nước Vạn Xuân tồn tại được khoảng 70 năm cho tới năm 602.

Dịch bệnh và mất mùa khiến Nhà Lương sụp đổ. Nhà Tùy lên thay, đưa quân sang đánh chiếm Vạn Xuân. Do ở xa khu vực núi lửa phun mà vào đầu những năm 600 kinh tế Trung Quốc đã hồi phục.  Kinh tế thế giới đình trệ đến tận năm 640 mới có tín hiệu hồi phục. Tín hiệu hồi phục là việc tìm thấy bụi chì tăng đột biến trong lõi băng, đánh dấu sự hồi sinh của hoạt động khai thác bạc làm tiền tệ. Đỉnh chì thứ hai, vào năm 660, đánh dấu việc sự gia tăng của thương mại. Việc sử dụng bạc với số lượng lớn cho thấy quy mô giao thương toàn cầu là lớn. Hai pho tượng Phật khổng lồ tại Bamiyan, nằm trên tuyến đường độc đạo giữa các dãy núi cao 4000m, nối liên Trung Á với Ấn Độ. Với quy mô và kích cỡ hai pho tượng, pho tượng cao 58m – tạc năm 507 – trước thời kỳ núi lửa phun, và pho tượng cao 38m – tạc năm 554 – sau khi kinh tế thế giới đã hồi phục, cho thấy song song với mở rộng giao thương buôn bán toàn cầu là sự bành trướng tôn giáo.
Lượng chì có trong không khí là chỉ số cho thấy gành luyện kim trên thế giới hồi phục. 
https://agupubs.onlinelibrary.wiley.com/.../2017GH000064

Như thế rất có thể do sự bóc lột của nhà Đường đã dẫn tới cuộc khởi nghĩa của Mai Thúc Loan. 
Tôi rất muốn khảo sát lại các sự kiện lịch sử trong khoảng thời gian từ năm 700 cho tới trước năm 1000. Tôi cho rằng dòng họ của các đời vua trong khoảng thời gian này tương đối ổn định, vì sự kiện tiêu diệt lẫn nhau gần như là không có. Như thế vùng đất nơi Đại Việt Sử Ký Toàn Thư ghi nhận là nơi phát tích một dòng vua sẽ xuất hiện mật độ dòng họ của vua là lớn nhất. Do có sự di dân nên tỷ lệ dòng họ ở vùng đất phía Nam mang tính trung bình. Do văn hóa làng xã nên, ngoại trừ Hà Nội, tỷ lệ dòng họ ở các vùng miền Bắc là rất ổn định. 

Đây là các sự liện liên quan tới các họ như Mai, Khúc, Dương, Kiều, Ngô, Đinh, Đỗ...   
A. Phần định danh. 
Và xã Đường Lâm ở Sơn Tây ngày nay là một địa danh mới chỉ xuất hiện sau 1945 trên cơ sở hợp nhất một số làng của tổng Cam Thịnh, còn Đường Lâm cổ - năm 669 thời Đường Cao Tông, cùng với 2 huyện An Viễn và Phúc Lộc thuộc châu Phúc Lộc, 757 thời Đường Túc Tông đổi thành quận Đường Lâm, 758 bỏ quận lập lại châu Phúc Lộc - thuộc vùng tây nam Châu Ái. "Tân Đường Thư" có ghi: trong tất cả các châu, quận An Nam chỉ có 2 vùng cống nạp bạch lạp (thiếc trắng) là Phong Châu và Đường Lâm. Từ Đèo Ngang trở ra chỉ có hai vùng có mỏ thiếc sa khoáng là Tuyên Quang (đời Đường thuộc Phong Châu) và mỏ thiếc Bù Me, gần núi Bù Chò thuộc các huyện Thường Xuân, Thọ Xuân (Tây Nam Thanh Hóa), một phần ăn sang Quỳ Hợp, Quế Phong miền Tây Nghệ An.
Xét về khả năng chỉ có vùng Tuyên Quang - Thái Nguyên và Thanh Hóa - Nghệ An có thể là Đường Lâm. 

A. Phần Sử Liệu

Đoạn viết sau là thể hiện của Đại Việt Sử Ký Toàn Thư.

Họ Mai Hắc Đế
Mai Thúc Loan 670 - 722, thôn Ngọc Trừng, Hoan Châu (nay thuộc huyện Nam Đàn, Nghệ An). Theo Việt điện u linh, cha của Mai Thúc Loan là Mai Hoàn, mẹ là Mai An Hòa nguyên gốc Lộc Hà, Hà Tĩnh, lưu lạc sang vùng Nam Đàn, Nghệ An. Theo sách Việt sử tiêu án, Mai Thúc Loan là người làng Hương Lãm, huyện Nam Đường, nay là thị trấn Nam Đàn, tỉnh Nghệ An, dân lập đền thờ ông ở thôn chợ Sa Nam. 
Năm 722, Mai Thúc Loan đánh Tống Bình (Hà Nội nay) xưng là Hắc Đế, bên ngoài liên kết với người Lâm Ấp, Chân Lạp, số quân nói là 30 vạn. Vua Đường sai nội thị tả giám môn vệ tướng quân là Dương Tư Húc và Đô hộ là Quang Sở Khách đánh dẹp yên được.

Họ Trương, Họ Cao.
Thành nằm ở vị trí giữa Thành Hà Nội và sông Tô Lịch, thuộc quận Ba Đình của Hà Nội hiện nay. Đại La ban đầu do Trương Bá Nghi đắp vào năm 767 và được tu bổ Triệu Xương năm 791, Trương Chu 824, Lý Nguyên Gia dời phủ trị tới bên sông Tô Lịch, đắp một cái thành nhỏ, gọi là La Thành. La Thành được Cao Biền cho đắp lại to lớn hơn. Theo sử cũ thì La Thành do Cao Biền cho đắp có chu vi 6.6km; cao 8.67m, chân thành rộng 8.33m.

Họ Phùng 
Năm 791, Phùng Hưng dấy binh vây đánh An Nam đô hộ phủ Cao Chính Bình. Phùng Hưng là người ở Đường Lâm thuộc huyện Phúc Lộc Giao Châu (Nay là xã Cam Lâm, huyện Ba Vì, tỉnh Hà Tây.)

Họ Ngô 
"Ngô Quyền sinh ngày 12 tháng 3 năm Đinh Tỵ (17 tháng 4 năm 898) trong một dòng họ hào trưởng có thế lực ở châu Đường Lâm, Ái Châu. Cha là Ngô Mân làm chức châu mục Đường Lâm."
"Một hào trưởng người Ái Châu (thuộc Thanh Hóa ngày nay) là Dương Đình Nghệ nuôi 3000 con nuôi, mưu đồ khôi phục. Ngô Quyền lớn lên làm nha tướng cho Dương Đình Nghệ, được Dương Đình Nghệ gả con gái cho và giao quyền cai quản Ái châu, đất bản bộ của họ Dương. Năm 931, Dương Đình Nghệ phát binh từ Thanh Hóa ra Bắc đánh đuổi quân Nam Hán, đánh bại Lý Tiến và quân cứu viện do Trần Bảo chỉ huy, chiếm giữ bờ cõi nước Việt, xưng là Tiết độ sứ. Năm 937, hào trưởng đất Phong Châu là Kiều Công Tiễn sát hại Dương Đình Nghệ, trở thành vị Tĩnh Hải quân Tiết độ sứ cuối cùng trong thời kì Tự chủ. Nhưng Công Tiễn lại không có chỗ dựa chính trị vững chắc, hành động tranh giành quyền lực của ông bị phản đối bởi nhiều thế lực địa phương và thậm chí nội bộ họ Kiều cũng chia rẽ trầm trọng. Bị cô lập, Công Tiễn vội vã cầu cứu nhà Nam Hán. Ngô Quyền nhanh chóng tập hợp lực lượng, kéo quân ra Bắc, giết chết Kiều Công Tiễn rồi chuẩn bị quyết chiến với quân Nam Hán. Thắng lợi của Ngô Quyền trên sông Bạch Đằng vào năm 938 đã đặt dấu chấm hết cho mọi âm mưu xâm lược Tĩnh Hải quân của nhà Nam Hán, đồng thời cũng kết thúc thời kì Bắc thuộc của Việt Nam. Năm 939, Ngô Quyền xưng vương, đóng đô ở Cổ Loa, lập ra nhà Ngô. Ngô Vương qua đời ở tuổi 47, trị vì được 6 năm. Sau cái chết của ông, nhà Ngô suy yếu nhanh chóng, không khống chế được các thế lực cát cứ địa phương và sụp đổ vào năm 965."

B. Phần phân tích phân bố dòng họ. 
Ở phần này chúng ta sử dụng CSDL về dòng họ trong số học sinh phổ thông của cả nước để truy tìm nơi phát tích của các dòng họ cổ xưa. Việc phân tích được thực hiện thông qua tỷ lệ phần trăm của các họ trong khu vực.
Chúng ta theo dõi dòng họ Dương thì thấy tâm mật độ dòng họ cao nhất là ở vùng Thái Nguyên và giảm dần theo khoảng cách tới tâm tăng lên. 

Họ Mai (Mai Hắc Đế 670 - 722)
Toàn quốc 0.86%, Miền Bắc 0.59%, Miền Trung 1.03%, Miền Nam 0.93%, Thái Nguyên 0.49%, Vĩnh Phúc 0.14%, Hà Nam 0.48%, Hưng Yên 0.5%, Hà Nội 0.36%, Ninh Bình 1.47%, Tuyên Quang 0.26%, Phú Thọ 0.44%, Hải Dương 0.38%, Nam Định 2.0%, Hòa Bình 0.14%, Thanh Hóa 2.4%, Nghệ An 0.38%, Đồng Nai 1.24%.
Kết hợp với sử liệu chúng ta thấy nơi phát tích dòng họ Mai, cụ thể là Mai Hắc Đế có thể là ở vùng từ Thanh Hóa tới Nam Định. 

Họ Dương (Dương Đình Nghệ 874 – 937)
Toàn quốc 1.4%, ở Miền Bắc là 1.65, Miền Trung 1.1%, Miền Nam 1.49, Thái Nguyên 6.19%, Vĩnh Phúc 2.69%, Hà Nam 1.8%, Hưng Yên 1.6%, Hà Nội 1.58%, Ninh Bình 1.34%, Tuyên Quang 1.4%, Phú Thọ 0.95%, Hải Dương 0.88%, Nam Định 0.68%, Hòa Bình 0.61%, Thanh Hóa 0.76%. Nghệ An 0.68%.
Dòng họ Dương có thể là ở vùng Thái Nguyên - Vĩnh Phúc. 
Vậy Đường Lâm <=> Tuyên Quang - Thái Nguyên 

Họ Ngô (Ngô Quyền 898-944)
Toàn quốc 1.66%, Miền Bắc là 1.7%, Miền Trung 1.64%, Miền Nam 1.49%, Thái Nguyên 2.24%, Hà Nội 2.14%, Vĩnh Phúc 1.48%, Hà Nam 2.21%, Hưng Yên 1.47%, Ninh Bình 0.91, Tuyên Quang 0.84, Phú Thọ 1.23%, Hải Dương 1.34%, Nam Định 2.2%, Hòa Bình 0.44%, Thanh Hóa 1.19%. 
Dòng họ Ngô có thể ở vùng thuộc tam giác Thái Nguyên - Hà Nội - Hà Nam. 
Đường Lâm <=> Tuyên Quang - Thái Nguyên 
Khả năng Ngô Quyền là người vùng Đường Lâm (Thái Nguyên) là rất lớn. Như thế việc Dương Đình Nghệ ở vùng đất Thanh Hóa xem ra không hợp lắm. Kết hợp thống kê lại với nhau chúng ta có thể nhận thấy có khả năng cả hai ông Dương Đình Nghệ và Ngô Quyền đều ở vùng đất Thái Nguyên.  

Vậy rõ ràng ở đây có một yếu tố gì đó, hoặc là Đại Việt Sử Ký Toàn Thư đã có sai sót về địa danh, hoặc là đã có một sự kiện chưa rõ nào đó.
Cấu trúc Làng Xã rất ổn định, việc cưỡng chế các vùng dân cư có tính lịch sử nhập vào với Hà Nội gây ra rất nhiều rắc rối cho thống kê này. Nếu có được phân bố chi tiết hơn tới Huyện thì chúng ta có thể nhận ra được vết của lịch sử.
Có bạn nào có dữ liệu thì cho tôi xin.
"Trong tất cả các châu, quận An Nam chỉ có 2 vùng cống nạp bạch lạp (thiếc trắng) là Phong Châu và Đường Lâm". 

Từ Đèo Ngang trở ra chỉ có hai vùng có mỏ thiếc sa khoáng là Tuyên Quang (đời Đường thuộc Phong Châu) và mỏ thiếc Bù Me, gần núi Bù Chò thuộc các huyện Thường Xuân, Thọ Xuân (Tây Nam Thanh Hóa), một phần ăn sang Quỳ Hợp, Quế Phong miền Tây Nghệ An.
Sơn Dương (Tuyên Quang) và Đại Từ (Thái Nguyên) là những vùng có nhiều mỏ thiếc lộ thiên. Nếu các dữ liệu chi tiết về dòng họ Ngô và Dương mà tạo ra phân bố với các tâm điểm ở hai vùng có mỏ thiếc, phía Thái Nguyên và Thanh Hóa, thì có thể phải xem lại vị trí của Đường Lâm nay.

Đường Lâm ở Sơn Tây ngày nay là một địa danh mới chỉ xuất hiện sau 1945 trên cơ sở hợp nhất một số làng của tổng Cam Thịnh, còn Đường Lâm cổ - năm 669 thời Đường Cao Tông, cùng với 2 huyện An Viễn và Phúc Lộc thuộc châu Phúc Lộc, 757 thời Đường Túc Tông đổi thành quận Đường Lâm, 758 bỏ quận lập lại châu Phúc Lộc - thuộc vùng tây nam Châu Ái. "Tân Đường Thư" có ghi: trong tất cả các châu, quận An Nam chỉ có 2 vùng cống nạp bạch lạp (thiếc trắng) là Phong Châu và Đường Lâm. Từ Đèo Ngang trở ra chỉ có hai vùng có mỏ thiếc sa khoáng là Tuyên Quang (đời Đường thuộc Phong Châu) và mỏ thiếc Bù Me, gần núi Bù Chò thuộc các huyện Thường Xuân, Thọ Xuân (Tây Nam Thanh Hóa), một phần ăn sang Quỳ Hợp, Quế Phong miền Tây Nghệ An.

Họ Dương đến Dương Đình Nghệ đã nhiều đời làm hào trưởng ở đất Dương Xá, Ái Châu. Khởi tổ họ Ngô là Ngô Nhật Đại quê ở Ái Châu, tham gia khởi nghĩa Mai Thúc Loan, khởi nghĩa thất bại quay về Ái Châu lập nghiệp, 5 đời sau sinh ra Ngô Quyền. Quê của Ngô Quyền cách quê của Dương Đình Nghệ chỉ khoảng 40km theo đường sông Chu, họ Ngô nhiều đời là châu mục khống chế cả một vùng biên viễn ngay sau lưng họ Dương, điều này lý giải vì sao Ngô Quyền quê ở Đường Lâm lại lấy con gái Dương Đình Nghệ, quê Dương Xá và được Dương Đình Nghệ tin tưởng giao luôn binh quyền ở Ái Châu, sau mới đem quân từ Ái Châu ra Đại La diệt Kiều Công Tiễn. Đinh Bộ Lĩnh, Lê Hoàn đều là cháu rể Dương Đình Nghệ.

Vậy có thể đưa ra kết luận "Các cuộc khởi nghĩa dẫn đến việc thiết lập các triều đại Vua ở Đại Việt liên quan tới việc chống lại sự áp bức bóc lột của phương Bắc trong việc khai mỏ thiếc". Tuy nhiên chúng ta cần phải có bằng chứng về việc khai thác thiếc vào thời kỳ từ năm 700 cho tới 900. Liệu có thể tìm ra được dấu vết khai mỏ không?

### Dữ liệu

```{r, warning=FALSE, message=FALSE, lazy=FALSE}
library(DT)
mai_sff <- dat_sff %>% mutate(prop.mai=(sum(subset(., Ho=="Mai")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mai")
mai_plot <- mai_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.mai, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
mai_plot$centroid <- sf::st_transform(mai_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

mai <- mai_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Thi tran Nga Son" & NAME_2=="Nga Son"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.mai=as.numeric(round(prop.mai, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.mai, area_km, songuoi_km, lng, lat, distm_km)

mai_peak <- mai_plot %>% filter(NAME_3=="Thi tran Nga Son" & NAME_2=="Nga Son")

datatable(mai, colnames = c("STT", "Tỉnh/Thành phố", "Quận/Huyện", "Phường/Xã", "Số người", "Dân số", "Tỉ lệ/xã phường", "Tỉ lệ/cả nước", "Diện tích (km2)", "Mật độ (người/km2)", "Kinh độ", "Vĩ độ", "Khoảng cách tới tâm (km)"), extensions = 'Buttons', options = list(
    dom = 'Bfrtip',
    buttons = c('copy', 'csv', 'excel', 'pdf', 'print')
  ))
```

### Phân bố tỉ lệ

```{r, warning=FALSE, message=FALSE, lazy=TRUE}
ggplot() + geom_sf() + geom_sf(data=mai_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=mai_peak, mapping = aes(label=NAME_3), color="red", size=3, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=8, label= paste(round(mai_plot$prop.mai[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 30)) +
  ggtitle("Mai")
```

### Phương trình hàm phân bố tỉ lệ

```{r, message=FALSE, warning=FALSE, lazy=TRUE}
mai <- dat_sff %>% filter(Ho=="Mai") %>% st_as_sf(crs = 4326)
mai$centroid <- sf::st_transform(mai, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
mai <- mai %>%
  mutate(centroid_0 = centroid[NAME_3=="Thi tran Nga Son"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

mai_radius <- mai %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())

distm_km<-mai_radius$distm_km
pro.pop<-mai_radius$pro.pop
rank<-mai_radius$rank
commune<-mai_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-35*exp(-(distm_km^2)/(2*100))

library(dplyr)

df <- data.frame(distm_km, rank, commune, estimate, pro.pop)

df <- df %>%
  mutate(num=sum((pro.pop-estimate)^2),
         den=nrow(df)-1,
         var=num/den,
         sd=sqrt(var),
         rank_com=as.numeric(rank))
  
breaks <- c(0, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200)

plot_df <- df %>%
  filter(row_number()<=1000) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=pro.pop, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=pro.pop), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=pro.pop, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=20)) +
  scale_x_discrete(name = "Xã/Phường", 
                     breaks = reorder(factor(rank), distm_km), 
                     labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Tỉ lệ (%)") +
  theme_bw() + 
  theme(text = element_text(size=20), axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_text(size=15),
        legend.text=element_text(size=15), legend.key.size = unit(3, "cm"), legend.key.height = unit(1, "cm"), legend.key.width = unit(1, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Mai")

plot_df
```

```{r}
library(gam)
library(metagam)
library(mgcv)
library(metafor)
library(gratia)

distm_km<-mai_radius$distm_km
pro.pop<-mai_radius$pro.pop
rank<-mai_radius$rank
commune<-mai_radius$NAME_3
rank<-factor(rank, labels = commune)
area_km<-mai_radius$area_km
songuoi_km<-mai_radius$songuoi_km
pro.pop_km<-mai_radius$pro.pop_km
estimate<-35*exp(-(distm_km^2)/(2*100))

library(dplyr)

df <- data.frame(distm_km, rank, commune, estimate, pro.pop, area_km, songuoi_km, pro.pop_km)

df <- df %>%
  mutate(num=sum((pro.pop-estimate)^2),
         den=nrow(df)-1,
         var=num/den,
         sd=sqrt(var),
         rank_com=as.numeric(rank))

df <- df %>% filter(row_number()<=1000) %>%
  mutate(rank1 = as.numeric(reorder(factor(rank), distm_km)))

# Fitting GAMs with regression splines
# Cubic regression splines: bs="cr". These have a cubic spline basis defined by a modest sized set of knots spread evenly through the covariate values. They are penalized by the conventional intergrated square second derivative cubic spline penalty. For details see cubic.regression.spline and e.g. Wood (2006a).
# https://stat.ethz.ch/R-manual/R-devel/library/mgcv/html/smooth.terms.html

# gam = gam::gam(pro.pop ~ s(rank1, 20) + s(area_km, 20), data = df)
gam = mgcv::gam(pro.pop ~ s(rank1, bs="cr") + s(area_km, bs="cr"), data = df)

plot(gam, se = TRUE, residuals = TRUE, rug = TRUE, pch = 1, cex = 0.5, shade = TRUE, shade.col = "lightblue")
gam.check(gam)

summary(gam)

# We've learned that the number of basis functions determines how wiggly a smooth can be. If there are not enough basis functions, it may not be wiggly enough to capture the relationships in data. Here is a model where smooths have 4 basis functions. As we see in this partial effect plot, this is not enough to capture the pattern.
# 
# It's not always obvious visually whether we have enough basis functions. We can test for this, though, via the gam.check() function.

# Running gam.check() on a model provides several outputs, in both the console and as plots. We'll start with the console output.
# 
# First, gam.check() reports on model convergence. Here, it reports full convergence. R has found a best solution. If the model has not converged, results are likely not correct. This can happen when there are too many parameters in the model for not enough data.
# 
# Below, we see a table of basis checking results. This shows a statistical test for patterns in model residuals, which should be random. Each line reports the test results for one smooth. It shows the k value or number of basis functions, the effective degrees of freedom, a test statistic, and p-value.
# 
# Here, small p-values indicate that residuals are not randomly distributed. This often means there are not enough basis functions.
# 
# This is an approximate test. Always visualize your results too, and compare the k and edf values in addition to looking at the p-value.

# If we re-fit our model with higher k , we see that this test is no longer significant. However, now we see a problem with the second smooth - the p-value for its test is now significant. Fixing one problem can reveal another. So it is always important to re-run gam.check after changing models.

# If we increase the k value for the second smooth, and run gam.check() again, now both smooths pass the test.
# 
# Neither has significant patterns in their residuals and both have enough basis functions.

# gam.check() will also generate four plots. Each of these gives a different way of looking at your model residuals. These plots show the results from the original, poorly fit model. On the top-left is a Q-Q plot, which compares the model residuals to a normal distribution. A well-fit model's residuals will be close to a straight line. On bottom left is a histogram of residuals. We would expect this to have a symmetrical bell shape. On top-right is a plot of residual values. These should be evenly distributed around zero. Finally, on the bottom-right is plot of response against fitted values. A perfect model would form a straight line. We don't expect a perfect model, but we do expect the pattern to cluster around the 1-to-1 line.

# Now, here is the output of our final model, with larger k values. See that the Q-Q plot no longer curves, the histogram is bell shaped, and the comparison of response vs. fitted values clusters around a 1-to-1 line. These all indicate a much better model fit.

```

```{r}
mod=lm(pro.pop ~ rank1 + poly(rank1, 20) + area_km, data=df)
summary(mod)
df <- df %>% mutate(pred=predict(mod))
ggplot(df, aes(x=rank_com, y=pred)) +
  geom_point(shape=".") +
  geom_smooth(colour="black",size=0.5) +
  theme_bw() + 
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())
```

```{r}
library(rms)
library(scales)

theme_set(theme_bw())
dd <- datadist(df)
options(datadist="dd")

fit1 <- ols(pro.pop ~ rcs(rank1, 20) + area_km, data = df)
fit1
anova(fit1)

pred <- rms::Predict(fit1, rank1=seq(min(df$rank1), max(df$rank1)))
g1 <- ggplot(pred, df)
g1
ggplot(df, aes(x=rank_com, y=pred)) +
  geom_point(shape=".") +
  geom_smooth(colour="black",size=0.5) +
  theme_bw() + 
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())
```

```{r}
library(rms)
library(scales)

theme_set(theme_bw())
dd <- datadist(df)
options(datadist="dd")

fit1 <- ols(pro.pop ~ rcs(distm_km, 20) + area_km, data = df)
fit1
anova(fit1)

pred <- rms::Predict(fit1, distm_km=seq(min(df$distm_km), max(df$distm_km)))
g1 <- ggplot(pred, df)
g1
ggplot(df, aes(x=rank_com, y=pred)) +
  geom_point(shape=".") +
  geom_smooth(colour="black",size=0.5) +
  theme_bw() + 
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())
```

### Phân bố mật độ

```{r, lazy=TRUE}
mai_sff <- dat_sff %>% mutate(prop.mai=(sum(subset(., Ho=="Mai")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mai")
mai_plotf <- mai_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.mai, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=mai_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=8, label= paste(round(mai_plotf$prop.mai[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 30)) +
  ggtitle("Mai")
```

### Phương trình hàm phân bố mật độ

```{r, message=FALSE, warning=FALSE, lazy=TRUE}
mai <- dat_sff %>% filter(Ho=="Mai") %>% st_as_sf(crs = 4326)
mai$centroid <- sf::st_transform(mai, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
mai <- mai %>%
  mutate(centroid_0 = centroid[NAME_3=="Thi tran Nga Son"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

mai_radius <- mai %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())

distm_km<-mai_radius$distm_km
songuoi_km<-mai_radius$songuoi_km
rank<-mai_radius$rank
commune<-mai_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-1300*exp(-(distm_km^2)/(2*100))

library(dplyr)
df <- data.frame(distm_km, rank, commune, estimate, songuoi_km)
df <- df %>%
  mutate(num=sum((songuoi_km-estimate)^2),
         den=nrow(df)-1,
         var=num/den,
         sd=sqrt(var),
         rank_com=as.numeric(reorder(factor(rank), distm_km)))
  
breaks <- c(0, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200)

plot_df <- df %>%
  filter(row_number()<=1000) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=songuoi_km, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=songuoi_km), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=songuoi_km, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=20)) +
  scale_x_discrete(name = "Xã/Phường", 
                     breaks = reorder(factor(rank), distm_km), 
                     labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Mật độ người/km2") +
  theme_bw() + 
  theme(text = element_text(size=20), axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_text(size=15),
        legend.text=element_text(size=15), legend.key.size = unit(3, "cm"), legend.key.height = unit(1, "cm"), legend.key.width = unit(1, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Mai")

plot_df
```

```{r}
library(gam)
library(metagam)
library(mgcv)
library(metafor)

distm_km<-mai_radius$distm_km
pro.pop<-mai_radius$pro.pop
rank<-mai_radius$rank
commune<-mai_radius$NAME_3
rank<-factor(rank, labels = commune)
area_km<-mai_radius$area_km
songuoi_km<-mai_radius$songuoi_km
pro.pop_km<-mai_radius$pro.pop_km
estimate<-35*exp(-(distm_km^2)/(2*100))

library(dplyr)

df <- data.frame(distm_km, rank, commune, estimate, pro.pop, area_km, songuoi_km, pro.pop_km)

df <- df %>%
  mutate(num=sum((pro.pop-estimate)^2),
         den=nrow(df)-1,
         var=num/den,
         sd=sqrt(var),
         rank_com=as.numeric(rank))

df <- df %>% filter(row_number()<=1000) %>%
  mutate(rank1 = as.numeric(reorder(factor(rank), distm_km)))

gam = mgcv::gam(songuoi_km ~ s(rank1, bs="cr") + s(area_km, bs="cr"), data = df)

plot(gam, se = TRUE, residuals = TRUE, rug = TRUE, pch = 1, cex = 0.5, shade = TRUE, shade.col = "lightblue")
gam.check(gam)

summary(gam)
```

## Phùng

Phùng (馮) là một họ cổ. Nó đứng thứ 27 trong danh sách các họ ở Trung Quốc đại lục ngày nay. 

Họ Phùng có nguồn gốc xa xưa là dân du mục ở Tân Cương. Vào khoảng 4000 năm về trước họ Phùng xuất hiện ở vùng Thiểm Tây như một quốc gia. 
https://www.newton.com.tw/wiki/%E9%A6%AE%E5%A7%93
https://kknews.cc/history/qq4j2r.html

Có thể đã có một dòng người di cư vào khoảng hơn 3000 năm về trước theo dòng sông Thao về tới được khu vực mà nay là Phùng Nguyên. Có lẽ Phùng Nguyên là nơi được coi là phát tích của họ Phùng. 

3000 năm về trước, Phùng Nguyên là một cái gò nhỏ ở cuối sông Thao trước khi gặp sông Đà. Theo thời gian do phù sa bồi lấp mà Phùng Nguyên trở thành đất liền. Ở đây người ta tìm thấy các di vật Nha Chương.

Dựa theo phân tích của Đức Dư về dòng họ ở Việt Nam 
https://duhongduc.shinyapps.io/HoViet/...
chúng ta có thể nhận thấy họ Phùng ở khu vực ngay chân núi Ba Vì. Đây là vùng đất cổ và là nơi các cơn mưa từ Ba Vì đổ xuống gây ngập lụt. Đó có thể là cội nguồn của truyền thuyết Sơn Tinh Thủy Tinh. 

Chúng ta có thể nhận thấy dòng họ Phùng chiếm vị trí sâu về phía chân núi, sau đó là họ Lý ở dải đất gần với biển hơn kéo dài từ vùng Đền Đô qua Từ Liêm, tiếp sau nữa là nhà Trần. 

Đây có thể là sự hình thành ra cấu trúc không gian văn hóa vua Hùng (phụ hệ) trong tổng thể văn hóa mẫu hệ ở đồng bằng Bắc Bộ.

### Dữ liệu

```{r, warning=FALSE, message=FALSE, lazy=FALSE}
phung_sff <- dat_sff %>% mutate(prop.phung=(sum(subset(., Ho=="Phùng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phùng")
phung_plot <- phung_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.phung, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
phung_plot$centroid <- sf::st_transform(phung_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

phung <- phung_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Phu Son" & NAME_2=="Ba Vi"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.phung=as.numeric(round(prop.phung, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.phung, area_km, songuoi_km, lng, lat, distm_km)

phung_peak <- phung_plot %>% filter(NAME_3=="Xa Phu Son" & NAME_2=="Ba Vi")

datatable(phung, colnames = c("STT", "Tỉnh/Thành phố", "Quận/Huyện", "Phường/Xã", "Số người", "Dân số", "Tỉ lệ/xã phường", "Tỉ lệ/cả nước", "Diện tích (km2)", "Mật độ (người/km2)", "Kinh độ", "Vĩ độ", "Khoảng cách tới tâm (km)"), extensions = 'Buttons', options = list(
    dom = 'Bfrtip',
    buttons = c('copy', 'csv', 'excel', 'pdf', 'print')
  ))
```

### Phân bố tỉ lệ

```{r, message=FALSE, warning=FALSE, lazy=TRUE}
# library(plotly)

phung_sf <- dat_sf %>% mutate(prop.phung=(sum(subset(., Ho=="Phùng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phùng")
phung_plot <- phung_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.phung, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=phung_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=phung_peak, mapping = aes(label=NAME_3), color="red", size=3, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=8, label= paste(round(phung_plot$prop.phung[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 30)) +
  ggtitle("Phùng")

# fig <- ggplotly(
#   ggplot(bui_plot) +
#     geom_sf(aes(fill = pro.pop), lwd=0) +
#     # geom_sf(data=river3, col="orange") +
#     scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
#     annotate(geom="text", x=108, y=23, color="red", label= paste(round(bui_plot$prop.bui[1],1), "% dân số", sep = "")) +
#     theme_bw()
# )
# 
# fig
```

### Phương trình hàm phân bố tỉ lệ

```{r, message=FALSE, warning=FALSE, lazy=TRUE}
phung <- dat_sff %>% filter(Ho=="Phùng") %>% st_as_sf(crs = 4326)
phung$centroid <- sf::st_transform(phung, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
phung <- phung %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Phu Son" & NAME_2=="Ba Vi"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

phung_radius <- phung %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())

distm_km<-phung_radius$distm_km
pro.pop<-phung_radius$pro.pop
rank<-phung_radius$rank
commune<-phung_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-45*exp(-(distm_km^2)/(2*100))

library(dplyr)
df<-data.frame(distm_km, rank, commune, estimate, pro.pop)

df <- df %>%
  mutate(num=sum((pro.pop-estimate)^2),
         den=nrow(df)-1,
         var=num/den,
         sd=sqrt(var),
         rank_com=as.numeric(reorder(factor(rank), distm_km)))
  
breaks <- c(0, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200)

plot_df <- df %>%
  filter(row_number()<=1000) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=pro.pop, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=pro.pop), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=pro.pop, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=20)) +
  scale_x_discrete(name = "Xã/Phường", 
                     breaks = reorder(factor(rank), distm_km), 
                     labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Tỉ lệ (%)") +
  theme_bw() + 
  theme(text = element_text(size=20), axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_text(size=15),
        legend.text=element_text(size=15), legend.key.size = unit(3, "cm"), legend.key.height = unit(1, "cm"), legend.key.width = unit(1, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Phùng")

plot_df
```

### Phân bố mật độ

```{r, lazy=TRUE}
phung_sff <- dat_sff %>% mutate(prop.phung=(sum(subset(., Ho=="Phùng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phùng")
phung_plotf <- phung_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.phung, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=phung_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=8, label= paste(round(phung_plotf$prop.phung[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 30)) +
  ggtitle("Phùng")
```

### Phương trình hàm phân bố mật độ

```{r, message=FALSE, warning=FALSE, lazy=TRUE}
phung <- dat_sff %>% filter(Ho=="Phùng") %>% st_as_sf(crs = 4326)
phung$centroid <- sf::st_transform(phung, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
phung <- phung %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Phu Son" & NAME_2=="Ba Vi"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

phung_radius <- phung %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())

distm_km<-phung_radius$distm_km
songuoi_km<-phung_radius$songuoi_km
rank<-phung_radius$rank
commune<-phung_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-750*exp(-(distm_km^2)/(2*100))

library(dplyr)
df<-data.frame(distm_km, rank, commune, estimate, songuoi_km)

df <- df %>%
  mutate(num=sum((songuoi_km-estimate)^2),
         den=nrow(df)-1,
         var=num/den,
         sd=sqrt(var),
         rank_com=as.numeric(reorder(factor(rank), distm_km)))
  
breaks <- c(0, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200)

plot_df <- df %>%
  filter(row_number()<=1000) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=songuoi_km, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=songuoi_km), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=songuoi_km, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=20)) +
  scale_x_discrete(name = "Xã/Phường", 
                     breaks = reorder(factor(rank), distm_km), 
                     labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Mật độ (người/km2)") +
  theme_bw() + 
  theme(text = element_text(size=20), axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_text(size=15),
        legend.text=element_text(size=15), legend.key.size = unit(3, "cm"), legend.key.height = unit(1, "cm"), legend.key.width = unit(1, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Phùng")

plot_df
```

## Khúc

Họ Khúc.

(Ngược dòng lịch sử)

Họ Khúc truyền nối làm chức Tiết Độ Sứ (tức làm Vua) gồm 3 đời: Khúc Thừa Dụ, Khúc Hạo, Khúc Thừa Mỹ, trị vì từ năm 905 tới năm 923 (hoặc 930). Đền thờ Khúc Thừa Dụ, Khúc Hạo, Khúc Thừa Mỹ, được xây dựng vào năm 2005 cạnh đình cổ làng Cúc Bồ bên bờ sông Luộc thuộc tỉnh Hải Dương.

Theo thống kê học sinh phổ thông năm 2017 thì họ Khúc có mật độ phân bố lớn nhất ở vùng Hải Dương, Hưng Yên, Ninh Bình, và Hà Nội. Phân bố thống kê mật độ người mang họ Khúc này hoàn toàn phù hợp với sử liệu về nơi phát tích gia tộc họ Khúc.

Năm Bính Dần (906) đời vua Chiêu Tuyên, nhà Đường rơi vào tay quyền thần Chu Ôn, các thế lực cát cứ nổi lên đánh giết lẫn nhau, tạo ra thế chia cắt 5 đời 10 nước (Ngũ đại Thập quốc).
Năm 905, ở Tĩnh Hải quân (tên gọi Việt Nam lúc đó), Tiết độ sứ Độc Cô Tổn bị Chu Ôn dời tiếp ra đảo Hải Nam và giết chết. Tĩnh Hải quân do đó không có người cai quản. 

Khúc Thừa Dụ 曲承裕 quê ở Hồng Châu (thuộc địa hạt Bàng Giang, Ninh Giang cũ ở Hải Dương), gặp thời buổi loạn lạc, nhân danh là hào trưởng một xứ, Thừa Dụ tự xưng là Tiết độ sứ" và cho dựng đô ở La Thành. Cương mục dẫn sách An Nam kỷ yếu, ghi thêm: "Cuối thời Đường, Khúc Hạo làm Tiết độ sứ thay cho Độc Cô Tôn; đổi các hương ở các huyện làm giáp, đặt ở mỗi giáp một viên quản giáp và một phó tri giáp để giữ việc đánh thuế. Hạo giữ chức Tiết độ sứ được hơn 4 năm thì mất".

Ngày 7 tháng 2 năm 906, vua Đường phong thêm cho Tĩnh Hải quân Tiết độ sứ Khúc Thừa Dụ tước "Đồng bình chương sự". Sau đó, Khúc Thừa Dụ tự lấy quyền mình, phong cho con là Khúc Hạo chức vụ "Tĩnh Hải hành quân tư mã quyền tri lưu hậu", tức là chức vụ chỉ huy quân đội và sẽ kế vị quyền Tiết độ sứ.

Ngày 23 tháng 7 năm 907, Khúc Thừa Dụ mất, Khúc Hạo lên kế vị và phong cho con là Khúc Thừa Mỹ làm "Tĩnh Hải hành quân tư mã quyền tri lưu hậu" để kế vị. 

Khúc Hạo người làng Cúc Bồ, huyện Ninh Thanh, tỉnh Hải Hưng ngày nay, ở đó hiện còn đình thờ họ Khúc. Việt sử thông giám cương mục (Tiền biên, quyển 5) viết: "Họ Khúc là một họ lớn lâu đời ở Hồng Châu. 

Năm sau nhà Đường mất ngôi (907), nhà Hậu Lương lên thay, phong cho Lưu Ẩn làm Nam Bình Vương, kiêm chức Tiết độ sứ Quảng Châu và Tĩnh Hải, có ý để lấy lại Giao Châu.
Khúc Thừa Mỹ chủ trương kết thân với nhà Hậu Lương ở Trung nguyên mà gây hấn với nước Nam Hán liền kề. Năm 919, ông sai sứ sang Biện Kinh xin tiết việt của nhà Hậu Lương. Vua Lương là Mạt đế Chu Hữu Trinh bấy giờ bận đối phó với các nước lớn ở Trung nguyên nên ban tiết việt cho Khúc Thừa Mỹ và phong ông làm Tiết độ sứ Giao châu.
Được sự hậu thuẫn của Hậu Lương, Thừa Mỹ chủ quan cho rằng uy thế của nhà Lương rộng lớn ở Trung nguyên có thể kìm chế được Nam Hán nhỏ hơn ở Quảng Châu. Ông công khai gọi nước Nam Hán là "ngụy đình" (triều đình tiếm ngôi, không chính thống). Chính sách đối ngoại đó của Khúc Thừa Mỹ khiến vua Nam Hán tức giận và quyết định sai Lý Khắc Chính cầm quân sang đánh chiếm Tĩnh Hải quân.

Sách Tân Ngũ Đại sử, phần Nam Hán thế gia ghi: Đại Hữu năm thứ ba (930), [Lưu Nghiễm] sai tướng Lý Thủ Dung và Lương Khắc Trinh đánh Giao Chỉ, bắt được Khúc Thừa Mỹ... Thừa Mỹ là con của Khúc Hạo. Lương Khắc Trinh lại đánh Chiêm Thành, cướp lấy đồ quý mang về.

Việc quân Nam Hán sang đánh Giao Châu (tức nước ta), bắt Khúc Thừa Mỹ, sử liệu Trung Quốc như Thông giám ghi vào tháng 9 năm Trường Hưng thứ 1 (930). Tân Ngũ Đại sử, Nam Hán thế gia ghi vào niên hiệu Đại Hữu thứ 3, cũng tức là năm 930. Chưa rõ vì sao cả Toàn thư và Cương mục đều ghi vào năm Quý Mùi (923)?

Từ sự liên kết các sự kiện nêu trong sử liệu Phương Bắc với các sử liệu có trong trong Đại Việt Sử Ký Toàn Thư, cộng với sự phù hợp về địa lý của hàm phân bố mật độ dân mang họ Khúc cho thấy các thông tin lịch sử về triều đại họ Khúc trong khoảng thời gian từ 905 tới năm 923 (hoặc 930) là đáng tin cậy.

### Dữ liệu

```{r, warning=FALSE, message=FALSE, lazy=FALSE}
khuc_sff <- dat_sff %>% mutate(prop.khuc=(sum(subset(., Ho=="Khúc")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Khúc")
khuc_plot <- khuc_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.khuc, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
khuc_plot$centroid <- sf::st_transform(khuc_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

khuc <- khuc_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Canh Tan" & NAME_2=="Hung Ha"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.khuc=as.numeric(round(prop.khuc, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.khuc, area_km, songuoi_km, lng, lat, distm_km)

khuc_peak <- khuc_plot %>% filter(NAME_3=="Xa Canh Tan" & NAME_2=="Hung Ha")

datatable(khuc, colnames = c("STT", "Tỉnh/Thành phố", "Quận/Huyện", "Phường/Xã", "Số người", "Dân số", "Tỉ lệ/xã phường", "Tỉ lệ/cả nước", "Diện tích (km2)", "Mật độ (người/km2)", "Kinh độ", "Vĩ độ", "Khoảng cách tới tâm (km)"), extensions = 'Buttons', options = list(
    dom = 'Bfrtip',
    buttons = c('copy', 'csv', 'excel', 'pdf', 'print')
  ))
```

### Phân bố tỉ lệ

```{r, message=FALSE, warning=FALSE, lazy=TRUE}
khuc_sf <- dat_sf %>% mutate(prop.khuc=(sum(subset(., Ho=="Khúc")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Khúc")
khuc_plot <- khuc_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.khuc, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=khuc_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=khuc_peak, mapping = aes(label=NAME_3), color="red", size=3, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=8, label= paste(round(khuc_plot$prop.khuc[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 30)) +
  ggtitle("Khúc")
```

### Phương trình hàm phân bố tỉ lệ

```{r, message=FALSE, warning=FALSE, lazy=TRUE}
khuc <- dat_sff %>% filter(Ho=="Khúc") %>% st_as_sf(crs = 4326)
khuc$centroid <- sf::st_transform(khuc, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
khuc <- khuc %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Canh Tan" & NAME_2=="Hung Ha"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

khuc_radius <- khuc %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())

distm_km<-khuc_radius$distm_km
pro.pop<-khuc_radius$pro.pop
rank<-khuc_radius$rank
commune<-khuc_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-18*exp(-(distm_km^2)/(2*100))

library(dplyr)
df<-data.frame(distm_km, rank, commune, estimate, pro.pop)

df <- df %>%
  mutate(num=sum((pro.pop-estimate)^2),
         den=nrow(df)-1,
         var=num/den,
         sd=sqrt(var),
         rank_com=as.numeric(reorder(factor(rank), distm_km)))
  
breaks <- c(0, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200)

plot_df <- df %>%
  filter(row_number()<=1000) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=pro.pop, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=pro.pop), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=pro.pop, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=20)) +
  scale_x_discrete(name = "Xã/Phường", 
                     breaks = reorder(factor(rank), distm_km), 
                     labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Tỉ lệ (%)") +
  theme_bw() + 
  theme(text = element_text(size=20), axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_text(size=15),
        legend.text=element_text(size=15), legend.key.size = unit(3, "cm"), legend.key.height = unit(1, "cm"), legend.key.width = unit(1, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Khúc")

plot_df
```

### Phân bố mật độ

```{r, lazy=TRUE}
khuc_sff <- dat_sff %>% mutate(prop.khuc=(sum(subset(., Ho=="Khúc")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Khúc")
khuc_plotf <- khuc_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.khuc, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=khuc_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=8, label= paste(round(khuc_plotf$prop.khuc[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 30)) +
  ggtitle("Khúc")
```

### Phương trình hàm phân bố mật độ

```{r, message=FALSE, warning=FALSE, lazy=TRUE}
khuc <- dat_sff %>% filter(Ho=="Khúc") %>% st_as_sf(crs = 4326)
khuc$centroid <- sf::st_transform(khuc, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
khuc <- khuc %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Canh Tan" & NAME_2=="Hung Ha"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

khuc_radius <- khuc %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())

distm_km<-khuc_radius$distm_km
songuoi_km<-khuc_radius$songuoi_km
rank<-khuc_radius$rank
commune<-khuc_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-250*exp(-(distm_km^2)/(2*100))

library(dplyr)
df<-data.frame(distm_km, rank, commune, estimate, songuoi_km)

df <- df %>%
  mutate(num=sum((songuoi_km-estimate)^2),
         den=nrow(df)-1,
         var=num/den,
         sd=sqrt(var),
         rank_com=as.numeric(reorder(factor(rank), distm_km)))
  
breaks <- c(0, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200)

plot_df <- df %>%
  filter(row_number()<=1000) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=songuoi_km, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=songuoi_km), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=songuoi_km, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=20)) +
  scale_x_discrete(name = "Xã/Phường", 
                     breaks = reorder(factor(rank), distm_km), 
                     labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Mật độ (người/km2)") +
  theme_bw() + 
  theme(text = element_text(size=20), axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_text(size=15),
        legend.text=element_text(size=15), legend.key.size = unit(3, "cm"), legend.key.height = unit(1, "cm"), legend.key.width = unit(1, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Khúc")

plot_df
```

## Dương

### Dữ liệu

```{r, warning=FALSE, message=FALSE, lazy=FALSE}
duong_sff <- dat_sff %>% mutate(prop.duong=(sum(subset(., Ho=="Dương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Dương")
duong_plot <- duong_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.duong, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
duong_plot$centroid <- sf::st_transform(duong_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

duong <- duong_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Quynh Son" & NAME_2=="Bac Son"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.duong=as.numeric(round(prop.duong, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.duong, area_km, songuoi_km, lng, lat, distm_km)

duong_peak <- duong_plot %>% filter(NAME_3=="Xa Quynh Son" & NAME_2=="Bac Son")

datatable(duong, colnames = c("STT", "Tỉnh/Thành phố", "Quận/Huyện", "Phường/Xã", "Số người", "Dân số", "Tỉ lệ/xã phường", "Tỉ lệ/cả nước", "Diện tích (km2)", "Mật độ (người/km2)", "Kinh độ", "Vĩ độ", "Khoảng cách tới tâm (km)"), extensions = 'Buttons', options = list(
    dom = 'Bfrtip',
    buttons = c('copy', 'csv', 'excel', 'pdf', 'print')
  ))
```

### Phân bố tỉ lệ

```{r, warning=FALSE, message=FALSE, lazy=TRUE}
duong_sf <- dat_sf %>% mutate(prop.duong=(sum(subset(., Ho=="Dương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Dương")
duong_plot <- duong_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.duong, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=duong_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=duong_peak, mapping = aes(label=NAME_3), color="red", size=3, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=8, label= paste(round(duong_plot$prop.duong[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 30)) +
  ggtitle("Dương")
```

### Phương trình hàm phân bố tỉ lệ

```{r, message=FALSE, warning=FALSE, lazy=TRUE}
duong <- dat_sff %>% filter(Ho=="Dương") %>% st_as_sf(crs = 4326)
duong$centroid <- sf::st_transform(duong, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
duong <- duong %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Quynh Son" & NAME_2=="Bac Son"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

duong_radius <- duong %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())

distm_km<-duong_radius$distm_km
pro.pop<-duong_radius$pro.pop
rank<-duong_radius$rank
commune<-duong_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-87*exp(-(distm_km^2)/(2*100))

library(dplyr)
df<-data.frame(distm_km, rank, commune, estimate, pro.pop)

df <- df %>%
  mutate(num=sum((pro.pop-estimate)^2),
         den=nrow(df)-1,
         var=num/den,
         sd=sqrt(var),
         rank_com=as.numeric(reorder(factor(rank), distm_km)))
  
breaks <- c(0, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200)

plot_df <- df %>%
  filter(row_number()<=1000) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=pro.pop, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=pro.pop), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=pro.pop, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=20)) +
  scale_x_discrete(name = "Xã/Phường", 
                     breaks = reorder(factor(rank), distm_km), 
                     labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Tỉ lệ (%)") +
  theme_bw() + 
  theme(text = element_text(size=20), axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_text(size=15),
        legend.text=element_text(size=15), legend.key.size = unit(3, "cm"), legend.key.height = unit(1, "cm"), legend.key.width = unit(1, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Dương")

plot_df
```

### Phân bố mật độ

```{r, lazy=TRUE}
duong_sff <- dat_sff %>% mutate(prop.duong=(sum(subset(., Ho=="Dương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Dương")
duong_plotf <- duong_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.duong, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=duong_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=8, label= paste(round(duong_plotf$prop.duong[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 30)) +
  ggtitle("Dương")
```

### Phương trình hàm phân bố mật độ

```{r, message=FALSE, warning=FALSE, lazy=TRUE}
duong <- dat_sff %>% filter(Ho=="Dương") %>% st_as_sf(crs = 4326)
duong$centroid <- sf::st_transform(duong, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
duong <- duong %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Quynh Son" & NAME_2=="Bac Son"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

duong_radius <- duong %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())

distm_km<-duong_radius$distm_km
songuoi_km<-duong_radius$songuoi_km
rank<-duong_radius$rank
commune<-duong_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-121*exp(-(distm_km^2)/(2*100))

library(dplyr)
df<-data.frame(distm_km, rank, commune, estimate, songuoi_km)

df <- df %>%
  mutate(num=sum((songuoi_km-estimate)^2),
         den=nrow(df)-1,
         var=num/den,
         sd=sqrt(var),
         rank_com=as.numeric(reorder(factor(rank), distm_km)))
  
breaks <- c(0, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200)

plot_df <- df %>%
  filter(row_number()<=1000) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=songuoi_km, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=songuoi_km), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=songuoi_km, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=20)) +
  scale_x_discrete(name = "Xã/Phường", 
                     breaks = reorder(factor(rank), distm_km), 
                     labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Mật độ (người/km2)") +
  theme_bw() + 
  theme(text = element_text(size=20), axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_text(size=15),
        legend.text=element_text(size=15), legend.key.size = unit(3, "cm"), legend.key.height = unit(1, "cm"), legend.key.width = unit(1, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Dương")

plot_df
```

## Ngô

### Dữ liệu

```{r, warning=FALSE, message=FALSE, lazy=FALSE}
ngo_sff <- dat_sff %>% mutate(prop.ngo=(sum(subset(., Ho=="Ngô")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ngô")
ngo_plot <- ngo_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ngo, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
ngo_plot$centroid <- sf::st_transform(ngo_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

ngo <- ngo_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Dai Thanh" & NAME_2=="Hiep Hoa"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.ngo=as.numeric(round(prop.ngo, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ngo, area_km, songuoi_km, lng, lat, distm_km)

ngo_peak <- ngo_plot %>% filter(NAME_3=="Xa Dai Thanh" & NAME_2=="Hiep Hoa")

datatable(ngo, colnames = c("STT", "Tỉnh/Thành phố", "Quận/Huyện", "Phường/Xã", "Số người", "Dân số", "Tỉ lệ/xã phường", "Tỉ lệ/cả nước", "Diện tích (km2)", "Mật độ (người/km2)", "Kinh độ", "Vĩ độ", "Khoảng cách tới tâm (km)"), extensions = 'Buttons', options = list(
    dom = 'Bfrtip',
    buttons = c('copy', 'csv', 'excel', 'pdf', 'print')
  ))
```

### Phân bố tỉ lệ

```{r, warning=FALSE, message=FALSE, lazy=TRUE}
ngo_sf <- dat_sf %>% mutate(prop.ngo=(sum(subset(., Ho=="Ngô")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ngô")
ngo_plot <- ngo_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.ngo, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ngo_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=ngo_peak, mapping = aes(label=NAME_3), color="red", size=3, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=8, label= paste(round(ngo_plot$prop.ngo[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 30)) +
  ggtitle("Ngô")
```

### Phương trình hàm phân bố tỉ lệ

```{r, message=FALSE, warning=FALSE, lazy=TRUE}
ngo <- dat_sff %>% filter(Ho=="Ngô") %>% st_as_sf(crs = 4326)
ngo$centroid <- sf::st_transform(ngo, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
ngo <- ngo %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Dai Thanh" & NAME_2=="Hiep Hoa"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

ngo_radius <- ngo %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())

distm_km<-ngo_radius$distm_km
pro.pop<-ngo_radius$pro.pop
rank<-ngo_radius$rank
commune<-ngo_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-35*exp(-(distm_km^2)/(2*100))

library(dplyr)
df<-data.frame(distm_km, rank, commune, estimate, pro.pop)

df <- df %>%
  mutate(num=sum((pro.pop-estimate)^2),
         den=nrow(df)-1,
         var=num/den,
         sd=sqrt(var),
         rank_com=as.numeric(reorder(factor(rank), distm_km)))
  
breaks <- c(0, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200)

plot_df <- df %>%
  filter(row_number()<=1000) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=pro.pop, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=pro.pop), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=pro.pop, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=20)) +
  scale_x_discrete(name = "Xã/Phường", 
                     breaks = reorder(factor(rank), distm_km), 
                     labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Tỉ lệ (%)") +
  theme_bw() + 
  theme(text = element_text(size=20), axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_text(size=15),
        legend.text=element_text(size=15), legend.key.size = unit(3, "cm"), legend.key.height = unit(1, "cm"), legend.key.width = unit(1, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Ngô")

plot_df
```

### Phân bố mật độ

```{r, lazy=TRUE}
ngo_sff <- dat_sff %>% mutate(prop.ngo=(sum(subset(., Ho=="Ngô")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ngô")
ngo_plotf <- ngo_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.ngo, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ngo_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=8, label= paste(round(ngo_plotf$prop.ngo[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 30)) +
  ggtitle("Ngô")
```

### Phương trình hàm phân bố mật độ

```{r, message=FALSE, warning=FALSE, lazy=TRUE}
ngo <- dat_sff %>% filter(Ho=="Ngô") %>% st_as_sf(crs = 4326)
ngo$centroid <- sf::st_transform(ngo, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
ngo <- ngo %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Dai Thanh" & NAME_2=="Hiep Hoa"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

ngo_radius <- ngo %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())

distm_km<-ngo_radius$distm_km
songuoi_km<-ngo_radius$songuoi_km
rank<-ngo_radius$rank
commune<-ngo_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-525*exp(-(distm_km^2)/(2*100))

library(dplyr)
df<-data.frame(distm_km, rank, commune, estimate, songuoi_km)

df <- df %>%
  mutate(num=sum((songuoi_km-estimate)^2),
         den=nrow(df)-1,
         var=num/den,
         sd=sqrt(var),
         rank_com=as.numeric(reorder(factor(rank), distm_km)))
  
breaks <- c(0, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200)

plot_df <- df %>%
  filter(row_number()<=1000) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=songuoi_km, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=songuoi_km), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=songuoi_km, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=20)) +
  scale_x_discrete(name = "Xã/Phường", 
                     breaks = reorder(factor(rank), distm_km), 
                     labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Mật độ (người/km2)") +
  theme_bw() + 
  theme(text = element_text(size=20), axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_text(size=15),
        legend.text=element_text(size=15), legend.key.size = unit(3, "cm"), legend.key.height = unit(1, "cm"), legend.key.width = unit(1, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Ngô")

plot_df
```

## Lương

### Dữ liệu

```{r, warning=FALSE, message=FALSE, lazy=FALSE}
luong_sff <- dat_sff %>% mutate(prop.luong=(sum(subset(., Ho=="Lương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lương")
luong_plot <- luong_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.luong, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
luong_plot$centroid <- sf::st_transform(luong_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

luong <- luong_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Tam Van" & NAME_2=="Lang Chanh"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.luong=as.numeric(round(prop.luong, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.luong, area_km, songuoi_km, lng, lat, distm_km)

luong_peak <- luong_plot %>% filter(NAME_3=="Xa Tam Van" & NAME_2=="Lang Chanh")

datatable(luong, colnames = c("STT", "Tỉnh/Thành phố", "Quận/Huyện", "Phường/Xã", "Số người", "Dân số", "Tỉ lệ/xã phường", "Tỉ lệ/cả nước", "Diện tích (km2)", "Mật độ (người/km2)", "Kinh độ", "Vĩ độ", "Khoảng cách tới tâm (km)"), extensions = 'Buttons', options = list(
    dom = 'Bfrtip',
    buttons = c('copy', 'csv', 'excel', 'pdf', 'print')
  ))
```

### Phân bố tỉ lệ

```{r, warning=FALSE, message=FALSE, lazy=TRUE}
luong_sf <- dat_sf %>% mutate(prop.luong=(sum(subset(., Ho=="Lương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lương")
luong_plot <- luong_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.luong, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=luong_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=luong_peak, mapping = aes(label=NAME_3), color="red", size=3, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=8, label= paste(round(luong_plot$prop.luong[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 30)) +
  ggtitle("Lương")
```

### Phương trình hàm phân bố tỉ lệ

```{r, message=FALSE, warning=FALSE, lazy=TRUE}
luong <- dat_sff %>% filter(Ho=="Lương") %>% st_as_sf(crs = 4326)
luong$centroid <- sf::st_transform(luong, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
luong <- luong %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Tam Van" & NAME_2=="Lang Chanh"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

luong_radius <- luong %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())

distm_km<-luong_radius$distm_km
pro.pop<-luong_radius$pro.pop
rank<-luong_radius$rank
commune<-luong_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-46*exp(-(distm_km^2)/(2*100))

library(dplyr)
df<-data.frame(distm_km, rank, commune, estimate, pro.pop)

df <- df %>%
  mutate(num=sum((pro.pop-estimate)^2),
         den=nrow(df)-1,
         var=num/den,
         sd=sqrt(var),
         rank_com=as.numeric(reorder(factor(rank), distm_km)))
  
breaks <- c(0, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200)

plot_df <- df %>%
  filter(row_number()<=1000) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=pro.pop, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=pro.pop), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=pro.pop, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=20)) +
  scale_x_discrete(name = "Xã/Phường", 
                     breaks = reorder(factor(rank), distm_km), 
                     labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Tỉ lệ (%)") +
  theme_bw() + 
  theme(text = element_text(size=20), axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_text(size=15),
        legend.text=element_text(size=15), legend.key.size = unit(3, "cm"), legend.key.height = unit(1, "cm"), legend.key.width = unit(1, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Lương")

plot_df
```

### Phân bố mật độ

```{r, lazy=TRUE}
luong_sff <- dat_sff %>% mutate(prop.luong=(sum(subset(., Ho=="Lương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lương")
luong_plotf <- luong_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.luong, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=luong_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=8, label= paste(round(luong_plotf$prop.luong[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 30)) +
  ggtitle("Lương")
```

### Phương trình hàm phân bố mật độ

```{r, message=FALSE, warning=FALSE, lazy=TRUE}
luong <- dat_sff %>% filter(Ho=="Lương") %>% st_as_sf(crs = 4326)
luong$centroid <- sf::st_transform(luong, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
luong <- luong %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Tam Van" & NAME_2=="Lang Chanh"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

luong_radius <- luong %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())

distm_km<-luong_radius$distm_km
songuoi_km<-luong_radius$songuoi_km
rank<-luong_radius$rank
commune<-luong_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-36*exp(-(distm_km^2)/(2*100))

library(dplyr)
df<-data.frame(distm_km, rank, commune, estimate, songuoi_km)

df <- df %>%
  mutate(num=sum((songuoi_km-estimate)^2),
         den=nrow(df)-1,
         var=num/den,
         sd=sqrt(var),
         rank_com=as.numeric(reorder(factor(rank), distm_km)))
  
breaks <- c(0, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200)

plot_df <- df %>%
  filter(row_number()<=1000) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=songuoi_km, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=songuoi_km), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=songuoi_km, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=20)) +
  scale_x_discrete(name = "Xã/Phường", 
                     breaks = reorder(factor(rank), distm_km), 
                     labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Mật độ (người/km2)") +
  theme_bw() + 
  theme(text = element_text(size=20), axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_text(size=15),
        legend.text=element_text(size=15), legend.key.size = unit(3, "cm"), legend.key.height = unit(1, "cm"), legend.key.width = unit(1, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Lương")

plot_df
```

## Lý

Họ Lý 李, Trần 陳, và Nguyễn 阮

Con tự họ Lý 李 hàm ý đứa con của cây rừng trên núi cao. Con tự dòng Nguyễn 阮 được hiểu là người thân phận như những mô đất (dòng họ) bị đè nén không ngóc đầu lên được. Con Tự dòng họ Trần 陳 là những mô đất (dòng họ) ở phía Đông nơi có cây bao phủ. Dòng Họ Lý 李 là ở phía rừng núi Quảng Tây, dòng họ Trần 陳 là ở về phía đồng bằng Quảng Đông. 

Trong bài khảo cứu về dòng họ Lý được đăng trên trithucvn.org, anh Việt giám đốc Trung Tâm Tiền Sử Đông Nam Á có khẳng định như sau. 

Trên một dụng cụ bằng đồng khai quật tại Quảng Đông còn nguyên dòng minh văn: “Nguyên Sơ ngũ niên thất nguyệt trung Tây Vu Lý Văn Sơn trị xạ trước (chú) hữu”. Tạm dịch: Vào trung tuần tháng bảy năm thứ năm đời Nguyên Sơ (năm 143 sau Công nguyên) Lý Văn Sơn người Tây Vu điều hành việc đúc đồng. 

Trên một chiếc vò sành đời Hán được Clemant Huet sưu tầm tại Thanh Hóa trước Chiến tranh thế giới lần thứ nhất, hiện trưng bày tại gian Việt Nam của Bảo tàng Hoàng gia Bỉ về Nghệ thuật và Lịch sử (Brussel) có khắc dòng chữ: “Kiến hòa tam niên nhuận nguyệt trấp nhật Lý thị tác”. Tạm dịch: Họ Lý sản xuất ngày hai mươi tháng nhuận năm thứ ba đời Kiến Hòa (năm 149 sau Công nguyên).

Huyện Tây Vu đời Nguyên Sơ bao gồm cả vùng đất Bắc Ninh, Bắc Giang trọng tâm là các vùng Quế Võ, Phả Lại, Thiên Thai… Mã Viện đã tách ra từ huyện Tây Vu cũ thành ba huyện: Tây Vu, Phong Châu và Vọng Hải. Anh Việt cũng cho biết thêm tổ của Lý Bí cũng từ phía Bắc sang đất Việt từ thời Tây Hán, 200 năm trước Công Nguyên.

Như thế họ Lý được biết đến ở Đại Việt tương đối sớm. Lần ngược lại lịch sử thì chúng ta được biết họ Nguyễn ở Đại Việt được hình thành một cách "nhân tạo" như sau.

Năm 1232, nhà Lý suy vong, Trần Thủ Độ đã bắt con cháu họ Lý đổi sang họ Nguyễn với lý do phạm húy bởi ông nội của Trần Cảnh tức vua Trần Thái Tông là Trần Lý. Trên thực tế lý do bắt đổi họ Lý 李 thành họ Nguyễn 阮 là hàm ý nhục mạ và để tiêu diệt tận gốc sự chống đối. 

Không riêng gì dòng họ Lý, trong lịch sử Việt Nam, tất cả các dòng họ khác với họ của Vua đều bị quy chuyển về Nguyễn. 

Suốt 1000 năm, từ năm 457 đến thời Hồ Quý Ly ở vùng đất Hải Dương và một phần Hải Phòng ngày nay có huyện Phí Gia người họ Phí. Vào thời nhà Trần đã bị đổi sang thành họ Nguyễn. Năm 1592, nhà Mạc suy tàn, con cháu họ Mạc cũng đổi sang họ Nguyễn.

Trần Quang Diệu (và vợ là Bùi Thị Xuân) làm quan lớn cho nhà Tây Sơn, chống lại Nguyễn Ánh, sau khi nhà Tây Sơn cáo chung, con cháu Trần Quang Diệu, Bùi Thị Xuân bị trả thù khốc liệt, phải đổi thành nhiều họ, trong đó một số thành họ Nguyễn.

Căn cứ vào thống kê sau chúng ta thấy ở Việt Nam có 3 loại họ được sử dụng nhiều hơn cả. Đó là họ Nguyễn, họ Trần, và họ Lê. Trong đó họ Nguyễn chiếm tới gần 40% tổng số họ được sử dụng. 

Về mặt nguyên tắc thì sau khi có lệnh của Trần Thủ Độ, ở Đại Việt không thể có người mang họ Lý. Hiện vẫn còn một phần rất ít người mang họ Lý. Vậy họ từ đâu mà ra? 

Xét về lịch sử, kể từ sau nhà Trần, nhà Lý không còn tham gia chính sự. Hơn thế dòng họ Lý chỉ chiếm rất ít 0.5% trong tỷ lệ dân số Đại Việt. Như thế biến động về tỷ lệ dân số của họ Lý là không lớn. 

Cho tới tận khi Pháp sang phương thức sản xuất ở đồng bằng Bắc Bộ vẫn không thay đổi so với thời kỳ từ đầu Công Nguyên. Mật độ dân cư vẫn là khoảng 1 hộ trên 1 heta, tức khoảng 6 nhân khẩu gồm 3 thế hệ trên 1 heta. Vào thời Nhà Trần bờ biển ở vào khoảng Nam Định, diện tích đồng bằng Bắc Bộ vào khoảng 670 nghìn heta. Như thế dân số thời Nhà Trần vào khoảng trên dưới 4 triệu. Theo cổ sử thì dân số thì thời nhà Trần có 3790000 người. Con số này là đáng tin cậy. Với tỷ lệ này thì 0.5%  là khoảng 20 nghìn. Đây có thể chính là số quân của Đại Lý sau khi làm phản đánh lại 15 nghìn quân Mông Cổ trong trận đánh Mông lần thứ nhất 1258 ở lại Đại Việt. Đây là lực lượng tạo ra chiến thắng cho nhà Trần và không liên quan gì tới dòng của các vua Lý. Hơn thế Trần Thủ Độ (1194–1264) chết già khoảng 8 năm sau cuộc chiến khốc liệt. Và có thể vì các lý do đó mà 20 nghìn quân Đại Lý đã không bị đổi họ.

Như thế rất có thể 0.5% dân số mang họ Lý là hậu duệ của 20 nghìn quân từ Đại Lý làm chư hầu cho 15 nghìn quân Mông Cổ tiến đánh Đại Việt lần thứ nhất vào năm 1258. 

Trận đánh thắng quân Mông - Đại Lý năm 1258 là trận đánh tầm cỡ thế giới, bởi đấy là trận thua đầu tiên của quân Mông sau khi đã bình định khắp cả lục địa Á Âu. 

Vào cuối thời kỳ nhà Lý xã hội rối ren suy tàn, vua chúa ham tửu sắc mà bỏ bê việc nước, cướp nổi lên khắp nơi. Năm 1225, Lý Huệ Tông truyền ngôi cho con gái 7 tuổi là Chiêu Thánh, tức vua Lý Chiêu Hoàng. Trần Thủ Độ chú của Lý Chiêu Hoàng đã dàn xếp việc truyền lại ngôi từ nhà Lý sang nhà Trần. Trần Thủ Độ tiến cử Trần Cảnh, lúc đó mới 8 tuổi, làm Chi hậu chính chi ứng cục hầu hạ trong cung. Ngày 11 tháng 12 năm ấy (tức 10 tháng 1 năm 1226), Chiêu Hoàng trao hoàng bào cho Trần Cảnh ở điện Thiên An. Nhà Lý chấm dứt sau 216 năm tồn tại. 
32 năm, từ năm 1226 đến năm 1258, là khoảng thời gian may mắn vừa để dẹp nạn cướp, vừa để củng cố sức mạnh quân sự đủ để đương đầu chống lại cuộc chiến với quân Mông Cổ. 

Diến tiến trận đánh như sau 
- Ngày 12 tháng chạp (17/1/1258), quân Nguyên từ Đại Lý thuộc Vân Nam sang giao chiến với quân nhà Trần trận đầu tiên ở Bình Lệ Nguyên (nay là khoảng Bình Xuyên, Vĩnh Phúc). 
- Ngày 13 tháng chạp (18/1/1258) giao chiến lần thứ 2 bên sông Phù Lỗ (tức sông Cà Lồ).
- Ngày 21 tháng 1 năm đó, quân Trần rút khỏi thành Thăng Long về Thiên Mạc. Quân Nguyên Mông chiếm được thành. 
- Ngày 24 tháng chạp (29/1/1258) giao chiến trận thứ 3 ở Đông Bộ Đầu. Trần Thái Tông cùng thái tử Trần Hoảng (sau là vua Trần Thánh Tông) dẫn quân ngược sông Nhị tiến đánh Đông Bộ Đầu. Quân Nguyên Mông rút chạy về Vân Nam.

Theo Đại Việt Sử Ký Toàn Thư thì trận đánh trên sông Cà Lồ quân của Trần Thái Tông bị thua trận quân lính tan tác. Sự kiện chỉ sau có 11 ngày, từ chỗ ngày 18/1 quân Trần đại bại, tới 29/1 quân Trần đại thắng, đánh bại 15 nghìn quân Mông được giải thích như sau. 

Đặc điểm của quân Mông là cưỡi ngựa, bắn tên rất giỏi. Đội quân này không mang theo lương thực. Họ đánh phá các làng mạc thành trì, cướp lương ăn, hãm hiếp phụ nữ, cứ như thế mà di chuyển đánh khắp cả châu Á châu Âu. Như vậy sức mạnh của quân Mông Cổ là ở khả năng di chuyển bằng ngựa chiến. Hiển nhiên là trận thua đầu tiên của quân Mông Cổ phải là do các vấn đề liên quan tới ngựa chiến. Sự thật có thể đã là thế nào?

Nhiều sử gia rất hoang mang khi nói đến số quân Mông Cổ huy động đánh Nhà Trần lần thứ 1, và càng hoang mang hơn khi lập luận về cuộc chiến đánh thắng quân Mông. 

Thủ phủ của Đại Lý ở hồ Nhĩ Hà, mà phía Tây của nó là thượng nguồn con sông Thao. Hốt Tất Liệt đưa 100 nghìn quân tiến từ Nội Mông qua Tân Cương xuống đánh Đại Lý. Đội quân này chia thành 3 cánh, Hốt Tất Liệt chỉ quy cánh giữa 70 nghìn quân. Cánh phải do Uriyangqatai chỉ huy với 15 nghìn quân. Sau khi đánh chiếm kinh thành của Đại Lý, Hôt Tất Liệt thu quân về đánh nhau với Tống. Uriyangqatai bình định nốt phần còn lại của Đại Lý rồi tiến quân xuống Đại Việt nhằm mở hướng tấn công Tống từ phía Nam.  
Số quân của Uriyangqatai là 35 nghìn, trong đó có 20 nghìn quân chư hầu Đại Lý. Đường đi ở vùng núi ít thay đổi theo thời gian. Ngày nay chúng là các đại lộ lớn. Như thế đường tiến quân của Uriyangqatai là qua Hà Giang rồi theo QL2, xuống Tam Quan.  

Đại Việt Sử Ký Toàn Thư nói tương đối rõ về bối cảnh trận chiến này. Vào tháng 11/1257 có lệnh "Mùa đông, tháng 11, Trần Thái Tông ra lệnh cả nước sắm sửa vũ khí." 
Các tình tiết sau chứng tỏ sự bị động của Đại Việt khi cuộc chiến bắt đầu. Cuộc chiến diễn ra tại vùng Bình Lệ Nguyên là vùng gồm Vinh Yên, Hương Canh ra tới tận bờ sông Hồng nay. Vào thế kỷ 12 sông Phan và sông Cà Lồ rộng khoảng 200m (bằng 2 lần tên bắn từ bờ ra giữa sông. Độ rộng này rộng hơn sông Thiên Phù -- vì sông Thiên Phù nay đã cạn.  Độ rộng của sông Thiên Phù gấp 2 lần sông Tô Lịch, và sông Tô Lịch thì rộng 70m từ Hàng Buồm qua Chợ Gạo). Bối cảnh chung thì Nhà Trần thi hành quan hệ hữu hảo với các tù trưởng ở biên cương. Quan hệ với Tống ở phía Bắc cũng rất tốt.

Nhắc lại diễn tiến 
- Mùa đông, tháng 11, lệnh truyền cả nước sắm sửa vũ khí.
- Tháng 12, ngày 12, tướng Nguyên Uriyangqatai (Ngột Lương Hợp Đải) xâm phạm Bình Lệ Nguyên.
- Vua thân hành đốc chiến, xông pha tên đạn. Quan quân hơi núng, vua ngoảnh trông tả hữu, chỉ có Lê Phụ Trần (tức Lê Trần) một mình một ngựa, ra vào trận giặc, sắc mặt bình thản như không.
- Lúc ấy, có người khuyên vua dừng lại để chỉ huy chiến đấu. Phụ Trần cố sức can vua: "Nay thì bệ hạ chỉ đánh một ván dốc túi thôi! Hãy nên tạm lánh chúng, sao lại có thể dễ dàng tin lời người ta thế!".
Bấy giờ, vua mới lui quân đóng ở sông Lô. Phụ Trần giữ phía sau. Quân giặc bắn loạn xạ, Phụ Trần lấy ván thuyền che cho vua khỏi trúng tên giặc. Thế giặc rất mạnh, vua lại phải lui giữ sông Thiên Mạc. Phụ Trần theo vua bàn những việc cơ mật, rất ít người biết được đều đó.
- Vua ngự thuyền nhỏ đến thuyền Thái úy Nhật Hiệu hỏi kế sách (chống giặc). Nhật Hiệu đương dựa mạn thuyền, cứ ngồi chứ không đứng dậy nổi, chỉ lấy ngón tay chấm nước viết hai chỉ "nhập Tống" lên mạn thuyền. Vua hỏi quân Tinh Cương ở đâu? (Tinh Cương là quân do Nhật Hiệu chỉ huy).
Nhật Hiệu trả lời: "Không gọi được chúng đến"
- Vua lập tức dời thuyền đến hỏi Thái sư Trần Thủ Độ, Thủ Độ trả lời: "Đầu thần chưa rơi xuống đất, bệ hạ đừng lo gì khác".
Như thế ngay từ phút giáp trận đầu tiên quân của Trần Thái Tông đã bị vỡ trận, bỏ chạy, tướng không còn thấy quân ở đâu. Tuy nhiên chỉ sau có 1 tháng quân của Uriyangqatai đã phải tháo chạy khỏi Đại Việt không còn đủ 3 nghìn quân. Vậy điều gì đã xảy ra.
Vào thế kỷ 12 đồng bằng Bắc Bộ thấp hơn hiện nay 4m. Vậy cuộc chiến xảy ra ở vùng sông nước. 
Mật độ dân cư đồng bằng Bắc Bộ ước tính 1 hộ/1ha, dân ở trong làng và đào hào quanh để lấy đất làm nhà làm đường. Quanh làng có lũy tre để ngăn cướp. Trên các con đường vào làng mà đào hố thì chả ngựa nào tấn công được. Như thế việc bình định nhanh vùng đầm hồ là không thể. Ưu thế của kị binh đánh nhanh thắng nhanh không còn. Cỏ ăn cho ngựa không hợp thổ nhưỡng, cũng có thể là nguyên nhân dẫn đến giảm sức chiến đấu. Quân của Mông Cổ hiển nhiên là đối tượng cho đội quân 20 nghìn quân thiện chiến của Đại Lý trả thù. Và chỉ sau chưa đầy 1 tháng thì "gậy ông đập lưng ông" chính quân Mông Cổ bị 20 nghìn quân chư hầu đánh lại. Quân của vua Trần Thái Tông cũng tập hợp lại và theo đà đánh đuổi quân Mông. Quân Mông Cổ chết gần hết. 20 nghìn quân Đại Lý này ở lại Đại Việt. Có thể những người này sống ở vùng rừng núi  ít liên quan tới nhà Trần, và cũng có thể nhà Trần đã đăng ký nhân khẩu và cấp họ cho những người này là Lý. 

Lần theo nguồn Đại Việt Sử Ký Toàn Thư, chúng ta thấy cái tên Đông Bộ Đầu được nhắc đến 10 lần, trong đó 9 lần đề đích danh Đông Bộ Đầu 東步頭, 1 lần đề là bến Triều Đông朝東津:
Vị trí của Đông Bộ Đầu được xác định nhờ bia "chùa Hòe Nhai".
https://yeuhannom.blogspot.com/.../bia-chua-hong-phuc-voi?fbclid=IwAR3s6qFXt__KF4_vOQSxbThNeq33iikJsPEoqxEpPZcmlwcdyEa1C7Xw1go

Theo các nhà sử học, người soạn tấm bia này là tiến sĩ Hà Tông Mục - tác giả của nhiều văn bia có giá trị vào thế kỷ 17. Hà Tông Mục 何宗穆 sinh ngày 25-9 năm Quý Tỵ (1653) mất ngày 7-3 Ðinh Hợi (1707), người làng Tỉnh Thạch huyện Thiên Lộc (nay là xã Tùng Lộc huyện Can Lộc) tỉnh Hà Tĩnh. Là một danh thần nổi tiếng triều Lê có tham gia biên soạn Đại Việt sử ký tục biên.

Mặt 1: 盛德宏功
蓋 聞：夫善之種福之宗而修福行善者，豈必於山巔水涯足跡穻到之所然後為至哉！我大越昇龍城之 "東步頭" 槐街坊有寺名洪福，帶瀘江而襟蘇瀝，控傘嶺而拱宸居。風景 有情精氣所萃，自古僧伽大士住持焚誦，上祝聖人壽下願民物康，國禱民祈應若桴鼓。誠古跡大伽藍都會中之勝概也。日月跡久平波靡常鄰房纔闕於鴟魚，梵宇盡灰 於回祿。一區淨土侵尋為讙鬧之場，幾座金身零落於福林之境。禪扃煙鎖僧砌苔漫，歷閱星霜六十餘年，皈依像教者睹之者莫不太息然未有修而復之者。睠玆
Dịch là 
THỊNH ĐỨC HOẰNG CÔNG
Từng nghe: Gieo mầm thiện là nối dòng phúc, mà tu phúc làm thiện, há phải ở những nơi góc biển chân trời nơi chân người ít đến mới được đâu! Phường Hòe Nhai, khu "Đông Bộ Đầu", thành Thăng Long nước Đại Việt ta có ngôi chùa tên Hồng Phúc, men dòng Lô giang (sông Hồng) mà bao dòng Tô Lịch, chống non Tản mà chầu hướng thần cư. Phong cảnh hữu tình là nơi tinh khí hội tụ, từ xưa là nơi các bậc tăng già đại sĩ trụ trì khấn tụng, trên thì chúc vua thánh thọ dưới nguyện dân vật an khang, quốc cúng dân cầu linh ứng vang truyền như trống dậy. Thực là nơi đại già lam cổ tích, thắng cảnh chốn đô thành. Năm tháng dài lâu, phong ba biến đổi, xóm thôn vắng vẻ đìu hiu, kèo cột tô khắc hình cá chim tiêu tán, cảnh chùa cũng mắc vòng lửa tai biến mà ra tro. Một khu Tịnh thổ dần thành chốn hoan lạc bon chen, mấy tòa tượng báu điêu tàn giữa cảnh phúc lâm. Cửa Thiền mây tỏa, thềm tăng rêu đầy, trải bao phen ngó sao nằm sương hơn sáu chục năm, những người quy y Tượng giáo (Phật Giáo) mà trông cảnh ấy không ai không than thở vì chưa có người tu sửa mà khôi phục lại.

Chùa Hòe Nhai ở Hà Nội là địa danh Đông Bộ Đầu 東步頭, tức "Bến đỗ thuyền phía đông". 

Khảo sát thực địa khu vực Hòe Nhai là một gò đất cao gần chân cầu Long Biên. Khảo sát thực tế chúng ta biết cửa sông Tô Lịch xưa là ở khoảng giữa Chợ Gạo và Hội Quán Quảng Đông trên phố Hàng Buồm. Như thế vào khoảng năm 1800 sông Hồng chảy theo đường Yên Phụ. Từ chùa Hòe Nhai, tức Đông Bộ Đầu, đi theo phố Hàng Than tới Hàng Ngang chính là bờ sông Hồng vào thời năm 1258. 

Khoảng cách từ phố Hàng Ngang tới đền Bạch Mã là 100m. Đền Bạch Mã có trên bản đồ 1490, như thế vận tốc bồi của phù sa làm bờ sông tiến dần ra là khoảng 100m cho 200 năm. Khoảng cách từ Đền Bạch Mã ra tới cửa sông Tô Lịch là 200m. Vậy 200m này ứng với 400 năm phù sa bồi. Như thế hội Quán Quảng Đông được dựng ra tại vị trí như hiện nay trên phố Hàng Buồm là vào khoảng năm 1900. 

Khoảng cách từ Hội Quán Phúc Kiến tới phố Hàng Ngang là 100m, vậy Hội Quán Phúc Kiến được dựng vào khoảng năm 1000, tức gần thời gian với vua Lý Công Uẩn rời đô ra Thăng Long. Đây chính là thời gian Nhà Trần từ Phúc Kiến di cư tới Đại Việt. Khu vực phát tích của Nhà Trần là ở Mỹ Lộc, Nam Định. Khoảng cách từ Mỹ Lộc tới cửa Ba Lạt là khoảng 50km. Cứ 1000 năm thì cửa sông Hồng tiến ra biển được 45km, vậy 50km ứng với khoảng 1000 năm. Đó chính là thời điểm xây dựng Hội Quán Phúc Kiến.

Như vậy chúng ta có thể tin vào khẳng định bờ sông Hồng vào năm 1258 là từ Hòe Nhai tới Hàng Ngang, rồi qua hồ Gươm. Vào năm 1400 bờ sông Hồng đã được phù sa bồi lấn tới phố Nguyễn Thiếp, Hàng Giầy, và do Hàng Bạc là một gò đất cao nên, bờ sông là vòng theo phố Lương Ngọc Quyến. Chùa Bạch Mã thờ Mã Viện thực chất là một miếu trên gò nổi ở bãi nổi giữa sông. Như vậy Đền Bạch Mã nơi thờ Mã Viện là được hình thành từ một cái miếu hoang ngoài bãi nổi giữa sông Hồng vào thời cư dân vùng ven biển Phúc Kiến di sang làm ăn buôn bán..

ĐVSKTT (Đại Việt Sử Ký Toàn Thư), là chính sử Ngô Sĩ Liên viết vào năm 1479. Sau nhiều năm kiểm duyệt, sửa đổi, và bổ sung, bộ sử 15 quyển được khắc in và phát hành vào năm 1697.
Ngô Sĩ Liên đã dựa vào hai bộ sử, bộ sử của Lê Văn Hưu và bộ sử của Phan Phu Tiên để biên soạn.

Bộ sử của Lê Văn Hưu biên soạn và hoàn thành vào năm 1272, Bộ Đại Việt sử ký 大越史記, là bộ quốc sử Việt Nam sớm nhất được ghi nhận,. Bộ sử ghi chép lịch sử Đại Việt từ thời đại Triệu Vũ Đế năm 207 TCN đến hết năm 1225 đời Lý Chiêu Hoàng nhà Lý.

Lê Văn Hưu theo lệnh vua Trần Thái Tông biên soạn bộ chính sử đầu tiên của nhà Trần mang tên Đại Việt Sử Ký. Bộ sách này bao gồm 30 quyển được hoàn thành và dâng lên vua Trần Thánh Tông vào tháng 1 năm 1272 và được vua Thánh Tông hết sức khen ngợi. Lê Tắc trong An Nam Chí Lược cho rằng Đại Việt Sử Ký của Lê Văn Hưu được biên soạn dựa trên cơ sở bộ Việt Chí (越志) của Trần Phổ được viết dưới thời Trần Thái Tông.

Như vậy ĐVSKTT có tham khảo Sử Ký 史記 của Đỗ Thiện thời nhà Lý, Việt chí 越志 của Hàn trưởng Trần Phổ thời nhà Trần. 

Lê Tắc (1263 - 1342) cùng chủ là Trần Kiện đã đầu hàng quân Nguyên, khi quân Nguyên đánh Đại Việt lần thứ 2, Lê Tắc được vua Nguyên phong chức. Hẳn là Lê Trác đã có được điều kiện để truy cập vào kho cổ sử các triều đại phong kiến Phương Bắc để viết An Nam Chí Lược. An Nam Chí Lược là cuốn cổ sử được viết dưới dạng cổ xúy cho các triều đại phong kiến Phương Bắc vì thế mà nó được phát hành, và cũng vì lý do đó mà các sự kiện lịch sử liên quan tới Đại Việt mới tới được với Ngô Sỹ Liên và chúng ta ngày nay. 

Về Nhà Trần ĐVSKTT viết: Có người tên là Kinh từ đất Mân di cư đến ở hương Tức Mặc, phủ Thiên Trường, sinh ra Hấp, Hấp sinh ra Lý, Lý sinh ra Thừa, đời đời làm nghề đánh cá. Trần Cảnh (1226-1258) là con thứ của Thừa, mẹ họ Lê, sinh ngày 16 tháng 6 năm Mậu Dần, Kiến Gia thứ 8. 

Như vậy Trần Cảnh là đời thứ 5 của Kinh di cưu tới  Mỹ Lộc thuộc Nam Định vào khoảng năm 1100. Cứ 1000 năm thì cửa Ba Lạt của sông Hồng tiến ra biển được khoảng 45km. Khoảng cách từ Mỹ Lộc tới cửa Ba Lạt khoảng 50km, tương ứng với khoảng 1000 năm về trước Mỹ Lộc là bờ biển. Điều này phù hợp với sử kiện ghi chép là tổ tiên của Nhà Trần tới vùng này làm nghề chài lưới vào khoảng năm 1100.

Trần Thủ Độ là chú họ bên ngoại của Lý Chiêu Hoàng (1218 - 1278) và là người sắp đặt cho việc Lý Chiêu Hoàng lấy Trần Cảnh (Trần Thái Tông) vào năm 1226, để chuyển ngôi từ nhà Lý sang nhà Trần.  Vào năm 1237, Trần Cảnh phế bỏ Hoàng Hậu Lý Chiêu Hoàng để lấy chị ruột của bà là  Hiển Từ Thuận Thiên Hoàng Hậu. Khi quân Mông tắt đường đánh chiếm kinh thành Thăng Long, Linh Từ (tức Lý Chiêu Hoàng) đã đưa hoàng thái tử, cung phi, công chúa và vợ con các tướng soái trốn thoát khỏi giặc cướp. 

Sau đại thắng quân Mông vào năm 1258, ở tuổi 40 Lý Chiêu Hoàng tái giá lấy Lê Phụ Trần. Lê Phụ Trần là một danh tướng phục vụ Trần Thái Tông, Trần Thánh Tông và Trần Nhân Tông. Ông đã có công cứu giúp Trần Thái Tông khỏi bị truy kích trong trận đánh với quân Mông ở Bình Lệ Nguyên.  

Bối cảnh trận đánh lần đầu tiên của quân Mông Cổ vào Đại Việt như sau.

Dali (Đại Lý) và Nam Tống là hai nước ở về phía Bắc của Đại Việt. Đế quốc Đại Lý hình thành vào năm 937 bao gồm cao nguyên Vân Nam 云南 và Tây Tứ Xuyên 四川西. Thủ phủ của Dali nằm ở phía nam hồ nước Erhai Lake 洱海. Hồ Erhai Lake dài 40km rộng 8km ở cao độ 2000m, bao quanh bởi các dãy núi dốc đứng cao 3500m. Đại Lý là nơi bắt đầu của tuyến đường tiến quân xuống Đông Nam Á, và là sườn phía Đông của Nam Tống. 

Năm 1252, đại hãn Mông Cổ Monkhe lệnh cho em trai mình là Hốt Tất Liệt 忽必烈 và tướng Ngột Lương Hợp Thai (Wulianghetai 兀良合台 sinh năm 1201 chết năm 1272, là  Wulianghetai con trai của Subutai  速不台 thuộc "Tứ linh Mông Cổ") dẫn 100 nghìn quân kỵ binh thiện chiến chinh phạt nước Đại Lý ở Vân Nam. 

Đây là cuộc viễn chinh quân sự đầu tiên của Hốt Tất Liệt và cũng là viễn chinh nổi tiếng trong lịch sử Trung Quốc. Muốn đánh Vân Nam thì phải qua Tứ Xuyên, nhưng Tứ Xuyên lúc này vẫn là đất của nhà Nam Tống. Tháng 7 năm 1252, Hốt Tất Liệt 忽必烈 khi ấy 36 tuổi, dẫn đội kỵ binh tiến hàng nghìn dặm dọc theo con đường qua Tây Tạng. Phải đến tháng 9 năm 1252, Hốt Tất Liệt mới tới được biên giới Đại Lý. Mục đích của việc đánh chiếm Dali là tạo thế gọng kìm để đánh quân Nam Tống từ phía bắc và từ phía Đông Nam. Sau khi đánh chiếm Dali, quân Mông Cổ đã tiến đánh Đại Việt với mực đích tấn công Tống từ phía Nam.

Cùng lúc ấy Meng Ge Khan 命汪德臣 (Wang Dechen), dẫn quân vào đánh Tứ Xuyên để hỗ trợ.

Vào mùa hè năm 1253, Quân Mông Cổ đi qua núi Liupan 六盘 và từ Lintao临洮 đến Tula 忒剌(nay là Dalagou, huyện Diebu, Cam Túc). Sau đó đội quân của Hốt Tất Liệt chia thành 3 cánh quân tiến về thành Kinh Thành Đại Lý ở phía nam. Wuliang Hetai dẫn quân tiến về theo đường phía Tây dọc theo Yandang (nay là đồng cỏ Aba ở Tứ Xuyên). Zong Wangchao và Yezhilie tiến theo đường phía Đông qua Mao Châu 茂州 (nay là Maowen) đến Huichuan 会川 (nay là Huilixi) và đến sông Lệ Giang Jinsha 沙江. Cánh quân giữa do Hốt Tất Liệt chỉ huy tiến qua thành phố Mantuo (nay là Hanyuan North, Tứ Xuyên) qua sông Dadu 渡大, dọc theo lãnh thổ nhà Thanh cổ đi hơn 1000 km về phía nam, vào đầu tháng 11, đến bờ sông Jinsha. Ước tính, trong tổng số 100 nghìn quân của cả 3 mũi thì cánh quân phía Tây của Wuliang Hetai có không ít hơn 15 nghìn quân.  

Vua Đại Lý Duẩn Hành Chi 段兴智 cử Tể tướng Cao Tương Gaoxiang Kublai 高祥 dẫn 100 nghìn quân từ Thiểm Tây tiến ra Huichuan 会川 đối phó. 

Cánh quân phía Tây của Wuliang Hetai chiếm được Lệ Giang. Cao Tương phải rút lui về chấn giữ đèo Đầu Rồng 龙首关. Sau khi hội quân, cả 3 toán quân Mông Cổ tập trung tấn công và đã đánh bại đại quân của Cao Tương tại Đèo Đầu Rồng 龙首关.

Sau khi trận chiến kết thúc, Hốt Tất Liệt đã ra lệnh cho Wuliang tiếp tục chinh phục các bộ lạc còn lại, và lệnh cho Liu Shizhong làm sứ thần áp đặt sự cai trịcủa Mông Cổ lên Đại Lý. Hốt Tất Liệt dẫn quân quay về phía bắc. WuLiang tiến vào Keab Chicheng. Vào mùa thu năm 1254 (năm thứ tư của Hoàng đế Xianzong ở Mông Cổ và năm thứ ba của Tianding ở Đại Lý), Wuliang Hetai dẫn quân đánh chiếm Bechicheng (nay là Côn Minh) truy đuổi Duẫn Hành Chi đến Côn Minh, và khi Duẫn Hành Chi chạy đến Kunze (nay là Yiliang) thì bị bắt. Duẫn Hành Chi bị dẫn giải đến Triều đình Khan miền bắc Mông Cổ. Meng Ge Khan cho phép Duẫn Hành Chi tiếp tục cai quản các bộ thuộc về ông. Wuliang Hetai sử dụng 20000 quân của gia tộc Duẩn làm tiên phong chiếm toàn bộ lãnh thổ Đại Lý.

Sau hai năm chiến đấu ác liệt, WuLiang đã chinh phục được Vương quốc Bare and Bald (tức là Luo Shigui, miền tây Quý Châu ngày nay), Luoluosi (tỉnh Tứ Xuyên Xichang ngày nay và tỉnh tự trị Liangshan Yi ), và Vương quốc Ziman Boli (khu vực Yuanjiang ngày nay). Thủ lĩnh Baiman Xilaifu bị bắt.

http://www.qulishi.com/article/201811/306471.html
http://www.qulishi.com/huati/menggumiedalizhizhan01/

Vào năm 1254 WuLiang  đưa đội kỵ binh 15 nghìn quân Mông Cổ cùng với 20000 quân của gia tộc Duẩn xâm nhập vào Đại Việt dọc theo phía hữu ngạn sông Hồng. Phần Đại Việt tiếp với Nam Tống kéo dài tới Lạng Sơn, có lẽ đường tiến quân của WuLiang là đi qua Lào Cai. 

Địa hình Đại Việt không giống như vùng cao nguyên Vân Nam. Phần phía Bắc và Tây giáp với Đại Lý, là các dáy núi đá dốc và rừng rậm đổ dọc về phía từ Tây Bắc xuống Đông Nam. Phần đồng bằng sông Hồng có cấu trúc gò đồi bao quanh là nước chảy. Do địa hình không phải là bình nguyên mà là rừng rậm nhiệt đới và đầm lầy nên không thể có đủ lượng cỏ cho ngựa ăn. Các mũi tiến quân của WuLiang không thể triển khai được.

Để biết được chiến sự đã diễn ra thế nào chúng ta căn cứ vào quy tắc, các đường đi trong vùng núi đá là đi theo các hẻm giữa các dãy núi và các đường này hầu như không hề thay đổi theo thời gian. Chúng là các con đường đi cả nghìn năm, vì thế mà nay chúng là các đường quốc lộ. Tiếp theo nữa là do việc các con sông liên tục mang phù sa bồi đắp mà nhiều vùng nay là đồng bằng thì trước đây là đầm lầy. Cũng như thế các con sông cũng rộng hơn ngày nay nhiều. Hàng năm vào mùa mưa, nước sông Hồng chảy lênh láng khắp vùng đồng bằng khu vực sông Phan. Phù sa bồi thêm một lớp dày 5mm mỗi năm. Như thế sau 800 năm nó bồi được một lớp đất khoảng 4m. Điều này cho thấy vào thế kỷ thứ 12 thì vùng đất này thấp hơn hiện nay tới 4m và con sông Phan thì rộng tới 150m. Vào thế kỷ 12 đầm hồ còn rất nhiều, người dân sống trên các gò đồi và đi lại chủ yếu bằng thuyền mảng nhỏ. Mỗi gò đồi là một làng. Người dân vợt đất làm nhà và làm đường trong làng vì thế bao quanh làng là dãy tre, mương nước, và ao sâu. Khả năng là quân của WuLiang đã tiến dọc theo đường QL14 giữa các dãy núi theo rồi qua QL2C để tránh đầm lầy phía nam hồ Thác Bà. Tiếp theo chúng tiến theo chân dãy núi Tam Đảo vào vùng đồi đất đỏ Hương Canh. 

Cuộc chiến đánh quân Mông ĐVSKTT viết
- Mùa đông, tháng 11, lệnh truyền cả nước sắm sửa vũ khí.
- Tháng 12, ngày 12, tướng Mông Uriyangqatai (1200-1271) xâm phạm Bình Lệ Nguyên.
- Vua thân hành đốc chiến, xông pha tên đạn. Quan quân hơi núng, vua ngoảnh trông tả hữu, chỉ có Lê Phụ Trần (tức Lê Trần) một mình một ngựa, ra vào trận giặc, sắc mặt bình thản như không.
- Lúc ấy, có người khuyên Trần Cảnh ở lại để chỉ huy chiến đấu. Phụ Trần cố sức can: "Nay thì bệ hạ chỉ đánh một ván dốc túi thôi! Hãy nên tạm lánh chúng, sao lại có thể dễ dàng tin lời người ta thế!". Bấy giờ, vua mới lui quân đóng ở sông Lô. Phụ Trần giữ phía sau. Quân giặc bắn loạn xạ, Phụ Trrần lấy ván thuyền che cho vua khỏi trúng tên giặc.
- Thế giặc rất mạnh, Trần Cảnh lui giữ sông Thiên Mạc. Phụ Trần theo vua bàn những việc cơ mật, rất ít người biết được đều đó. 
- Vua ngự thuyền nhỏ đến thuyền Thái úy Nhật Hiệu hỏi kế sách (chống giặc). Nhật Hiệu đương dựa mạn thuyền, cứ ngồi chứ không đứng dậy nổi, chỉ lấy ngón tay chấm nước viết hai chỉ "nhập
Tống" lên mạn thuyền. Vua hỏi quân Tinh Cương ở đâu? (Tinh Cương là quân do Nhật Hiệu chỉ huy). Nhật Hiệu trả lời: "Không gọi được chúng đến"
- Vua lập tức dời thuyền đến hỏi Thái sư Trần Thủ Độ, Thủ Độ trả lời: "Đầu thần chưa rơi xuống đất, bệ hạ đừng lo gì khác".
- Ngày 24, vua và Thái Tử ngự lâu thuyền, tiến quân đến Đông Bộ Đầu, đón đánh, cả phá được quân giặc. Quân Mông chạy trốn về, đến trại Quy Hóa, chủ trại là Hà Bổng chiêu tập người Man ra tập kích, lại cả phá bọn chúng.

Uriyangqatai (WuLiang) là con của Subotai, là một trong tứ dũng của Thành Cát Tư Hãn. Con của Uriyangqatai là Ajiu nguyên soái chỉ huy 700 nghìn quân đánh chiếm thành Tương Dương tiêu diệt Nam Tống. Quân của Uriyangqatai rất giỏi cưỡi ngựa bắn cung. Đoạn "Quân giặc bắn loạn xạ, Phụ Trrần lấy ván thuyền che cho vua khỏi trúng tên giặc." cho thấy việc "Vua Trần Cảnh ngoảnh trông tả hữu, chỉ có Lê Phụ Trần (tức Lê Trần) một mình một ngựa, ra vào trận giặc, sắc mặt bình thản như không." là viết phịa. Lê Phụ Trần không thể một mình một ngựa mà sống sót được dưới làn tên bắn của đội quân thiện chiến đánh khắp cả châu Âu - Châu Á. 

Bình Lệ Nguyên là vùng đất thận lợi cho kỵ binh Mông Cổ. Việc Trần Cảnh hỏi quân của Nhật Hiệu ở đâu? Nhật Hiệu trả lời: "Không gọi được chúng đến" là cho thấy quân của nhà Trần đã thua trận và tan tác. 

Chỉ 2 ngày sau trận đại bại ở Bình Lệ Nguyên, ngày 24/2/1258 xảy ra trận thắng ở Đông Bộ Đầu. 

Đông Bộ Đầu được cho là ở vùng Hòe Nhai nay, tức dốc Hàng Than ở đầu cầu Long Biên, là nơi quân của Trần Cảnh đón đánh cản phá được quân Mông. Đông Bộ Đầu ở ven sông phía bên này sông Hồng. Rõ ràng là ĐVSKTT đã nói rõ, quân Mông đã tiến đánh Thăng Long và Linh Từ Thái Hâu đã kịp đưa hoàng thái tử, cung phi, công chúa và vợ con các tướng soái trốn thoát. Như thế việc khẳng định Đông Bộ Đầu là trận đánh quyết định khiến cho quân Mông phải tự rút về nước có phần không đúng. Trận Đông Bộ Đầu cùng lắm là đánh nhau với toán quân Mông đánh vào Kinh Thành Thăng Long. Toàn bộ 35 nghìn quân Mông và Đại Lý vẫn còn cố thủ ở Bình Lệ Nguyên. Việc quân Mông bại trận và phải rút về nước có thể là do 20 nghìn quân Đại Lý làm binh biến đánh lại 15 nghìn quân kỵ binh Mông Cổ. 

Trần Thủ Độ đã cho đổi họ Lý thành họ Nguyễn từ trước cuộc xâm lược lần thứ nhất của quân Nguyên -  Mông, vậy những người mang họ Lý hiện nay có thể là 20 nghìn quân Đại Lý năm xưa, được đăng triều đình cho nhận họ Lý.

ĐVSKTT viết 

Tháng 1/1259, phu nhân Trần Thủ Độ là Linh Từ quốc mẫu Trần thị mất. Trần thị được gọi là quốc mẫu vì đó vốn là hiệu của Ngô phu nhân trước kia, tức là hoàng hậu Thái Tông thấy Linh Từ đã từng làm hoàng hậu của Lý Huệ Tông, không nỡ gọi là công chúa, cho nên phong làm quốc mẫu, cũng là biệt danh của hoàng hậu. Xe kiệu, mũ áo, quân hầu của bà đều ngang với hoàng 

Đến khi người Nguyên tắt đường vào cướp, kinh thành thất thủ, Linh Từ ở Hoàng Giang, giữ gìn hoàng thái tử, cung phi, công chúa và vợ con các tướng soái thoát khỏi giặc cướp, lại khám xét thuyền các nhà chứa giấu quân khí đều đưa dùng vào việc quân.

### Dữ liệu

```{r, warning=FALSE, message=FALSE, lazy=FALSE}
ly_sff <- dat_sff %>% mutate(prop.ly=(sum(subset(., Ho=="Lý")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lý")
ly_plot <- ly_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ly, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
ly_plot$centroid <- sf::st_transform(ly_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

ly <- ly_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Trung Leng Ho" & NAME_2=="Bat Xat"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.ly=as.numeric(round(prop.ly, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.ly, area_km, songuoi_km, lng, lat, distm_km)

ly_peak <- ly_plot %>% filter(NAME_3=="Xa Trung Leng Ho" & NAME_2=="Bat Xat")

datatable(ly, colnames = c("STT", "Tỉnh/Thành phố", "Quận/Huyện", "Phường/Xã", "Số người", "Dân số", "Tỉ lệ/xã phường", "Tỉ lệ/cả nước", "Diện tích (km2)", "Mật độ (người/km2)", "Kinh độ", "Vĩ độ", "Khoảng cách tới tâm (km)"), extensions = 'Buttons', options = list(
    dom = 'Bfrtip',
    buttons = c('copy', 'csv', 'excel', 'pdf', 'print')
  ))
```

### Phân bố tỉ lệ

```{r, warning=FALSE, message=FALSE, lazy=TRUE}
ly_sf <- dat_sf %>% mutate(prop.ly=(sum(subset(., Ho=="Lý")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lý")
ly_plot <- ly_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.ly, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ly_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=ly_peak, mapping = aes(label=NAME_3), color="red", size=3, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=8, label= paste(round(ly_plot$prop.ly[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 30)) +
  ggtitle("Lý")
```

### Phương trình hàm phân bố tỉ lệ

```{r, message=FALSE, warning=FALSE, lazy=TRUE}
ly <- dat_sff %>% filter(Ho=="Lý") %>% st_as_sf(crs = 4326)
ly$centroid <- sf::st_transform(ly, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
ly <- ly %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Trung Leng Ho" & NAME_2=="Bat Xat"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

ly_radius <- ly %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())

distm_km<-ly_radius$distm_km
pro.pop<-ly_radius$pro.pop
rank<-ly_radius$rank
commune<-ly_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-35*exp(-(distm_km^2)/(2*100))

library(dplyr)
df<-data.frame(distm_km, rank, commune, estimate, pro.pop)

df <- df %>%
  mutate(num=sum((pro.pop-estimate)^2),
         den=nrow(df)-1,
         var=num/den,
         sd=sqrt(var),
         rank_com=as.numeric(reorder(factor(rank), distm_km)))
  
breaks <- c(0, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200)

plot_df <- df %>%
  filter(row_number()<=1000) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=pro.pop, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=pro.pop), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=pro.pop, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=20)) +
  scale_x_discrete(name = "Xã/Phường", 
                     breaks = reorder(factor(rank), distm_km), 
                     labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Tỉ lệ (%)") +
  theme_bw() + 
  theme(text = element_text(size=20), axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_text(size=15),
        legend.text=element_text(size=15), legend.key.size = unit(3, "cm"), legend.key.height = unit(1, "cm"), legend.key.width = unit(1, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Lý")

plot_df
```

### Phân bố mật độ

```{r, lazy=TRUE}
ly_sff <- dat_sff %>% mutate(prop.ly=(sum(subset(., Ho=="Lý")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lý")
ly_plotf <- ly_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.ly, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=ly_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=8, label= paste(round(ly_plotf$prop.ly[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 30)) +
  ggtitle("Lý")
```

### Phương trình hàm phân bố mật độ

```{r, message=FALSE, warning=FALSE, lazy=TRUE}
ly <- dat_sff %>% filter(Ho=="Lý") %>% st_as_sf(crs = 4326)
ly$centroid <- sf::st_transform(ly, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
ly <- ly %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Trung Leng Ho" & NAME_2=="Bat Xat"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

ly_radius <- ly %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())

distm_km<-ly_radius$distm_km
songuoi_km<-ly_radius$songuoi_km
rank<-ly_radius$rank
commune<-ly_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-40*exp(-(distm_km^2)/(2*100))

library(dplyr)
df<-data.frame(distm_km, rank, commune, estimate, songuoi_km)

df <- df %>%
  mutate(num=sum((songuoi_km-estimate)^2),
         den=nrow(df)-1,
         var=num/den,
         sd=sqrt(var),
         rank_com=as.numeric(reorder(factor(rank), distm_km)))
  
breaks <- c(0, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200)

plot_df <- df %>%
  filter(row_number()<=1000) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=songuoi_km, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=songuoi_km), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=songuoi_km, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=20)) +
  scale_x_discrete(name = "Xã/Phường", 
                     breaks = reorder(factor(rank), distm_km), 
                     labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Mật độ (người/km2)") +
  theme_bw() + 
  theme(text = element_text(size=20), axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_text(size=15),
        legend.text=element_text(size=15), legend.key.size = unit(3, "cm"), legend.key.height = unit(1, "cm"), legend.key.width = unit(1, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Lý")

plot_df
```

## Hoàng

### Dữ liệu

```{r, warning=FALSE, message=FALSE, lazy=FALSE}
hoang_sff <- dat_sff %>% mutate(prop.hoang=(sum(subset(., Ho=="Hoàng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hoàng")
hoang_plot <- hoang_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.hoang, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
hoang_plot$centroid <- sf::st_transform(hoang_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

hoang <- hoang_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Ban Ria" & NAME_2=="Quang Binh"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.hoang=as.numeric(round(prop.hoang, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.hoang, area_km, songuoi_km, lng, lat, distm_km)

hoang_peak <- hoang_plot %>% filter(NAME_3=="Xa Ban Ria" & NAME_2=="Quang Binh")

datatable(hoang, colnames = c("STT", "Tỉnh/Thành phố", "Quận/Huyện", "Phường/Xã", "Số người", "Dân số", "Tỉ lệ/xã phường", "Tỉ lệ/cả nước", "Diện tích (km2)", "Mật độ (người/km2)", "Kinh độ", "Vĩ độ", "Khoảng cách tới tâm (km)"), extensions = 'Buttons', options = list(
    dom = 'Bfrtip',
    buttons = c('copy', 'csv', 'excel', 'pdf', 'print')
  ))
```

### Phân bố tỉ lệ

```{r, warning=FALSE, message=FALSE, lazy=TRUE}
hoang_sf <- dat_sf %>% mutate(prop.hoang=(sum(subset(., Ho=="Hoàng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hoàng")
hoang_plot <- hoang_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.hoang, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=hoang_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=hoang_peak, mapping = aes(label=NAME_3), color="red", size=3, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=8, label= paste(round(hoang_plot$prop.hoang[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 30)) +
  ggtitle("Hoàng")
```

### Phương trình hàm phân bố tỉ lệ

```{r, message=FALSE, warning=FALSE, lazy=TRUE}
hoang <- dat_sff %>% filter(Ho=="Hoàng") %>% st_as_sf(crs = 4326)
hoang$centroid <- sf::st_transform(hoang, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
hoang <- hoang %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Ban Ria" & NAME_2=="Quang Binh"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

hoang_radius <- hoang %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())

distm_km<-hoang_radius$distm_km
pro.pop<-hoang_radius$pro.pop
rank<-hoang_radius$rank
commune<-hoang_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-86*exp(-(distm_km^2)/(2*100))

library(dplyr)
df<-data.frame(distm_km, rank, commune, estimate, pro.pop)

df <- df %>%
  mutate(num=sum((pro.pop-estimate)^2),
         den=nrow(df)-1,
         var=num/den,
         sd=sqrt(var),
         rank_com=as.numeric(reorder(factor(rank), distm_km)))
  
breaks <- c(0, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200)

plot_df <- df %>%
  filter(row_number()<=1000) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=pro.pop, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=pro.pop), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=pro.pop, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=20)) +
  scale_x_discrete(name = "Xã/Phường", 
                     breaks = reorder(factor(rank), distm_km), 
                     labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Tỉ lệ (%)") +
  theme_bw() + 
  theme(text = element_text(size=20), axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_text(size=15),
        legend.text=element_text(size=15), legend.key.size = unit(3, "cm"), legend.key.height = unit(1, "cm"), legend.key.width = unit(1, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Hoàng")

plot_df
```

### Phân bố mật độ

```{r, lazy=TRUE}
hoang_sff <- dat_sff %>% mutate(prop.hoang=(sum(subset(., Ho=="Hoàng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hoàng")
hoang_plotf <- hoang_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.hoang, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=hoang_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=8, label= paste(round(hoang_plotf$prop.hoang[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 30)) +
  ggtitle("Hoàng")
```

### Phương trình hàm phân bố mật độ

```{r, message=FALSE, warning=FALSE, lazy=TRUE}
hoang <- dat_sff %>% filter(Ho=="Hoàng") %>% st_as_sf(crs = 4326)
hoang$centroid <- sf::st_transform(hoang, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
hoang <- hoang %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Ban Ria" & NAME_2=="Quang Binh"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

hoang_radius <- hoang %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())

distm_km<-hoang_radius$distm_km
songuoi_km<-hoang_radius$songuoi_km
rank<-hoang_radius$rank
commune<-hoang_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-47*exp(-(distm_km^2)/(2*100))

library(dplyr)
df<-data.frame(distm_km, rank, commune, estimate, songuoi_km)

df <- df %>%
  mutate(num=sum((songuoi_km-estimate)^2),
         den=nrow(df)-1,
         var=num/den,
         sd=sqrt(var),
         rank_com=as.numeric(reorder(factor(rank), distm_km)))
  
breaks <- c(0, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200)

plot_df <- df %>%
  filter(row_number()<=1000) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=songuoi_km, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=songuoi_km), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=songuoi_km, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=20)) +
  scale_x_discrete(name = "Xã/Phường", 
                     breaks = reorder(factor(rank), distm_km), 
                     labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Mật độ (người/km2)") +
  theme_bw() + 
  theme(text = element_text(size=20), axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_text(size=15),
        legend.text=element_text(size=15), legend.key.size = unit(3, "cm"), legend.key.height = unit(1, "cm"), legend.key.width = unit(1, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Hoàng")

plot_df
```

## Triệu

### Dữ liệu

```{r, warning=FALSE, message=FALSE, lazy=FALSE}
trieu_sff <- dat_sff %>% mutate(prop.trieu=(sum(subset(., Ho=="Triệu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Triệu")
trieu_plot <- trieu_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.trieu, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
trieu_plot$centroid <- sf::st_transform(trieu_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

trieu <- trieu_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Vinh Tien" & NAME_2=="Trang Dinh"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.trieu=as.numeric(round(prop.trieu, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.trieu, area_km, songuoi_km, lng, lat, distm_km)

trieu_peak <- trieu_plot %>% filter(NAME_3=="Xa Vinh Tien" & NAME_2=="Trang Dinh")

datatable(trieu, colnames = c("STT", "Tỉnh/Thành phố", "Quận/Huyện", "Phường/Xã", "Số người", "Dân số", "Tỉ lệ/xã phường", "Tỉ lệ/cả nước", "Diện tích (km2)", "Mật độ (người/km2)", "Kinh độ", "Vĩ độ", "Khoảng cách tới tâm (km)"), extensions = 'Buttons', options = list(
  dom = 'Bfrtip',
  buttons = c('copy', 'csv', 'excel', 'pdf', 'print')
))
```

### Phân bố tỉ lệ

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
trieu_sf <- dat_sf %>% mutate(prop.trieu=(sum(subset(., Ho=="Triệu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Triệu")
trieu_plot <- trieu_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.trieu, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=trieu_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=trieu_peak, mapping = aes(label=NAME_3), color="red", size=3, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=8, label= paste(round(trieu_plot$prop.trieu[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 30)) +
  ggtitle("Triệu")
```

### Phương trình hàm phân bố tỉ lệ

```{r, message=FALSE, warning=FALSE, lazy=TRUE}
trieu <- dat_sff %>% filter(Ho=="Triệu") %>% st_as_sf(crs = 4326)
trieu$centroid <- sf::st_transform(trieu, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
trieu <- trieu %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Vinh Tien" & NAME_2=="Trang Dinh"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

trieu_radius <- trieu %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())

distm_km<-trieu_radius$distm_km
pro.pop<-trieu_radius$pro.pop
rank<-trieu_radius$rank
commune<-trieu_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-85*exp(-(distm_km^2)/(2*100))

library(dplyr)
df<-data.frame(distm_km, rank, commune, estimate, pro.pop)

df <- df %>%
  mutate(num=sum((pro.pop-estimate)^2),
         den=nrow(df)-1,
         var=num/den,
         sd=sqrt(var),
         rank_com=as.numeric(reorder(factor(rank), distm_km)))

breaks <- c(0, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200)

plot_df <- df %>%
  filter(row_number()<=1000) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=pro.pop, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=pro.pop), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=pro.pop, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=20)) +
  scale_x_discrete(name = "Xã/Phường", 
                   breaks = reorder(factor(rank), distm_km), 
                   labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Tỉ lệ (%)") +
  theme_bw() + 
  theme(text = element_text(size=20), axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_text(size=15),
        legend.text=element_text(size=15), legend.key.size = unit(3, "cm"), legend.key.height = unit(1, "cm"), legend.key.width = unit(1, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Triệu")

plot_df
```

### Phân bố mật độ

```{r, lazy = TRUE}
trieu_sff <- dat_sff %>% mutate(prop.trieu=(sum(subset(., Ho=="Triệu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Triệu")
trieu_plotf <- trieu_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.trieu, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=trieu_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=8, label= paste(round(trieu_plotf$prop.trieu[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 30)) +
  ggtitle("Triệu")
```

### Phương trình hàm phân bố mật độ

```{r, message=FALSE, warning=FALSE, lazy=TRUE}
trieu <- dat_sff %>% filter(Ho=="Triệu") %>% st_as_sf(crs = 4326)
trieu$centroid <- sf::st_transform(trieu, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
trieu <- trieu %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Vinh Tien" & NAME_2=="Trang Dinh"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

trieu_radius <- trieu %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())

distm_km<-trieu_radius$distm_km
songuoi_km<-trieu_radius$songuoi_km
rank<-trieu_radius$rank
commune<-trieu_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-14*exp(-(distm_km^2)/(2*100))

library(dplyr)
df<-data.frame(distm_km, rank, commune, estimate, songuoi_km)

df <- df %>%
  mutate(num=sum((songuoi_km-estimate)^2),
         den=nrow(df)-1,
         var=num/den,
         sd=sqrt(var),
         rank_com=as.numeric(reorder(factor(rank), distm_km)))

breaks <- c(0, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200)

plot_df <- df %>%
  filter(row_number()<=1000) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=songuoi_km, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=songuoi_km), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=songuoi_km, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=20)) +
  scale_x_discrete(name = "Xã/Phường", 
                   breaks = reorder(factor(rank), distm_km), 
                   labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Mật độ (người/km2)") +
  theme_bw() + 
  theme(text = element_text(size=20), axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_text(size=15),
        legend.text=element_text(size=15), legend.key.size = unit(3, "cm"), legend.key.height = unit(1, "cm"), legend.key.width = unit(1, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Triệu")

plot_df
```

## Nguyễn

### Dữ liệu

```{r, warning=FALSE, message=FALSE, lazy = FALSE}
nguyen_sff <- dat_sff %>% mutate(prop.nguyen=(sum(subset(., Ho=="Nguyễn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Nguyễn")
nguyen_plot <- nguyen_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.nguyen, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
nguyen_plot$centroid <- sf::st_transform(nguyen_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

nguyen <- nguyen_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Viet Thong" & NAME_2=="Que Vo"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.nguyen=as.numeric(round(prop.nguyen, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.nguyen, area_km, songuoi_km, lng, lat, distm_km)

nguyen_peak <- nguyen_plot %>% filter(NAME_3=="Xa Viet Thong" & NAME_2=="Que Vo")

datatable(nguyen, colnames = c("STT", "Tỉnh/Thành phố", "Quận/Huyện", "Phường/Xã", "Số người", "Dân số", "Tỉ lệ/xã phường", "Tỉ lệ/cả nước", "Diện tích (km2)", "Mật độ (người/km2)", "Kinh độ", "Vĩ độ", "Khoảng cách tới tâm (km)"), extensions = 'Buttons', options = list(
  dom = 'Bfrtip',
  buttons = c('copy', 'csv', 'excel', 'pdf', 'print')
))

```

### Phân bố tỉ lệ

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
nguyen_sf <- dat_sf %>% mutate(prop.nguyen=(sum(subset(., Ho=="Nguyễn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Nguyễn")
nguyen_plot <- nguyen_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.nguyen, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=nguyen_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=nguyen_peak, mapping = aes(label=NAME_3), color="red", size=3, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=8, label= paste(round(nguyen_plot$prop.nguyen[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 30)) +
  ggtitle("Nguyễn")
```

### Phương trình hàm phân bố tỉ lệ

```{r, message=FALSE, warning=FALSE, lazy=TRUE}
nguyen <- dat_sff %>% filter(Ho=="Nguyễn") %>% st_as_sf(crs = 4326)
nguyen$centroid <- sf::st_transform(nguyen, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
nguyen <- nguyen %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Viet Thong" & NAME_2=="Que Vo"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

nguyen_radius <- nguyen %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())

distm_km<-nguyen_radius$distm_km
pro.pop<-nguyen_radius$pro.pop
rank<-nguyen_radius$rank
commune<-nguyen_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-88*exp(-(distm_km^2)/(2*100))

library(dplyr)
df<-data.frame(distm_km, rank, commune, estimate, pro.pop)

df <- df %>%
  mutate(num=sum((pro.pop-estimate)^2),
         den=nrow(df)-1,
         var=num/den,
         sd=sqrt(var),
         rank_com=as.numeric(reorder(factor(rank), distm_km)))

breaks <- c(0, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200)

plot_df <- df %>%
  filter(row_number()<=1000) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=pro.pop, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=pro.pop), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=pro.pop, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=20)) +
  scale_x_discrete(name = "Xã/Phường", 
                   breaks = reorder(factor(rank), distm_km), 
                   labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Tỉ lệ (%)") +
  theme_bw() + 
  theme(text = element_text(size=20), axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_text(size=15),
        legend.text=element_text(size=15), legend.key.size = unit(3, "cm"), legend.key.height = unit(1, "cm"), legend.key.width = unit(1, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Nguyễn")

plot_df
```

### Phân bố mật độ

```{r, lazy = TRUE}
nguyen_sff <- dat_sff %>% mutate(prop.nguyen=(sum(subset(., Ho=="Nguyễn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Nguyễn")
nguyen_plotf <- nguyen_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.nguyen, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=nguyen_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=8, label= paste(round(nguyen_plotf$prop.nguyen[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 30)) +
  ggtitle("Nguyễn")
```

### Phương trình hàm phân bố mật độ

```{r, message=FALSE, warning=FALSE, lazy=TRUE}
nguyen <- dat_sff %>% filter(Ho=="Nguyễn") %>% st_as_sf(crs = 4326)
nguyen$centroid <- sf::st_transform(nguyen, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
nguyen <- nguyen %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Viet Thong" & NAME_2=="Que Vo"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

nguyen_radius <- nguyen %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())

distm_km<-nguyen_radius$distm_km
songuoi_km<-nguyen_radius$songuoi_km
rank<-nguyen_radius$rank
commune<-nguyen_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-1100*exp(-(distm_km^2)/(2*100))

library(dplyr)
df<-data.frame(distm_km, rank, commune, estimate, songuoi_km)

df <- df %>%
  mutate(num=sum((songuoi_km-estimate)^2),
         den=nrow(df)-1,
         var=num/den,
         sd=sqrt(var),
         rank_com=as.numeric(reorder(factor(rank), distm_km)))

breaks <- c(0, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200)

plot_df <- df %>%
  filter(row_number()<=1000) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=songuoi_km, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=songuoi_km), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=songuoi_km, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=20)) +
  scale_x_discrete(name = "Xã/Phường", 
                   breaks = reorder(factor(rank), distm_km), 
                   labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Mật độ (người/km2)") +
  theme_bw() + 
  theme(text = element_text(size=20), axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_text(size=15),
        legend.text=element_text(size=15), legend.key.size = unit(3, "cm"), legend.key.height = unit(1, "cm"), legend.key.width = unit(1, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Nguyễn")

plot_df
```

## Trần

### Dữ liệu

```{r, warning=FALSE, message=FALSE, lazy = FALSE}
tran_sff <- dat_sff %>% mutate(prop.tran=(sum(subset(., Ho=="Trần")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trần")
tran_plot <- tran_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.tran, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
tran_plot$centroid <- sf::st_transform(tran_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

tran <- tran_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Hoa Hau" & NAME_2=="Ly Nhan"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.tran=as.numeric(round(prop.tran, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.tran, area_km, songuoi_km, lng, lat, distm_km)

tran_peak <- tran_plot %>% filter(NAME_3=="Xa Hoa Hau" & NAME_2=="Ly Nhan")

datatable(tran, colnames = c("STT", "Tỉnh/Thành phố", "Quận/Huyện", "Phường/Xã", "Số người", "Dân số", "Tỉ lệ/xã phường", "Tỉ lệ/cả nước", "Diện tích (km2)", "Mật độ (người/km2)", "Kinh độ", "Vĩ độ", "Khoảng cách tới tâm (km)"), extensions = 'Buttons', options = list(
  dom = 'Bfrtip',
  buttons = c('copy', 'csv', 'excel', 'pdf', 'print')
))

```

### Phân bố tỉ lệ

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
tran_sf <- dat_sf %>% mutate(prop.tran=(sum(subset(., Ho=="Trần")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trần")
tran_plot <- tran_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.tran, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=tran_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=tran_peak, mapping = aes(label=NAME_3), color="red", size=3, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=8, label= paste(round(tran_plot$prop.tran[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 30)) +
  ggtitle("Trần")
```

### Phương trình hàm phân bố tỉ lệ

```{r, message=FALSE, warning=FALSE, lazy=TRUE}
tran <- dat_sff %>% filter(Ho=="Trần") %>% st_as_sf(crs = 4326)
tran$centroid <- sf::st_transform(tran, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
tran <- tran %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Hoa Hau" & NAME_2=="Ly Nhan"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

tran_radius <- tran %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())

distm_km<-tran_radius$distm_km
pro.pop<-tran_radius$pro.pop
rank<-tran_radius$rank
commune<-tran_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-94*exp(-(distm_km^2)/(2*100))

library(dplyr)
df<-data.frame(distm_km, rank, commune, estimate, pro.pop)

df <- df %>%
  mutate(num=sum((pro.pop-estimate)^2),
         den=nrow(df)-1,
         var=num/den,
         sd=sqrt(var),
         rank_com=as.numeric(reorder(factor(rank), distm_km)))

breaks <- c(0, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200)

plot_df <- df %>%
  filter(row_number()<=1000) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=pro.pop, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=pro.pop), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=pro.pop, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=20)) +
  scale_x_discrete(name = "Xã/Phường", 
                   breaks = reorder(factor(rank), distm_km), 
                   labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Tỉ lệ (%)") +
  theme_bw() + 
  theme(text = element_text(size=20), axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_text(size=15),
        legend.text=element_text(size=15), legend.key.size = unit(3, "cm"), legend.key.height = unit(1, "cm"), legend.key.width = unit(1, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Trần")

plot_df
```

### Phân bố mật độ

```{r, lazy = TRUE}
tran_sff <- dat_sff %>% mutate(prop.tran=(sum(subset(., Ho=="Trần")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trần")
tran_plotf <- tran_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.tran, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=tran_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=8, label= paste(round(tran_plotf$prop.tran[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 30)) +
  ggtitle("Trần")
```

### Phương trình hàm phân bố mật độ

```{r, message=FALSE, warning=FALSE, lazy=TRUE}
tran <- dat_sff %>% filter(Ho=="Trần") %>% st_as_sf(crs = 4326)
tran$centroid <- sf::st_transform(tran, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
tran <- tran %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Hoa Hau" & NAME_2=="Ly Nhan"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

tran_radius <- tran %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())

distm_km<-tran_radius$distm_km
songuoi_km<-tran_radius$songuoi_km
rank<-tran_radius$rank
commune<-tran_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-1500*exp(-(distm_km^2)/(2*100))

library(dplyr)
df<-data.frame(distm_km, rank, commune, estimate, songuoi_km)

df <- df %>%
  mutate(num=sum((songuoi_km-estimate)^2),
         den=nrow(df)-1,
         var=num/den,
         sd=sqrt(var),
         rank_com=as.numeric(reorder(factor(rank), distm_km)))

breaks <- c(0, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200)

plot_df <- df %>%
  filter(row_number()<=1000) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=songuoi_km, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=songuoi_km), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=songuoi_km, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=20)) +
  scale_x_discrete(name = "Xã/Phường", 
                   breaks = reorder(factor(rank), distm_km), 
                   labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Mật độ (người/km2)") +
  theme_bw() + 
  theme(text = element_text(size=20), axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_text(size=15),
        legend.text=element_text(size=15), legend.key.size = unit(3, "cm"), legend.key.height = unit(1, "cm"), legend.key.width = unit(1, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Trần")

plot_df
```

## Lê

### Dữ liệu

```{r, warning=FALSE, message=FALSE, lazy = FALSE}
le_sff <- dat_sff %>% mutate(prop.le=(sum(subset(., Ho=="Lê")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lê")
le_plot <- le_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.le, area_km, songuoi_km, geometry) %>% st_as_sf(crs = 4326)
le_plot$centroid <- sf::st_transform(le_plot, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

le <- le_plot %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Hoang Phu" & NAME_2=="Hoang Hoa"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km=round(as.numeric(distm_km), 2),
         lng = map(centroid,1),
         lat = map(centroid,2),
         lng = round(as.numeric(lng), 2),
         lat = round(as.numeric(lat), 2),
         pro.pop=as.numeric(round(pro.pop, 2)),
         prop.le=as.numeric(round(prop.le, 2)),
         area_km=as.numeric(round(area_km, 2)),
         songuoi_km=as.numeric(round(songuoi_km, 2))) %>%
  arrange(distm_km) %>%
  st_drop_geometry() %>%
  select(NAME_1, NAME_2, NAME_3, songuoi, danso, pro.pop, prop.le, area_km, songuoi_km, lng, lat, distm_km)

le_peak <- le_plot %>% filter(NAME_3=="Xa Hoang Phu" & NAME_2=="Hoang Hoa")

datatable(le, colnames = c("STT", "Tỉnh/Thành phố", "Quận/Huyện", "Phường/Xã", "Số người", "Dân số", "Tỉ lệ/xã phường", "Tỉ lệ/cả nước", "Diện tích (km2)", "Mật độ (người/km2)", "Kinh độ", "Vĩ độ", "Khoảng cách tới tâm (km)"), extensions = 'Buttons', options = list(
  dom = 'Bfrtip',
  buttons = c('copy', 'csv', 'excel', 'pdf', 'print')
))

```

### Phân bố tỉ lệ

```{r, warning=FALSE, message=FALSE, lazy = TRUE}
le_sf <- dat_sf %>% mutate(prop.le=(sum(subset(., Ho=="Lê")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lê")
le_plot <- le_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.le, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=le_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="orange") +
  geom_sf_label(data=le_peak, mapping = aes(label=NAME_3), color="red", size=3, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=8, label= paste(round(le_plot$prop.le[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 30)) +
  ggtitle("Lê")
```

### Phương trình hàm phân bố tỉ lệ

```{r, message=FALSE, warning=FALSE, lazy=TRUE}
le <- dat_sff %>% filter(Ho=="Lê") %>% st_as_sf(crs = 4326)
le$centroid <- sf::st_transform(le, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
le <- le %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Hoang Phu" & NAME_2=="Hoang Hoa"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

le_radius <- le %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())

distm_km<-le_radius$distm_km
pro.pop<-le_radius$pro.pop
rank<-le_radius$rank
commune<-le_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-78*exp(-(distm_km^2)/(2*100))

library(dplyr)
df<-data.frame(distm_km, rank, commune, estimate, pro.pop)

df <- df %>%
  mutate(num=sum((pro.pop-estimate)^2),
         den=nrow(df)-1,
         var=num/den,
         sd=sqrt(var),
         rank_com=as.numeric(reorder(factor(rank), distm_km)))

breaks <- c(0, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200)

plot_df <- df %>%
  filter(row_number()<=1000) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=pro.pop, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=pro.pop), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=pro.pop, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=20)) +
  scale_x_discrete(name = "Xã/Phường", 
                   breaks = reorder(factor(rank), distm_km), 
                   labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Tỉ lệ (%)") +
  theme_bw() + 
  theme(text = element_text(size=20), axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_text(size=15),
        legend.text=element_text(size=15), legend.key.size = unit(3, "cm"), legend.key.height = unit(1, "cm"), legend.key.width = unit(1, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Lê")

plot_df
```

### Phân bố mật độ

```{r, lazy = TRUE}
le_sff <- dat_sff %>% mutate(prop.le=(sum(subset(., Ho=="Lê")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lê")
le_plotf <- le_sff %>% select(NAME_1, NAME_2, NAME_3, songuoi_km, prop.le, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=le_plotf, aes(fill=songuoi_km), color=NA) +
  geom_sf(data=river3, col="orange") +
  annotate(geom="text", x=108, y=23, color="red", size=8, label= paste(round(le_plotf$prop.le[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Mật độ (người/km2)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=20), axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), legend.text=element_text(size=15), legend.key.size = unit(1, "cm"), plot.title = element_text(size = 30)) +
  ggtitle("Lê")
```

### Phương trình hàm phân bố mật độ

```{r, message=FALSE, warning=FALSE, lazy=TRUE}
le <- dat_sff %>% filter(Ho=="Lê") %>% st_as_sf(crs = 4326)
le$centroid <- sf::st_transform(le, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
le <- le %>%
  mutate(centroid_0 = centroid[NAME_3=="Xa Hoang Phu" & NAME_2=="Hoang Hoa"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

le_radius <- le %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())

distm_km<-le_radius$distm_km
songuoi_km<-le_radius$songuoi_km
rank<-le_radius$rank
commune<-le_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-750*exp(-(distm_km^2)/(2*100))

library(dplyr)
df<-data.frame(distm_km, rank, commune, estimate, songuoi_km)

df <- df %>%
  mutate(num=sum((songuoi_km-estimate)^2),
         den=nrow(df)-1,
         var=num/den,
         sd=sqrt(var),
         rank_com=as.numeric(reorder(factor(rank), distm_km)))

breaks <- c(0, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200)

plot_df <- df %>%
  filter(row_number()<=1000) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=songuoi_km, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=songuoi_km), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=songuoi_km, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=20)) +
  scale_x_discrete(name = "Xã/Phường", 
                   breaks = reorder(factor(rank), distm_km), 
                   labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Mật độ (người/km2)") +
  theme_bw() + 
  theme(text = element_text(size=20), axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_text(size=15),
        legend.text=element_text(size=15), legend.key.size = unit(3, "cm"), legend.key.height = unit(1, "cm"), legend.key.width = unit(1, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Lê")

plot_df
```

# Bản đồ tỉ lệ % họ tính đến xã

## Họ Nguyễn

```{r}
library(sf)
nguyen_sf <- dat_sf %>% mutate(prop.nguyen=(sum(subset(., Ho=="Nguyễn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Nguyễn")
nguyen_plot <- nguyen_sf %>% select(pro.pop, prop.nguyen, geometry) %>% st_as_sf(crs = 4326)
#colnames(nguyen_plot) <- c("Tỉ lệ % họ trên tổng dân số", "geometry")
#plot(nguyen_plot)
ggplot() + geom_sf() + geom_sf(data=nguyen_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(nguyen_plot$prop.nguyen[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Nguyễn")
#ggsave(filename = file.path("Ho Nguyen-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Nguyen-PerPop.jpeg"), width = 49, height = 33)
```

## Họ Trần

```{r}
tran_sf <- dat_sf %>% mutate(prop.tran=(sum(subset(., Ho=="Trần")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trần")
tran_plot <- tran_sf %>% select(pro.pop, prop.tran, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=tran_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(tran_plot$prop.tran[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Trần")
#ggsave(filename = file.path("Ho Tran-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Tran-PerPop.jpeg"), width = 49, height = 33)
```

## Họ Lã

```{r}
la_sf <- dat_sf %>% mutate(prop.la=(sum(subset(., Ho=="Lã")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lã")
la_plot <- la_sf %>% select(pro.pop, prop.la, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=la_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(la_plot$prop.la[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Lã")
#ggsave(filename = file.path("Ho La-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho La-PerPop.jpeg"), width = 49, height = 33)
```

## Họ Lưu

```{r}
luu_sf <- dat_sf %>% mutate(prop.luu=(sum(subset(., Ho=="Lưu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lưu")
luu_plot <- luu_sf %>% select(pro.pop, prop.luu, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=luu_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(luu_plot$prop.luu[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Lưu")
#ggsave(filename = file.path("Ho Luu-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Luu-PerPop.jpeg"), width = 49, height = 33)
```

## Họ Lương

```{r}
luong_sf <- dat_sf %>% mutate(prop.luong=(sum(subset(., Ho=="Lương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lương")
luong_plot <- luong_sf %>% select(pro.pop, prop.luong, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=luong_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(luong_plot$prop.luong[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Lương")
#ggsave(filename = file.path("Ho Luong-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Luong-PerPop.jpeg"), width = 49, height = 33)
```

## Họ Lê

```{r}
le_sf <- dat_sf %>% mutate(prop.le=(sum(subset(., Ho=="Lê")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lê")
le_plot <- le_sf %>% select(pro.pop, prop.le, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=le_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(le_plot$prop.le[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Lê")
#ggsave(filename = file.path("Ho Le-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Le-PerPop.jpeg"), width = 49, height = 33)
```

## Họ Dư

```{r}
du_sf <- dat_sf %>% mutate(prop.du=(sum(subset(., Ho=="Dư")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Dư")
du_plot <- du_sf %>% select(pro.pop, prop.du, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=du_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(du_plot$prop.du[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Dư")
#ggsave(filename = file.path("Ho Du-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Du-PerPop.jpeg"), width = 49, height = 33)
```
## Họ Dương

```{r}
duong_sf <- dat_sf %>% mutate(prop.duong=(sum(subset(., Ho=="Dương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Dương")
duong_plot <- duong_sf %>% select(pro.pop, prop.duong, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=duong_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(duong_plot$prop.duong[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Dương")
#ggsave(filename = file.path("Ho Duong-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Duong-PerPop.jpeg"), width = 49, height = 33)
```

## Họ Lý

```{r}
ly_sf <- dat_sf %>% mutate(prop.ly=(sum(subset(., Ho=="Lý")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lý")
ly_plot <- ly_sf %>% select(pro.pop, prop.ly, geometry) %>% st_as_sf(crs = 4326)
#colnames(ly_plot) <- c("Tỉ lệ % họ trên tổng dân số", "geometry")
ggplot() + geom_sf() + geom_sf(data=ly_plot, aes(fill=pro.pop), lwd=0) +
  #geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(ly_plot$prop.ly[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Lý")
#ggsave(filename = file.path("Ho Ly-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Ly-PerPop.jpeg"), width = 49, height = 33)
```
## Họ Đoàn

```{r}
doan_sf <- dat_sf %>% mutate(prop.doan=(sum(subset(., Ho=="Đoàn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đoàn")
doan_plot <- doan_sf %>% select(pro.pop, prop.doan, geometry) %>% st_as_sf(crs = 4326)
#colnames(doan_plot) <- c("Tỉ lệ % họ trên tổng dân số", "geometry")
ggplot() + geom_sf(data=doan_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(doan_plot$prop.doan[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Đoàn")
#ggsave(filename = file.path("Ho Doan-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Doan-PerPop.jpeg"), width = 49, height = 33)
```

## Họ Ngô

```{r}
ngo_sf <- dat_sf %>% mutate(prop.ngo=(sum(subset(., Ho=="Ngô")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ngô")
ngo_plot <- ngo_sf %>% select(pro.pop, prop.ngo, geometry) %>% st_as_sf(crs = 4326)
#colnames(doan_plot) <- c("Tỉ lệ % họ trên tổng dân số", "geometry")
ggplot() + geom_sf(data=ngo_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(ngo_plot$prop.ngo[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Ngô")
#ggsave(filename = file.path("Ho Ngo-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Ngo-PerPop.jpeg"), width = 49, height = 33)
```
## Họ Triệu

```{r}
trieu_sf <- dat_sf %>% mutate(prop.trieu=(sum(subset(., Ho=="Triệu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Triệu")
trieu_plot <- trieu_sf %>% select(pro.pop, prop.trieu, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=trieu_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(trieu_plot$prop.trieu[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Triệu")
#ggsave(filename = file.path("Ho Trieu-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Trieu-PerPop.jpeg"), width = 49, height = 33)
```

## Họ Mã

```{r}
ma_sf <- dat_sf %>% mutate(prop.ma=(sum(subset(., Ho=="Mã")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mã")
ma_plot <- ma_sf %>% select(pro.pop, prop.ma, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=ma_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(ma_plot$prop.ma[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Mã")
#ggsave(filename = file.path("Ho Ma-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Ma-PerPop.jpeg"), width = 49, height = 33)
```

## Họ Mạc

```{r}
mac_sf <- dat_sf %>% mutate(prop.mac=(sum(subset(., Ho=="Mạc")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mạc")
mac_plot <- mac_sf %>% select(pro.pop, prop.mac, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=mac_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(mac_plot$prop.mac[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Mạc")
#ggsave(filename = file.path("Ho Mac-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Mac-PerPop.jpeg"), width = 49, height = 33)
```
## Họ Mai

```{r}
mai_sf <- dat_sf %>% mutate(prop.mai=(sum(subset(., Ho=="Mai")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mai")
mai_plot <- mai_sf %>% select(pro.pop, prop.mai, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=mai_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(mai_plot$prop.mai[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Mai")

mai_sf <- dat_sf %>% mutate(prop.mai=(sum(subset(., Ho=="Mai")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mai")
mai_plot <- mai_sf %>% select(NAME_1, NAME_2, NAME_3, pro.pop, prop.mai, geometry) %>% st_as_sf(crs = 4326)
mai_peak <- mai_plot %>% filter(NAME_3=="Thi tran Nga Son")

ggplot() + geom_sf() + geom_sf(data=mai_plot, aes(fill=pro.pop), color=NA) +
  geom_sf(data=river3, col="white") +
  geom_sf_text(data=river3, mapping=aes(label = nam), stat = "sf_coordinates", position = "identity", check_overlap = T) +
  geom_sf_label(data=mai_peak, mapping = aes(label=NAME_3), color="red", size=6, stat = "sf_coordinates", hjust=-0.1, vjust=1, label.size = 0.5) +
  annotate(geom="text", x=108, y=23, color="red", size=15, label= paste(round(mai_plot$prop.mai[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm"), plot.title = element_text(size = 45)) +
  ggtitle("Mai")
#ggsave(filename = file.path("Ho Mai-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Mai-PerPop.png"), width = 33, height = 49)
ggsave(filename = file.path("figures", "General", "Ho Mai-PerPop.jpeg"), width = 33, height = 49)
```

## Họ Phùng

```{r}
phung_sf <- dat_sf %>% mutate(prop.phung=(sum(subset(., Ho=="Phùng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phùng")
phung_plot <- phung_sf %>% select(pro.pop, prop.phung, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=phung_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(phung_plot$prop.phung[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Phùng")
#ggsave(filename = file.path("Ho Phung-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Phung-PerPop.jpeg"), width = 49, height = 33)
```
## Họ Khúc

```{r}
khuc_sf <- dat_sf %>% mutate(prop.khuc=(sum(subset(., Ho=="Khúc")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Khúc")
khuc_plot <- khuc_sf %>% select(pro.pop, prop.khuc, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=khuc_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(khuc_plot$prop.khuc[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Khúc")
#ggsave(filename = file.path("Ho Khuc-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Khuc-PerPop.jpeg"), width = 49, height = 33)
```
## Họ Phạm

```{r}
pham_sf <- dat_sf %>% mutate(prop.pham=(sum(subset(., Ho=="Phạm")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phạm")
pham_plot <- pham_sf %>% select(pro.pop, prop.pham, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=pham_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(pham_plot$prop.pham[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Phạm")
#ggsave(filename = file.path("Ho Pham-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Pham-PerPop.jpeg"), width = 49, height = 33)
```

## Họ Hồ

```{r}
ho_sf <- dat_sf %>% mutate(prop.ho=(sum(subset(., Ho=="Hồ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hồ")
ho_plot <- ho_sf %>% select(pro.pop, prop.ho, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=ho_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(ho_plot$prop.ho[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Hồ")
#ggsave(filename = file.path("Ho Ho-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Ho-PerPop.jpeg"), width = 49, height = 33)
```

## Họ Tôn

```{r}
ton_sf <- dat_sf %>% mutate(prop.ton=(sum(subset(., Ho=="Tôn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Tôn")
ton_plot <- ton_sf %>% select(pro.pop, prop.ton, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=ton_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(ton_plot$prop.ton[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Tôn")
#ggsave(filename = file.path("Ho Ton-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Ton-PerPop.jpeg"), width = 49, height = 33)
```
## Họ Bùi

```{r}
bui_sf <- dat_sf %>% mutate(prop.bui=(sum(subset(., Ho=="Bùi")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Bùi")
bui_plot <- bui_sf %>% select(pro.pop, prop.bui, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=bui_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(bui_plot$prop.bui[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Bùi")
#ggsave(filename = file.path("Ho Bui-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Bui-PerPop.jpeg"), width = 49, height = 33)
```
## Họ Đào

```{r}
dao_sf <- dat_sf %>% mutate(prop.dao=(sum(subset(., Ho=="Đào")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đào")
dao_plot <- dao_sf %>% select(pro.pop, prop.dao, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=dao_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(dao_plot$prop.dao[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Đào")
#ggsave(filename = file.path("Ho Dao-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Dao-PerPop.jpeg"), width = 49, height = 33)
```

## Họ Đinh

```{r}
dinh_sf <- dat_sf %>% mutate(prop.dinh=(sum(subset(., Ho=="Đinh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đinh")
dinh_plot <- dinh_sf %>% select(pro.pop, prop.dinh, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=dinh_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(dinh_plot$prop.dinh[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Đinh")
#ggsave(filename = file.path("Ho Dinh-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Dinh-PerPop.jpeg"), width = 49, height = 33)
```
## Họ Đỗ

```{r}
do_sf <- dat_sf %>% mutate(prop.do=(sum(subset(., Ho=="Đỗ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đỗ")
do_plot <- do_sf %>% select(pro.pop, prop.do, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=do_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(do_plot$prop.do[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Đỗ")
#ggsave(filename = file.path("Ho Do-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Do-PerPop.jpeg"), width = 49, height = 33)
```
## Họ Hoàng

```{r}
hoang_sf <- dat_sf %>% mutate(prop.hoang=(sum(subset(., Ho=="Hoàng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hoàng")
hoang_plot <- hoang_sf %>% select(pro.pop, prop.hoang, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=hoang_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(hoang_plot$prop.hoang[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Hoàng")
#ggsave(filename = file.path("Ho Hoang-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Hoang-PerPop.jpeg"), width = 49, height = 33)
```
## Họ Huỳnh

```{r}
huynh_sf <- dat_sf %>% mutate(prop.huynh=(sum(subset(., Ho=="Huỳnh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Huỳnh")
huynh_plot <- huynh_sf %>% select(pro.pop, prop.huynh, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=huynh_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(huynh_plot$prop.huynh[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Huỳnh")
#ggsave(filename = file.path("Ho Huynh-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Huynh-PerPop.jpeg"), width = 49, height = 33)
```

## Họ Phan

```{r}
phan_sf <- dat_sf %>% mutate(prop.phan=(sum(subset(., Ho=="Phan")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phan")
phan_plot <- phan_sf %>% select(pro.pop, prop.phan, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=phan_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(phan_plot$prop.phan[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Phan")
#ggsave(filename = file.path("Ho Phan-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Phan-PerPop.jpeg"), width = 49, height = 33)
```

## Họ Quách

```{r}
quach_sf <- dat_sf %>% mutate(prop.quach=(sum(subset(., Ho=="Quách")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Quách")
quach_plot <- quach_sf %>% select(pro.pop, prop.quach, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=quach_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(quach_plot$prop.quach[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Quách")
#ggsave(filename = file.path("Ho Quach-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Quach-PerPop.jpeg"), width = 49, height = 33)
```

## Họ Trịnh

```{r}
trinh_sf <- dat_sf %>% mutate(prop.trinh=(sum(subset(., Ho=="Trịnh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trịnh")
trinh_plot <- trinh_sf %>% select(pro.pop, prop.trinh, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=trinh_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(trinh_plot$prop.trinh[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Trịnh")
#ggsave(filename = file.path("Ho Trinh-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Trinh-PerPop.jpeg"), width = 49, height = 33)
```

## Họ Trương

```{r}
truong_sf <- dat_sf %>% mutate(prop.truong=(sum(subset(., Ho=="Trương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trương")
truong_plot <- truong_sf %>% select(pro.pop, prop.truong, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=truong_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(truong_plot$prop.truong[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Trương")
#ggsave(filename = file.path("Ho Truong-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Truong-PerPop.jpeg"), width = 49, height = 33)
```

## Họ Vũ

```{r}
vu_sf <- dat_sf %>% mutate(prop.vu=(sum(subset(., Ho=="Vũ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Vũ")
vu_plot <- vu_sf %>% select(pro.pop, prop.vu, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=vu_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(vu_plot$prop.vu[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Vũ")
#ggsave(filename = file.path("Ho Vu-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Vu-PerPop.jpeg"), width = 49, height = 33)
```
## Họ Võ

```{r}
vo_sf <- dat_sf %>% mutate(prop.vo=(sum(subset(., Ho=="Võ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Võ")
vo_plot <- vo_sf %>% select(pro.pop, prop.vo, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=vo_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(vo_plot$prop.vo[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Võ")
#ggsave(filename = file.path("Ho Vo-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Vo-PerPop.jpeg"), width = 49, height = 33)
```

# Bản đồ mật độ họ trên diện tích tính đến xã

## Họ Nguyễn

```{r}
library(sf)
nguyen_sff <- dat_sff %>% mutate(prop.nguyen=(sum(subset(., Ho=="Nguyễn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Nguyễn")
nguyen_plotf <- nguyen_sff %>% select(songuoi_km, prop.nguyen, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=nguyen_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(nguyen_plotf$prop.nguyen[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Nguyễn")
#ggsave(filename = file.path("Ho Nguyen-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Nguyen-PerArea.jpeg"), width = 49, height = 33)
```

## Họ Trần

```{r}
tran_sff <- dat_sff %>% mutate(prop.tran=(sum(subset(., Ho=="Trần")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trần")
tran_plotf <- tran_sff %>% select(songuoi_km, prop.tran, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=tran_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(tran_plot$prop.tran[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Trần")
#ggsave(filename = file.path("Ho Tran-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Tran-PerArea.jpeg"), width = 49, height = 33)
```

## Họ Lã

```{r}
la_sff <- dat_sff %>% mutate(prop.la=(sum(subset(., Ho=="Lã")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lã")
la_plotf <- la_sff %>% select(songuoi_km, prop.la, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=la_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(la_plot$prop.la[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Lã")
#ggsave(filename = file.path("Ho La-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho La-PerArea.jpeg"), width = 49, height = 33)
```

## Họ Lê

```{r}
le_sff <- dat_sff %>% mutate(prop.le=(sum(subset(., Ho=="Lê")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lê")
le_plotf <- le_sff %>% select(songuoi_km, prop.le, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=le_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(le_plot$prop.le[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Lê")
#ggsave(filename = file.path("Ho Le-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Le-PerArea.jpeg"), width = 49, height = 33)
```

## Họ Lưu

```{r}
luu_sff <- dat_sff %>% mutate(prop.luu=(sum(subset(., Ho=="Lưu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lưu")
luu_plotf <- luu_sff %>% select(songuoi_km, prop.luu, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=luu_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(luu_plot$prop.luu[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Lưu")
#ggsave(filename = file.path("Ho Luu-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Luu-PerArea.jpeg"), width = 49, height = 33)
```

## Họ Lương

```{r}
luong_sff <- dat_sff %>% mutate(prop.luong=(sum(subset(., Ho=="Lương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lương")
luong_plotf <- luong_sff %>% select(songuoi_km, prop.luong, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=luong_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(luong_plot$prop.luong[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Lương")
#ggsave(filename = file.path("Ho Luong-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Luong-PerArea.jpeg"), width = 49, height = 33)
```

## Họ Dư

```{r}
du_sff <- dat_sff %>% mutate(prop.du=(sum(subset(., Ho=="Dư")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Dư")
du_plotf <- du_sff %>% select(songuoi_km, prop.du, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=du_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(du_plot$prop.du[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Dư")
#ggsave(filename = file.path("Ho Du-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Du-PerArea.jpeg"), width = 49, height = 33)
```
## Họ Dương

```{r}
duong_sff <- dat_sff %>% mutate(prop.duong=(sum(subset(., Ho=="Dương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Dương")
duong_plotf <- duong_sff %>% select(songuoi_km, prop.duong, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=duong_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(duong_plot$prop.duong[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Dương")
#ggsave(filename = file.path("Ho Duong-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Duong-PerArea.jpeg"), width = 49, height = 33)
```

## Họ Lý

```{r}
ly_sff <- dat_sff %>% mutate(prop.ly=(sum(subset(., Ho=="Lý")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lý")
ly_plotf <- ly_sff %>% select(songuoi_km, prop.ly, geometry) %>% st_as_sf(crs = 4326)
#colnames(ly_plot) <- c("Tỉ lệ % họ trên tổng dân số", "geometry")
ggplot() + geom_sf() + geom_sf(data=ly_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(ly_plot$prop.ly[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Lý")
#ggsave(filename = file.path("Ho Ly-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Ly-PerArea.jpeg"), width = 49, height = 33)
```
## Họ Đoàn

```{r}
doan_sff <- dat_sff %>% mutate(prop.doan=(sum(subset(., Ho=="Đoàn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đoàn")
doan_plotf <- doan_sff %>% select(songuoi_km, prop.doan, geometry) %>% st_as_sf(crs = 4326)
#colnames(doan_plot) <- c("Tỉ lệ % họ trên tổng dân số", "geometry")
ggplot() + geom_sf(data=doan_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(doan_plot$prop.doan[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Đoàn")
#ggsave(filename = file.path("Ho Doan-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Doan-PerArea.jpeg"), width = 49, height = 33)
```

## Họ Ngô

```{r}
ngo_sff <- dat_sff %>% mutate(prop.ngo=(sum(subset(., Ho=="Ngô")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ngô")
ngo_plotf <- ngo_sff %>% select(songuoi_km, prop.ngo, geometry) %>% st_as_sf(crs = 4326)
#colnames(doan_plot) <- c("Tỉ lệ % họ trên tổng dân số", "geometry")
ggplot() + geom_sf(data=ngo_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(ngo_plot$prop.ngo[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Ngô")
#ggsave(filename = file.path("Ho Ngo-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Ngo-PerArea.jpeg"), width = 49, height = 33)
```
## Họ Triệu

```{r}
trieu_sff <- dat_sff %>% mutate(prop.trieu=(sum(subset(., Ho=="Triệu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Triệu")
trieu_plotf <- trieu_sff %>% select(songuoi_km, prop.trieu, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=trieu_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(trieu_plot$prop.trieu[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Triệu")
#ggsave(filename = file.path("Ho Trieu-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Trieu-PerArea.jpeg"), width = 49, height = 33)
```

## Họ Mã

```{r}
ma_sff <- dat_sff %>% mutate(prop.ma=(sum(subset(., Ho=="Mã")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mã")
ma_plotf <- ma_sff %>% select(songuoi_km, prop.ma, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=ma_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(ma_plot$prop.ma[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Mã")
#ggsave(filename = file.path("Ho Ma-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Ma-PerArea.jpeg"), width = 49, height = 33)
```

## Họ Mạc

```{r}
mac_sff <- dat_sff %>% mutate(prop.mac=(sum(subset(., Ho=="Mạc")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mạc")
mac_plotf <- mac_sff %>% select(songuoi_km, prop.mac, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=mac_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(mac_plot$prop.mac[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Mạc")
#ggsave(filename = file.path("Ho Mac-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Mac-PerArea.jpeg"), width = 49, height = 33)
```

## Họ Mai

```{r}
mai_sff <- dat_sff %>% mutate(prop.mai=(sum(subset(., Ho=="Mai")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mai")
mai_plotf <- mai_sff %>% select(songuoi_km, prop.mai, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=mai_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(mai_plot$prop.mai[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Mai")
#ggsave(filename = file.path("Ho Mai-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Mai-PerArea.jpeg"), width = 49, height = 33)
```

## Họ Phùng

```{r}
phung_sff <- dat_sff %>% mutate(prop.phung=(sum(subset(., Ho=="Phùng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phùng")
phung_plotf <- phung_sff %>% select(songuoi_km, prop.phung, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=phung_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(phung_plot$prop.phung[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Phùng")
#ggsave(filename = file.path("Ho Phung-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Phung-PerArea.jpeg"), width = 49, height = 33)
```
## Họ Khúc

```{r}
khuc_sff <- dat_sff %>% mutate(prop.khuc=(sum(subset(., Ho=="Khúc")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Khúc")
khuc_plotf <- khuc_sff %>% select(songuoi_km, prop.khuc, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=khuc_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(khuc_plot$prop.khuc[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Khúc")
#ggsave(filename = file.path("Ho Khuc-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Khuc-PerArea.jpeg"), width = 49, height = 33)
```
## Họ Phạm

```{r}
pham_sff <- dat_sff %>% mutate(prop.pham=(sum(subset(., Ho=="Phạm")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phạm")
pham_plotf <- pham_sff %>% select(songuoi_km, prop.pham, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=pham_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(pham_plot$prop.pham[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Phạm")
#ggsave(filename = file.path("Ho Pham-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Pham-PerArea.jpeg"), width = 49, height = 33)
```

## Họ Hồ

```{r}
ho_sff <- dat_sff %>% mutate(prop.ho=(sum(subset(., Ho=="Hồ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hồ")
ho_plotf <- ho_sff %>% select(songuoi_km, prop.ho, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=ho_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(ho_plotf$prop.ho[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Hồ")
#ggsave(filename = file.path("Ho Ho-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Ho-PerArea.jpeg"), width = 49, height = 33)
```

## Họ Tôn

```{r}
ton_sff <- dat_sff %>% mutate(prop.ton=(sum(subset(., Ho=="Tôn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Tôn")
ton_plotf <- ton_sff %>% select(songuoi_km, prop.ton, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=ton_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(ton_plotf$prop.ton[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Tôn")
#ggsave(filename = file.path("Ho Ton-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Ton-PerArea.jpeg"), width = 49, height = 33)
```

## Họ Bùi

```{r}
bui_sff <- dat_sff %>% mutate(prop.bui=(sum(subset(., Ho=="Bùi")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Bùi")
bui_plotf <- bui_sff %>% select(songuoi_km, prop.bui, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=bui_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(bui_plotf$prop.bui[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Bùi")
#ggsave(filename = file.path("Ho Bui-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Bui-PerArea.jpeg"), width = 49, height = 33)
```
## Họ Đào

```{r}
dao_sff <- dat_sff %>% mutate(prop.dao=(sum(subset(., Ho=="Đào")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đào")
dao_plotf <- dao_sff %>% select(songuoi_km, prop.dao, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=dao_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(dao_plotf$prop.dao[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Đào")
#ggsave(filename = file.path("Ho Dao-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Dao-PerArea.jpeg"), width = 49, height = 33)
```

## Họ Đinh

```{r}
dinh_sff <- dat_sff %>% mutate(prop.dinh=(sum(subset(., Ho=="Đinh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đinh")
dinh_plotf <- dinh_sff %>% select(songuoi_km, prop.dinh, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=dinh_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(dinh_plotf$prop.dinh[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Đinh")
#ggsave(filename = file.path("Ho Dinh-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Dinh-PerArea.jpeg"), width = 49, height = 33)
```
## Họ Đỗ

```{r}
do_sff <- dat_sff %>% mutate(prop.do=(sum(subset(., Ho=="Đỗ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đỗ")
do_plotf <- do_sff %>% select(songuoi_km, prop.do, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=do_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(do_plotf$prop.do[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Đỗ")
#ggsave(filename = file.path("Ho Do-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Do-PerArea.jpeg"), width = 49, height = 33)
```
## Họ Hoàng

```{r}
hoang_sff <- dat_sff %>% mutate(prop.hoang=(sum(subset(., Ho=="Hoàng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hoàng")
hoang_plotf <- hoang_sff %>% select(songuoi_km, prop.hoang, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=hoang_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(hoang_plotf$prop.hoang[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Hoàng")
#ggsave(filename = file.path("Ho Hoang-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Hoang-PerArea.jpeg"), width = 49, height = 33)
```
## Họ Huỳnh

```{r}
huynh_sff <- dat_sff %>% mutate(prop.huynh=(sum(subset(., Ho=="Huỳnh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Huỳnh")
huynh_plotf <- huynh_sff %>% select(songuoi_km, prop.huynh, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=huynh_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(huynh_plotf$prop.huynh[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Huỳnh")
#ggsave(filename = file.path("Ho Huynh-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Huynh-PerArea.jpeg"), width = 49, height = 33)
```
## Họ Phan

```{r}
phan_sff <- dat_sff %>% mutate(prop.phan=(sum(subset(., Ho=="Phan")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phan")
phan_plotf <- phan_sff %>% select(songuoi_km, prop.phan, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=phan_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(phan_plotf$prop.phan[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Phan")
#ggsave(filename = file.path("Ho Phan-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Phan-PerArea.jpeg"), width = 49, height = 33)
```

## Họ Quách

```{r}
quach_sff <- dat_sff %>% mutate(prop.quach=(sum(subset(., Ho=="Quách")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Quách")
quach_plotf <- quach_sff %>% select(songuoi_km, prop.quach, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=quach_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(quach_plotf$prop.quach[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Quách")
#ggsave(filename = file.path("Ho Quach-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Quach-PerArea.jpeg"), width = 49, height = 33)
```

## Họ Trịnh

```{r}
trinh_sff <- dat_sff %>% mutate(prop.trinh=(sum(subset(., Ho=="Trịnh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trịnh")
trinh_plotf <- trinh_sff %>% select(songuoi_km, prop.trinh, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=trinh_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(trinh_plotf$prop.trinh[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Trịnh")
#ggsave(filename = file.path("Ho Trinh-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Trinh-PerArea.jpeg"), width = 49, height = 33)
```
## Họ Trương

```{r}
truong_sff <- dat_sff %>% mutate(prop.truong=(sum(subset(., Ho=="Trương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trương")
truong_plotf <- truong_sff %>% select(songuoi_km, prop.truong, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=truong_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(truong_plotf$prop.truong[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Trương")
#ggsave(filename = file.path("Ho Truong-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Truong-PerArea.jpeg"), width = 49, height = 33)
```

## Họ Vũ

```{r}
vu_sff <- dat_sff %>% mutate(prop.vu=(sum(subset(., Ho=="Vũ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Vũ")
vu_plotf <- vu_sff %>% select(songuoi_km, prop.vu, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=vu_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(vu_plotf$prop.vu[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Vũ")
#ggsave(filename = file.path("Ho Vu-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Vu-PerArea.jpeg"), width = 49, height = 33)
```
## Họ Võ

```{r}
vo_sff <- dat_sff %>% mutate(prop.vo=(sum(subset(., Ho=="Võ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Võ")
vo_plotf <- vo_sff %>% select(songuoi_km, prop.vo, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=vo_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(vo_plotf$prop.vo[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Võ")
#ggsave(filename = file.path("Ho Vo-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Vo-PerArea.jpeg"), width = 49, height = 33)
```

# Phương trình hàm phân bố từng họ

```{r}
dat_sff_st <- dat_sff %>% st_as_sf(crs = 4326)
dat_sff_st$centroid <- sf::st_transform(dat_sff_st, 2154) %>%
  st_centroid() %>%
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

dat_st <- dat_sff_st %>%
  mutate(lng = map(centroid,1),
         lat = map(centroid,2),
         lng = as.numeric(lng),
         lat = as.numeric(lat)) %>%
  st_drop_geometry() %>%
  select(-c("MAXA", "MAHUYEN", "MATINH", "TYPE_3", "area", "centroid"))

ho <- data_ho_overall %>%
  arrange(desc(songuoi)) %>%
  mutate(pro.pop=(songuoi/sum(songuoi)*100))
ho <- head(ho, n=200)

dat_st <- dat_st %>% filter(Ho %in% ho$Ho)
dat_st$area_km = as.numeric(dat_st$area_km)
```

## Họ Mai

```{r, message=FALSE, warning=FALSE}
mai <- dat_sff %>% filter(Ho=="Mai") %>% st_as_sf(crs = 4326)
mai$centroid <- sf::st_transform(mai, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
mai <- mai %>%
  mutate(centroid_0 = centroid[NAME_3=="Thi tran Nga Son"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

mai_radius <- mai %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())

distm_km<-mai_radius$distm_km
pro.pop<-mai_radius$pro.pop
rank<-mai_radius$rank
commune<-mai_radius$NAME_3
rank<-factor(rank, labels = commune)
estimate<-35*exp(-(distm_km^2)/(2*100))

library(dplyr)

df <- data.frame(distm_km, rank, commune, estimate, pro.pop)

df <- df %>%
  mutate(num=sum((pro.pop-estimate)^2),
         den=nrow(df)-1,
         var=num/den,
         sd=sqrt(var),
         rank_com=as.numeric(rank))
  
breaks <- c(0, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200)

plot_df <- df %>%
  filter(row_number()<=1000) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=pro.pop, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=pro.pop), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=pro.pop, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=20)) +
  scale_x_discrete(name = "Xã/Phường", 
                     breaks = reorder(factor(rank), distm_km), 
                     labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Tỉ lệ (%)") +
  theme_bw() + 
  theme(text = element_text(size=45), axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_text(size=30),
        legend.text=element_text(size=30), legend.key.size = unit(6, "cm"), legend.key.height = unit(3, "cm"), legend.key.width = unit(5, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Mai")

plot_df
# ggsave(filename = file.path("figures", "General", "Mai-Density-2(2).jpeg"), width = 25, height = 16)
```

```{r}
library(gam)
df<-df %>% filter(row_number()<=1000)
gam = gam(pro.pop ~ s(as.numeric(reorder(factor(rank), distm_km)), 20), data = df)
plot(gam, se = TRUE, col = "green")
summary(gam)
```

```{r}
mod=lm(pro.pop ~ rank_com + poly(rank_com, 20), data=df)
summary(mod)
df <- df %>% mutate(pred=predict(mod))
ggplot(df, aes(x=rank_com, y=pred)) +
  geom_point(shape=".") +
  geom_smooth(colour="black",size=0.5) +
  theme_bw() + 
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())
```

```{r}
# Function to convert an EPSG code from meters to kilometers
epsgKM <- function(x) {
  crs <- st_crs(x)
  proj4KM <- gsub(pattern = "+.units=m", replacement = "+units=km", 
                  crs$proj4string)
  return(proj4KM)
}

# Envelope for variogram
variog_envelope <- function (geodata, coords = geodata$coords, data = geodata$data, 
                             obj.variog, nsim = 99, save.sim = FALSE, messages) 
{
  call.fc <- match.call()
  if (missing(geodata)) 
    geodata <- list(coords = coords, data = data)
  if (missing(messages)) 
    messages.screen <- as.logical(ifelse(is.null(getOption("geoR.messages")), 
                                         TRUE, getOption("geoR.messages")))
  else messages.screen <- messages
  obj.variog$v <- NULL
  if ((is.matrix(data) | is.data.frame(data))) 
    if (ncol(data) > 1) 
      stop("envelops can be computed for only one data set at once")
  if (!is.null(obj.variog$estimator.type)) 
    estimator.type <- obj.variog$estimator.type
  else estimator.type <- "classical"
  if (abs(obj.variog$lambda - 1) > 1e-04) {
    if (abs(obj.variog$lambda) < 1e-04) 
      data <- log(data)
    else data <- ((data^obj.variog$lambda) - 1)/obj.variog$lambda
  }
  xmat <- unclass(trend.spatial(trend = obj.variog$trend, geodata = geodata))
  if (obj.variog$trend != "cte") {
    if (is.vector(data)) {
      data <- lm(data ~ xmat + 0)$residuals
      names(data) <- NULL
    }
    else {
      only.res <- function(y, x) {
        lm(y ~ xmat + 0)$residuals
      }
      data <- apply(data, 2, only.res, x = xmat)
    }
  }
  if (messages.screen) 
    cat(paste("variog.env: generating", nsim, "simulations by permutating data values\n"))
  simula <- list(coords = coords)
  n.data <- length(data)
  perm.f <- function(i, data, n.data) {
    return(data[sample(1:n.data)])
  }
  simula$data <- apply(as.matrix(1:nsim), 1, perm.f, data = data, 
                       n.data = n.data)
  if (messages.screen) 
    cat(paste("variog.env: computing the empirical variogram for the", 
              nsim, "simulations\n"))
  nbins <- length(obj.variog$bins.lim) - 1
  if (obj.variog$direction == "omnidirectional") {
    bin.f <- function(sim) {
      cbin <- vbin <- sdbin <- rep(0, nbins)
      temp <- .C("binit", as.integer(obj.variog$n.data), 
                 as.double(as.vector(coords[, 1])), as.double(as.vector(coords[, 
                                                                               2])), as.double(as.vector(sim)), as.integer(nbins), 
                 as.double(as.vector(obj.variog$bins.lim)), as.integer(estimator.type == 
                                                                         "modulus"), as.double(max(obj.variog$u)), as.double(cbin), 
                 vbin = as.double(vbin), as.integer(FALSE), as.double(sdbin), 
                 PACKAGE = "geoR")$vbin
      return(temp)
    }
    simula.bins <- apply(simula$data, 2, bin.f)
  }
  else {
    variog.vbin <- function(x, ...) {
      variog(geodata = geodata, 
             data = x, uvec = obj.variog$uvec, estimator.type = obj.variog$estimator.type, 
             nugget.tolerance = obj.variog$nugget.tolerance, max.dist = obj.variog$max.dist, 
             pairs.min = obj.variog$pairs.min, direction = obj.variog$direction, 
             tolerance = obj.variog$tolerance, messages.screen = FALSE,...)$v
    }
    simula.bins <- apply(simula$data, 2, variog.vbin)
  }
  simula.bins <- simula.bins[obj.variog$ind.bin, ]
  if (save.sim == FALSE) 
    simula$data <- NULL
  if (messages.screen) 
    cat("variog.env: computing the envelops\n")
  limits <- apply(simula.bins, 1, quantile, prob = c(0.025, 0.975))
  res.env <- list(u = obj.variog$u, v.lower = limits[1, ], 
                  v.upper = limits[2, ])
  if (save.sim) 
    res.env$simulations <- simula$data
  res.env$call <- call.fc
  oldClass(res.env) <- "variogram.envelope"
  return(res.env)
}
# Calculate and plot the variogram
ggvario <- function(coords, 
                    data, 
                    bins = 15, 
                    maxdist = max(dist(coords))/3, 
                    uvec = NULL, 
                    nsim = 999,
                    color = "royalblue1", 
                    xlab = "distance", 
                    show_nbins = F, envelop=FALSE, cov.model="matern", fix.kappa=T) {
  require(geoR)
  res <- list()
  coords <- as.matrix(coords)
  min_dist <- min(dist(coords))
  if(is.null(uvec)) uvec <- seq(min_dist, maxdist, l = bins)
  empvario <- variog(coords = coords, data = data, uvec = uvec, messages = F)
  if(envelop ==FALSE){
    
    ### plot variogram alone 
    
    dfvario <- data.frame(distance = empvario$u, empirical = empvario$v,
                          nbinns = empvario$n)
    p1 <- ggplot(dfvario, aes(y = empirical, x = distance, label = nbinns)) +
      geom_point(col = "black", fill = color, shape = 21, size = 3) +
      scale_x_continuous(name = xlab, limits = c(0, uvec[length(uvec)]),
                         breaks = round(seq(0, uvec[length(uvec)], l = 6))) +
      scale_y_continuous(name = "semivariance",
                         #breaks = round(seq(0, max(dfvario$upemp, dfvario$empirical), l = 6), 1),
                         limits = c(0,  max(dfvario$empirical))) +
      ggtitle("Empirical semivariogram") 
    # theme_classic()
    p2 <- p1 + geom_text(vjust = 1, nudge_y = - diff(range(dfvario$empirical)) / 22)
    if(show_nbins){
      res[["pl"]] <- p2 
    } else {
      res[["pl"]] <- p1
    }
  } else if (envelop == TRUE){
    ### plot the Monte Carlo envelope and variogram
    
    envmc <- variog_envelope(coords = coords, data = data, 
                             obj.variog = empvario, nsim = nsim, messages = F)
    dfvario <- data.frame(distance = empvario$u, empirical = empvario$v,
                          lowemp = envmc$v.lower, upemp = envmc$v.upper, 
                          nbins = empvario$n)
    p1 <- ggplot(dfvario, aes(y = empirical, x = distance, label = nbins)) +
      geom_ribbon(aes(ymin = lowemp, ymax = upemp), fill = color, alpha = .3) +
      geom_point(aes(y = empirical), col = "black", fill = color, shape = 21, size = 3) +
      scale_x_continuous(name = xlab, limits = c(0, uvec[length(uvec)]),
                         breaks = round(seq(0, uvec[length(uvec)], l = 6))) +
      scale_y_continuous(name = "semivariance", 
                         #breaks = round(seq(0, max(dfvario$upemp, dfvario$empirical), l = 6), 1), 
                         limits = c(0, max(dfvario$upemp, dfvario$empirical))) +
      ggtitle("Empirical semivariogram") 
    # theme_classic()
    p2 <- p1 + geom_text(vjust = 1, nudge_y = - diff(range(dfvario$empirical)) / 22)
    if(show_nbins){
      res[["pl"]] <- p2 
    } else {
      res[["pl"]] <- p1
    }
  }
  res
}
```

```{r}
library(sf)
library(rgeos)
library(rgdal)
library(tmap)
library(dplyr)
library(geoR)
library(ggplot2)

# Plot the histogram of the lead concentration
df <- df %>% mutate(pro.pop=as.numeric(pro.pop))
hist(df$pro.pop)

## map the songuoi_km
tm_shape(mai) + tm_symbols(col="pro.pop", midpoint = NA)  

## scatter plot of the log of the lead concentration and pm10
ggplot(df, aes(x = rank, y = pro.pop)) + geom_point()

# put a smooth line on it 
ggplot(df, aes(x =rank, y = pro.pop)) + geom_point() + geom_smooth()

## scatter plot of the log of the lead concentration and all the other variables
ggplot( df %>% gather(key, value, -loglead, -lead), 
        aes(x = value, y = loglead)) + geom_point() + 
  facet_wrap(facets = ~key, scales = "free") + geom_smooth()


########## Section 3
### construct a variogram

# First thing to note is that the variogram is constructed on the residual. 
# So fit a linear model to the loglead and extract the residual

fit <- lm(formula = pro.pop~ rank, data = df)
resi <- residuals(fit)

ggvario(coords = df[, c("long", "lat")], data = resi, bins = 15, 
        show_nbins = F, envelope = F)

# Note that we set envelop to FALSE to have just the variogram

# note that the distance is still in degrees, so we need to convert the long and lat to meters

## convert the gps coordinate to web mercator ############
utmcoords <- mai %>% st_transform(., crs= 4326) %>% st_coordinates()
# note that 3857 is the code for the projection to Web Mercator 

#### now construct the variogram again in kilometers
ggvario(coords = utmcoords/1000, data = resi, bins = 15, show_nbins = F)


##### Now to perform the permutation test ###########
# We will add  the envelop and nsim argument
ggvario(coords = utmcoords/1000, data = resi, bins = 15, show_nbins = F, envelop = TRUE, nsim = 999)
```
