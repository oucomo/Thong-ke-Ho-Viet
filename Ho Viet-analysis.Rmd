---
title: "Ho Viet"
author: "Duc Du"
date: '`r format(Sys.time(), "%d %B, %Y")`'
output: html_document
---

```{r setup, include=FALSE}
rm(list = ls(all.names = TRUE))
knitr::opts_chunk$set(echo = FALSE, 
                      cache=TRUE,
                      tidy.opts=list(width.cutoff=60),
                      tidy=TRUE)
#library(rmarkdown)
#library(knitr)
library(markdown)
library(stringr)
library(forcats)
library(RColorBrewer)
library(tidyverse)
library(dplyr)
library(ggplot2)
library(Hmisc)
library(gtsummary)
#library(flextable)
library(huxtable)
library(data.table)
library(lubridate)
library(stringi)
library(forcats)
library(ggpubr)
library(rstatix)
#library(dlookr)
#library(flextable)
library(haven)
library(raster)
library(rgdal)
library(viridis)
library(sf)

select<-dplyr::select
filter<-dplyr::filter
recode<-dplyr::recode
getData<-raster::getData

# rotate function (see here: https://r-spatial.github.io/sf/articles/sf3.html#affine-transformations
rot <- function(a) matrix(c(cos(a), sin(a), -sin(a), cos(a)), 2, 2)

options(scipen=999, digits = 3)
options(max.print=1000000)
```

# Load data

```{r load data2}
load("data/hoviet.RData")
```

# Top Họ cả nước

```{r}
data_ho_top1000 <- data_ho_overall %>%
  arrange(desc(songuoi))
data_ho_top1000 <- head(data_ho_top1000, n=1000)

data_ho_top500 <- data_ho_overall %>%
  arrange(desc(songuoi))
data_ho_top500 <- head(data_ho_top500, n=500)

data_ho_top200 <- data_ho_overall %>%
  arrange(desc(songuoi))
data_ho_top200 <- head(data_ho_top200, n=200) %>%
  mutate(rank = dense_rank(desc(songuoi)),
         group=NA,
         group=ifelse(rank %in% c(1:50), 1, ifelse(rank %in% c(51:100), 2, ifelse(rank %in% c(101:150), 3, ifelse(rank %in% c(151:200), 4, group)))),
         group=factor(group, levels = c(1,2,3,4), labels = c("1-50","51-100","101-150","151-200")))

data_ho_top150 <- data_ho_overall %>%
  arrange(desc(songuoi))
data_ho_top150 <- data_ho_top150 %>% slice(101:150)

data_ho_top100 <- data_ho_overall %>%
  arrange(desc(songuoi))
data_ho_top100 <- data_ho_top100 %>% slice(51:100)

data_ho_top50 <- data_ho_overall %>%
  arrange(desc(songuoi))
data_ho_top50 <- head(data_ho_top50, n=50)

data_ho_top20 <- data_ho_overall %>%
  arrange(desc(songuoi))
data_ho_top20 <- head(data_ho_top20, n=20)

data_ho_top10 <- data_ho_overall %>%
  arrange(desc(songuoi))
data_ho_top10 <- head(data_ho_top10, n=10)
```

```{r}
ggplot(data = data_ho_top50, aes(x = reorder(Ho, songuoi, decreasing=F), y =songuoi)) +
  geom_bar(stat = "identity", fill="red", width = 0.75) +
  #geom_text(aes(label = songuoi, y = songuoi + 50), size = 3) +
  scale_x_discrete(name = NULL) +
  scale_y_continuous(name = NULL, breaks = seq(from = 0, to = 30000000, by = 5000000)) +
  theme_bw() +
  theme(axis.text.y = element_text(size = 7),
        panel.grid.major = element_blank()) + coord_flip() +
  ggtitle("Top 50 họ có số người cao nhất")
ggsave(filename = file.path("figures", "General", "top50_ho.png"), width = 7, height = 5)
```

# Bản đồ tỉ lệ % họ tính đến xã

## Họ Nguyễn

```{r}
library(sf)
nguyen_sf <- dat_sf %>% mutate(prop.nguyen=(sum(subset(., Ho=="Nguyễn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Nguyễn")
nguyen_plot <- nguyen_sf %>% select(pro.pop, prop.nguyen, geometry) %>% st_as_sf(crs = 4326)
#colnames(nguyen_plot) <- c("Tỉ lệ % họ trên tổng dân số", "geometry")
#plot(nguyen_plot)
ggplot() + geom_sf() + geom_sf(data=nguyen_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(nguyen_plot$prop.nguyen[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Nguyễn")
#ggsave(filename = file.path("Ho Nguyen-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Nguyen-PerPop.jpeg"), width = 49, height = 33)
```

## Họ Trần

```{r}
tran_sf <- dat_sf %>% mutate(prop.tran=(sum(subset(., Ho=="Trần")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trần")
tran_plot <- tran_sf %>% select(pro.pop, prop.tran, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=tran_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(tran_plot$prop.tran[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Trần")
#ggsave(filename = file.path("Ho Tran-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Tran-PerPop.jpeg"), width = 49, height = 33)
```

## Họ Lã

```{r}
la_sf <- dat_sf %>% mutate(prop.la=(sum(subset(., Ho=="Lã")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lã")
la_plot <- la_sf %>% select(pro.pop, prop.la, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=la_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(la_plot$prop.la[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Lã")
#ggsave(filename = file.path("Ho La-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho La-PerPop.jpeg"), width = 49, height = 33)
```

## Họ Lưu

```{r}
luu_sf <- dat_sf %>% mutate(prop.luu=(sum(subset(., Ho=="Lưu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lưu")
luu_plot <- luu_sf %>% select(pro.pop, prop.luu, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=luu_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(luu_plot$prop.luu[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Lưu")
#ggsave(filename = file.path("Ho Luu-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Luu-PerPop.jpeg"), width = 49, height = 33)
```

## Họ Lương

```{r}
luong_sf <- dat_sf %>% mutate(prop.luong=(sum(subset(., Ho=="Lương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lương")
luong_plot <- luong_sf %>% select(pro.pop, prop.luong, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=luong_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(luong_plot$prop.luong[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Lương")
#ggsave(filename = file.path("Ho Luong-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Luong-PerPop.jpeg"), width = 49, height = 33)
```

## Họ Lê

```{r}
le_sf <- dat_sf %>% mutate(prop.le=(sum(subset(., Ho=="Lê")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lê")
le_plot <- le_sf %>% select(pro.pop, prop.le, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=le_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(le_plot$prop.le[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Lê")
#ggsave(filename = file.path("Ho Le-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Le-PerPop.jpeg"), width = 49, height = 33)
```

## Họ Dư

```{r}
du_sf <- dat_sf %>% mutate(prop.du=(sum(subset(., Ho=="Dư")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Dư")
du_plot <- du_sf %>% select(pro.pop, prop.du, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=du_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(du_plot$prop.du[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Dư")
#ggsave(filename = file.path("Ho Du-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Du-PerPop.jpeg"), width = 49, height = 33)
```
## Họ Dương

```{r}
duong_sf <- dat_sf %>% mutate(prop.duong=(sum(subset(., Ho=="Dương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Dương")
duong_plot <- duong_sf %>% select(pro.pop, prop.duong, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=duong_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(duong_plot$prop.duong[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Dương")
#ggsave(filename = file.path("Ho Duong-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Duong-PerPop.jpeg"), width = 49, height = 33)
```

## Họ Lý

```{r}
ly_sf <- dat_sf %>% mutate(prop.ly=(sum(subset(., Ho=="Lý")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lý")
ly_plot <- ly_sf %>% select(pro.pop, prop.ly, geometry) %>% st_as_sf(crs = 4326)
#colnames(ly_plot) <- c("Tỉ lệ % họ trên tổng dân số", "geometry")
ggplot() + geom_sf() + geom_sf(data=ly_plot, aes(fill=pro.pop), lwd=0) +
  #geom_sf(data=river3) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(ly_plot$prop.ly[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Lý")
#ggsave(filename = file.path("Ho Ly-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Ly-PerPop.jpeg"), width = 49, height = 33)
```
## Họ Đoàn

```{r}
doan_sf <- dat_sf %>% mutate(prop.doan=(sum(subset(., Ho=="Đoàn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đoàn")
doan_plot <- doan_sf %>% select(pro.pop, prop.doan, geometry) %>% st_as_sf(crs = 4326)
#colnames(doan_plot) <- c("Tỉ lệ % họ trên tổng dân số", "geometry")
ggplot() + geom_sf(data=doan_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(doan_plot$prop.doan[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Đoàn")
#ggsave(filename = file.path("Ho Doan-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Doan-PerPop.jpeg"), width = 49, height = 33)
```

## Họ Ngô

```{r}
ngo_sf <- dat_sf %>% mutate(prop.ngo=(sum(subset(., Ho=="Ngô")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ngô")
ngo_plot <- ngo_sf %>% select(pro.pop, prop.ngo, geometry) %>% st_as_sf(crs = 4326)
#colnames(doan_plot) <- c("Tỉ lệ % họ trên tổng dân số", "geometry")
ggplot() + geom_sf(data=ngo_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(ngo_plot$prop.ngo[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Ngô")
#ggsave(filename = file.path("Ho Ngo-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Ngo-PerPop.jpeg"), width = 49, height = 33)
```
## Họ Triệu

```{r}
trieu_sf <- dat_sf %>% mutate(prop.trieu=(sum(subset(., Ho=="Triệu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Triệu")
trieu_plot <- trieu_sf %>% select(pro.pop, prop.trieu, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=trieu_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(trieu_plot$prop.trieu[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Triệu")
#ggsave(filename = file.path("Ho Trieu-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Trieu-PerPop.jpeg"), width = 49, height = 33)
```

## Họ Mã

```{r}
ma_sf <- dat_sf %>% mutate(prop.ma=(sum(subset(., Ho=="Mã")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mã")
ma_plot <- ma_sf %>% select(pro.pop, prop.ma, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=ma_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(ma_plot$prop.ma[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Mã")
#ggsave(filename = file.path("Ho Ma-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Ma-PerPop.jpeg"), width = 49, height = 33)
```

## Họ Mạc

```{r}
mac_sf <- dat_sf %>% mutate(prop.mac=(sum(subset(., Ho=="Mạc")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mạc")
mac_plot <- mac_sf %>% select(pro.pop, prop.mac, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=mac_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(mac_plot$prop.mac[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Mạc")
#ggsave(filename = file.path("Ho Mac-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Mac-PerPop.jpeg"), width = 49, height = 33)
```
## Họ Mai

```{r}
mai_sf <- dat_sf %>% mutate(prop.mai=(sum(subset(., Ho=="Mai")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mai")
mai_plot <- mai_sf %>% select(pro.pop, prop.mai, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=mai_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(mai_plot$prop.mai[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Mai")
#ggsave(filename = file.path("Ho Mai-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Mai-PerPop.jpeg"), width = 49, height = 33)
```

## Họ Phùng

```{r}
phung_sf <- dat_sf %>% mutate(prop.phung=(sum(subset(., Ho=="Phùng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phùng")
phung_plot <- phung_sf %>% select(pro.pop, prop.phung, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=phung_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(phung_plot$prop.phung[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Phùng")
#ggsave(filename = file.path("Ho Phung-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Phung-PerPop.jpeg"), width = 49, height = 33)
```
## Họ Khúc

```{r}
khuc_sf <- dat_sf %>% mutate(prop.khuc=(sum(subset(., Ho=="Khúc")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Khúc")
khuc_plot <- khuc_sf %>% select(pro.pop, prop.khuc, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=khuc_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(khuc_plot$prop.khuc[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Khúc")
#ggsave(filename = file.path("Ho Khuc-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Khuc-PerPop.jpeg"), width = 49, height = 33)
```
## Họ Phạm

```{r}
pham_sf <- dat_sf %>% mutate(prop.pham=(sum(subset(., Ho=="Phạm")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phạm")
pham_plot <- pham_sf %>% select(pro.pop, prop.pham, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=pham_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(pham_plot$prop.pham[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Phạm")
#ggsave(filename = file.path("Ho Pham-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Pham-PerPop.jpeg"), width = 49, height = 33)
```

## Họ Hồ

```{r}
ho_sf <- dat_sf %>% mutate(prop.ho=(sum(subset(., Ho=="Hồ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hồ")
ho_plot <- ho_sf %>% select(pro.pop, prop.ho, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=ho_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(ho_plot$prop.ho[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Hồ")
#ggsave(filename = file.path("Ho Ho-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Ho-PerPop.jpeg"), width = 49, height = 33)
```

## Họ Tôn

```{r}
ton_sf <- dat_sf %>% mutate(prop.ton=(sum(subset(., Ho=="Tôn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Tôn")
ton_plot <- ton_sf %>% select(pro.pop, prop.ton, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=ton_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(ton_plot$prop.ton[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Tôn")
#ggsave(filename = file.path("Ho Ton-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Ton-PerPop.jpeg"), width = 49, height = 33)
```
## Họ Bùi

```{r}
bui_sf <- dat_sf %>% mutate(prop.bui=(sum(subset(., Ho=="Bùi")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Bùi")
bui_plot <- bui_sf %>% select(pro.pop, prop.bui, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=bui_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(bui_plot$prop.bui[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Bùi")
#ggsave(filename = file.path("Ho Bui-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Bui-PerPop.jpeg"), width = 49, height = 33)
```
## Họ Đào

```{r}
dao_sf <- dat_sf %>% mutate(prop.dao=(sum(subset(., Ho=="Đào")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đào")
dao_plot <- dao_sf %>% select(pro.pop, prop.dao, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=dao_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(dao_plot$prop.dao[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Đào")
#ggsave(filename = file.path("Ho Dao-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Dao-PerPop.jpeg"), width = 49, height = 33)
```

## Họ Đinh

```{r}
dinh_sf <- dat_sf %>% mutate(prop.dinh=(sum(subset(., Ho=="Đinh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đinh")
dinh_plot <- dinh_sf %>% select(pro.pop, prop.dinh, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=dinh_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(dinh_plot$prop.dinh[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Đinh")
#ggsave(filename = file.path("Ho Dinh-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Dinh-PerPop.jpeg"), width = 49, height = 33)
```
## Họ Đỗ

```{r}
do_sf <- dat_sf %>% mutate(prop.do=(sum(subset(., Ho=="Đỗ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đỗ")
do_plot <- do_sf %>% select(pro.pop, prop.do, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=do_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(do_plot$prop.do[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Đỗ")
#ggsave(filename = file.path("Ho Do-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Do-PerPop.jpeg"), width = 49, height = 33)
```
## Họ Hoàng

```{r}
hoang_sf <- dat_sf %>% mutate(prop.hoang=(sum(subset(., Ho=="Hoàng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hoàng")
hoang_plot <- hoang_sf %>% select(pro.pop, prop.hoang, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=hoang_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(hoang_plot$prop.hoang[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Hoàng")
#ggsave(filename = file.path("Ho Hoang-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Hoang-PerPop.jpeg"), width = 49, height = 33)
```
## Họ Huỳnh

```{r}
huynh_sf <- dat_sf %>% mutate(prop.huynh=(sum(subset(., Ho=="Huỳnh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Huỳnh")
huynh_plot <- huynh_sf %>% select(pro.pop, prop.huynh, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=huynh_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(huynh_plot$prop.huynh[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Huỳnh")
#ggsave(filename = file.path("Ho Huynh-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Huynh-PerPop.jpeg"), width = 49, height = 33)
```

## Họ Phan

```{r}
phan_sf <- dat_sf %>% mutate(prop.phan=(sum(subset(., Ho=="Phan")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phan")
phan_plot <- phan_sf %>% select(pro.pop, prop.phan, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=phan_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(phan_plot$prop.phan[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Phan")
#ggsave(filename = file.path("Ho Phan-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Phan-PerPop.jpeg"), width = 49, height = 33)
```

## Họ Quách

```{r}
quach_sf <- dat_sf %>% mutate(prop.quach=(sum(subset(., Ho=="Quách")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Quách")
quach_plot <- quach_sf %>% select(pro.pop, prop.quach, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=quach_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(quach_plot$prop.quach[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Quách")
#ggsave(filename = file.path("Ho Quach-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Quach-PerPop.jpeg"), width = 49, height = 33)
```

## Họ Trịnh

```{r}
trinh_sf <- dat_sf %>% mutate(prop.trinh=(sum(subset(., Ho=="Trịnh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trịnh")
trinh_plot <- trinh_sf %>% select(pro.pop, prop.trinh, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=trinh_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(trinh_plot$prop.trinh[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Trịnh")
#ggsave(filename = file.path("Ho Trinh-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Trinh-PerPop.jpeg"), width = 49, height = 33)
```

## Họ Trương

```{r}
truong_sf <- dat_sf %>% mutate(prop.truong=(sum(subset(., Ho=="Trương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trương")
truong_plot <- truong_sf %>% select(pro.pop, prop.truong, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=truong_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(truong_plot$prop.truong[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Trương")
#ggsave(filename = file.path("Ho Truong-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Truong-PerPop.jpeg"), width = 49, height = 33)
```

## Họ Vũ

```{r}
vu_sf <- dat_sf %>% mutate(prop.vu=(sum(subset(., Ho=="Vũ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Vũ")
vu_plot <- vu_sf %>% select(pro.pop, prop.vu, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=vu_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(vu_plot$prop.vu[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Vũ")
#ggsave(filename = file.path("Ho Vu-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Vu-PerPop.jpeg"), width = 49, height = 33)
```
## Họ Võ

```{r}
vo_sf <- dat_sf %>% mutate(prop.vo=(sum(subset(., Ho=="Võ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Võ")
vo_plot <- vo_sf %>% select(pro.pop, prop.vo, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=vo_plot, aes(fill=pro.pop), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(vo_plot$prop.vo[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Võ")
#ggsave(filename = file.path("Ho Vo-PerPop.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Vo-PerPop.jpeg"), width = 49, height = 33)
```

# Bản đồ mật độ họ trên diện tích tính đến xã

## Họ Nguyễn

```{r}
library(sf)
nguyen_sff <- dat_sff %>% mutate(prop.nguyen=(sum(subset(., Ho=="Nguyễn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Nguyễn")
nguyen_plotf <- nguyen_sff %>% select(songuoi_km, prop.nguyen, geometry) %>% st_as_sf(crs = 4326)

ggplot() + geom_sf() + geom_sf(data=nguyen_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(nguyen_plotf$prop.nguyen[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Nguyễn")
#ggsave(filename = file.path("Ho Nguyen-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Nguyen-PerArea.jpeg"), width = 49, height = 33)
```

## Họ Trần

```{r}
tran_sff <- dat_sff %>% mutate(prop.tran=(sum(subset(., Ho=="Trần")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trần")
tran_plotf <- tran_sff %>% select(songuoi_km, prop.tran, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=tran_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(tran_plot$prop.tran[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Trần")
#ggsave(filename = file.path("Ho Tran-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Tran-PerArea.jpeg"), width = 49, height = 33)
```

## Họ Lã

```{r}
la_sff <- dat_sff %>% mutate(prop.la=(sum(subset(., Ho=="Lã")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lã")
la_plotf <- la_sff %>% select(songuoi_km, prop.la, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=la_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(la_plot$prop.la[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Lã")
#ggsave(filename = file.path("Ho La-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho La-PerArea.jpeg"), width = 49, height = 33)
```

## Họ Lê

```{r}
le_sff <- dat_sff %>% mutate(prop.le=(sum(subset(., Ho=="Lê")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lê")
le_plotf <- le_sff %>% select(songuoi_km, prop.le, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=le_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(le_plot$prop.le[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Lê")
#ggsave(filename = file.path("Ho Le-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Le-PerArea.jpeg"), width = 49, height = 33)
```

## Họ Lưu

```{r}
luu_sff <- dat_sff %>% mutate(prop.luu=(sum(subset(., Ho=="Lưu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lưu")
luu_plotf <- luu_sff %>% select(songuoi_km, prop.luu, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=luu_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(luu_plot$prop.luu[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Lưu")
#ggsave(filename = file.path("Ho Luu-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Luu-PerArea.jpeg"), width = 49, height = 33)
```

## Họ Lương

```{r}
luong_sff <- dat_sff %>% mutate(prop.luong=(sum(subset(., Ho=="Lương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lương")
luong_plotf <- luong_sff %>% select(songuoi_km, prop.luong, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=luong_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(luong_plot$prop.luong[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Lương")
#ggsave(filename = file.path("Ho Luong-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Luong-PerArea.jpeg"), width = 49, height = 33)
```

## Họ Dư

```{r}
du_sff <- dat_sff %>% mutate(prop.du=(sum(subset(., Ho=="Dư")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Dư")
du_plotf <- du_sff %>% select(songuoi_km, prop.du, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=du_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(du_plot$prop.du[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Dư")
#ggsave(filename = file.path("Ho Du-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Du-PerArea.jpeg"), width = 49, height = 33)
```
## Họ Dương

```{r}
duong_sff <- dat_sff %>% mutate(prop.duong=(sum(subset(., Ho=="Dương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Dương")
duong_plotf <- duong_sff %>% select(songuoi_km, prop.duong, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=duong_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(duong_plot$prop.duong[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Dương")
#ggsave(filename = file.path("Ho Duong-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Duong-PerArea.jpeg"), width = 49, height = 33)
```

## Họ Lý

```{r}
ly_sff <- dat_sff %>% mutate(prop.ly=(sum(subset(., Ho=="Lý")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Lý")
ly_plotf <- ly_sff %>% select(songuoi_km, prop.ly, geometry) %>% st_as_sf(crs = 4326)
#colnames(ly_plot) <- c("Tỉ lệ % họ trên tổng dân số", "geometry")
ggplot() + geom_sf() + geom_sf(data=ly_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(ly_plot$prop.ly[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Lý")
#ggsave(filename = file.path("Ho Ly-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Ly-PerArea.jpeg"), width = 49, height = 33)
```
## Họ Đoàn

```{r}
doan_sff <- dat_sff %>% mutate(prop.doan=(sum(subset(., Ho=="Đoàn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đoàn")
doan_plotf <- doan_sff %>% select(songuoi_km, prop.doan, geometry) %>% st_as_sf(crs = 4326)
#colnames(doan_plot) <- c("Tỉ lệ % họ trên tổng dân số", "geometry")
ggplot() + geom_sf(data=doan_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(doan_plot$prop.doan[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Đoàn")
#ggsave(filename = file.path("Ho Doan-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Doan-PerArea.jpeg"), width = 49, height = 33)
```

## Họ Ngô

```{r}
ngo_sff <- dat_sff %>% mutate(prop.ngo=(sum(subset(., Ho=="Ngô")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Ngô")
ngo_plotf <- ngo_sff %>% select(songuoi_km, prop.ngo, geometry) %>% st_as_sf(crs = 4326)
#colnames(doan_plot) <- c("Tỉ lệ % họ trên tổng dân số", "geometry")
ggplot() + geom_sf(data=ngo_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(ngo_plot$prop.ngo[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Ngô")
#ggsave(filename = file.path("Ho Ngo-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Ngo-PerArea.jpeg"), width = 49, height = 33)
```
## Họ Triệu

```{r}
trieu_sff <- dat_sff %>% mutate(prop.trieu=(sum(subset(., Ho=="Triệu")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Triệu")
trieu_plotf <- trieu_sff %>% select(songuoi_km, prop.trieu, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=trieu_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(trieu_plot$prop.trieu[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Triệu")
#ggsave(filename = file.path("Ho Trieu-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Trieu-PerArea.jpeg"), width = 49, height = 33)
```

## Họ Mã

```{r}
ma_sff <- dat_sff %>% mutate(prop.ma=(sum(subset(., Ho=="Mã")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mã")
ma_plotf <- ma_sff %>% select(songuoi_km, prop.ma, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=ma_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(ma_plot$prop.ma[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Mã")
#ggsave(filename = file.path("Ho Ma-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Ma-PerArea.jpeg"), width = 49, height = 33)
```

## Họ Mạc

```{r}
mac_sff <- dat_sff %>% mutate(prop.mac=(sum(subset(., Ho=="Mạc")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mạc")
mac_plotf <- mac_sff %>% select(songuoi_km, prop.mac, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=mac_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(mac_plot$prop.mac[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Mạc")
#ggsave(filename = file.path("Ho Mac-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Mac-PerArea.jpeg"), width = 49, height = 33)
```

## Họ Mai

```{r}
mai_sff <- dat_sff %>% mutate(prop.mai=(sum(subset(., Ho=="Mai")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Mai")
mai_plotf <- mai_sff %>% select(songuoi_km, prop.mai, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=mai_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(mai_plot$prop.mai[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Mai")
#ggsave(filename = file.path("Ho Mai-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Mai-PerArea.jpeg"), width = 49, height = 33)
```

## Họ Phùng

```{r}
phung_sff <- dat_sff %>% mutate(prop.phung=(sum(subset(., Ho=="Phùng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phùng")
phung_plotf <- phung_sff %>% select(songuoi_km, prop.phung, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=phung_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(phung_plot$prop.phung[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Phùng")
#ggsave(filename = file.path("Ho Phung-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Phung-PerArea.jpeg"), width = 49, height = 33)
```
## Họ Khúc

```{r}
khuc_sff <- dat_sff %>% mutate(prop.khuc=(sum(subset(., Ho=="Khúc")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Khúc")
khuc_plotf <- khuc_sff %>% select(songuoi_km, prop.khuc, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=khuc_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(khuc_plot$prop.khuc[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Khúc")
#ggsave(filename = file.path("Ho Khuc-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Khuc-PerArea.jpeg"), width = 49, height = 33)
```
## Họ Phạm

```{r}
pham_sff <- dat_sff %>% mutate(prop.pham=(sum(subset(., Ho=="Phạm")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phạm")
pham_plotf <- pham_sff %>% select(songuoi_km, prop.pham, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=pham_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(pham_plot$prop.pham[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Phạm")
#ggsave(filename = file.path("Ho Pham-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Pham-PerArea.jpeg"), width = 49, height = 33)
```

## Họ Hồ

```{r}
ho_sff <- dat_sff %>% mutate(prop.ho=(sum(subset(., Ho=="Hồ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hồ")
ho_plotf <- ho_sff %>% select(songuoi_km, prop.ho, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=ho_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(ho_plotf$prop.ho[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Hồ")
#ggsave(filename = file.path("Ho Ho-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Ho-PerArea.jpeg"), width = 49, height = 33)
```

## Họ Tôn

```{r}
ton_sff <- dat_sff %>% mutate(prop.ton=(sum(subset(., Ho=="Tôn")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Tôn")
ton_plotf <- ton_sff %>% select(songuoi_km, prop.ton, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=ton_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(ton_plotf$prop.ton[1],2), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Tôn")
#ggsave(filename = file.path("Ho Ton-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Ton-PerArea.jpeg"), width = 49, height = 33)
```

## Họ Bùi

```{r}
bui_sff <- dat_sff %>% mutate(prop.bui=(sum(subset(., Ho=="Bùi")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Bùi")
bui_plotf <- bui_sff %>% select(songuoi_km, prop.bui, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=bui_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(bui_plotf$prop.bui[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Bùi")
#ggsave(filename = file.path("Ho Bui-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Bui-PerArea.jpeg"), width = 49, height = 33)
```
## Họ Đào

```{r}
dao_sff <- dat_sff %>% mutate(prop.dao=(sum(subset(., Ho=="Đào")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đào")
dao_plotf <- dao_sff %>% select(songuoi_km, prop.dao, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=dao_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(dao_plotf$prop.dao[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Đào")
#ggsave(filename = file.path("Ho Dao-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Dao-PerArea.jpeg"), width = 49, height = 33)
```

## Họ Đinh

```{r}
dinh_sff <- dat_sff %>% mutate(prop.dinh=(sum(subset(., Ho=="Đinh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đinh")
dinh_plotf <- dinh_sff %>% select(songuoi_km, prop.dinh, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=dinh_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(dinh_plotf$prop.dinh[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Đinh")
#ggsave(filename = file.path("Ho Dinh-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Dinh-PerArea.jpeg"), width = 49, height = 33)
```
## Họ Đỗ

```{r}
do_sff <- dat_sff %>% mutate(prop.do=(sum(subset(., Ho=="Đỗ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Đỗ")
do_plotf <- do_sff %>% select(songuoi_km, prop.do, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=do_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(do_plotf$prop.do[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Đỗ")
#ggsave(filename = file.path("Ho Do-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Do-PerArea.jpeg"), width = 49, height = 33)
```
## Họ Hoàng

```{r}
hoang_sff <- dat_sff %>% mutate(prop.hoang=(sum(subset(., Ho=="Hoàng")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Hoàng")
hoang_plotf <- hoang_sff %>% select(songuoi_km, prop.hoang, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=hoang_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(hoang_plotf$prop.hoang[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Hoàng")
#ggsave(filename = file.path("Ho Hoang-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Hoang-PerArea.jpeg"), width = 49, height = 33)
```
## Họ Huỳnh

```{r}
huynh_sff <- dat_sff %>% mutate(prop.huynh=(sum(subset(., Ho=="Huỳnh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Huỳnh")
huynh_plotf <- huynh_sff %>% select(songuoi_km, prop.huynh, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=huynh_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(huynh_plotf$prop.huynh[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Huỳnh")
#ggsave(filename = file.path("Ho Huynh-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Huynh-PerArea.jpeg"), width = 49, height = 33)
```
## Họ Phan

```{r}
phan_sff <- dat_sff %>% mutate(prop.phan=(sum(subset(., Ho=="Phan")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Phan")
phan_plotf <- phan_sff %>% select(songuoi_km, prop.phan, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=phan_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(phan_plotf$prop.phan[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Phan")
#ggsave(filename = file.path("Ho Phan-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Phan-PerArea.jpeg"), width = 49, height = 33)
```

## Họ Quách

```{r}
quach_sff <- dat_sff %>% mutate(prop.quach=(sum(subset(., Ho=="Quách")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Quách")
quach_plotf <- quach_sff %>% select(songuoi_km, prop.quach, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=quach_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(quach_plotf$prop.quach[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Quách")
#ggsave(filename = file.path("Ho Quach-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Quach-PerArea.jpeg"), width = 49, height = 33)
```

## Họ Trịnh

```{r}
trinh_sff <- dat_sff %>% mutate(prop.trinh=(sum(subset(., Ho=="Trịnh")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trịnh")
trinh_plotf <- trinh_sff %>% select(songuoi_km, prop.trinh, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=trinh_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(trinh_plotf$prop.trinh[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Trịnh")
#ggsave(filename = file.path("Ho Trinh-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Trinh-PerArea.jpeg"), width = 49, height = 33)
```
## Họ Trương

```{r}
truong_sff <- dat_sff %>% mutate(prop.truong=(sum(subset(., Ho=="Trương")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Trương")
truong_plotf <- truong_sff %>% select(songuoi_km, prop.truong, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=truong_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(truong_plotf$prop.truong[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Trương")
#ggsave(filename = file.path("Ho Truong-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Truong-PerArea.jpeg"), width = 49, height = 33)
```

## Họ Vũ

```{r}
vu_sff <- dat_sff %>% mutate(prop.vu=(sum(subset(., Ho=="Vũ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Vũ")
vu_plotf <- vu_sff %>% select(songuoi_km, prop.vu, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=vu_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(vu_plotf$prop.vu[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Vũ")
#ggsave(filename = file.path("Ho Vu-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Vu-PerArea.jpeg"), width = 49, height = 33)
```
## Họ Võ

```{r}
vo_sff <- dat_sff %>% mutate(prop.vo=(sum(subset(., Ho=="Võ")[, "songuoi"])/sum(songuoi))*100) %>% filter(Ho=="Võ")
vo_plotf <- vo_sff %>% select(songuoi_km, prop.vo, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=vo_plotf, aes(fill=songuoi_km), lwd=0) +
  annotate(geom="text", x=108, y=23, color="red", size=18, label= paste(round(vo_plotf$prop.vo[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Số người trên 1 km2 tại địa phương", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Họ Võ")
#ggsave(filename = file.path("Ho Vo-PerArea.png"), width = 49, height = 33)
ggsave(filename = file.path("figures", "General", "Ho Vo-PerArea.jpeg"), width = 49, height = 33)
```

# Phương trình hàm phân bố từng họ

```{r}
dat_sff_st <- dat_sff %>% st_as_sf(crs = 4326)
dat_sff_st$centroid <- sf::st_transform(dat_sff_st, 2154) %>%
  st_centroid() %>%
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

dat_st <- dat_sff_st %>%
  mutate(lng = map(centroid,1),
         lat = map(centroid,2),
         lng = as.numeric(lng),
         lat = as.numeric(lat)) %>%
  st_drop_geometry() %>%
  select(-c("MAXA", "MAHUYEN", "MATINH", "TYPE_3", "area", "centroid"))

ho <- data_ho_overall %>%
  arrange(desc(songuoi)) %>%
  mutate(pro.pop=(songuoi/sum(songuoi)*100))
ho <- head(ho, n=200)

dat_st <- dat_st %>% filter(Ho %in% ho$Ho)
dat_st$area_km = as.numeric(dat_st$area_km)
```

## Họ Mai

```{r}
mai <- dat_sff %>% filter(Ho=="Mai") %>% st_as_sf(crs = 4326)
mai$centroid <- sf::st_transform(mai, 2154) %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry()

library(geosphere)
mai <- mai %>%
  mutate(centroid_0 = centroid[NAME_3=="Thi tran Nga Son"],
         distm = geosphere::distGeo(st_coordinates(centroid), st_coordinates(centroid_0)),
         distm_km=distm/1000,
         distm_km2=distm_km^2,
         sum_distm_km2=sum(distm_km2),
         var=sum_distm_km2/(n()-1),
         sd=sqrt(var))

mai_st <- mai %>%
  mutate(lng = map(centroid,1),
         lat = map(centroid,2),
         lng = as.numeric(lng),
         lat = as.numeric(lat)) %>%
  st_drop_geometry() %>%
  select(-c("MAXA", "MAHUYEN", "MATINH", "TYPE_3", "area", "centroid"))

mai_st$area_km = as.numeric(mai_st$area_km)

mai_radius <- mai_st %>%
  arrange(distm_km) %>%
  mutate(rank=row_number())

distm_km<-mai_radius$distm_km
songuoi_km<-mai_radius$songuoi_km
rank<-mai_radius$rank
commune<-mai_radius$NAME_3
rank<-factor(rank, labels = commune)
long<-mai_radius$lng
lat<-mai_radius$lat
estimate<-1200*exp(-(distm_km^2)/(2*100))

library(dplyr)
df <- data.frame(distm_km, rank, commune, estimate, songuoi_km, long, lat) %>%
  mutate(num=sum((songuoi_km-estimate)^2),
         den=nrow(df)-1,
         var=num/den,
         sd=sqrt(var),
         rank_com=as.numeric(reorder(factor(rank), distm_km)))
  
breaks <- c(0, 200, 400, 600, 800, 1000, 1200, 1400, 1600, 1800, 2000)

plot_df <- df %>%
  #filter(row_number()<=100) %>%
  ggplot(aes(x=reorder(factor(rank), distm_km), y=songuoi_km, fill=distm_km)) +
  geom_bar(aes(x=reorder(factor(rank), distm_km), y=songuoi_km), stat = "identity", width = 0.5) + 
  #stat_smooth(method = 'lm', aes(colour = 'linear'), se = FALSE) +
  #geom_line(aes(x=as.numeric(reorder(factor(rank), distm_km)), y=estimate)) +
  stat_smooth(aes(y=songuoi_km, x=as.numeric(reorder(factor(rank), distm_km))),method="gam",se=TRUE,formula=y~s(x,k=20)) +
  scale_x_discrete(name = "Xã/Phường", 
                     breaks = reorder(factor(rank), distm_km), 
                     labels = reorder(factor(rank), distm_km)) +
  scale_fill_gradientn("Khoảng cách tới tâm (km)", colours = terrain.colors(10), breaks=breaks) +
  scale_y_continuous(name="Mật độ người/km2") +
  theme_bw() + 
  theme(text = element_text(size=20), axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_text(size=20),
        legend.text=element_text(size=20), legend.key.size = unit(5, "cm"), legend.key.height = unit(2, "cm"), legend.key.width = unit(4, "cm"), legend.position = "bottom") +
  theme(panel.grid.major = element_blank()) + 
  #annotate(geom='text', x=30, y=200, label="y == 55*e^-{(x^{2}+y^{2})/2*(160)}", parse = TRUE,size=10) +
  #annotate(geom='text', x=30, y=180, label="s.e. = 130 người/xã",parse=F,size=8) +
  #coord_flip() +
  ggtitle("Mai")

plot_df
ggsave(filename = file.path("figures", "General", "Mai-Density-2(2).jpeg"), width = 25, height = 16)
```

```{r}
library(gam)
gam = gam(songuoi_km ~ s(as.numeric(reorder(factor(rank), distm_km)), 20), data = df)
plot(gam, se = TRUE, col = "green")
summary(gam)
```

```{r}
mod=lm(songuoi_km ~ rank_com + poly(rank_com, 20), data=df)
summary(mod)
df <- df %>% mutate(pred=predict(mod))
ggplot(df, aes(x=rank_com, y=pred)) +
  geom_point(shape=".") +
  geom_smooth(colour="black",size=0.5) +
  theme_bw() + 
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())
```

```{r}
# Function to convert an EPSG code from meters to kilometers
epsgKM <- function(x) {
  crs <- st_crs(x)
  proj4KM <- gsub(pattern = "+.units=m", replacement = "+units=km", 
                  crs$proj4string)
  return(proj4KM)
}

# Envelope for variogram
variog_envelope <- function (geodata, coords = geodata$coords, data = geodata$data, 
                             obj.variog, nsim = 99, save.sim = FALSE, messages) 
{
  call.fc <- match.call()
  if (missing(geodata)) 
    geodata <- list(coords = coords, data = data)
  if (missing(messages)) 
    messages.screen <- as.logical(ifelse(is.null(getOption("geoR.messages")), 
                                         TRUE, getOption("geoR.messages")))
  else messages.screen <- messages
  obj.variog$v <- NULL
  if ((is.matrix(data) | is.data.frame(data))) 
    if (ncol(data) > 1) 
      stop("envelops can be computed for only one data set at once")
  if (!is.null(obj.variog$estimator.type)) 
    estimator.type <- obj.variog$estimator.type
  else estimator.type <- "classical"
  if (abs(obj.variog$lambda - 1) > 1e-04) {
    if (abs(obj.variog$lambda) < 1e-04) 
      data <- log(data)
    else data <- ((data^obj.variog$lambda) - 1)/obj.variog$lambda
  }
  xmat <- unclass(trend.spatial(trend = obj.variog$trend, geodata = geodata))
  if (obj.variog$trend != "cte") {
    if (is.vector(data)) {
      data <- lm(data ~ xmat + 0)$residuals
      names(data) <- NULL
    }
    else {
      only.res <- function(y, x) {
        lm(y ~ xmat + 0)$residuals
      }
      data <- apply(data, 2, only.res, x = xmat)
    }
  }
  if (messages.screen) 
    cat(paste("variog.env: generating", nsim, "simulations by permutating data values\n"))
  simula <- list(coords = coords)
  n.data <- length(data)
  perm.f <- function(i, data, n.data) {
    return(data[sample(1:n.data)])
  }
  simula$data <- apply(as.matrix(1:nsim), 1, perm.f, data = data, 
                       n.data = n.data)
  if (messages.screen) 
    cat(paste("variog.env: computing the empirical variogram for the", 
              nsim, "simulations\n"))
  nbins <- length(obj.variog$bins.lim) - 1
  if (obj.variog$direction == "omnidirectional") {
    bin.f <- function(sim) {
      cbin <- vbin <- sdbin <- rep(0, nbins)
      temp <- .C("binit", as.integer(obj.variog$n.data), 
                 as.double(as.vector(coords[, 1])), as.double(as.vector(coords[, 
                                                                               2])), as.double(as.vector(sim)), as.integer(nbins), 
                 as.double(as.vector(obj.variog$bins.lim)), as.integer(estimator.type == 
                                                                         "modulus"), as.double(max(obj.variog$u)), as.double(cbin), 
                 vbin = as.double(vbin), as.integer(FALSE), as.double(sdbin), 
                 PACKAGE = "geoR")$vbin
      return(temp)
    }
    simula.bins <- apply(simula$data, 2, bin.f)
  }
  else {
    variog.vbin <- function(x, ...) {
      variog(geodata = geodata, 
             data = x, uvec = obj.variog$uvec, estimator.type = obj.variog$estimator.type, 
             nugget.tolerance = obj.variog$nugget.tolerance, max.dist = obj.variog$max.dist, 
             pairs.min = obj.variog$pairs.min, direction = obj.variog$direction, 
             tolerance = obj.variog$tolerance, messages.screen = FALSE,...)$v
    }
    simula.bins <- apply(simula$data, 2, variog.vbin)
  }
  simula.bins <- simula.bins[obj.variog$ind.bin, ]
  if (save.sim == FALSE) 
    simula$data <- NULL
  if (messages.screen) 
    cat("variog.env: computing the envelops\n")
  limits <- apply(simula.bins, 1, quantile, prob = c(0.025, 0.975))
  res.env <- list(u = obj.variog$u, v.lower = limits[1, ], 
                  v.upper = limits[2, ])
  if (save.sim) 
    res.env$simulations <- simula$data
  res.env$call <- call.fc
  oldClass(res.env) <- "variogram.envelope"
  return(res.env)
}
# Calculate and plot the variogram
ggvario <- function(coords, 
                    data, 
                    bins = 15, 
                    maxdist = max(dist(coords))/3, 
                    uvec = NULL, 
                    nsim = 999,
                    color = "royalblue1", 
                    xlab = "distance", 
                    show_nbins = F, envelop=FALSE, cov.model="matern", fix.kappa=T) {
  require(geoR)
  res <- list()
  coords <- as.matrix(coords)
  min_dist <- min(dist(coords))
  if(is.null(uvec)) uvec <- seq(min_dist, maxdist, l = bins)
  empvario <- variog(coords = coords, data = data, uvec = uvec, messages = F)
  if(envelop ==FALSE){
    
    ### plot variogram alone 
    
    dfvario <- data.frame(distance = empvario$u, empirical = empvario$v,
                          nbinns = empvario$n)
    p1 <- ggplot(dfvario, aes(y = empirical, x = distance, label = nbinns)) +
      geom_point(col = "black", fill = color, shape = 21, size = 3) +
      scale_x_continuous(name = xlab, limits = c(0, uvec[length(uvec)]),
                         breaks = round(seq(0, uvec[length(uvec)], l = 6))) +
      scale_y_continuous(name = "semivariance",
                         #breaks = round(seq(0, max(dfvario$upemp, dfvario$empirical), l = 6), 1),
                         limits = c(0,  max(dfvario$empirical))) +
      ggtitle("Empirical semivariogram") 
    # theme_classic()
    p2 <- p1 + geom_text(vjust = 1, nudge_y = - diff(range(dfvario$empirical)) / 22)
    if(show_nbins){
      res[["pl"]] <- p2 
    } else {
      res[["pl"]] <- p1
    }
  } else if (envelop == TRUE){
    ### plot the Monte Carlo envelope and variogram
    
    envmc <- variog_envelope(coords = coords, data = data, 
                             obj.variog = empvario, nsim = nsim, messages = F)
    dfvario <- data.frame(distance = empvario$u, empirical = empvario$v,
                          lowemp = envmc$v.lower, upemp = envmc$v.upper, 
                          nbins = empvario$n)
    p1 <- ggplot(dfvario, aes(y = empirical, x = distance, label = nbins)) +
      geom_ribbon(aes(ymin = lowemp, ymax = upemp), fill = color, alpha = .3) +
      geom_point(aes(y = empirical), col = "black", fill = color, shape = 21, size = 3) +
      scale_x_continuous(name = xlab, limits = c(0, uvec[length(uvec)]),
                         breaks = round(seq(0, uvec[length(uvec)], l = 6))) +
      scale_y_continuous(name = "semivariance", 
                         #breaks = round(seq(0, max(dfvario$upemp, dfvario$empirical), l = 6), 1), 
                         limits = c(0, max(dfvario$upemp, dfvario$empirical))) +
      ggtitle("Empirical semivariogram") 
    # theme_classic()
    p2 <- p1 + geom_text(vjust = 1, nudge_y = - diff(range(dfvario$empirical)) / 22)
    if(show_nbins){
      res[["pl"]] <- p2 
    } else {
      res[["pl"]] <- p1
    }
  }
  res
}
```

```{r}
library(sf)
library(rgeos)
library(rgdal)
library(tmap)
library(dplyr)
library(geoR)
library(ggplot2)

# Plot the histogram of the lead concentration
hist(df$songuoi_km)

## map the songuoi_km
tm_shape(mai) + tm_symbols(col="songuoi_km", midpoint = NA)  

## scatter plot of the log of the lead concentration and pm10
ggplot(df, aes(x = rank, y = songuoi_km)) + geom_point()

# put a smooth line on it 
ggplot(df, aes(x =rank, y = songuoi_km)) + geom_point() + geom_smooth()

## scatter plot of the log of the lead concentration and all the other variables
ggplot( df %>% gather(key, value, -loglead, -lead), 
        aes(x = value, y = loglead)) + geom_point() + 
  facet_wrap(facets = ~key, scales = "free") + geom_smooth()


########## Section 3
### construct a variogram

# First thing to note is that the variogram is constructed on the residual. 
# So fit a linear model to the loglead and extract the residual

fit <- lm(formula = songuoi_km ~ rank, data = df)
resi <- residuals(fit)

ggvario(coords = df[, c("long", "lat")], data = resi, bins = 15, 
        show_nbins = F, envelope = F)

# Note that we set envelop to FALSE to have just the variogram

# note that the distance is still in degrees, so we need to convert the long and lat to meters

## convert the gps coordinate to web mercator ############
utmcoords <- mai %>% st_transform(., crs= 4326) %>% st_coordinates()
# note that 3857 is the code for the projection to Web Mercator 

#### now construct the variogram again in kilometers
ggvario(coords = utmcoords/1000, data = resi, bins = 15, show_nbins = F)


##### Now to perform the permutation test ###########
# We will add  the envelop and nsim argument
ggvario(coords = utmcoords/1000, data = resi, bins = 15, show_nbins = F, envelop = TRUE, nsim = 999)
```
